<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Portal - Fluent Feathers Academy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; color: #2d3748; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    header { background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { color: #667eea; font-size: 24px; }
    
    /* Admin Banner */
    #adminBanner { position: fixed; top: 0; left: 0; right: 0; background: #2d3748; color: white; padding: 15px 20px; display: none; align-items: center; justify-content: space-between; z-index: 2000; }
    #adminBanner.active { display: flex; }
    
    /* Login Section */
    .login-section { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 500px; margin: 50px auto; text-align: center; }
    
    /* Dashboard */
    .info-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 5px solid #667eea; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
    .info-item { padding: 10px; background: #f7fafc; border-radius: 5px; }
    .info-item strong { display: block; color: #718096; font-size: 0.85rem; margin-bottom: 5px; }
    .info-item span { font-size: 1.1rem; font-weight: 600; color: #2d3748; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 12px 20px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: #667eea; color: white; border-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Sections */
    .section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
    
    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    
    /* Buttons */
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #667eea; color: white; width: 100%; }
    .btn-primary:hover { background: #5568d3; }
    .btn-secondary { background: #718096; color: white; width: 100%; margin-top: 10px; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-success { background: #38a169; color: white; }
    .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; color: #4a5568; font-weight: 600; }
    
    /* Zoom Button */
    .zoom-btn { display: block; background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; text-decoration: none; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; transition: all 0.2s; }
    .zoom-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(56, 178, 172, 0.4); }
    
    /* Materials Grid */
    .materials-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .material-card { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.2s; }
    .material-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: #667eea; }
    .material-icon { font-size: 3rem; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="adminBanner">
    <span>üîê Admin View: <strong id="viewingStudentName"></strong></span>
    <button onclick="exitAdminView()" class="btn btn-danger btn-sm">Exit Admin View</button>
  </div>

  <div class="container">
    <!-- LOGIN SECTION -->
    <div id="loginSection" class="login-section">
      <h1 style="color: #667eea; margin-bottom: 20px;">üîê Parent Login</h1>
      <p style="color: #718096; margin-bottom: 30px;">Enter your registered email to access your child's portal</p>
      
      <!-- Email Form -->
      <form id="emailForm" style="display: block;">
        <div class="form-group" style="text-align: left;">
          <label>Parent Email *</label>
          <input type="email" id="parentEmail" required placeholder="parent@example.com">
        </div>
        <button type="submit" class="btn btn-primary">Continue</button>
      </form>

      <!-- Password Form -->
      <form id="passwordForm" style="display: none;">
        <div class="form-group" style="text-align: left;">
          <label>Password *</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary">Login</button>
        <button type="button" onclick="showOTPForm()" class="btn btn-secondary">Use OTP Instead</button>
      </form>

      <!-- OTP Form -->
      <form id="otpForm" style="display: none;">
        <div id="otpSendSection">
          <p style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #38a169; text-align: left;">
            ‚úÖ We'll send a 6-digit code to your registered email
          </p>
          <button type="button" onclick="sendOTP()" class="btn btn-success">üìß Send OTP</button>
          <button type="button" onclick="showPasswordForm()" class="btn btn-secondary">Use Password Instead</button>
        </div>

        <div id="otpVerifySection" style="display: none;">
          <div class="form-group" style="text-align: left;">
            <label>Enter 6-Digit OTP *</label>
            <input type="text" id="otpCode" required placeholder="000000" maxlength="6" style="letter-spacing: 5px; text-align: center; font-size: 1.5rem;">
          </div>
          <p style="color: #718096; margin-bottom: 15px;">OTP sent to <strong id="otpEmail"></strong></p>
          <button type="submit" class="btn btn-primary">Verify OTP</button>
          <button type="button" onclick="resendOTP()" class="btn btn-secondary">Resend OTP</button>
        </div>
      </form>

      <!-- Setup Password Form -->
      <form id="setupPasswordForm" style="display: none;">
        <h3 style="color: #38a169; margin-bottom: 15px;">üéâ Welcome! Set Your Password</h3>
        <p style="color: #718096; margin-bottom: 20px; text-align: left;">This is your first login. Create a password for future access.</p>
        <div class="form-group" style="text-align: left;">
          <label>Create Password *</label>
          <input type="password" id="newPassword" required minlength="6">
        </div>
        <div class="form-group" style="text-align: left;">
          <label>Confirm Password *</label>
          <input type="password" id="confirmPassword" required minlength="6">
        </div>
        <button type="submit" class="btn btn-primary">Set Password & Login</button>
      </form>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection" style="display: none;">
      <header>
        <div>
          <h1>üë®‚Äçüë©‚Äçüëß Parent Portal</h1>
          <p>Fluent Feathers Academy</p>
        </div>
        <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
      </header>

      <!-- Student Info Card -->
      <div class="info-card">
        <h2 style="color: #667eea; margin-bottom: 15px;">üë§ Student Information</h2>
        <div class="info-grid">
          <div class="info-item"><strong>Name:</strong><span id="displayName">-</span></div>
          <div class="info-item"><strong>Grade:</strong><span id="displayGrade">-</span></div>
          <div class="info-item"><strong>Program:</strong><span id="displayProgram">-</span></div>
          <div class="info-item"><strong>Timezone:</strong><span id="displayTimezone">-</span></div>
          <div class="info-item"><strong>Total Sessions:</strong><span id="displayTotal">-</span></div>
          <div class="info-item"><strong>Completed:</strong><span id="displayCompleted" style="color: #38a169;">-</span></div>
          <div class="info-item"><strong>Remaining:</strong><span id="displayRemaining" style="color: #e53e3e;">-</span></div>
          <div class="info-item"><strong>Fees Paid:</strong><span id="displayFees">-</span></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('upcoming')">üìÖ Upcoming</button>
        <button class="tab-btn" onclick="showTab('past')">üìö Past Classes</button>
        <button class="tab-btn" onclick="showTab('materials')">üìÅ Materials</button>
        <button class="tab-btn" onclick="showTab('homework')">üìù Homework</button>
      </div>

      <!-- Upcoming Tab -->
      <div id="upcomingTab" class="tab-content active">
        <a href="https://us04web.zoom.us/j/7288533155?pwd=Nng5N2l0aU12L0FQK245c0VVVHJBUT09" target="_blank" class="zoom-btn">
          üé• Join Zoom Class
        </a>

        <div class="section">
          <h2 style="margin-bottom: 20px;">üö´ Cancel Upcoming Class</h2>
          <p style="color: #718096; margin-bottom: 20px;">If you cannot attend, cancel below. A makeup credit will be added automatically.</p>
          
          <form id="cancelClassForm">
            <div class="form-group">
              <label>Select Class to Cancel *</label>
              <select id="cancelClassSelect" required>
                <option value="">Loading...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Reason (Optional)</label>
              <textarea id="cancelReason" rows="3" placeholder="Let us know why you need to cancel..."></textarea>
            </div>
            <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #38a169;">
              <p style="margin: 0; color: #155724;">
                <strong>üí° Note:</strong> A makeup class credit will be added immediately after cancellation.
              </p>
            </div>
            <button type="submit" class="btn btn-danger">üö´ Cancel Class</button>
          </form>
        </div>

        <div class="section">
          <h2>üìÖ Upcoming Schedule</h2>
          <table id="upcomingTable">
            <thead>
              <tr>
                <th>Session #</th>
                <th>Date</th>
                <th>Time</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="upcomingBody">
              <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Past Tab -->
      <div id="pastTab" class="tab-content">
        <div class="section">
          <h2>üìö Completed Classes</h2>
          <table id="pastTable">
            <thead>
              <tr>
                <th>Session #</th>
                <th>Date</th>
                <th>Time</th>
                <th>Attendance</th>
                <th>PPT</th>
                <th>Recording</th>
                <th>Homework</th>
                <th>Grade</th>
              </tr>
            </thead>
            <tbody id="pastBody">
              <tr><td colspan="8" style="text-align: center;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Materials Tab -->
      <div id="materialsTab" class="tab-content">
        <div class="section">
          <h2>üìÅ Class Materials</h2>
          <div id="materialsGrid" class="materials-grid">
            <p style="grid-column: 1/-1; text-align: center; color: #718096; padding: 40px;">Loading...</p>
          </div>
        </div>
      </div>

      <!-- Homework Tab -->
      <div id="homeworkTab" class="tab-content">
        <div class="section">
          <h2>üì§ Upload Homework</h2>
          <form id="uploadHomeworkForm">
            <div class="form-group">
              <label>Session Date *</label>
              <input type="date" id="homeworkDate" required>
            </div>
            <div class="form-group">
              <label>Select File *</label>
              <input type="file" id="homeworkFile" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.zip">
              <small style="color: #718096;">PDF, DOC, Images, ZIP (Max 50MB)</small>
            </div>
            <button type="submit" class="btn btn-primary">üì§ Upload Homework</button>
          </form>
        </div>

        <div class="section">
          <h2>üì§ Submission History</h2>
          <table id="homeworkTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>File</th>
                <th>Uploaded</th>
                <th>Grade</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody id="homeworkBody">
              <tr><td colspan="5" style="text-align: center;">No submissions yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStudent = null;
    let currentEmail = '';

    // ‚úÖ HELPER: Normalize time string to HH:MM format
    function normalizeTimeString(timeStr) {
      if (!timeStr) return null;
      
      timeStr = timeStr.trim();
      
      // Already in HH:MM format
      if (/^\d{2}:\d{2}$/.test(timeStr)) {
        return timeStr;
      }
      
      // HH:MM:SS format - extract HH:MM
      if (/^\d{2}:\d{2}:\d{2}/.test(timeStr)) {
        return timeStr.substring(0, 5);
      }
      
      // Try parsing as full datetime
      try {
        const date = new Date(timeStr);
        if (!isNaN(date.getTime())) {
          const hours = String(date.getUTCHours()).padStart(2, '0');
          const minutes = String(date.getUTCMinutes()).padStart(2, '0');
          return `${hours}:${minutes}`;
        }
      } catch (e) {
        console.error('Failed to parse time:', timeStr, e);
      }
      
      return null;
    }

   // ‚úÖ HELPER: Create proper UTC datetime string
    function createUTCDateTime(dateStr, timeStr) {
      const normalizedTime = normalizeTimeString(timeStr);
      
      if (!dateStr || !normalizedTime) {
        console.error('Invalid input:', { dateStr, timeStr, normalizedTime });
        return null;
      }
      
      // Clean date and time before creating UTC string
      const cleanDate = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
      const cleanTime = normalizedTime.length === 8 ? normalizedTime.substring(0, 5) : normalizedTime;
      const utcDateTimeStr = `${cleanDate}T${cleanTime}:00Z`;
      
      // Validate
      const testDate = new Date(utcDateTimeStr);
      if (isNaN(testDate.getTime())) {
        console.error('Invalid datetime created:', utcDateTimeStr);
        return null;
      }
      
      return utcDateTimeStr;
    }

    // ‚úÖ HELPER: Convert UTC datetime to local timezone
    function convertToLocalTime(dateStr, timeStr, timezone) {
      const utcDateTimeStr = createUTCDateTime(dateStr, timeStr);
      
      if (!utcDateTimeStr) {
        return { date: 'Invalid Date', time: 'Invalid Time', isValid: false };
      }
      
      try {
        const utcDateTime = new Date(utcDateTimeStr);
        
        const displayDate = utcDateTime.toLocaleDateString('en-US', {
          timeZone: timezone,
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        
        const displayTime = utcDateTime.toLocaleTimeString('en-US', {
          timeZone: timezone,
          hour12: true,
          hour: '2-digit',
          minute: '2-digit'
        });
        
        return { date: displayDate, time: displayTime, isValid: true };
      } catch (e) {
        console.error('Conversion error:', e);
        return { date: 'Invalid Date', time: 'Invalid Time', isValid: false };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const parentViewStudent = sessionStorage.getItem('parentViewStudent');
      const parentViewMode = sessionStorage.getItem('parentViewMode');

      if (parentViewMode === 'true' && parentViewStudent) {
        console.log('üîê Admin viewing parent portal');
        currentStudent = JSON.parse(parentViewStudent);
        
        const banner = document.getElementById('adminBanner');
        banner.classList.add('active');
        document.getElementById('viewingStudentName').textContent = currentStudent.name + ' (' + currentStudent.parent_email + ')';
        document.body.style.paddingTop = '60px';
        
        showDashboard();
      } else {
        setupLoginHandlers();
      }
    });

    function setupLoginHandlers() {
      document.getElementById('emailForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        currentEmail = document.getElementById('parentEmail').value.trim();
        
        try {
          const res = await fetch('/api/parent/check-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail })
          });
          const result = await res.json();
          
          if (res.ok) {
            document.getElementById('emailForm').style.display = 'none';
            if (result.hasPassword) {
              document.getElementById('passwordForm').style.display = 'block';
            } else {
              document.getElementById('setupPasswordForm').style.display = 'block';
            }
          } else {
            alert('‚ùå ' + result.error);
          }
        } catch (err) {
          alert('‚ùå Network error. Please try again.');
          console.error(err);
        }
      });

      document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('loginPassword').value;
        
        try {
          const res = await fetch('/api/parent/login-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail, password })
          });
          const result = await res.json();
          
          if (res.ok && result.student) {
            currentStudent = result.student;
            showDashboard();
          } else {
            alert('‚ùå ' + result.error);
          }
        } catch (err) {
          alert('‚ùå Network error. Please try again.');
          console.error(err);
        }
      });

      document.getElementById('otpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const otp = document.getElementById('otpCode').value;
        
        try {
          const res = await fetch('/api/parent/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail, otp })
          });
          const result = await res.json();
          
          if (res.ok && result.student) {
            currentStudent = result.student;
            showDashboard();
          } else {
            alert('‚ùå ' + result.error);
          }
        } catch (err) {
          alert('‚ùå Network error. Please try again.');
          console.error(err);
        }
      });

      document.getElementById('setupPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const p1 = document.getElementById('newPassword').value;
        const p2 = document.getElementById('confirmPassword').value;
        
        if (p1 !== p2) return alert('‚ùå Passwords do not match');
        if (p1.length < 6) return alert('‚ùå Password must be at least 6 characters');
        
        try {
          const res = await fetch('/api/parent/setup-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail, password: p1 })
          });
          const result = await res.json();
          
          if (res.ok && result.student) {
            currentStudent = result.student;
            showDashboard();
          } else {
            alert('‚ùå ' + result.error);
          }
        } catch (err) {
          alert('‚ùå Error setting password. Please try again.');
          console.error(err);
        }
      });
    }

    function showPasswordForm() {
      document.getElementById('otpForm').style.display = 'none';
      document.getElementById('passwordForm').style.display = 'block';
    }

    function showOTPForm() {
      document.getElementById('passwordForm').style.display = 'none';
      document.getElementById('otpForm').style.display = 'block';
      document.getElementById('otpSendSection').style.display = 'block';
      document.getElementById('otpVerifySection').style.display = 'none';
    }

    async function sendOTP() {
      try {
        const res = await fetch('/api/parent/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail })
        });
        
        if (res.ok) {
          document.getElementById('otpSendSection').style.display = 'none';
          document.getElementById('otpVerifySection').style.display = 'block';
          document.getElementById('otpEmail').textContent = currentEmail;
          alert('‚úÖ OTP sent to your email!');
        } else {
          alert('‚ùå Failed to send OTP');
        }
      } catch (err) {
        alert('‚ùå Network error');
        console.error(err);
      }
    }

    function resendOTP() {
      sendOTP();
    }

    function showDashboard() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      
      document.getElementById('displayName').textContent = currentStudent.name;
      document.getElementById('displayGrade').textContent = currentStudent.grade;
      document.getElementById('displayProgram').textContent = currentStudent.program_name;
      document.getElementById('displayTimezone').textContent = currentStudent.timezone;
      document.getElementById('displayTotal').textContent = currentStudent.total_sessions;
      document.getElementById('displayCompleted').textContent = currentStudent.completed_sessions;
      document.getElementById('displayRemaining').textContent = currentStudent.remaining_sessions;
      document.getElementById('displayFees').textContent = currentStudent.currency + (currentStudent.fees_paid || 0);
      
      loadUpcomingSessions();
      loadPastSessions();
      loadMaterials();
      loadHomeworkHistory();
      loadCancelDropdown();
    }

    async function loadUpcomingSessions() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`);
        const sessions = await res.json();
        
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => 
          s.session_date >= today && 
          (s.status === 'Pending' || s.status === 'Scheduled')
        );
        
        const tbody = document.getElementById('upcomingBody');
        
        if (upcoming.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #718096;">No upcoming classes scheduled</td></tr>';
          return;
        }
        
        tbody.innerHTML = upcoming.map(s => {
          const converted = convertToLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          
          if (!converted.isValid) {
            console.error('Invalid session data:', s);
            return `
              <tr>
                <td><strong>Session ${s.session_number}</strong></td>
                <td colspan="3" style="color: #e53e3e;">
                  Invalid date/time data
                  <br><small>Date: ${s.session_date}, Time: ${s.session_time}</small>
                </td>
              </tr>
            `;
          }
          
          return `
            <tr>
              <td><strong>Session ${s.session_number}</strong></td>
              <td>${converted.date}</td>
              <td>
                <strong style="color: #667eea; font-size: 1.1rem;">${converted.time}</strong>
                <br>
                <small style="color: #718096;">${currentStudent.timezone}</small>
              </td>
              <td><a href="${s.zoom_link}" target="_blank" class="btn btn-success btn-sm">üé• Join</a></td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error('Failed to load upcoming sessions:', err);
        document.getElementById('upcomingBody').innerHTML = 
          '<tr><td colspan="4" style="text-align: center; color: #e53e3e;">Error loading sessions</td></tr>';
      }
    }

    async function loadCancelDropdown() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`);
        const sessions = await res.json();
        
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => 
          s.session_date >= today && 
          (s.status === 'Pending' || s.status === 'Scheduled')
        );
        
        const select = document.getElementById('cancelClassSelect');
        
        if (upcoming.length === 0) {
          select.innerHTML = '<option value="">No upcoming classes to cancel</option>';
          return;
        }
        
        select.innerHTML = '<option value="">Select a class...</option>' + 
          upcoming.map(s => {
            const converted = convertToLocalTime(s.session_date, s.session_time, currentStudent.timezone);
            
            if (!converted.isValid) return '';
            
            const normalizedTime = normalizeTimeString(s.session_time);
            
            return `<option value="${s.id}" data-date="${s.session_date}" data-time="${normalizedTime}">
              Session ${s.session_number} - ${converted.date} at ${converted.time} (${currentStudent.timezone})
            </option>`;
          }).join('');
      } catch (err) {
        console.error('Failed to load cancel dropdown:', err);
         }
    }

    document.getElementById('cancelClassForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const select = document.getElementById('cancelClassSelect');
      const selectedOption = select.options[select.selectedIndex];
      
      if (!selectedOption.value) return alert('Please select a class to cancel');
      
      const sessionDate = selectedOption.getAttribute('data-date');
      const sessionTime = selectedOption.getAttribute('data-time');
      const reason = document.getElementById('cancelReason').value;
      
      if (!confirm('Are you sure you want to cancel this class? A makeup credit will be added to your account.')) {
        return;
      }
      
      try {
        const res = await fetch('/api/parent/cancel-class', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: currentStudent.id,
            session_date: sessionDate,
            session_time: sessionTime,
            reason: reason
          })
        });
        
        const result = await res.json();
        
        if (res.ok) {
          alert('‚úÖ ' + result.message);
          e.target.reset();
          loadUpcomingSessions();
          loadCancelDropdown();
        } else {
          alert('‚ùå ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Network error');
        console.error(err);
      }
    });

    async function loadPastSessions() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`);
        const sessions = await res.json();
        
        const past = sessions.filter(s => s.status === 'Completed' || s.status === 'Missed');
        
        const tbody = document.getElementById('pastBody');
        
        if (past.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #718096;">No completed classes yet</td></tr>';
          return;
        }
        
        tbody.innerHTML = past.map(s => {
          const converted = convertToLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          
          let displayDate = 'Invalid Date';
          let displayTime = 'Invalid Time';
          
          if (converted.isValid) {
            displayDate = converted.date;
            displayTime = converted.time;
          }
          
          return `
            <tr>
              <td><strong>Session ${s.session_number}</strong></td>
              <td>${displayDate}</td>
              <td>${displayTime}</td>
              <td>
                <span style="padding: 4px 12px; border-radius: 12px; background: ${s.attendance === 'Present' ? '#d4edda' : '#f8d7da'}; color: ${s.attendance === 'Present' ? '#155724' : '#721c24'};">
                  ${s.attendance || '-'}
                </span>
              </td>
              <td>${s.ppt_file_path ? '<a href="/uploads/materials/' + s.ppt_file_path + '" target="_blank" download class="btn btn-primary btn-sm">üì• PPT</a>' : '-'}</td>
              <td>${s.recording_file_path ? '<a href="/uploads/materials/' + s.recording_file_path + '" target="_blank" class="btn btn-primary btn-sm">üé• Video</a>' : '-'}</td>
              <td>${s.homework_file_path ? '<a href="/uploads/materials/' + s.homework_file_path + '" target="_blank" download class="btn btn-primary btn-sm">üìù HW</a>' : '-'}</td>
              <td><strong style="color: #667eea;">${s.homework_grade || '-'}</strong></td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error('Failed to load past sessions:', err);
        document.getElementById('pastBody').innerHTML = 
          '<tr><td colspan="8" style="text-align: center; color: #e53e3e;">Error loading past sessions</td></tr>';
      }
    }

    async function loadMaterials() {
      try {
        const res = await fetch(`/api/materials/${currentStudent.id}`);
        const materials = await res.json();
        
        const grid = document.getElementById('materialsGrid');
        const teacherMaterials = materials.filter(m => m.uploaded_by === 'Teacher');
        
        if (teacherMaterials.length === 0) {
          grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #718096; padding: 40px;">No materials available yet</p>';
          return;
        }
        
        grid.innerHTML = teacherMaterials.map(m => {
          let icon = 'üìÅ';
          if (m.file_type === 'PPT') icon = 'üìä';
          if (m.file_type === 'Recording') icon = 'üé•';
          if (m.file_type === 'Homework') icon = 'üìù';
          
          return `
            <div class="material-card">
              <div class="material-icon">${icon}</div>
              <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">${m.file_type}</div>
              <div style="font-weight: 600; margin-bottom: 10px;">${m.file_name}</div>
              <div style="color: #718096; font-size: 0.85rem; margin-bottom: 15px;">${m.session_date || 'General'}</div>
              <a href="/uploads/homework/${m.file_path}" download class="btn btn-primary btn-sm">Download</a>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Failed to load materials:', err);
        document.getElementById('materialsGrid').innerHTML = 
          '<p style="grid-column: 1/-1; text-align: center; color: #e53e3e; padding: 40px;">Error loading materials</p>';
      }
    }

    async function loadHomeworkHistory() {
      try {
        const res = await fetch(`/api/materials/${currentStudent.id}`);
        const materials = await res.json();
        
        const homework = materials.filter(m => m.uploaded_by === 'Parent');
        
        const tbody = document.getElementById('homeworkBody');
        
        if (homework.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">No submissions yet</td></tr>';
          return;
        }
        
        tbody.innerHTML = homework.map(h => `
          <tr>
            <td>${h.session_date || '-'}</td>
            <td><a href="/uploads/homework/${h.file_path}" target="_blank" style="color: #667eea; text-decoration: none;">${h.file_name}</a></td>
            <td>${new Date(h.uploaded_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
            <td><strong style="color: ${h.feedback_grade ? '#38a169' : '#718096'};">${h.feedback_grade || 'Pending'}</strong></td>
            <td>${h.feedback_comments || '-'}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Failed to load homework history:', err);
        document.getElementById('homeworkBody').innerHTML = 
          '<tr><td colspan="5" style="text-align: center; color: #e53e3e;">Error loading homework</td></tr>';
      }
    }

    document.getElementById('uploadHomeworkForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const file = document.getElementById('homeworkFile').files[0];
      if (!file) return alert('Please select a file');
      
      if (file.size > 50 * 1024 * 1024) {
        return alert('‚ùå File size exceeds 50MB limit');
      }
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('sessionDate', document.getElementById('homeworkDate').value);
      formData.append('uploadType', 'homework');
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Uploading...';
      
      try {
        const res = await fetch(`/api/upload/homework/${currentStudent.id}`, {
          method: 'POST',
          body: formData
        });
        
        const result = await res.json();
        
        if (res.ok) {
          alert('‚úÖ ' + result.message);
          e.target.reset();
          loadHomeworkHistory();
          loadMaterials();
        } else {
          alert('‚ùå ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Upload failed. Please try again.');
        console.error(err);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üì§ Upload Homework';
      }
    });

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      
      document.getElementById(tabName + 'Tab').classList.add('active');
      event.target.classList.add('active');
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('parentViewStudent');
        sessionStorage.removeItem('parentViewMode');
        location.reload();
      }
    }

    function exitAdminView() {
      sessionStorage.removeItem('parentViewStudent');
      sessionStorage.removeItem('parentViewMode');
      window.close();
    }
  </script>
</body>
</html>