<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Portal - Fluent Feathers Academy</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; margin: 0; padding: 20px; color: #2d3748; }
    .container { max-width: 1000px; margin: 0 auto; }
    header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    h1 { margin: 0; color: #2b6cb0; font-size: 24px; }
    button { cursor: pointer; }
    
    .form-section { background: white; padding: 30px; border-radius: 10px; max-width: 500px; margin: 40px auto; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; }
    
    .btn-primary { background: #4299e1; color: white; border: none; padding: 12px 20px; border-radius: 6px; width: 100%; font-weight: 600; }
    .btn-secondary { background: #718096; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-top: 10px; width: 100%; }
    .btn-cancel { background: #e53e3e; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; margin-top: 10px; font-weight: bold; }

    .info-card { background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #4299e1; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
    .tab-btn { padding: 10px 20px; background: white; border: 1px solid #cbd5e0; border-radius: 6px; }
    .tab-btn.active { background: #4299e1; color: white; border-color: #4299e1; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; font-weight: 600; }
    
    .btn-zoom { background: #38b2ac; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
    .btn-zoom-large { display: block; text-align: center; background: #38b2ac; color: white; text-decoration: none; padding: 15px; border-radius: 8px; font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
    
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
    .modal-content { background:white; padding:20px; border-radius:8px; max-width:500px; width:90%; }
    
    #adminBanner { position: fixed; top: 0; left: 0; width: 100%; background: #2d3748; color: white; padding: 10px; text-align: center; z-index: 1000; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div><h1>üë®‚Äçüë©‚Äçüëß Parent Portal</h1><p>Fluent Feathers Academy</p></div>
    <button onclick="logout()" id="logoutBtn" style="display:none; background:#e53e3e; color:white; border:none; padding:8px 15px; border-radius:5px;">Logout</button>
  </header>

  <!-- LOGIN SECTION -->
  <section id="loginSection" class="form-section">
    <h2>üîê Login</h2>
    
    <!-- Step 1: Email -->
    <form id="emailForm">
      <div class="form-group"><label>Email *</label><input type="email" id="parentEmail" required></div>
      <button type="submit" class="btn-primary">Continue</button>
    </form>

    <!-- Step 2: Method -->
    <div id="loginMethodSection" style="display:none;">
      <button onclick="showPasswordForm()" class="btn-primary">üîë Password</button>
      <button onclick="showOTPForm()" class="btn-secondary">üì± Send OTP</button>
      <button onclick="resetLogin()" class="btn-secondary" style="background:transparent; color:#718096; margin-top:5px;">Back</button>
    </div>

    <!-- Password Form -->
    <form id="passwordForm" style="display:none;">
      <div class="form-group"><label>Password *</label><input type="password" id="loginPassword" required></div>
      <button type="submit" class="btn-primary">Login</button>
      <button type="button" onclick="resetLogin()" class="btn-secondary">Cancel</button>
    </form>
    
    <!-- Setup Password -->
    <form id="setupPasswordForm" style="display:none;">
      <h3>Create Password</h3>
      <div class="form-group"><label>New Password</label><input type="password" id="newPass" required></div>
      <div class="form-group"><label>Confirm</label><input type="password" id="confirmPass" required></div>
      <button type="submit" class="btn-primary">Set & Login</button>
    </form>

    <!-- OTP Form -->
    <form id="otpForm" style="display:none;">
      <div id="otpSend">
        <p>We will send a code to your email.</p>
        <button type="button" onclick="sendOTP()" class="btn-primary">Send Code</button>
      </div>
      <div id="otpVerify" style="display:none;">
        <div class="form-group"><label>Enter OTP</label><input type="text" id="otpCode"></div>
        <button type="submit" class="btn-primary">Verify</button>
      </div>
      <button type="button" onclick="resetLogin()" class="btn-secondary">Cancel</button>
    </form>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboardSection" style="display:none;">
    <div class="info-card">
      <div class="info-grid">
        <div><strong>Student:</strong> <span id="sName">-</span></div>
        <div><strong>Program:</strong> <span id="sProgram">-</span></div>
        <div><strong>Completed:</strong> <span id="sCompleted" style="color:green">-</span></div>
        <div><strong>Remaining:</strong> <span id="sRemaining" style="color:red">-</span></div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('upcoming', this)">üìÖ Upcoming</button>
      <button class="tab-btn" onclick="showTab('past', this)">üìö History</button>
      <button class="tab-btn" onclick="showTab('materials', this)">üìÅ Materials</button>
      <button class="tab-btn" onclick="showTab('homework', this)">üìù Homework</button>
    </div>

    <!-- UPCOMING TAB -->
    <div id="upcomingTab" class="tab-content active">
      <a href="https://us04web.zoom.us/j/7288533155?pwd=Nng5N2l0aU12L0FQK245c0VVVHJBUT09" target="_blank" class="btn-zoom-large">üé• Join Zoom Class</a>
      
      <!-- Cancel Form -->
      <div style="background:white; padding:20px; border-radius:10px; margin-bottom:20px;">
        <h3>üö´ Cancel Class</h3>
        <form id="cancelUpcomingForm">
          <div class="form-group">
            <select id="cancelClassSelect" required><option value="">Loading...</option></select>
          </div>
          <div class="form-group">
            <input type="text" id="cancelReason" placeholder="Reason (Optional)">
          </div>
          <button type="submit" class="btn-cancel">Cancel Class</button>
        </form>
      </div>

      <table id="upcomingTable">
        <thead><tr><th>#</th><th>Date</th><th>Time</th><th>Action</th></tr></thead>
        <tbody id="upcomingBody"></tbody>
      </table>
    </div>

    <!-- PAST TAB -->
    <div id="pastTab" class="tab-content">
      <table id="pastTable">
        <thead><tr><th>Date</th><th>Status</th><th>Resources</th></tr></thead>
        <tbody id="pastBody"></tbody>
      </table>
    </div>

    <!-- MATERIALS TAB -->
    <div id="materialsTab" class="tab-content">
      <div id="materialsGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px;"></div>
    </div>

    <!-- HOMEWORK TAB -->
    <div id="homeworkTab" class="tab-content">
      <div style="background:white; padding:20px; border-radius:10px; margin-bottom:20px;">
        <h3>Upload Homework</h3>
        <form id="uploadHwForm">
          <div class="form-group"><input type="date" id="hwDate" required></div>
          <div class="form-group"><input type="file" id="hwFile" required></div>
          <button type="submit" class="btn-primary">Upload</button>
        </form>
      </div>
      <table id="hwTable">
        <thead><tr><th>Date</th><th>File</th><th>Feedback</th></tr></thead>
        <tbody id="hwBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
let currentStudent = null;
let currentEmail = '';

// Check for Admin Mode
if(sessionStorage.getItem('adminAccessMode') === 'true') {
  currentStudent = JSON.parse(sessionStorage.getItem('adminAccessStudent'));
  currentEmail = sessionStorage.getItem('adminAccessEmail');
  document.body.insertAdjacentHTML('afterbegin', '<div id="adminBanner">üîê ADMIN VIEW MODE <button onclick="exitAdmin()">Exit</button></div>');
  document.body.style.paddingTop = '50px';
  showDashboard();
}

// Event Listeners
document.getElementById('emailForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  currentEmail = document.getElementById('parentEmail').value;
  const res = await fetch('/api/parent/check-email', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentEmail}) });
  const data = await res.json();
  
  if(res.ok) {
    document.getElementById('emailForm').style.display = 'none';
    if(data.hasPassword) {
      document.getElementById('loginMethodSection').style.display = 'block';
    } else {
      document.getElementById('setupPasswordForm').style.display = 'block';
    }
  } else { alert(data.error); }
});

document.getElementById('passwordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const password = document.getElementById('loginPassword').value;
  const res = await fetch('/api/parent/login-password', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentEmail, password}) });
  const data = await res.json();
  if(res.ok) { currentStudent = data.student; showDashboard(); } else { alert(data.error); }
});

document.getElementById('setupPasswordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const p1 = document.getElementById('newPass').value;
  const p2 = document.getElementById('confirmPass').value;
  if(p1!==p2) return alert('Passwords do not match');
  const res = await fetch('/api/parent/setup-password', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentEmail, password:p1}) });
  const data = await res.json();
  if(res.ok) { currentStudent = data.student; showDashboard(); } else { alert(data.error); }
});

document.getElementById('otpForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const otp = document.getElementById('otpCode').value;
  const res = await fetch('/api/parent/verify-otp', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentEmail, otp}) });
  const data = await res.json();
  if(res.ok) { currentStudent = data.student; showDashboard(); } else { alert(data.error); }
});

document.getElementById('cancelUpcomingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const val = document.getElementById('cancelClassSelect').value;
  if(!val) return alert('Select a class');
  
  if(!confirm('Cancel this class?')) return;
  
  const [id, type] = val.split('_'); // Split ID and Type
  const reason = document.getElementById('cancelReason').value;

  const res = await fetch('/api/parent/cancel-upcoming-class', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ student_id: currentStudent.id, session_id: id, type, reason })
  });
  
  if(res.ok) { alert('Cancelled. Credit added.'); loadUpcoming(); loadDropdown(); }
  else { alert('Failed'); }
});

document.getElementById('uploadHwForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append('file', document.getElementById('hwFile').files[0]);
  formData.append('sessionDate', document.getElementById('hwDate').value);
  const res = await fetch(`/api/upload/homework/${currentStudent.id}`, { method:'POST', body:formData });
  if(res.ok) { alert('Uploaded'); loadHomework(); } else { alert('Error'); }
});

// UI Functions
function showPasswordForm() { document.getElementById('loginMethodSection').style.display='none'; document.getElementById('passwordForm').style.display='block'; }
function showOTPForm() { document.getElementById('loginMethodSection').style.display='none'; document.getElementById('otpForm').style.display='block'; }
function resetLogin() { location.reload(); }
function logout() { sessionStorage.clear(); location.reload(); }
function exitAdmin() { sessionStorage.clear(); location.reload(); }

async function sendOTP() {
  const res = await fetch('/api/parent/send-otp', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentEmail}) });
  if(res.ok) { document.getElementById('otpSend').style.display='none'; document.getElementById('otpVerify').style.display='block'; }
  else { alert('Failed to send OTP'); }
}

function showDashboard() {
  document.getElementById('loginSection').style.display='none';
  document.getElementById('dashboardSection').style.display='block';
  document.getElementById('logoutBtn').style.display='block';
  
  document.getElementById('sName').textContent = currentStudent.name;
  document.getElementById('sProgram').textContent = currentStudent.program_name;
  document.getElementById('sCompleted').textContent = currentStudent.completed_sessions;
  document.getElementById('sRemaining').textContent = currentStudent.remaining_sessions;
  
  loadUpcoming();
  loadDropdown();
  loadPast();
  loadMaterials();
  loadHomework();
}

function showTab(t, btn) {
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(t+'Tab').classList.add('active');
  if(btn) btn.classList.add('active');
}

// Data Loaders
async function loadUpcoming() {
  const res = await fetch(`/api/parent/upcoming/${currentStudent.id}`);
  const data = await res.json();
  
  // 90 Minute Buffer Logic
  const now = new Date();
  const buffer = 90 * 60 * 1000;
  const cutoff = new Date(now.getTime() - buffer);
  
  const upcoming = data.filter(s => new Date(s.session_start_utc) >= cutoff && ['Pending','Scheduled'].includes(s.status));
  
  document.getElementById('upcomingBody').innerHTML = upcoming.map(s => {
    const d = new Date(s.session_start_utc);
    const dateStr = d.toLocaleDateString('en-US', {timeZone:currentStudent.timezone});
    const timeStr = d.toLocaleTimeString('en-US', {timeZone:currentStudent.timezone, hour:'2-digit', minute:'2-digit'});
    
    // Highlight if active now
    const isActive = (d <= now && d >= cutoff) || (d - now <= 600000);
    const btnStyle = isActive ? 'background:#e53e3e; animation:pulse 1.5s infinite;' : 'background:#38b2ac;';
    
    return `<tr>
      <td>#${s.session_number}</td>
      <td>${dateStr}</td>
      <td>${timeStr}</td>
      <td><a href="${s.zoom_link}" target="_blank" style="${btnStyle} padding:5px 10px; color:white; border-radius:4px; text-decoration:none;">${isActive ? 'üî¥ Join Now' : 'Join'}</a></td>
    </tr>`;
  }).join('') || '<tr><td colspan="4">No upcoming classes</td></tr>';
}

async function loadDropdown() {
  const res = await fetch(`/api/parent/upcoming/${currentStudent.id}`);
  const data = await res.json();
  const now = new Date();
  const upcoming = data.filter(s => new Date(s.session_start_utc) >= now && ['Pending','Scheduled'].includes(s.status));
  
  const sel = document.getElementById('cancelClassSelect');
  sel.innerHTML = '<option value="">Select class...</option>' + upcoming.map(s => 
    `<option value="${s.id}_${s.type}">${s.session_date} - ${s.type}</option>`
  ).join('');
}

async function loadPast() {
  // Use same API but filter for completed/missed
  const res = await fetch(`/api/parent/upcoming/${currentStudent.id}`);
  const data = await res.json();
  const past = data.filter(s => ['Completed','Missed','Cancelled by Parent','Cancelled by Teacher'].includes(s.status));
  
  document.getElementById('pastBody').innerHTML = past.map(s => {
    let resLinks = '';
    if(s.ppt_file_path) resLinks += `<a href="/uploads/homework/${s.ppt_file_path}">PPT</a> `;
    if(s.recording_file_path) resLinks += `<a href="/uploads/homework/${s.recording_file_path}">Rec</a> `;
    return `<tr><td>${s.session_date}</td><td>${s.status}</td><td>${resLinks || '-'}</td></tr>`;
  }).join('') || '<tr><td colspan="3">No history</td></tr>';
}

async function loadMaterials() {
  const res = await fetch(`/api/materials/${currentStudent.id}`);
  const data = await res.json();
  const mats = data.filter(m => m.uploaded_by === 'Teacher');
  
  document.getElementById('materialsGrid').innerHTML = mats.map(m => `
    <div style="background:white; padding:15px; border-radius:8px; border:1px solid #eee; text-align:center;">
      <div style="font-size:2em;">üìÅ</div>
      <div style="font-weight:bold;">${m.file_type}</div>
      <div style="margin:5px 0;">${m.file_name}</div>
      <a href="/uploads/homework/${m.file_path}" download style="color:#4299e1;">Download</a>
    </div>
  `).join('') || '<p>No materials</p>';
}

async function loadHomework() {
  const res = await fetch(`/api/materials/${currentStudent.id}`);
  const data = await res.json();
  const hw = data.filter(m => m.uploaded_by === 'Parent');
  
  document.getElementById('hwBody').innerHTML = hw.map(h => `
    <tr><td>${h.session_date}</td><td>${h.file_name}</td><td>${h.feedback_grade || 'Pending'}</td></tr>
  `).join('') || '<tr><td colspan="3">No uploads</td></tr>';
}
</script>
</body>
</html>