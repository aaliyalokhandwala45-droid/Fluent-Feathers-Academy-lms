<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Portal - Fluent Feathers Academy By Aaliya</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; color: #2d3748; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { color: #667eea; font-size: 24px; }
    .login-section { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 500px; margin: 50px auto; text-align: center; }
    .info-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 5px solid #667eea; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 12px 20px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: #667eea; color: white; border-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #667eea; color: white; width: 100%; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .btn-zoom { background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; display: inline-block; }
    .btn-zoom:hover { background: linear-gradient(135deg, #319795 0%, #285e61 100%); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; color: #4a5568; font-weight: 600; }
    .zoom-btn { display: block; background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; text-decoration: none; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; }
    #studentSelector { margin-bottom: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; text-align: center; display: none; }
    .makeup-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .makeup-card h3 { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN SECTION -->
    <div id="loginSection" class="login-section">
      <h1 style="color: #667eea; margin-bottom: 20px;">ğŸ” Parent Login</h1>
      <form id="emailForm"><div class="form-group"><label>Parent Email *</label><input type="email" id="parentEmail" required></div><button type="submit" class="btn btn-primary">Continue</button></form>
      <form id="passwordForm" style="display: none;"><div class="form-group"><label>Password *</label><input type="password" id="loginPassword" required></div><button type="submit" class="btn btn-primary">Login</button></form>
      <form id="otpForm" style="display: none;"><div id="otpSendSection"><button type="button" onclick="sendOTP()" class="btn btn-primary">ğŸ“§ Send OTP</button></div><div id="otpVerifySection" style="display: none;"><div class="form-group"><label>Enter OTP *</label><input type="text" id="otpCode" required></div><button type="submit" class="btn btn-primary">Verify</button></div></form>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection" style="display: none;">
      <header><div><h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent Portal</h1></div><button onclick="logout()" class="btn btn-danger btn-sm">Logout</button></header>

      <div id="studentSelector">
        <h3>ğŸ‘‹ Welcome! Select a child:</h3>
        <select id="childSelect" style="max-width: 300px; margin: 10px auto; padding: 10px;"><option value="">Select Child...</option></select>
      </div>

      <div class="info-card">
        <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ‘¤ Student Information</h2>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
          <div><strong>Name:</strong> <span id="displayName">-</span></div>
          <div><strong>Grade:</strong> <span id="displayGrade">-</span></div>
          <div><strong>Total Sessions:</strong> <span id="displayTotal">-</span></div>
          <div><strong>Remaining:</strong> <span id="displayRemaining" style="color: #e53e3e;">-</span></div>
        </div>
      </div>

      <div id="makeupCreditCard" class="makeup-card" style="display: none;">
        <h3>ğŸ Makeup Credits Available</h3>
        <div style="font-size: 2rem; font-weight: bold;" id="makeupCount">0</div>
        <p style="opacity: 0.9;">Contact your teacher to schedule makeup classes</p>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('upcoming', event)">ğŸ“… Upcoming</button>
        <button class="tab-btn" onclick="showTab('past', event)">ğŸ“š Past Classes</button>
        <button class="tab-btn" onclick="showTab('homework', event)">ğŸ“ Homework</button>
        <button class="tab-btn" onclick="showTab('events', event)">ğŸ‰ Events</button>
      </div>

      <div id="upcomingTab" class="tab-content active">
        <div class="section">
          <h2>ğŸš« Cancel Class</h2>
          <p style="color: #718096; margin-bottom: 20px;">Note: Cannot cancel less than 2 hours before class.</p>
          <form id="cancelClassForm">
            <div class="form-group"><label>Select Class</label><select id="cancelClassSelect" required></select></div>
            <button type="submit" class="btn btn-danger">Cancel Class</button>
          </form>
        </div>
        <div class="section">
          <h2>ğŸ“… Schedule</h2>
          <table id="upcomingTable">
            <thead><tr><th>Session #</th><th>Date</th><th>Time</th><th>Join</th></tr></thead>
            <tbody id="upcomingBody"><tr><td colspan="4">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="pastTab" class="tab-content">
        <div class="section"><h2>ğŸ“š Completed Classes</h2><table id="pastTable"><thead><tr><th>Session #</th><th>Date</th><th>Time</th><th>Attendance</th><th>Materials</th></tr></thead><tbody id="pastBody"><tr><td colspan="5">Loading...</td></tr></tbody></table></div>
      </div>

      <div id="homeworkTab" class="tab-content">
        <div class="section"><h2>ğŸ“¤ Upload Homework</h2><form id="uploadHomeworkForm"><div class="form-group"><label>Select Session *</label><select id="homeworkSessionSelect" required><option value="">Loading...</option></select></div><div class="form-group"><label>File *</label><input type="file" id="homeworkFile" required accept=".pdf,.doc,.docx,.jpg,.png"></div><button type="submit" class="btn btn-primary">Upload</button></form></div>
      </div>

      <div id="eventsTab" class="tab-content">
        <div class="section"><h2>ğŸ‰ Events</h2><div id="eventsContainer">Loading...</div></div>
      </div>
    </div>
  </div>

  <script>
    let currentStudent = null;
    let allMyStudents = [];

    const adminToken = sessionStorage.getItem('adminParentToken');
    function authHeaders() {
      return adminToken ? { 'x-admin-token': adminToken } : {};
    }

    function toLocalTime(dateStr, timeStr, tz) {
      try {
        if (!dateStr || !timeStr) {
          console.error('Missing date or time:', dateStr, timeStr);
          return { date: 'Invalid Date', time: 'Invalid Time' };
        }

        // Handle date format
        const cleanDate = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;

        // Handle time format - ensure it has seconds
        let cleanTime = timeStr.trim();
        if (cleanTime.length === 5) cleanTime += ':00';
        if (cleanTime.length === 8 && !cleanTime.includes('.')) {
          // Time is in HH:MM:SS format
        } else if (cleanTime.includes('.')) {
          // Time has microseconds, truncate them
          cleanTime = cleanTime.split('.')[0];
        }

        // Create UTC ISO string
        const isoString = `${cleanDate}T${cleanTime}Z`;
        const utcDate = new Date(isoString);

        if (isNaN(utcDate.getTime())) {
          console.error('Invalid date created:', isoString);
          return { date: cleanDate, time: cleanTime };
        }

        // Convert to local timezone
        const localDate = utcDate.toLocaleDateString('en-US', {
          timeZone: tz || 'Asia/Kolkata',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        const localTime = utcDate.toLocaleTimeString('en-US', {
          timeZone: tz || 'Asia/Kolkata',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        return { date: localDate, time: localTime };
      } catch(e) {
        console.error('Error in toLocalTime:', e, 'Date:', dateStr, 'Time:', timeStr);
        return { date: dateStr, time: timeStr };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (adminToken) {
        fetch('/api/parent/admin-view', { headers: authHeaders() })
        .then(res => {
          if (!res.ok) throw new Error('Invalid Token');
          return res.json();
        })
        .then(data => {
          currentStudent = data.student;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('dashboardSection').style.display = 'block';
          showDashboard();
        })
        .catch(() => {
          sessionStorage.removeItem('adminParentToken');
          location.reload();
        });
        return;
      }
      setupLoginHandlers();
    });

    function setupLoginHandlers() {
      document.getElementById('emailForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        try {
          const res = await fetch('/api/parent/check-email', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || 'Email not found');
            return;
          }
          document.getElementById('emailForm').style.display = 'none';
          if (data.hasPassword) document.getElementById('passwordForm').style.display = 'block';
          else document.getElementById('otpForm').style.display = 'block';
        } catch (err) { alert('Error checking email'); }
      });

      document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const pwd = document.getElementById('loginPassword').value;
        try {
          const res = await fetch('/api/parent/login-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd }) });
          const data = await res.json();
          if (res.ok) handleMultipleStudents(data.students);
          else alert(data.error);
        } catch (err) { alert('Login error'); }
      });

      document.getElementById('otpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const otp = document.getElementById('otpCode').value;
        try {
          const res = await fetch('/api/parent/verify-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, otp }) });
          const data = await res.json();
          if (res.ok) handleMultipleStudents(data.students);
          else alert(data.error);
        } catch (err) { alert('OTP verification error'); }
      });
    }

    function handleMultipleStudents(students) {
      allMyStudents = students;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';

      if (students.length > 1) {
        document.getElementById('studentSelector').style.display = 'block';
        const sel = document.getElementById('childSelect');
        sel.innerHTML = '<option value="">Select Child...</option>' + students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
        sel.addEventListener('change', (e) => {
          const s = students.find(st => st.id == e.target.value);
          if (s) {
            currentStudent = s;
            document.getElementById('studentSelector').style.display = 'none';
            showDashboard();
          }
        });
      } else {
        currentStudent = students[0];
        showDashboard();
      }
    }

    async function sendOTP() {
      const email = document.getElementById('parentEmail').value.trim();
      try {
        await fetch('/api/parent/send-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        document.getElementById('otpSendSection').style.display = 'none';
        document.getElementById('otpVerifySection').style.display = 'block';
        alert('OTP sent to your email');
      } catch(e) {
        alert('Error sending OTP');
      }
    }

    function showTab(name, e) {
      if(e) e.stopPropagation();
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(name+'Tab').classList.add('active');
      if(e) e.target.classList.add('active');
      if(name === 'homework') loadHomeworkSessions();
      if(name === 'events') loadEvents();
    }

    function showDashboard() {
      document.getElementById('displayName').textContent = currentStudent.name;
      document.getElementById('displayGrade').textContent = currentStudent.grade;
      document.getElementById('displayTotal').textContent = currentStudent.total_sessions;
      document.getElementById('displayRemaining').textContent = currentStudent.remaining_sessions;
      loadMakeupCredits();
      loadUpcoming();
      loadPast();
      loadCancelDropdown();
    }

    async function loadMakeupCredits() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/makeup-credits`, { headers: authHeaders() });
        const credits = await res.json();
        const count = credits.length || 0;

        if (count > 0) {
          document.getElementById('makeupCreditCard').style.display = 'block';
          document.getElementById('makeupCount').textContent = count;
        } else {
          document.getElementById('makeupCreditCard').style.display = 'none';
        }
      } catch(e) {
        console.error('Error loading makeup credits:', e);
      }
    }

    async function loadUpcoming() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date >= today && !['Cancelled', 'Completed', 'Missed'].includes(s.status);
        });

        const tbody = document.getElementById('upcomingBody');

        if (upcoming.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #718096;">No upcoming classes scheduled</td></tr>';
          return;
        }

        tbody.innerHTML = upcoming.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          const zoomLink = s.zoom_link || 'https://zoom.us';
          return `<tr>
            <td>#${s.session_number}</td>
            <td>${t.date}</td>
            <td><strong style="color:#667eea">${t.time}</strong></td>
            <td><a href="${zoomLink}" target="_blank" class="btn-zoom">ğŸ¥ Join Zoom</a></td>
          </tr>`;
        }).join('');
      } catch(e) {
        console.error('Error loading upcoming:', e);
        document.getElementById('upcomingBody').innerHTML = '<tr><td colspan="4">Error loading sessions</td></tr>';
      }
    }

    async function loadPast() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const past = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date < today || ['Completed', 'Missed'].includes(s.status);
        });

        const tbody = document.getElementById('pastBody');

        if (past.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">No past classes</td></tr>';
          return;
        }

        tbody.innerHTML = past.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          return `<tr><td>#${s.session_number}</td><td>${t.date}</td><td>${t.time}</td><td>${s.status||'-'}</td><td>${s.ppt_file_path?'ğŸ“Š':''} ${s.recording_file_path?'ğŸ¥':''} ${s.homework_file_path?'ğŸ“':''}</td></tr>`;
        }).join('');
      } catch(e) {
        console.error('Error loading past:', e);
      }
    }

    async function loadHomeworkSessions() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const completed = sessions.filter(s => s.status === 'Completed');
        const sel = document.getElementById('homeworkSessionSelect');

        if (completed.length === 0) {
          sel.innerHTML = '<option value="">No completed sessions yet</option>';
          return;
        }

        sel.innerHTML = '<option value="">Select Session...</option>' + completed.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          return `<option value="${s.id}">Session #${s.session_number} - ${t.date}</option>`;
        }).join('');
      } catch(e) {
        console.error('Error loading homework sessions:', e);
      }
    }

    async function loadCancelDropdown() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date >= today && (s.status === 'Pending' || s.status === 'Scheduled');
        });

        const sel = document.getElementById('cancelClassSelect');

        if (upcoming.length === 0) {
           sel.innerHTML = '<option>No cancellable classes</option>';
           return;
        }

        sel.innerHTML = '<option value="">Select Class...</option>' + upcoming.map(s => {
            const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
            return `<option value="${s.id}">Session #${s.session_number} - ${t.date} at ${t.time}</option>`;
        }).join('');
      } catch(e) {
        console.error('Error loading cancel dropdown:', e);
      }
    }

    document.getElementById('cancelClassForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sid = document.getElementById('cancelClassSelect').value;
      if(!sid) return alert('Please select a class to cancel');

      if (!confirm('Are you sure you want to cancel this class? You will receive a makeup credit.')) return;

      try {
        const res = await fetch('/api/parent/cancel-class', {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type':'application/json'},
          body: JSON.stringify({ student_id: currentStudent.id, session_id: sid })
        });

        const data = await res.json();

        if(res.ok) {
          alert(data.message || 'Class cancelled successfully! Makeup credit added.');
          loadUpcoming();
          loadCancelDropdown();
          loadMakeupCredits();
        } else {
          alert(data.error || 'Cannot cancel this class');
        }
      } catch(e) {
        console.error('Cancel error:', e);
        alert('Error cancelling class');
      }
    });

    document.getElementById('uploadHomeworkForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sid = document.getElementById('homeworkSessionSelect').value;
      const file = document.getElementById('homeworkFile').files[0];
      if(!sid || !file) return alert('Please fill all fields');

      const fd = new FormData();
      fd.append('file', file);
      fd.append('sessionId', sid);
      fd.append('uploadType', 'homework');

      try {
        const res = await fetch(`/api/upload/homework/${currentStudent.id}`, {
          method: 'POST',
          headers: authHeaders(),
          body: fd
        });

        if(res.ok) {
          alert('Homework uploaded successfully!');
          e.target.reset();
        } else {
          alert('Error uploading homework');
        }
      } catch(e) {
        console.error('Upload error:', e);
        alert('Error uploading homework');
      }
    });

    async function loadEvents() {
      try {
        const res = await fetch(`/api/events/student/${currentStudent.id}`, { headers: authHeaders() });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const events = await res.json();
        const container = document.getElementById('eventsContainer');

        if (events.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No upcoming events</p>';
          return;
        }

        container.innerHTML = events.map(e => {
          const t = toLocalTime(e.event_date, e.event_time, currentStudent.timezone);
          return `
          <div style="background:white; border:1px solid #ddd; padding:15px; margin-bottom:10px; border-radius:8px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">${e.event_name}</h3>
            <p style="margin-bottom: 10px;">${e.event_description || ''}</p>
            <p><strong>ğŸ“… Date:</strong> ${t.date} | <strong>ğŸ• Time:</strong> ${t.time}</p>
            ${!e.is_registered ? `<button onclick="registerEvent(${e.id})" class="btn btn-primary" style="margin-top:10px; width: auto; padding: 10px 20px;">Register Now</button>` : '<span style="color:green; font-weight: bold;">âœ“ Registered</span>'}
          </div>`;
        }).join('');
      } catch(e) {
        console.error('Error loading events:', e);
        document.getElementById('eventsContainer').innerHTML = '<p style="color: #e53e3e; text-align: center; padding: 20px;">Error loading events. Please try again later.</p>';
      }
    }

    async function registerEvent(eid) {
      try {
        const res = await fetch(`/api/events/${eid}/register`, {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type':'application/json'},
          body: JSON.stringify({ student_id: currentStudent.id })
        });

        const data = await res.json();

        if(res.ok) {
          alert(data.message || 'Successfully registered for event!');
          loadEvents();
        } else {
          alert(data.error || 'Registration failed');
        }
      } catch(e) {
        console.error('Registration error:', e);
        alert('Error registering for event');
      }
    }

    function logout() {
      if(confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('adminParentToken');
        sessionStorage.removeItem('parentViewStudent');
        sessionStorage.removeItem('parentViewMode');
        location.reload();
      }
    }
  </script>
</body>
</html>
