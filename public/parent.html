<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Portal - Fluent Feathers Academy By Aaliya</title>
  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
  /* Base styles */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f0f4f8;
    color: #2d3748;
  }

  /* Loading Screen Styles */
  #serverLoadingScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%);
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .spinner {
    border: 4px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top: 4px solid white;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-top: 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { color: #B05D9E; font-size: 24px; }
    .login-section { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 500px; margin: 50px auto; text-align: center; }
    .info-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 5px solid #B05D9E; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 12px 20px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: #B05D9E; color: white; border-color: #B05D9E; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #B05D9E; color: white; }
    .btn-primary:hover { background: #9A4D88; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .btn-meet { background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; display: inline-block; }
    .btn-meet:hover { background: linear-gradient(135deg, #319795 0%, #285e61 100%); }
    .btn-download { background: #B05D9E; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; display: inline-block; margin: 2px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; color: #4a5568; font-weight: 600; }
    #studentSelector { margin-bottom: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; text-align: center; display: none; }
    .makeup-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .makeup-card h3 { margin-bottom: 10px; }

    /* Badges - Golden & Catchy Design */
    .badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; }
    .badge-card {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      border: 3px solid #FFD700;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .badge-card::before {
      content: '‚≠ê';
      position: absolute;
      top: -20px;
      right: -20px;
      font-size: 80px;
      opacity: 0.2;
    }
    .badge-card:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 30px rgba(255, 215, 0, 0.6);
    }
    .badge-icon { font-size: 48px; margin-bottom: 10px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3)); }
    .badge-name { font-size: 16px; font-weight: bold; color: #2d3748; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(255,255,255,0.5); }
    .badge-desc { font-size: 12px; color: #4a5568; background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; }
    .badge-date { font-size: 11px; color: #2d3748; margin-top: 5px; font-style: italic; }

    /* Feedback Modal */
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
    .modal-header h2 { color: #B05D9E; font-size: 24px; }
    .close-modal { background: #e53e3e; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .star-rating { display: flex; justify-content: center; gap: 10px; font-size: 48px; margin: 20px 0; }
    .star { cursor: pointer; color: #ddd; transition: all 0.2s; }
    .star.active, .star:hover { color: #FFD700; transform: scale(1.2); }
    .payment-history-item { background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #B05D9E; margin-bottom: 15px; }
    .payment-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

    /* Certificate Star Animation */
    @keyframes twinkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
<div id="serverLoadingScreen">
  <div style="text-align:center; color:white;">
    <img id="loadingLogo" src="/logo.png" alt="Fluent Feathers" height="100"
     onerror="this.outerHTML='üéì'">
    <h1>Welcome to Fluent Feathers Academy By Aaliya</h1>
    <p id="loadingMessage">Preparing your learning portal...</p>
    <div class="spinner"></div>
  </div>
</div>

  <div class="container">
    <!-- LOGIN SECTION -->
    <div id="loginSection" class="login-section">
      <h1 style="color: #B05D9E; margin-bottom: 20px;">üîê Parent Login</h1>
      <form id="emailForm"><div class="form-group"><label>Parent Email *</label><input type="email" id="parentEmail" required></div><button type="submit" class="btn btn-primary">Continue</button></form>

      <!-- First Time User - Create Password -->
      <div id="firstTimeUserSection" style="display: none; margin-top: 20px;">
        <div style="background: #e6fffa; border: 2px solid #38b2ac; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p style="color: #2c7a7b; margin: 0; font-weight: 600;">üëã Welcome! This is your first login.</p>
          <p style="color: #4a5568; margin: 5px 0 0; font-size: 14px;">Please create a password to access your account.</p>
        </div>
        <form id="setupPasswordForm">
          <div class="form-group"><label>Create Password *</label><input type="password" id="newPassword" required minlength="6" placeholder="At least 6 characters"></div>
          <div class="form-group"><label>Confirm Password *</label><input type="password" id="confirmPassword" required minlength="6"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Create Password & Login</button>
        </form>
        <p style="margin-top: 15px; color: #718096; font-size: 14px; text-align: center;">
          Or <a href="#" onclick="showOTPLogin(); return false;" style="color: #B05D9E;">login with OTP</a> instead
        </p>
      </div>

      <!-- Existing User - Login Options -->
      <div id="existingUserSection" style="display: none; margin-top: 20px;">
        <p style="color: #4a5568; margin-bottom: 15px; text-align: center;">Welcome back! Choose how to login:</p>
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
          <button type="button" onclick="showPasswordLogin()" class="btn btn-primary">üîë Use Password</button>
          <button type="button" onclick="showOTPLogin()" class="btn" style="background: #38b2ac; color: white;">üìß Use OTP</button>
        </div>
      </div>

      <!-- Password Login Form -->
      <form id="passwordForm" style="display: none; margin-top: 20px;">
        <div class="form-group"><label>Password *</label><input type="password" id="loginPassword" required></div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
        <div style="margin-top: 15px; text-align: center;">
          <a href="#" onclick="showForgotPassword(); return false;" style="color: #e53e3e; font-size: 14px;">Forgot Password?</a>
          <span style="color: #cbd5e0; margin: 0 10px;">|</span>
          <a href="#" onclick="showOTPLogin(); return false;" style="color: #B05D9E; font-size: 14px;">Login with OTP</a>
        </div>
      </form>

      <!-- Forgot Password Section -->
      <div id="forgotPasswordSection" style="display: none; margin-top: 20px;">
        <div style="background: #fef5e7; border: 2px solid #f6ad55; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p style="color: #c05621; margin: 0; font-weight: 600;">üîÑ Reset Your Password</p>
          <p style="color: #4a5568; margin: 5px 0 0; font-size: 14px;">We'll send an OTP to verify your identity, then you can set a new password.</p>
        </div>
        <div id="forgotOtpSendSection">
          <button type="button" onclick="sendForgotPasswordOTP()" class="btn btn-primary" style="width: 100%;">üìß Send Reset OTP</button>
        </div>
        <div id="forgotOtpVerifySection" style="display: none;">
          <div class="form-group"><label>Enter OTP *</label><input type="text" id="forgotOtpCode" required maxlength="6" pattern="[0-9]{6}" placeholder="Enter 6-digit OTP"></div>
          <button type="button" onclick="verifyForgotOTP()" class="btn btn-primary" style="width: 100%;">Verify OTP</button>
        </div>
        <div id="newPasswordSection" style="display: none;">
          <div class="form-group"><label>New Password *</label><input type="password" id="resetNewPassword" required minlength="6"></div>
          <div class="form-group"><label>Confirm New Password *</label><input type="password" id="resetConfirmPassword" required minlength="6"></div>
          <button type="button" onclick="resetPassword()" class="btn btn-primary" style="width: 100%;">Reset Password & Login</button>
        </div>
        <p style="margin-top: 15px; color: #718096; font-size: 14px; text-align: center;">
          <a href="#" onclick="backToLoginOptions(); return false;" style="color: #B05D9E;">‚Üê Back to Login</a>
        </p>
      </div>

      <!-- OTP Login Form -->
      <form id="otpForm" style="display: none; margin-top: 20px;">
        <div id="otpSendSection">
          <p style="color: #4a5568; margin-bottom: 15px;">We'll send a 6-digit OTP to your email</p>
          <button type="button" onclick="sendOTP()" class="btn btn-primary" style="width: 100%;">üìß Send OTP</button>
        </div>
        <div id="otpVerifySection" style="display: none;">
          <div class="form-group"><label>Enter OTP *</label><input type="text" id="otpCode" required maxlength="6" pattern="[0-9]{6}" placeholder="Enter 6-digit OTP"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Verify OTP</button>
          <p style="margin-top: 10px; color: #718096; font-size: 14px; text-align: center;">
            <a href="#" onclick="sendOTP(); return false;" style="color: #B05D9E;">Resend OTP</a>
          </p>
        </div>
        <p style="margin-top: 15px; color: #718096; font-size: 14px; text-align: center;">
          <a href="#" onclick="backToLoginOptions(); return false;" style="color: #B05D9E;">‚Üê Back to Login Options</a>
        </p>
      </form>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection" style="display: none;">
      <header>
        <div style="display: flex; align-items: center; gap: 15px;">
          <img id="headerLogo" src="/logo.png" alt="Fluent Feathers" style="height: 50px;">
          <div>
            <h1 style="margin: 0; font-size: 24px;">Fluent Feathers Academy By Aaliya</h1>
            <p style="margin: 5px 0 0; color: #718096; font-size: 12px; font-weight: 500;">Empowering Young Minds Through Language & Communication</p>
          </div>
        </div>
        <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
      </header>

      <div id="studentSelector">
        <h3>üëã Welcome! Select a child:</h3>
        <select id="childSelect" style="max-width: 300px; margin: 10px auto; padding: 10px;"><option value="">Select Child...</option></select>
      </div>

      <div class="info-card">
        <h2 style="color: #B05D9E; margin-bottom: 15px;">üë§ Student Information</h2>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
          <div><strong>Name:</strong> <span id="displayName">-</span></div>
          <div><strong>Grade:</strong> <span id="displayGrade">-</span></div>
          <div><strong>Total Sessions:</strong> <span id="displayTotal">-</span></div>
          <div><strong>Remaining:</strong> <span id="displayRemaining" style="color: #e53e3e;">-</span></div>
        </div>
      </div>

      <div id="makeupCreditCard" class="makeup-card" style="display: none;">
        <h3>üéÅ Makeup Credits Available</h3>
        <div style="font-size: 2rem; font-weight: bold;" id="makeupCount">0</div>
        <p style="opacity: 0.9;">Contact your teacher to schedule makeup classes</p>
      </div>

      <!-- Badges Section -->
      <div class="section">
        <h2 style="color: #B05D9E; margin-bottom: 10px;">üèÜ Achievement Badges</h2>
        <p style="color: #718096; margin-bottom: 15px;">Keep learning to unlock more badges!</p>
        <div id="badgesContainer" class="badges-grid">
          <p style="text-align: center; color: #718096;">Loading badges...</p>
        </div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('upcoming', event)">üìÖ Upcoming</button>
        <button class="tab-btn" onclick="showTab('past', event)">üìö Past Classes</button>
        <button class="tab-btn" onclick="showTab('homework', event)">üìù Homework</button>
        <button class="tab-btn" onclick="showTab('payments', event)">üí≥ Payments</button>
        <button class="tab-btn" onclick="showTab('assessments', event)">üìä Report Cards</button>
        <button class="tab-btn" onclick="showTab('announcements', event)">üì¢ News</button>
        <button class="tab-btn" onclick="showTab('events', event)">üéâ Events</button>
      </div>

      <div id="upcomingTab" class="tab-content active">
        <div class="section">
          <h2>üö´ Cancel Class</h2>
          <p style="color: #718096; margin-bottom: 20px;">Note: Cannot cancel less than 1 hour before class.</p>
          <form id="cancelClassForm">
            <div class="form-group"><label>Select Class</label><select id="cancelClassSelect" required></select></div>
            <button type="submit" class="btn btn-danger">Cancel Class</button>
          </form>
        </div>
        <div class="section">
          <h2>üìÖ Schedule</h2>
          <table id="upcomingTable">
            <thead><tr><th>Session #</th><th>Date</th><th>Time</th><th>Join</th></tr></thead>
            <tbody id="upcomingBody"><tr><td colspan="4">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="pastTab" class="tab-content">
        <div class="section">
          <h2>üìö Completed Classes</h2>
          <table id="pastTable">
            <thead><tr><th>Session #</th><th>Date</th><th>Time</th><th>Attendance</th><th>Materials</th><th>Homework</th><th>Feedback</th></tr></thead>
            <tbody id="pastBody"><tr><td colspan="7">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="homeworkTab" class="tab-content">
        <div class="section">
          <h2>üì§ Upload Homework</h2>
          <form id="uploadHomeworkForm">
            <div class="form-group">
              <label>Select Session *</label>
              <select id="homeworkSessionSelect" required><option value="">Loading...</option></select>
            </div>
            <div class="form-group">
              <label>Files * (Select multiple files at once)</label>
              <input type="file" id="homeworkFile" required multiple>
              <p style="color: #718096; font-size: 0.85rem; margin-top: 5px;">
                Upload any file type: Images, Videos, PDFs, Documents, Presentations, Audio, etc. - Max 100MB per file. You can select multiple files.
              </p>
            </div>
            <button type="submit" class="btn btn-primary">üì§ Upload Homework</button>
          </form>

          <h3 style="margin-top: 30px; color: #B05D9E;">üìö My Submitted Homework</h3>
          <div id="submittedHomeworkList" style="margin-top: 15px;">
            <p style="color: #718096;">Loading your submissions...</p>
          </div>
        </div>
      </div>

      <div id="paymentsTab" class="tab-content">
        <div class="section">
          <h2>üí≥ Payment Information</h2>
          <div class="payment-grid" style="margin-bottom: 20px;">
            <div><strong>Initial Payment:</strong> <span id="displayInitialPayment">-</span></div>
            <div><strong>Total Paid:</strong> <span id="displayTotalPaid" style="color: #38a169;">-</span></div>
            <div><strong>Payment Method:</strong> <span id="displayPaymentMethod">-</span></div>
            <div><strong>Currency:</strong> <span id="displayCurrency">-</span></div>
          </div>
          <h3 style="margin-top: 30px; margin-bottom: 15px;">üìã Payment History</h3>
          <div id="paymentHistoryContainer">
            <p style="text-align: center; color: #718096;">Loading payment history...</p>
          </div>
        </div>
      </div>

      <div id="assessmentsTab" class="tab-content">
        <div class="section">
          <h2>üìä Monthly Report Cards</h2>
          <div id="assessmentsContainer">
            <p style="text-align: center; color: #718096;">Loading report cards...</p>
          </div>
        </div>
      </div>

      <div id="announcementsTab" class="tab-content">
        <div class="section">
          <h2>üì¢ Latest News & Announcements</h2>
          <div id="announcementsContainer">
            <p style="text-align: center; color: #718096;">Loading announcements...</p>
          </div>
        </div>
      </div>

      <div id="eventsTab" class="tab-content">
        <div class="section"><h2>üéâ Events</h2><div id="eventsContainer">Loading...</div></div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚≠ê Rate Your Class</h2>
        <button class="close-modal" onclick="closeFeedbackModal()">‚úï</button>
      </div>
      <form id="feedbackForm">
        <input type="hidden" id="feedbackSessionId">
        <div style="text-align: center; margin-bottom: 20px;">
          <p style="font-size: 18px; color: #4a5568; margin-bottom: 15px;">How was Session #<span id="feedbackSessionNum"></span>?</p>
          <div class="star-rating" id="starRatingContainer" style="font-size: 2.5rem; cursor: pointer;">
            <span class="star" data-rating="1" onclick="setRating(1)">‚òÜ</span>
            <span class="star" data-rating="2" onclick="setRating(2)">‚òÜ</span>
            <span class="star" data-rating="3" onclick="setRating(3)">‚òÜ</span>
            <span class="star" data-rating="4" onclick="setRating(4)">‚òÜ</span>
            <span class="star" data-rating="5" onclick="setRating(5)">‚òÜ</span>
          </div>
        </div>
        <div class="form-group">
          <label>Comments (Optional)</label>
          <textarea id="feedbackTextArea" rows="3" placeholder="Share your thoughts..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Submit</button>
      </form>
    </div>
  </div>

  <script>

    // ==================== SERVER WAKE-UP LOADING SCREEN ====================
(function() {
  let serverReady = false;
  let checkAttempts = 0;
  const maxAttempts = 30; // 30 seconds maximum
  
  const loadingScreen = document.getElementById('serverLoadingScreen');
  const loadingMessage = document.getElementById('loadingMessage');
  
  const messages = [
    'Preparing your learning portal...',
    'Loading your classes...',
    'Setting up your dashboard...',
    'Almost ready...',
    'Just a moment more...'
  ];
  
  let messageIndex = 0;
  
  // Show loading screen immediately
  function showLoadingScreen() {
    loadingScreen.style.display = 'flex';
    
    // Rotate messages every 3 seconds
    const messageInterval = setInterval(() => {
      messageIndex = (messageIndex + 1) % messages.length;
      loadingMessage.textContent = messages[messageIndex];
    }, 3000);
    
    return messageInterval;
  }
  
  // Hide loading screen
  function hideLoadingScreen(messageInterval) {
    clearInterval(messageInterval);
    loadingScreen.style.opacity = '0';
    loadingScreen.style.transition = 'opacity 0.5s ease';
    setTimeout(() => {
      loadingScreen.style.display = 'none';
    }, 500);
  }
  
  // Check if server is ready
  async function checkServerHealth() {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
      
      const response = await fetch('/api/config', {
        signal: controller.signal,
        cache: 'no-store'
      });
      
      clearTimeout(timeoutId);
      
      if (response.ok) {
        serverReady = true;
        return true;
      }
      return false;
    } catch (error) {
      console.log('Server not ready yet, attempt', checkAttempts + 1);
      return false;
    }
  }
  
  // Main loading logic
  async function initializeApp() {
    const messageInterval = showLoadingScreen();
    
    // Check server health
    while (!serverReady && checkAttempts < maxAttempts) {
      checkAttempts++;
      const isReady = await checkServerHealth();
      
      if (isReady) {
        console.log('‚úÖ Server is ready!');
        hideLoadingScreen(messageInterval);
        break;
      }
      
      // Wait 1 second before next attempt
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    // If server didn't respond after max attempts, still hide loading screen
    // to let user see any error messages
    if (!serverReady) {
      console.warn('‚ö†Ô∏è Server may be slow to respond');
      hideLoadingScreen(messageInterval);
    }
  }
  
  // Start initialization when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
})();

    let currentStudent = null;
    let allMyStudents = [];
    let selectedRating = 0;
    let checkedFeedbackSessions = new Set();
    let appConfig = { logoUrl: '/logo.png' };

    // Load app configuration (logo URL from environment)
   async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    appConfig = await res.json();
    
    // Update header logo
    const headerLogo = document.getElementById('headerLogo');
    if (headerLogo && appConfig.logoUrl) {
      headerLogo.src = appConfig.logoUrl;
    }
    
    // Update loading screen logo
    const loadingLogo = document.getElementById('loadingLogo');
    if (loadingLogo && appConfig.logoUrl) {
      loadingLogo.src = appConfig.logoUrl;
    }
  } catch (e) {
    console.log('Using default config');
  }
}

    const adminToken = sessionStorage.getItem('adminParentToken');
    function authHeaders() {
      return adminToken ? { 'x-admin-token': adminToken } : {};
    }

    function toLocalTime(dateStr, timeStr, tz) {
      try {
        if (!dateStr || !timeStr) {
          console.error('Missing date or time:', dateStr, timeStr);
          return { date: 'Invalid Date', time: 'Invalid Time' };
        }

        const cleanDate = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
        let cleanTime = timeStr.trim();
        if (cleanTime.length === 5) cleanTime += ':00';
        if (cleanTime.includes('.')) cleanTime = cleanTime.split('.')[0];

        const isoString = `${cleanDate}T${cleanTime}Z`;
        const utcDate = new Date(isoString);

        if (isNaN(utcDate.getTime())) {
          console.error('Invalid date created:', isoString);
          return { date: cleanDate, time: cleanTime };
        }

        const localDate = utcDate.toLocaleDateString('en-US', {
          timeZone: tz || 'Asia/Kolkata',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        const localTime = utcDate.toLocaleTimeString('en-US', {
          timeZone: tz || 'Asia/Kolkata',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        return { date: localDate, time: localTime };
      } catch(e) {
        console.error('Error in toLocalTime:', e, 'Date:', dateStr, 'Time:', timeStr);
        return { date: dateStr, time: timeStr };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Load app configuration (logo URL)
      loadConfig();

      if (adminToken) {
        fetch('/api/parent/admin-view', { headers: authHeaders() })
        .then(res => {
          if (!res.ok) throw new Error('Invalid Token');
          return res.json();
        })
        .then(data => {
          currentStudent = data.student;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('dashboardSection').style.display = 'block';
          showDashboard();
        })
        .catch(() => {
          sessionStorage.removeItem('adminParentToken');
          location.reload();
        });
        return;
      }
      setupLoginHandlers();
    });

    let hasExistingPassword = false;
    let forgotPasswordOtpVerified = false;

    function setupLoginHandlers() {
      document.getElementById('emailForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        try {
          const res = await fetch('/api/parent/check-email', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || 'Email not found. Please contact your teacher.');
            return;
          }
          hasExistingPassword = data.hasPassword;
          document.getElementById('emailForm').style.display = 'none';

          // Show appropriate section based on whether user has password
          if (hasExistingPassword) {
            document.getElementById('existingUserSection').style.display = 'block';
          } else {
            document.getElementById('firstTimeUserSection').style.display = 'block';
          }
        } catch (err) { alert('Error checking email'); }
      });

      document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const pwd = document.getElementById('loginPassword').value;
        try {
          const res = await fetch('/api/parent/login-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd }) });
          const data = await res.json();
          if (res.ok) handleMultipleStudents(data.students);
          else alert(data.error || 'Invalid password');
        } catch (err) { alert('Login error'); }
      });

      document.getElementById('setupPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const pwd = document.getElementById('newPassword').value;
        const confirmPwd = document.getElementById('confirmPassword').value;

        if (pwd !== confirmPwd) {
          alert('Passwords do not match!');
          return;
        }
        if (pwd.length < 6) {
          alert('Password must be at least 6 characters!');
          return;
        }

        try {
          const res = await fetch('/api/parent/setup-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd }) });
          const data = await res.json();
          if (res.ok) {
            alert('Password created successfully! Welcome to Fluent Feathers Academy!');
            handleMultipleStudents(data.students);
          } else {
            alert(data.error);
          }
        } catch (err) { alert('Error creating password'); }
      });

      document.getElementById('otpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const otp = document.getElementById('otpCode').value;
        try {
          const res = await fetch('/api/parent/verify-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, otp }) });
          const data = await res.json();
          if (res.ok) handleMultipleStudents(data.students);
          else alert(data.error || 'Invalid OTP');
        } catch (err) { alert('OTP verification error'); }
      });
    }

    function hideAllLoginForms() {
      document.getElementById('firstTimeUserSection').style.display = 'none';
      document.getElementById('existingUserSection').style.display = 'none';
      document.getElementById('passwordForm').style.display = 'none';
      document.getElementById('forgotPasswordSection').style.display = 'none';
      document.getElementById('otpForm').style.display = 'none';
      document.getElementById('otpSendSection').style.display = 'block';
      document.getElementById('otpVerifySection').style.display = 'none';
      document.getElementById('forgotOtpSendSection').style.display = 'block';
      document.getElementById('forgotOtpVerifySection').style.display = 'none';
      document.getElementById('newPasswordSection').style.display = 'none';
    }

    function backToLoginOptions() {
      hideAllLoginForms();
      if (hasExistingPassword) {
        document.getElementById('existingUserSection').style.display = 'block';
      } else {
        document.getElementById('firstTimeUserSection').style.display = 'block';
      }
    }

    function showPasswordLogin() {
      hideAllLoginForms();
      document.getElementById('passwordForm').style.display = 'block';
    }

    function showOTPLogin() {
      hideAllLoginForms();
      document.getElementById('otpForm').style.display = 'block';
    }

    function showForgotPassword() {
      hideAllLoginForms();
      forgotPasswordOtpVerified = false;
      document.getElementById('forgotPasswordSection').style.display = 'block';
    }

    async function sendForgotPasswordOTP() {
      const email = document.getElementById('parentEmail').value.trim();
      try {
        const res = await fetch('/api/parent/send-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        const data = await res.json();
        if (res.ok) {
          alert('OTP sent to your email!');
          document.getElementById('forgotOtpSendSection').style.display = 'none';
          document.getElementById('forgotOtpVerifySection').style.display = 'block';
        } else {
          alert(data.error || 'Error sending OTP');
        }
      } catch(e) {
        alert('Error sending OTP');
      }
    }

    async function verifyForgotOTP() {
      const email = document.getElementById('parentEmail').value.trim();
      const otp = document.getElementById('forgotOtpCode').value;
      try {
        const res = await fetch('/api/parent/verify-reset-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, otp }) });
        const data = await res.json();
        if (res.ok) {
          forgotPasswordOtpVerified = true;
          document.getElementById('forgotOtpVerifySection').style.display = 'none';
          document.getElementById('newPasswordSection').style.display = 'block';
        } else {
          alert(data.error || 'Invalid OTP');
        }
      } catch(e) {
        alert('Error verifying OTP');
      }
    }

    async function resetPassword() {
      if (!forgotPasswordOtpVerified) {
        alert('Please verify OTP first');
        return;
      }

      const email = document.getElementById('parentEmail').value.trim();
      const pwd = document.getElementById('resetNewPassword').value;
      const confirmPwd = document.getElementById('resetConfirmPassword').value;

      if (pwd !== confirmPwd) {
        alert('Passwords do not match!');
        return;
      }
      if (pwd.length < 6) {
        alert('Password must be at least 6 characters!');
        return;
      }

      try {
        const res = await fetch('/api/parent/reset-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd }) });
        const data = await res.json();
        if (res.ok) {
          alert('Password reset successfully! Please login with your new password.');
          hideAllLoginForms();
          document.getElementById('existingUserSection').style.display = 'block';
          hasExistingPassword = true;
        } else {
          alert(data.error || 'Error resetting password');
        }
      } catch(e) {
        alert('Error resetting password');
      }
    }

    function handleMultipleStudents(students) {
      allMyStudents = students;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';

      if (students.length > 1) {
        document.getElementById('studentSelector').style.display = 'block';
        const sel = document.getElementById('childSelect');
        sel.innerHTML = '<option value="">Select Child...</option>' + students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
        sel.addEventListener('change', (e) => {
          const s = students.find(st => st.id == e.target.value);
          if (s) {
            currentStudent = s;
            document.getElementById('studentSelector').style.display = 'none';
            showDashboard();
          }
        });
      } else {
        currentStudent = students[0];
        showDashboard();
      }
    }

    async function sendOTP() {
      const email = document.getElementById('parentEmail').value.trim();
      try {
        await fetch('/api/parent/send-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        document.getElementById('otpSendSection').style.display = 'none';
        document.getElementById('otpVerifySection').style.display = 'block';
        alert('OTP sent to your email');
      } catch(e) {
        alert('Error sending OTP');
      }
    }

    function showTab(name, e) {
      if(e) e.stopPropagation();
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(name+'Tab').classList.add('active');
      if(e) e.target.classList.add('active');
      if(name === 'homework') loadHomeworkSessions();
      if(name === 'events') loadEvents();
      if(name === 'payments') loadPayments();
      if(name === 'assessments') loadAssessments();
      if(name === 'announcements') loadAnnouncements();
    }

    function showDashboard() {
      document.getElementById('displayName').textContent = currentStudent.name;
      document.getElementById('displayGrade').textContent = currentStudent.grade;
      document.getElementById('displayTotal').textContent = currentStudent.total_sessions;
      document.getElementById('displayRemaining').textContent = currentStudent.remaining_sessions;
      loadMakeupCredits();
      loadBadges();
      loadUpcoming();
      loadPast();
      loadCancelDropdown();
      checkForFeedback();
    }

    async function loadBadges() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/badges`, { headers: authHeaders() });
        const badges = await res.json();
        const container = document.getElementById('badgesContainer');

        if (badges.length === 0) {
          container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #718096; padding: 20px;">No badges earned yet. Attend classes and submit homework to unlock badges! üåü</p>';
        } else {
          container.innerHTML = badges.map(b => `
            <div class="badge-card">
              <div class="badge-icon">${b.badge_name.split(' ')[0]}</div>
              <div class="badge-name">${b.badge_name.substring(b.badge_name.indexOf(' ') + 1)}</div>
              <div class="badge-desc">${b.badge_description}</div>
              <div class="badge-date">Earned: ${new Date(b.earned_date).toLocaleDateString()}</div>
            </div>
          `).join('');
        }
      } catch(e) {
        console.error('Error loading badges:', e);
        document.getElementById('badgesContainer').innerHTML = '<p style="color: #e53e3e;">Error loading badges</p>';
      }
    }

    async function loadMakeupCredits() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/makeup-credits`, { headers: authHeaders() });
        const credits = await res.json();
        const count = credits.length || 0;

        if (count > 0) {
          document.getElementById('makeupCreditCard').style.display = 'block';
          document.getElementById('makeupCount').textContent = count;
        } else {
          document.getElementById('makeupCreditCard').style.display = 'none';
        }
      } catch(e) {
        console.error('Error loading makeup credits:', e);
      }
    }

    async function loadUpcoming() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date >= today && !['Cancelled', 'Completed', 'Missed'].includes(s.status);
        });

        const tbody = document.getElementById('upcomingBody');

        if (upcoming.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #718096;">No upcoming classes scheduled</td></tr>';
          return;
        }

        tbody.innerHTML = upcoming.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          // Get day name
          const dateStr = s.session_date.includes('T') ? s.session_date.split('T')[0] : s.session_date;
          const d = new Date(dateStr + 'T00:00:00');
          const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
          const meetLink = s.meet_link || 'https://meet.google.com/qne-muzw-wav';

          // Get class duration in minutes from session (default 40 mins if not specified)
          const durationMatch = s.duration ? s.duration.match(/(\d+)\s*mins?/) : null;
          const classDurationMins = durationMatch ? parseInt(durationMatch[1]) : 40;

          // Check if within join window: 5 mins before start until end of class
          const sessionDateTime = new Date(dateStr + 'T' + s.session_time + 'Z');
          const now = new Date();
          const diffMinutes = (sessionDateTime - now) / (1000 * 60);
          
          // Can join from 5 mins before until class duration after start (e.g., 40 mins for 40 min class)
          const canJoin = diffMinutes <= 5 && diffMinutes >= -(classDurationMins);

          const meetButton = canJoin
  ? `<a href="${meetLink}" target="_blank" class="btn-meet">üé• Join Meet</a>`
  : `<button onclick="alert('You can join from 5 minutes before class starts until the end of class (${classDurationMins} minutes). Please wait until then.')" class="btn-meet" style="background: #a0aec0; cursor: not-allowed;">üîí Join Meet</button>`;

          return `<tr>
            <td>#${s.session_number}</td>
            <td>${dayName}, ${t.date}</td>
            <td><strong style="color:#B05D9E">${t.time}</strong></td>
            <td>${meetButton}</td>
          </tr>`;
        }).join('');
      } catch(e) {
        console.error('Error loading upcoming:', e);
        document.getElementById('upcomingBody').innerHTML = '<tr><td colspan="4">Error loading sessions</td></tr>';
      }
    }

    async function loadPast() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const past = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date < today || ['Completed', 'Missed'].includes(s.status);
        });

        const tbody = document.getElementById('pastBody');

        if (past.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #718096;">No past classes</td></tr>';
          return;
        }

        tbody.innerHTML = past.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);

          // Helper to format material links/files properly
          function getMaterialLink(filePath, icon, label) {
            if (!filePath) return '';
            if (filePath.startsWith('LINK:')) {
              // External link
              const url = filePath.replace('LINK:', '');
              return `<a href="${url}" target="_blank" class="btn-download">${icon} ${label}</a>`;
            } else if (filePath.startsWith('https://') || filePath.startsWith('http://')) {
              // Cloudinary or external URL - use directly
              return `<a href="${filePath}" target="_blank" class="btn-download" download>${icon} ${label}</a>`;
            } else {
              // File upload - needs /uploads/materials/ prefix
              const fullPath = filePath.startsWith('/uploads/') ? filePath : '/uploads/materials/' + filePath;
              return `<a href="${fullPath}" target="_blank" class="btn-download" download>${icon} ${label}</a>`;
            }
          }

          let materials = '';
          materials += getMaterialLink(s.ppt_file_path, 'üìä', 'PPT');
          materials += getMaterialLink(s.recording_file_path, 'üé•', 'Recording');
          materials += getMaterialLink(s.homework_file_path, 'üìù', 'HW');
          if (!materials) materials = '-';

          let hwStatus = '-';
          if (s.homework_submission_path) {
            hwStatus = `<span style="color: #38a169;">‚úì Submitted</span>`;
            if (s.homework_grade) {
              hwStatus += `<br><span style="background:#38a169; color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem;">${s.homework_grade}</span>`;
            }
            if (s.homework_feedback) {
              hwStatus += `<br><small style="color:#4a5568; font-style:italic;">üí¨ ${s.homework_feedback}</small>`;
            }
          }

          // Feedback button - show if completed and not already given feedback
          let feedbackBtn = '-';
          if (s.status === 'Completed') {
            if (s.has_feedback) {
              feedbackBtn = `<span style="color:#38a169;">‚úì Given</span>`;
            } else {
              feedbackBtn = `<button onclick="openFeedbackModal(${s.id}, ${s.session_number})" style="background:#B05D9E; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.85rem;">‚≠ê Rate</button>`;
            }
          }

          // Convert status to attendance display
          let attendanceDisplay = '-';
          if (s.status === 'Completed') {
            attendanceDisplay = `<span style="color:#38a169; font-weight:600;">‚úì Present</span>`;
          } else if (s.status === 'Missed') {
            attendanceDisplay = `<span style="color:#e53e3e; font-weight:600;">‚úó Absent</span>`;
          } else if (s.status === 'Cancelled') {
            attendanceDisplay = `<span style="color:#718096;">Cancelled</span>`;
          } else {
            attendanceDisplay = s.status || '-';
          }

          return `<tr>
            <td>#${s.session_number}</td>
            <td>${t.date}</td>
            <td>${t.time}</td>
            <td>${attendanceDisplay}</td>
            <td>${materials}</td>
            <td>${hwStatus}</td>
            <td>${feedbackBtn}</td>
          </tr>`;
        }).join('');
      } catch(e) {
        console.error('Error loading past:', e);
      }
    }

    async function loadHomeworkSessions() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const completed = sessions.filter(s => s.status === 'Completed');
        const sel = document.getElementById('homeworkSessionSelect');

        if (completed.length === 0) {
          sel.innerHTML = '<option value="">No completed sessions yet</option>';
          return;
        }

        sel.innerHTML = '<option value="">Select Session...</option>' + completed.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          return `<option value="${s.id}">Session #${s.session_number} - ${t.date}</option>`;
        }).join('');

        // Also load submitted homework
        loadSubmittedHomework();
      } catch(e) {
        console.error('Error loading homework sessions:', e);
      }
    }

    async function loadSubmittedHomework() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/homework`, { headers: authHeaders() });
        const submissions = await res.json();
        const container = document.getElementById('submittedHomeworkList');

        if (!submissions || submissions.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No homework submitted yet. Upload your first homework above!</p>';
          return;
        }

        container.innerHTML = submissions.map(hw => {
          const fileExt = hw.file_name ? hw.file_name.split('.').pop().toLowerCase() : '';
          const fileIcon = ['mp4', 'mov', 'avi'].includes(fileExt) ? 'üé•' :
                          ['jpg', 'jpeg', 'png', 'gif'].includes(fileExt) ? 'üñºÔ∏è' :
                          ['pdf'].includes(fileExt) ? 'üìÑ' :
                          ['doc', 'docx'].includes(fileExt) ? 'üìù' :
                          ['ppt', 'pptx'].includes(fileExt) ? 'üìä' : 'üìÅ';

          const gradeDisplay = hw.feedback_grade
            ? `<span style="background: #38a169; color: white; padding: 3px 10px; border-radius: 4px; font-size: 0.85rem;">${hw.feedback_grade}</span>`
            : '<span style="color: #f6ad55; font-size: 0.85rem;">‚è≥ Pending Review</span>';

          const feedbackDisplay = hw.feedback_comments
            ? `<p style="color: #4a5568; font-size: 0.9rem; margin-top: 8px; padding: 10px; background: #f0fff4; border-radius: 6px;"><strong>Teacher's Feedback:</strong> ${hw.feedback_comments}</p>`
            : '';

          // Build proper file URL for viewing
          let fileUrl = '';
          let viewText = 'View';
          if (hw.file_path) {
            if (hw.file_path.startsWith('LINK:')) {
              fileUrl = hw.file_path.replace('LINK:', '');
              viewText = 'Open Link';
            } else if (hw.file_path.startsWith('https://') || hw.file_path.startsWith('http://')) {
              // Cloudinary or external URL - use directly
              fileUrl = hw.file_path;
            } else if (hw.file_path.startsWith('/uploads/')) {
              fileUrl = hw.file_path;
            } else if (/^\d+-\d+/.test(hw.file_path)) {
              // This is a Cloudinary public_id - construct the full URL
              // Use 'raw' for non-image files (pdf, docx, etc) and 'image' for images
              // Note: homework files go to fluentfeathers/homework folder in Cloudinary
              const isImageFile = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
              const resourceType = isImageFile ? 'image' : 'raw';
              const folder = hw.uploaded_by === 'Parent' ? 'homework' : 'materials';
              fileUrl = `https://res.cloudinary.com/divz4aavx/${resourceType}/upload/fluentfeathers/${folder}/${hw.file_path}`;
            } else {
              fileUrl = '/uploads/homework/' + hw.file_path;
            }
          }

          // For images, show preview
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
          const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(fileExt);

          let previewHtml = '';
          if (isImage && fileUrl) {
            previewHtml = `<img src="${fileUrl}" style="max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 8px; cursor: pointer;" onclick="window.open('${fileUrl}', '_blank')" onerror="this.style.display='none'">`;
          } else if (isVideo && fileUrl) {
            previewHtml = `<video controls style="max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 8px;"><source src="${fileUrl}" type="video/${fileExt}">Your browser does not support video.</video>`;
          }

          return `
            <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #B05D9E;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                  <strong style="color: #2d3748;">${fileIcon} Session #${hw.session_number || 'N/A'}</strong>
                  <p style="color: #718096; font-size: 0.85rem; margin: 5px 0;">
                    ${hw.file_name || 'File'} ‚Ä¢ Uploaded ${hw.uploaded_at ? new Date(hw.uploaded_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A'}
                  </p>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  ${gradeDisplay}
                  ${fileUrl ? `<a href="${fileUrl}" target="_blank" style="color: #B05D9E; font-size: 0.85rem;">${viewText}</a>` : ''}
                  ${fileUrl && !hw.file_path.startsWith('LINK:') ? `<a href="${fileUrl}" download style="color: #667eea; font-size: 0.85rem;">Download</a>` : ''}
                  <button onclick="deleteHomework(${hw.id})" style="background: #e53e3e; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Delete</button>
                </div>
              </div>
              ${feedbackDisplay}
              ${previewHtml}
            </div>
          `;
        }).join('');
      } catch(e) {
        console.error('Error loading submitted homework:', e);
        document.getElementById('submittedHomeworkList').innerHTML = '<p style="color: #e53e3e;">Error loading submissions</p>';
      }
    }

    async function loadCancelDropdown() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date >= today && (s.status === 'Pending' || s.status === 'Scheduled');
        });

        const sel = document.getElementById('cancelClassSelect');

        if (upcoming.length === 0) {
           sel.innerHTML = '<option>No cancellable classes</option>';
           return;
        }

        sel.innerHTML = '<option value="">Select Class...</option>' + upcoming.map(s => {
            const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
            return `<option value="${s.id}">Session #${s.session_number} - ${t.date} at ${t.time}</option>`;
        }).join('');
      } catch(e) {
        console.error('Error loading cancel dropdown:', e);
      }
    }

    async function loadPayments() {
      try {
        // Load initial payment info
        document.getElementById('displayInitialPayment').textContent = `${currentStudent.currency} ${currentStudent.fees_paid}`;
        document.getElementById('displayTotalPaid').textContent = `${currentStudent.currency} ${currentStudent.fees_paid}`;
        document.getElementById('displayPaymentMethod').textContent = currentStudent.payment_method || '-';
        document.getElementById('displayCurrency').textContent = currentStudent.currency;

        // Load payment renewals
        const res = await fetch(`/api/students/${currentStudent.id}/renewals`, { headers: authHeaders() });
        const renewals = await res.json();
        const container = document.getElementById('paymentHistoryContainer');

        if (renewals.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096;">No renewal payments yet</p>';
          return;
        }

        container.innerHTML = renewals.map(r => `
          <div class="payment-history-item">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: #B05D9E; font-size: 18px;">${r.currency} ${r.amount}</strong>
                <p style="color: #4a5568; margin-top: 5px;">+${r.sessions_added} sessions added</p>
                <p style="color: #718096; font-size: 0.9rem; margin-top: 5px;">Payment Method: ${r.payment_method || 'N/A'}</p>
                ${r.notes ? `<p style="color: #718096; font-size: 0.9rem; font-style: italic;">${r.notes}</p>` : ''}
              </div>
              <div style="text-align: right;">
                <span style="background: #38a169; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.85rem;">${r.status}</span>
                <p style="color: #718096; margin-top: 5px; font-size: 0.9rem;">${new Date(r.renewal_date).toLocaleDateString()}</p>
              </div>
            </div>
          </div>
        `).join('');
      } catch(e) {
        console.error('Error loading payments:', e);
        document.getElementById('paymentHistoryContainer').innerHTML = '<p style="color: #e53e3e;">Error loading payment history</p>';
      }
    }

    async function checkForFeedback() {
      // Only show feedback popup ONCE per login session - completely optional
      if (sessionStorage.getItem('feedbackPopupShown_' + currentStudent.id)) return;

      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();

        // Find the most recent completed session without feedback
        const needsFeedback = sessions.find(s => {
          if (s.status !== 'Completed') return false;
          if (s.has_feedback === true) return false;
          return true;
        });

        if (needsFeedback) {
          // Mark popup as shown for this student this session - won't bother them again
          sessionStorage.setItem('feedbackPopupShown_' + currentStudent.id, 'true');
          // Show the optional feedback popup
          openFeedbackModal(needsFeedback.id, needsFeedback.session_number);
        }
      } catch(e) {
        console.error('Error checking feedback:', e);
      }
    }

    // Legacy functions kept for compatibility
    function showFeedbackModal(session) {
      openFeedbackModal(session.id, session.session_number);
    }

    // Star rating interaction (for legacy support)
    document.addEventListener('DOMContentLoaded', () => {
      // No longer needed - using new star system
    });

    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (selectedRating === 0) {
        alert('Please select a star rating');
        return;
      }

      const sessionId = document.getElementById('feedbackSessionId').value;
      const feedbackText = document.getElementById('feedbackTextArea').value;

      try {
        const res = await fetch(`/api/sessions/${sessionId}/feedback`, {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type': 'application/json'},
          body: JSON.stringify({
            student_id: currentStudent.id,
            rating: selectedRating,
            feedback_text: feedbackText
          })
        });

        if (res.ok) {
          alert('Thank you for your feedback! üåü');
          closeFeedbackModal();
          loadBadges(); // Reload badges as feedback might award one
          loadPast(); // Refresh past classes to show feedback given
        } else {
          alert('Error submitting feedback');
        }
      } catch(e) {
        console.error('Feedback submission error:', e);
        alert('Error submitting feedback');
      }
    });

    document.getElementById('cancelClassForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sid = document.getElementById('cancelClassSelect').value;
      if(!sid) return alert('Please select a class to cancel');

      if (!confirm('Are you sure you want to cancel this class? You will receive a makeup credit.')) return;

      try {
        const res = await fetch('/api/parent/cancel-class', {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type':'application/json'},
          body: JSON.stringify({ student_id: currentStudent.id, session_id: sid })
        });

        const data = await res.json();

        if(res.ok) {
          alert(data.message || 'Class cancelled successfully! Makeup credit added.');
          loadUpcoming();
          loadCancelDropdown();
          loadMakeupCredits();
        } else {
          alert(data.error || 'Cannot cancel this class');
        }
      } catch(e) {
        console.error('Cancel error:', e);
        alert('Error cancelling class');
      }
    });

    document.getElementById('uploadHomeworkForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sid = document.getElementById('homeworkSessionSelect').value;
      const files = document.getElementById('homeworkFile').files;
      if(!sid || files.length === 0) return alert('Please select a session and at least one file');

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';

      let successCount = 0;
      let errorCount = 0;

      try {
        // Upload each file separately
        for (let i = 0; i < files.length; i++) {
          const fd = new FormData();
          fd.append('file', files[i]);
          fd.append('sessionId', sid);
          fd.append('uploadType', 'homework');

          try {
            const res = await fetch(`/api/upload/homework/${currentStudent.id}`, {
              method: 'POST',
              headers: authHeaders(),
              body: fd
            });

            if(res.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch(err) {
            errorCount++;
          }
        }

        if (successCount > 0) {
          alert(`‚úÖ ${successCount} file(s) uploaded successfully!${errorCount > 0 ? ` (${errorCount} failed)` : ''}`);
          e.target.reset();
          loadPast();
          loadBadges();
          loadSubmittedHomework();
        } else {
          alert('Error uploading files');
        }
      } catch(err) {
        console.error('Upload error:', err);
        alert('Error uploading homework');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üì§ Upload Homework';
      }
    });

    // Delete homework submission
    async function deleteHomework(homeworkId) {
      if (!confirm('Are you sure you want to delete this homework submission?')) return;

      try {
        const res = await fetch(`/api/homework/${homeworkId}`, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (res.ok) {
          alert('Homework deleted successfully!');
          loadSubmittedHomework();
          loadPast();
        } else {
          const data = await res.json();
          alert(data.error || 'Error deleting homework');
        }
      } catch (e) {
        console.error('Delete error:', e);
        alert('Error deleting homework');
      }
    }

    // ==================== CLASS FEEDBACK ====================
    function openFeedbackModal(sessionId, sessionNumber) {
      document.getElementById('feedbackSessionId').value = sessionId;
      document.getElementById('feedbackSessionNum').textContent = sessionNumber;
      selectedRating = 0;
      document.getElementById('feedbackTextArea').value = '';
      // Reset stars
      document.querySelectorAll('#starRatingContainer .star').forEach(s => s.textContent = '‚òÜ');
      document.getElementById('feedbackModal').classList.add('active');
    }

    function closeFeedbackModal() {
      document.getElementById('feedbackModal').classList.remove('active');
      selectedRating = 0;
    }

    function setRating(rating) {
      selectedRating = rating;
      document.querySelectorAll('#starRatingContainer .star').forEach(s => {
        const starNum = parseInt(s.getAttribute('data-rating'));
        s.textContent = starNum <= rating ? '‚≠ê' : '‚òÜ';
      });
    }

    async function loadEvents() {
      try {
        const res = await fetch(`/api/events/student/${currentStudent.id}`, { headers: authHeaders() });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const events = await res.json();
        const container = document.getElementById('eventsContainer');

        if (events.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No upcoming events</p>';
          return;
        }

        container.innerHTML = events.map(e => {
          const t = toLocalTime(e.event_date, e.event_time, currentStudent.timezone);
          return `
          <div style="background:white; border:1px solid #ddd; padding:15px; margin-bottom:10px; border-radius:8px;">
            <h3 style="color: #B05D9E; margin-bottom: 10px;">${e.event_name}</h3>
            <p style="margin-bottom: 10px;">${e.event_description || ''}</p>
            <p><strong>üìÖ Date:</strong> ${t.date} | <strong>üïê Time:</strong> ${t.time}</p>
            ${!e.is_registered ? `<button onclick="registerEvent(${e.id})" class="btn btn-primary" style="margin-top:10px; width: auto; padding: 10px 20px;">Register Now</button>` : '<span style="color:green; font-weight: bold;">‚úì Registered</span>'}
          </div>`;
        }).join('');
      } catch(e) {
        console.error('Error loading events:', e);
        document.getElementById('eventsContainer').innerHTML = '<p style="color: #e53e3e; text-align: center; padding: 20px;">Error loading events. Please try again later.</p>';
      }
    }

    async function registerEvent(eid) {
      try {
        const res = await fetch(`/api/events/${eid}/register`, {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type':'application/json'},
          body: JSON.stringify({ student_id: currentStudent.id })
        });

        const data = await res.json();

        if(res.ok) {
          alert(data.message || 'Successfully registered for event!');
          loadEvents();
        } else {
          alert(data.error || 'Registration failed');
        }
      } catch(e) {
        console.error('Registration error:', e);
        alert('Error registering for event');
      }
    }

    async function loadAssessments() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/assessments`, { headers: authHeaders() });
        const assessments = await res.json();
        const container = document.getElementById('assessmentsContainer');

        if (assessments.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No monthly assessments yet. Your teacher will share progress reports soon! üìä</p>';
          return;
        }

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        container.innerHTML = assessments.map(a => {
          const skills = a.skills ? JSON.parse(a.skills) : [];

          return `
          <div style="background: white; border: 1px solid #e2e8f0; padding: 25px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%); padding: 20px; margin: -25px -25px 20px -25px; border-radius: 12px 12px 0 0; text-align: center;">
              <div style="font-size: 40px; margin-bottom: 8px;">üìä</div>
              <h3 style="margin: 0; color: white; font-size: 22px;">Monthly Progress Report</h3>
              <p style="margin: 5px 0 0; color: rgba(255,255,255,0.95); font-size: 16px; font-weight: 600;">${monthNames[a.month - 1]} ${a.year}</p>
            </div>

            ${a.certificate_title ? `
            <!-- Colorful Kid-Friendly Certificate -->
            <div id="certificate-${a.id}" class="certificate-container" style="background: #ffffff; border-radius: 20px; padding: 0; margin-bottom: 20px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 650px; margin-left: auto; margin-right: auto; overflow: hidden; display: flex; min-height: 380px;">

              <!-- Left Decorative Panel (Pink/Magenta) -->
              <div style="width: 140px; background: linear-gradient(180deg, #e91e8c 0%, #d81b7a 50%, #c41569 100%); position: relative; flex-shrink: 0; display: flex; flex-direction: column; justify-content: space-between; padding: 15px 10px;">
                <!-- Top decorations -->
                <div style="text-align: center;">
                  <div style="font-size: 45px; margin-bottom: 5px;">üß∏</div>
                  <div style="font-size: 28px;">üéà</div>
                </div>

                <!-- Middle decorations -->
                <div style="text-align: center;">
                  <div style="font-size: 22px; margin-bottom: 8px;">‚≠ê</div>
                  <div style="font-size: 20px; margin-bottom: 8px;">üïê</div>
                  <div style="font-size: 22px;">‚úèÔ∏è</div>
                </div>

                <!-- Bottom decorations -->
                <div style="text-align: center;">
                  <div style="font-size: 18px; margin-bottom: 5px;">‚≠ê</div>
                  <div style="font-size: 25px;">üéÄ</div>
                </div>

                <!-- Scattered stars -->
                <div style="position: absolute; top: 25%; left: 15px; font-size: 14px; color: #fff;">‚ú¶</div>
                <div style="position: absolute; top: 45%; right: 12px; font-size: 12px; color: #fff;">‚ú¶</div>
                <div style="position: absolute; bottom: 25%; left: 18px; font-size: 16px; color: #fff;">‚ú¶</div>
              </div>

              <!-- Blue Wavy Border -->
              <div style="width: 25px; background: linear-gradient(180deg, #4fc3f7 0%, #29b6f6 50%, #03a9f4 100%); position: relative;">
                <svg style="position: absolute; right: -8px; top: 0; height: 100%; width: 15px;" viewBox="0 0 15 100" preserveAspectRatio="none">
                  <path d="M0,0 Q15,12.5 0,25 Q15,37.5 0,50 Q15,62.5 0,75 Q15,87.5 0,100 L15,100 L15,0 Z" fill="#fff"/>
                </svg>
              </div>

              <!-- Main Content Area (White) -->
              <div style="flex: 1; padding: 25px 30px; display: flex; flex-direction: column; justify-content: center; position: relative;">

                <!-- Top Right Star Decoration -->
                <div style="position: absolute; top: 15px; right: 20px; font-size: 28px; color: #ffd700;">‚≠ê</div>
                <div style="position: absolute; top: 45px; right: 45px; font-size: 18px; color: #ffd700;">‚≠ê</div>

                <!-- Certificate Title -->
                <div style="text-align: center; margin-bottom: 15px;">
                  <h1 style="margin: 0; color: #e91e8c; font-size: 28px; font-family: 'Comic Sans MS', cursive, sans-serif; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                    Certificate of Appreciation
                  </h1>
                </div>

                <!-- Blue Badge with Number -->
                <div style="text-align: center; margin: 10px 0;">
                  <div style="display: inline-block; width: 60px; height: 60px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); border-radius: 50%; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4); display: flex; align-items: center; justify-content: center; position: relative;">
                    <span style="color: white; font-size: 32px; font-weight: bold; font-family: 'Comic Sans MS', cursive;">1</span>
                    <!-- Ribbon tails -->
                    <div style="position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); width: 50px; height: 20px; overflow: hidden;">
                      <div style="width: 20px; height: 25px; background: #1976d2; position: absolute; left: 5px; transform: skewX(-15deg);"></div>
                      <div style="width: 20px; height: 25px; background: #2196f3; position: absolute; right: 5px; transform: skewX(15deg);"></div>
                    </div>
                  </div>
                </div>

                <!-- Award Type -->
                <div style="text-align: center; margin: 18px 0 10px;">
                  <span style="background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%); color: #5d4e00; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);">
                    üèÜ ${a.certificate_title}
                  </span>
                </div>

                <!-- Awarded To -->
                <div style="text-align: center; margin: 15px 0;">
                  <p style="margin: 0 0 5px; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">Proudly Presented To</p>
                  <h2 style="margin: 0; color: #e91e8c; font-size: 26px; font-family: 'Comic Sans MS', cursive, sans-serif; font-weight: bold;">
                    ${currentStudent.name}
                  </h2>
                </div>

                <!-- Achievement Text -->
                <div style="text-align: center; margin: 10px 0; padding: 10px 15px; background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-radius: 12px; border: 2px dashed #ffd700;">
                  <p style="margin: 0; color: #5d4e37; font-size: 13px; line-height: 1.5;">
                    For outstanding achievement & dedication<br>
                    <strong style="color: #e91e8c; font-size: 14px;">${monthNames[a.month - 1]} ${a.year}</strong>
                  </p>
                </div>

                <!-- Signature & Logo Row -->
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px; padding-top: 12px; border-top: 2px dotted #e91e8c;">
                  <div style="text-align: center;">
                    <p style="margin: 0; font-family: 'Brush Script MT', cursive; font-size: 20px; color: #333;">Aaliya Lokhandwala</p>
                    <p style="margin: 2px 0 0; color: #888; font-size: 10px; font-weight: 600;">Founder & Teacher</p>
                  </div>
                  <div style="text-align: center;">
                    <img src="${appConfig.logoUrl}" alt="Fluent Feathers" style="height: 40px;" onerror="this.outerHTML='<div style=\\'font-size:30px;\\'>üéì</div>'">
                    <p style="margin: 2px 0 0; color: #B05D9E; font-size: 9px; font-weight: 600;">Fluent Feathers Academy</p>
                  </div>
                </div>

                <!-- Certificate Number -->
                <div style="text-align: right; margin-top: 8px;">
                  <span style="color: #aaa; font-size: 8px; font-family: monospace;">Cert #FFA-${a.year}${String(a.month).padStart(2, '0')}-${String(a.id).padStart(4, '0')}</span>
                </div>
              </div>
            </div>

            <!-- Download Button -->
            <div style="text-align: center; margin-bottom: 15px;">
              <button onclick="downloadCertificate(${a.id}, '${currentStudent.name.replace(/'/g, "\\'")}', '${a.certificate_title.replace(/'/g, "\\'")}', '${monthNames[a.month - 1]}', ${a.year})"
                      style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">
                üì• Download Certificate
              </button>
            </div>
            ` : ''}

            ${skills.length > 0 ? `
            <!-- Skills -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 6px;">
                <span>üìù</span> Skills Assessed
              </h4>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${skills.map(skill => `
                <span style="background: #f7fafc; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #B05D9E; font-size: 12px; color: #4a5568; font-weight: 600;">
                  ‚úì ${skill}
                </span>
                `).join('')}
              </div>
            </div>
            ` : ''}

            ${a.performance_summary ? `
            <!-- Performance -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 10px; display: flex; align-items: center; gap: 6px;">
                <span>üìà</span> Performance Summary
              </h4>
              <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border-left: 3px solid #38b2ac;">
                <p style="margin: 0; color: #2d3748; font-size: 14px; line-height: 1.6;">${a.performance_summary}</p>
              </div>
            </div>
            ` : ''}

            ${a.areas_of_improvement ? `
            <!-- Improvement Areas -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 10px; display: flex; align-items: center; gap: 6px;">
                <span>üìå</span> Areas to Focus On
              </h4>
              <div style="background: #fff5f5; padding: 15px; border-radius: 8px; border-left: 3px solid #fc8181;">
                <p style="margin: 0; color: #2d3748; font-size: 14px; line-height: 1.6;">${a.areas_of_improvement}</p>
              </div>
            </div>
            ` : ''}

            ${a.teacher_comments ? `
            <!-- Teacher Comments -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 10px; display: flex; align-items: center; gap: 6px;">
                <span>üí¨</span> Teacher's Comments
              </h4>
              <div style="background: #fef5e7; padding: 15px; border-radius: 8px; border-left: 3px solid #f6ad55;">
                <p style="margin: 0; color: #2d3748; font-size: 14px; line-height: 1.6; font-style: italic;">"${a.teacher_comments}"</p>
              </div>
            </div>
            ` : ''}

            <!-- Footer -->
            <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px; margin-top: 20px;">
              <p style="margin: 0; color: #B05D9E; font-size: 13px; font-weight: 600;">
                üìÖ Issued: ${new Date(a.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
              </p>
            </div>
          </div>
          `;
        }).join('');
      } catch(e) {
        console.error('Error loading assessments:', e);
        document.getElementById('assessmentsContainer').innerHTML = '<p style="color: #e53e3e;">Error loading assessments</p>';
      }
    }

    // Download Certificate as PDF
    async function downloadCertificate(assessmentId, studentName, certTitle, month, year) {
      const certElement = document.getElementById(`certificate-${assessmentId}`);
      if (!certElement) {
        alert('Certificate not found');
        return;
      }

      // Show loading
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Generating PDF...';
      btn.disabled = true;

      try {
        const { jsPDF } = window.jspdf;

        // Capture the certificate as canvas
        const canvas = await html2canvas(certElement, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        });

        // Create PDF in landscape for better certificate look
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4'
        });

        const imgWidth = 297; // A4 landscape width in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // Center vertically if image is shorter than page
        const pageHeight = 210; // A4 landscape height
        const yOffset = imgHeight < pageHeight ? (pageHeight - imgHeight) / 2 : 0;

        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, yOffset, imgWidth, imgHeight);

        // Download the PDF
        const fileName = `Certificate_${studentName.replace(/\s+/g, '_')}_${month}_${year}.pdf`;
        pdf.save(fileName);

        btn.innerHTML = '‚úÖ Downloaded!';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      } catch (err) {
        console.error('PDF generation error:', err);
        alert('Error generating PDF. Please try again.');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function loadAnnouncements() {
      try {
        const res = await fetch('/api/announcements');
        const announcements = await res.json();
        const container = document.getElementById('announcementsContainer');

        if (announcements.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No announcements at this time</p>';
          return;
        }

        container.innerHTML = announcements.map(a => {
          const priorityColor = a.priority === 'Urgent' ? '#e53e3e' : a.priority === 'High' ? '#f6ad55' : '#B05D9E';
          const typeIcon = a.announcement_type === 'Holiday' ? 'üéâ' : a.announcement_type === 'Reminder' ? '‚è∞' : a.announcement_type === 'Update' ? 'üì¢' : 'üì∞';

          return `
          <div style="background: white; border: 1px solid #e2e8f0; border-left: 4px solid ${priorityColor}; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <h3 style="margin: 0; color: ${priorityColor}; font-size: 18px;">${typeIcon} ${a.title}</h3>
              <span style="background: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${a.priority}</span>
            </div>
            <p style="margin: 0; color: #4a5568; line-height: 1.6; white-space: pre-wrap;">${a.content}</p>
            <p style="margin: 10px 0 0; color: #718096; font-size: 13px;">üìÖ ${new Date(a.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
          </div>
          `;
        }).join('');
      } catch(e) {
        console.error('Error loading announcements:', e);
        document.getElementById('announcementsContainer').innerHTML = '<p style="color: #e53e3e;">Error loading announcements</p>';
      }
    }

    function logout() {
      if(confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('adminParentToken');
        sessionStorage.removeItem('parentViewStudent');
        sessionStorage.removeItem('parentViewMode');
        location.reload();
      }
    }
  </script>

  <!-- Footer -->
  <footer style="background: white; padding: 20px; text-align: center; margin-top: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
    <p style="margin: 0; color: #B05D9E; font-size: 14px; font-weight: 600;">Made with ‚ù§Ô∏è By Aaliya</p>
  </footer>
</body>
</html>
