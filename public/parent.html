
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Portal - Fluent Feathers Academy By Aaliya</title>
  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
  /* Base styles */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f0f4f8;
    color: #2d3748;
  }

  /* Loading Screen Styles - Shows immediately to prevent black screen */
  #serverLoadingScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .spinner {
    border: 4px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top: 4px solid white;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-top: 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Hide main content until server is ready */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    display: none;
  }
  .container.ready {
    display: block;
  }
    header { background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { color: #B05D9E; font-size: 24px; }
    .login-section { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 500px; margin: 50px auto; text-align: center; }
    .info-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 5px solid #B05D9E; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 12px 20px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: #B05D9E; color: white; border-color: #B05D9E; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #B05D9E; color: white; }
    .btn-primary:hover { background: #9A4D88; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    .btn-meet { background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; display: inline-block; }
    .btn-meet:hover { background: linear-gradient(135deg, #319795 0%, #285e61 100%); }
    .btn-download { background: #B05D9E; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; display: inline-block; margin: 2px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; color: #4a5568; font-weight: 600; }
    #studentSelector { margin-bottom: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; text-align: center; display: none; }
    .makeup-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .makeup-card h3 { margin-bottom: 10px; }

    /* Badges - Cute Compact Design */
    .badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; margin-top: 15px; }
    .badge-card {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border: 2px solid rgba(255, 183, 77, 0.5);
      border-radius: 12px;
      padding: 12px 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(252, 182, 159, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .badge-card::before {
      content: 'âœ¨';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 40px;
      opacity: 0.15;
    }
    .badge-card:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 6px 18px rgba(252, 182, 159, 0.5);
    }
    .badge-icon { font-size: 32px; margin-bottom: 6px; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2)); }
    .badge-name { font-size: 12px; font-weight: 600; color: #2d3748; margin-bottom: 4px; line-height: 1.2; }
    .badge-desc { font-size: 10px; color: #4a5568; background: rgba(255,255,255,0.7); padding: 4px 6px; border-radius: 6px; line-height: 1.3; }
    .badge-date { font-size: 9px; color: #718096; margin-top: 4px; font-style: italic; }

    /* Feedback Modal */
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
    .modal-header h2 { color: #B05D9E; font-size: 24px; }
    .close-modal { background: #e53e3e; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .star-rating { display: flex; justify-content: center; gap: 10px; font-size: 48px; margin: 20px 0; }
    .star { cursor: pointer; color: #ddd; transition: all 0.2s; }
    .star.active, .star:hover { color: #FFD700; transform: scale(1.2); }
    .payment-history-item { background: #f7fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #B05D9E; margin-bottom: 15px; }
    .payment-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

    /* Certificate Star Animation */
    @keyframes twinkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* ==================== MOBILE RESPONSIVE STYLES ==================== */
    @media screen and (max-width: 768px) {
      .container { padding: 10px; }
      header { padding: 15px; flex-direction: column; gap: 10px; text-align: center; }
      header h1 { font-size: 18px; }
      .section { padding: 15px; }
      .info-card { padding: 15px; }
      .tabs { justify-content: center; }
      .tab-btn { padding: 10px 15px; font-size: 0.9rem; }

      /* Table responsive - make tables scrollable */
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table { min-width: 600px; }
      th, td { padding: 8px 6px; font-size: 0.85rem; }

      /* Buttons */
      .btn { padding: 10px 16px; font-size: 0.9rem; }
      .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
      .btn-download { padding: 4px 8px; font-size: 0.75rem; }

      /* Form inputs */
      .form-group input, .form-group select, .form-group textarea { font-size: 16px; } /* Prevents zoom on iOS */

      /* Payment grid */
      .payment-grid { grid-template-columns: 1fr; }

      /* Badges grid */
      .badges-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
      .badge-card { padding: 10px 8px; }
      .badge-icon { font-size: 28px; }
      .badge-name { font-size: 11px; }
      .badge-desc { font-size: 9px; }
      .badge-date { font-size: 8px; }

      /* Modal */
      .modal-content { padding: 20px; margin: 10px; width: calc(100% - 20px); }
      .modal-header h2 { font-size: 18px; }
      .star-rating { font-size: 36px !important; gap: 5px; }

      /* Homework section */
      #submittedHomeworkList > div { padding: 12px; }
      #submittedHomeworkList > div > div { flex-direction: column; align-items: flex-start !important; gap: 8px; }
      #submittedHomeworkList > div > div > div:last-child { width: 100%; display: flex; flex-wrap: wrap; gap: 5px; }

      /* Certificate container */
      .certificate-container { min-height: auto !important; flex-direction: column !important; }

      /* Login section */
      .login-section { padding: 25px 15px; margin: 20px 10px; }
    }

    @media screen and (max-width: 480px) {
      header h1 { font-size: 16px; }
      .tab-btn { padding: 8px 12px; font-size: 0.85rem; }
      table { min-width: 500px; }
      th, td { padding: 6px 4px; font-size: 0.8rem; }
      .badges-grid { grid-template-columns: repeat(2, 1fr); }
      .modal-content { padding: 15px; }
      .star-rating { font-size: 28px !important; }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
<div id="serverLoadingScreen">
  <div style="text-align:center; color:white;">
    <img id="loadingLogo" src="/logo.png" alt="Fluent Feathers" height="100"
     onerror="this.outerHTML='ğŸ“'">
    <h1>Welcome to Fluent Feathers Academy By Aaliya</h1>
    <p id="loadingMessage">Preparing your learning portal...</p>
    <div class="spinner"></div>
  </div>
</div>

  <div class="container">
    <!-- LOGIN SECTION -->
    <div id="loginSection" class="login-section">
      <h1 style="color: #B05D9E; margin-bottom: 20px;">ğŸ” Parent Login</h1>
      <form id="emailForm"><div class="form-group"><label>Parent Email *</label><input type="email" id="parentEmail" required></div><button type="submit" class="btn btn-primary">Continue</button></form>

      <!-- First Time User - Create Password -->
      <div id="firstTimeUserSection" style="display: none; margin-top: 20px;">
        <div style="background: #e6fffa; border: 2px solid #38b2ac; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p style="color: #2c7a7b; margin: 0; font-weight: 600;">ğŸ‘‹ Welcome! This is your first login.</p>
          <p style="color: #4a5568; margin: 5px 0 0; font-size: 14px;">Please create a password to access your account.</p>
        </div>
        <form id="setupPasswordForm">
          <div class="form-group"><label>Create Password *</label><input type="password" id="newPassword" required minlength="6" placeholder="At least 6 characters"></div>
          <div class="form-group"><label>Confirm Password *</label><input type="password" id="confirmPassword" required minlength="6"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Create Password & Login</button>
        </form>
        <p style="margin-top: 15px; color: #718096; font-size: 14px; text-align: center;">
          Or <a href="#" onclick="showOTPLogin(); return false;" style="color: #B05D9E;">login with OTP</a> instead
        </p>
      </div>

      <!-- Existing User - Login Options -->
      <div id="existingUserSection" style="display: none; margin-top: 20px;">
        <p style="color: #4a5568; margin-bottom: 15px; text-align: center;">Welcome back! Choose how to login:</p>
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
          <button type="button" onclick="showPasswordLogin()" class="btn btn-primary">ğŸ”‘ Use Password</button>
          <button type="button" onclick="showOTPLogin()" class="btn" style="background: #38b2ac; color: white;">ğŸ“§ Use OTP</button>
        </div>
      </div>

      <!-- Password Login Form -->
      <form id="passwordForm" style="display: none; margin-top: 20px;">
        <div class="form-group"><label>Password *</label><input type="password" id="loginPassword" required></div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
        <div style="margin-top: 15px; text-align: center;">
          <a href="#" onclick="showForgotPassword(); return false;" style="color: #e53e3e; font-size: 14px;">Forgot Password?</a>
          <span style="color: #cbd5e0; margin: 0 10px;">|</span>
          <a href="#" onclick="showOTPLogin(); return false;" style="color: #B05D9E; font-size: 14px;">Login with OTP</a>
        </div>
      </form>

      <!-- Forgot Password Section -->
      <div id="forgotPasswordSection" style="display: none; margin-top: 20px;">
        <div style="background: #fef5e7; border: 2px solid #f6ad55; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p style="color: #c05621; margin: 0; font-weight: 600;">ğŸ”„ Reset Your Password</p>
          <p style="color: #4a5568; margin: 5px 0 0; font-size: 14px;">We'll send an OTP to verify your identity, then you can set a new password.</p>
        </div>
        <div id="forgotOtpSendSection">
          <button type="button" onclick="sendForgotPasswordOTP()" class="btn btn-primary" style="width: 100%;">ğŸ“§ Send Reset OTP</button>
        </div>
        <div id="forgotOtpVerifySection" style="display: none;">
          <div class="form-group"><label>Enter OTP *</label><input type="text" id="forgotOtpCode" required maxlength="6" pattern="[0-9]{6}" placeholder="Enter 6-digit OTP"></div>
          <button type="button" onclick="verifyForgotOTP()" class="btn btn-primary" style="width: 100%;">Verify OTP</button>
        </div>
        <div id="newPasswordSection" style="display: none;">
          <div class="form-group"><label>New Password *</label><input type="password" id="resetNewPassword" required minlength="6"></div>
          <div class="form-group"><label>Confirm New Password *</label><input type="password" id="resetConfirmPassword" required minlength="6"></div>
          <button type="button" onclick="resetPassword()" class="btn btn-primary" style="width: 100%;">Reset Password & Login</button>
        </div>
        <p style="margin-top: 15px; color: #718096; font-size: 14px; text-align: center;">
          <a href="#" onclick="backToLoginOptions(); return false;" style="color: #B05D9E;">â† Back to Login</a>
        </p>
      </div>

      <!-- OTP Login Form -->
      <form id="otpForm" style="display: none; margin-top: 20px;">
        <div id="otpSendSection">
          <p style="color: #4a5568; margin-bottom: 15px;">We'll send a 6-digit OTP to your email</p>
          <button type="button" onclick="sendOTP()" class="btn btn-primary" style="width: 100%;">ğŸ“§ Send OTP</button>
        </div>
        <div id="otpVerifySection" style="display: none;">
          <div class="form-group"><label>Enter OTP *</label><input type="text" id="otpCode" required maxlength="6" pattern="[0-9]{6}" placeholder="Enter 6-digit OTP"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Verify OTP</button>
          <p style="margin-top: 10px; color: #718096; font-size: 14px; text-align: center;">
            <a href="#" onclick="sendOTP(); return false;" style="color: #B05D9E;">Resend OTP</a>
          </p>
        </div>
        <p style="margin-top: 15px; color: #718096; font-size: 14px; text-align: center;">
          <a href="#" onclick="backToLoginOptions(); return false;" style="color: #B05D9E;">â† Back to Login Options</a>
        </p>
      </form>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection" style="display: none;">
      <header>
        <div style="display: flex; align-items: center; gap: 15px;">
          <img id="headerLogo" src="/logo.png" alt="Fluent Feathers" style="height: 50px;">
          <div>
            <h1 style="margin: 0; font-size: 24px;">Fluent Feathers Academy By Aaliya</h1>
            <p style="margin: 5px 0 0; color: #718096; font-size: 12px; font-weight: 500;">Empowering Young Minds Through Language & Communication</p>
          </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
          <span id="currentChildBadge" style="display: none; background: #e2e8f0; color: #4a5568; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">Viewing: <strong id="currentChildName">-</strong></span>
          <button id="switchChildBtn" onclick="showChildSelector()" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: transform 0.2s;" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">ğŸ‘§ğŸ‘¦ Switch Child</button>
          <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
      </header>

      <!-- Child Selector Modal for Siblings -->
      <div id="studentSelector">
        <h3>ğŸ‘‹ Welcome! Select a child:</h3>
        <div id="childCards" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;"></div>
        <p style="color: #718096; font-size: 0.85rem; margin-top: 15px;">You can switch between children anytime using the "Switch Child" button</p>
      </div>

      <div class="info-card">
        <h2 style="color: #B05D9E; margin-bottom: 15px;">ğŸ‘¤ Student Information</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
          <div><strong>Name:</strong> <span id="displayName">-</span></div>
          <div><strong>Grade:</strong> <span id="displayGrade">-</span></div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center;">
          <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #2d3748;" id="displayTotal">-</div>
            <div style="font-size: 0.75rem; color: #718096;">Total</div>
          </div>
          <div style="background: #c6f6d5; padding: 12px; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #276749;" id="displayCompleted">-</div>
            <div style="font-size: 0.75rem; color: #276749;">Completed</div>
          </div>
          <div style="background: #fed7d7; padding: 12px; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #c53030;" id="displayMissed">0</div>
            <div style="font-size: 0.75rem; color: #c53030;">Missed</div>
          </div>
          <div style="background: #feebc8; padding: 12px; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #c05621;" id="displayRemaining">-</div>
            <div style="font-size: 0.75rem; color: #c05621;">Remaining</div>
          </div>
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: bold; color: white;" id="displayMakeup">0</div>
            <div style="font-size: 0.75rem; color: white;">Makeup</div>
          </div>
        </div>
      </div>

      <div id="makeupCreditCard" class="section" style="display: none;">
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
          <h3 style="margin-bottom: 10px;">ğŸ Makeup Credits Available</h3>
          <div style="font-size: 2rem; font-weight: bold;" id="makeupCount">0</div>
          <p style="opacity: 0.9; margin-top: 5px;">Contact your teacher to schedule makeup classes</p>
        </div>

        <!-- Makeup Credit History -->
        <h3 style="color: #B05D9E; margin-bottom: 15px;">ğŸ“‹ Makeup Credit History</h3>
        <div id="makeupCreditsHistory">
          <p style="text-align: center; color: #718096;">Loading history...</p>
        </div>
      </div>

      <!-- Badges Section -->
      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
          <div>
            <h2 style="color: #B05D9E; margin-bottom: 5px;">ğŸ† Achievement Badges</h2>
            <p style="color: #718096; margin: 0; font-size: 0.9rem;">Keep learning to unlock more badges!</p>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <div id="totalBadgesCount" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">
              Total: <span id="badgeCountNum">0</span>
            </div>
            <button onclick="openLeaderboardModal()" class="btn btn-sm" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #333; font-weight: 600; font-size: 0.85rem; padding: 8px 12px;">
              ğŸ… Leaderboard
            </button>
          </div>
        </div>
        <div id="badgesContainer" class="badges-grid">
          <p style="text-align: center; color: #718096;">Loading badges...</p>
        </div>
        <div id="viewAllBadgesBtn" style="display: none; text-align: center; margin-top: 15px;">
          <button onclick="openAllBadgesModal()" class="btn" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; font-weight: 600;">
            View All Badges â†’
          </button>
        </div>
      </div>

      <!-- Weekly Challenges Section -->
      <div class="section" id="challengesSection">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2 style="color: #B05D9E; margin: 0;">ğŸ¯ Weekly Challenges</h2>
        </div>
        <div id="studentChallenges" style="display: grid; gap: 12px;">
          <p style="text-align: center; color: #718096; padding: 20px;">Loading challenges...</p>
        </div>
      </div>

      <!-- Parent Expectations Section -->
      <div class="section">
        <h2 style="color: #B05D9E; margin-bottom: 10px;">ğŸ’­ My Expectations <span style="font-size: 0.75rem; color: #718096;">(Optional)</span></h2>
        <p style="color: #718096; margin-bottom: 15px; font-size: 0.9rem;">Share your goals and expectations for your child's learning journey. Your teacher will see this.</p>
        <div id="parentExpectationsSection">
          <textarea id="myExpectations" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; resize: vertical;" placeholder="e.g., I want my child to improve their reading fluency and confidence in speaking..."></textarea>
          <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
            <button onclick="saveMyExpectations()" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">ğŸ’¾ Save Expectations</button>
            <span id="myExpectationsSaveStatus" style="color: #718096; font-size: 0.85rem;"></span>
          </div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('upcoming', event)">ğŸ“… Upcoming</button>
        <button class="tab-btn" onclick="showTab('past', event)">ğŸ“š Past Classes</button>
        <button class="tab-btn" onclick="showTab('homework', event)">ğŸ“ Homework</button>
        <button class="tab-btn" onclick="showTab('payments', event)">ğŸ’³ Payments</button>
        <button class="tab-btn" onclick="showTab('assessments', event)">ğŸ“Š Report Cards</button>
        <button class="tab-btn" onclick="showTab('announcements', event)">ğŸ“¢ News</button>
        <button class="tab-btn" onclick="showTab('events', event)">ğŸ‰ Events</button>
        <button class="tab-btn" onclick="showTab('resources', event)">ğŸ“š Resources</button>
        <button class="tab-btn" onclick="showTab('profile', event)">ğŸ‘¤ Profile</button>
      </div>

      <div id="upcomingTab" class="tab-content active">
        <div class="section">
          <h2>ğŸš« Cancel Class</h2>
          <p style="color: #718096; margin-bottom: 20px;">Note: Cannot cancel less than 1 hour before class.</p>
          <form id="cancelClassForm">
            <div class="form-group"><label>Select Class</label><select id="cancelClassSelect" required></select></div>
            <button type="submit" class="btn btn-danger">Cancel Class</button>
          </form>
        </div>
        <div class="section">
          <h2>ğŸ“… Schedule</h2>
          <div class="table-responsive">
            <table id="upcomingTable">
              <thead><tr><th>Session #</th><th>Date</th><th>Time</th><th>Join</th></tr></thead>
              <tbody id="upcomingBody"><tr><td colspan="4">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="pastTab" class="tab-content">
        <div class="section">
          <h2>ğŸ“š Completed Classes</h2>
          <div style="background: linear-gradient(135deg, #fff8e6 0%, #fef3c7 100%); border: 1px solid #f6ad55; border-radius: 10px; padding: 12px 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.5rem;">â°</span>
            <p style="margin: 0; color: #744210; font-size: 0.9rem;"><strong>Note:</strong> Class recordings are available for <strong>15 days only</strong> from the class date. Please download them if you wish to keep a copy.</p>
          </div>
          <!-- Search and Filter Controls -->
          <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 20px;">
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="pastClassSearch" placeholder="ğŸ” Search by session #, date, status..."
                     style="width: 100%; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;"
                     oninput="filterPastClasses()">
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="showRecentClasses(10)" class="past-filter-btn active" id="btnRecent10" style="padding: 8px 16px; border: 2px solid #B05D9E; background: #B05D9E; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">Recent 10</button>
              <button onclick="showAllClasses()" class="past-filter-btn" id="btnAllClasses" style="padding: 8px 16px; border: 2px solid #B05D9E; background: white; color: #B05D9E; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">All Classes</button>
            </div>
          </div>
          <p id="pastClassCount" style="color: #718096; font-size: 0.85rem; margin-bottom: 10px;">Showing recent 10 classes</p>
          <div class="table-responsive">
            <table id="pastTable">
              <thead><tr><th>Session #</th><th>Date</th><th>Time</th><th>Attendance</th><th>Materials</th><th>Homework</th><th>Feedback</th></tr></thead>
              <tbody id="pastBody"><tr><td colspan="7">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="homeworkTab" class="tab-content">
        <div class="section">
          <h2>ğŸ“¤ Upload Homework</h2>
          <form id="uploadHomeworkForm">
            <div class="form-group">
              <label>Select Session *</label>
              <select id="homeworkSessionSelect" required><option value="">Loading...</option></select>
            </div>
            <div class="form-group">
              <label>Files * (Select multiple files at once)</label>
              <input type="file" id="homeworkFile" required multiple>
              <p style="color: #718096; font-size: 0.85rem; margin-top: 5px;">
                Upload any file type: Images, Videos, PDFs, Documents, Presentations, Audio, etc. - Max 100MB per file. You can select multiple files.
              </p>
            </div>
            <button type="submit" class="btn btn-primary">ğŸ“¤ Upload Homework</button>
          </form>

          <h3 style="margin-top: 30px; color: #B05D9E;">ğŸ“š My Submitted Homework</h3>
          <div id="submittedHomeworkList" style="margin-top: 15px;">
            <p style="color: #718096;">Loading your submissions...</p>
          </div>
        </div>
      </div>

      <div id="paymentsTab" class="tab-content">
        <div class="section">
          <h2>ğŸ’³ Payment Information</h2>

          <!-- Session Progress Card -->
          <div id="sessionProgressCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">ğŸ“Š Session Progress</h3>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center;">
              <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px;">
                <div style="font-size: 1.75rem; font-weight: bold;" id="paymentTotalSessions">-</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Total</div>
              </div>
              <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px;">
                <div style="font-size: 1.75rem; font-weight: bold;" id="paymentCompletedSessions">-</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Completed</div>
              </div>
              <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px;">
                <div style="font-size: 1.75rem; font-weight: bold;" id="paymentMissedSessions">0</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Missed</div>
              </div>
              <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px;">
                <div style="font-size: 1.75rem; font-weight: bold;" id="paymentRemainingSessions">-</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Remaining</div>
              </div>
              <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 10px;">
                <div style="font-size: 1.75rem; font-weight: bold;" id="paymentMakeupCredits">0</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">Makeup</div>
              </div>
            </div>
            <div id="renewalWarning" style="display: none; margin-top: 15px; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
              âš ï¸ <strong>Low sessions!</strong> Please contact your teacher to renew your package.
            </div>
          </div>

          <div class="payment-grid" style="margin-bottom: 20px;">
            <div><strong>Initial Payment:</strong> <span id="displayInitialPayment">-</span></div>
            <div><strong>Total Paid:</strong> <span id="displayTotalPaid" style="color: #38a169;">-</span></div>
            <div><strong>Payment Method:</strong> <span id="displayPaymentMethod">-</span></div>
            <div><strong>Currency:</strong> <span id="displayCurrency">-</span></div>
          </div>
          <h3 style="margin-top: 30px; margin-bottom: 15px;">ğŸ“‹ Payment History</h3>
          <div id="paymentHistoryContainer">
            <p style="text-align: center; color: #718096;">Loading payment history...</p>
          </div>
        </div>
      </div>

      <div id="assessmentsTab" class="tab-content">
        <div class="section">
          <h2>ğŸ“Š Monthly Report Cards</h2>
          <div id="assessmentsContainer">
            <p style="text-align: center; color: #718096;">Loading report cards...</p>
          </div>
        </div>
      </div>

      <div id="announcementsTab" class="tab-content">
        <div class="section">
          <h2>ğŸ“¢ Latest News & Announcements</h2>
          <div id="announcementsContainer">
            <p style="text-align: center; color: #718096;">Loading announcements...</p>
          </div>
        </div>
      </div>

      <div id="eventsTab" class="tab-content">
        <div class="section"><h2>ğŸ‰ Events</h2><div id="eventsContainer">Loading...</div></div>
      </div>

      <!-- Resources Tab -->
      <div id="resourcesTab" class="tab-content">
        <div class="section">
          <h2 style="color: #B05D9E; margin-bottom: 10px;">ğŸ“š Learning Resources</h2>
          <p style="color: #718096; margin-bottom: 20px;">Explore additional learning materials - videos, worksheets, and practice activities!</p>

          <!-- Category Filter -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
            <span style="color: #4a5568; font-weight: 600;">Filter by:</span>
            <select id="parentResourceCategory" onchange="loadParentResources()" style="padding: 8px 15px; border-radius: 20px; border: 2px solid #e2e8f0; background: white; font-size: 0.9rem;">
              <option value="all">All Categories</option>
              <option value="Videos">Videos</option>
              <option value="Worksheets">Worksheets</option>
              <option value="PDFs">PDFs / Documents</option>
              <option value="Practice">Practice Materials</option>
              <option value="Games">Games & Activities</option>
              <option value="Stories">Stories & Reading</option>
            </select>
          </div>

          <!-- Resources Grid -->
          <div id="parentResourcesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
            <p style="color: #718096; text-align: center; padding: 40px; grid-column: 1/-1;">Loading resources...</p>
          </div>
        </div>
      </div>

      <!-- Profile Tab -->
      <div id="profileTab" class="tab-content">
        <div class="section">
          <h2 style="color: #B05D9E; margin-bottom: 20px;">ğŸ‘¤ Profile Settings</h2>
          <p style="color: #718096; margin-bottom: 25px;">View and update your contact information</p>

          <form id="profileForm">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
              <!-- Student Info (Read Only) -->
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white;">
                <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">ğŸ‘§ Student Information</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <div><strong>Name:</strong> <span id="profileStudentName">-</span></div>
                  <div><strong>Grade:</strong> <span id="profileStudentGrade">-</span></div>
                  <div><strong>Program:</strong> <span id="profileProgram">-</span></div>
                  <div><strong>Class Type:</strong> <span id="profileClassType">-</span></div>
                </div>
              </div>

              <!-- Parent Info (Editable) -->
              <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0;">
                <h3 style="margin: 0 0 15px 0; color: #B05D9E; font-size: 1.1rem;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent Information</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                  <div>
                    <label style="color: #4a5568; font-weight: 600; display: block; margin-bottom: 5px;">Parent Name</label>
                    <input type="text" id="profileParentName" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>
                  <div>
                    <label style="color: #4a5568; font-weight: 600; display: block; margin-bottom: 5px;">Email Address</label>
                    <input type="email" id="profileEmail" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>
                  <div>
                    <label style="color: #4a5568; font-weight: 600; display: block; margin-bottom: 5px;">Primary Contact</label>
                    <input type="text" id="profileContact" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>
                  <div>
                    <label style="color: #4a5568; font-weight: 600; display: block; margin-bottom: 5px;">Alternate Contact</label>
                    <input type="text" id="profileAltContact" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Optional">
                  </div>
                </div>
              </div>

              <!-- Student Details (Editable) -->
              <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0;">
                <h3 style="margin: 0 0 15px 0; color: #B05D9E; font-size: 1.1rem;">ğŸ‚ Additional Details</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                  <div>
                    <label style="color: #4a5568; font-weight: 600; display: block; margin-bottom: 5px;">Child's Date of Birth</label>
                    <input type="date" id="profileDOB" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                  </div>
                  <div>
                    <label style="color: #4a5568; font-weight: 600; display: block; margin-bottom: 5px;">Timezone</label>
                    <input type="text" id="profileTimezone" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; background: #f7fafc;" readonly>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top: 25px; text-align: center;">
              <button type="submit" style="background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%); color: white; border: none; padding: 12px 40px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                ğŸ’¾ Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>â­ Rate Your Class</h2>
        <button class="close-modal" onclick="closeFeedbackModal()">âœ•</button>
      </div>
      <form id="feedbackForm">
        <input type="hidden" id="feedbackSessionId">
        <div style="text-align: center; margin-bottom: 20px;">
          <p style="font-size: 18px; color: #4a5568; margin-bottom: 15px;">How was Session #<span id="feedbackSessionNum"></span>?</p>
          <div class="star-rating" id="starRatingContainer" style="font-size: 2.5rem; cursor: pointer;">
            <span class="star" data-rating="1" onclick="setRating(1)">â˜†</span>
            <span class="star" data-rating="2" onclick="setRating(2)">â˜†</span>
            <span class="star" data-rating="3" onclick="setRating(3)">â˜†</span>
            <span class="star" data-rating="4" onclick="setRating(4)">â˜†</span>
            <span class="star" data-rating="5" onclick="setRating(5)">â˜†</span>
          </div>
        </div>
        <div class="form-group">
          <label>Comments (Optional)</label>
          <textarea id="feedbackTextArea" rows="3" placeholder="Share your thoughts..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Submit</button>
      </form>
    </div>
  </div>

  <script>

    // ==================== SERVER WAKE-UP LOADING SCREEN ====================
(function() {
  let serverReady = false;
  let checkAttempts = 0;
  const maxAttempts = 30; // 30 seconds maximum
  
  const loadingScreen = document.getElementById('serverLoadingScreen');
  const loadingMessage = document.getElementById('loadingMessage');
  
  const messages = [
    'Preparing your learning portal...',
    'Waking up the server...',
    'Connecting to database...',
    'Loading your classes...',
    'Setting up your dashboard...',
    'Almost ready...',
    'Just a moment more...',
    'Server is starting up, please wait...'
  ];
  
  let messageIndex = 0;
  
  // Show loading screen immediately
  function showLoadingScreen() {
    loadingScreen.style.display = 'flex';
    
    // Rotate messages every 3 seconds
    const messageInterval = setInterval(() => {
      messageIndex = (messageIndex + 1) % messages.length;
      loadingMessage.textContent = messages[messageIndex];
    }, 3000);
    
    return messageInterval;
  }
  
  // Hide loading screen and show content
  function hideLoadingScreen(messageInterval) {
    clearInterval(messageInterval);
    // Show the main content
    document.querySelector('.container').classList.add('ready');
    // Fade out loading screen
    loadingScreen.style.opacity = '0';
    loadingScreen.style.transition = 'opacity 0.5s ease';
    setTimeout(() => {
      loadingScreen.style.display = 'none';
    }, 500);
  }
  
  // Check if server is ready
  async function checkServerHealth() {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
      
      const response = await fetch('/api/config', {
        signal: controller.signal,
        cache: 'no-store'
      });
      
      clearTimeout(timeoutId);
      
      if (response.ok) {
        serverReady = true;
        return true;
      }
      return false;
    } catch (error) {
      console.log('Server not ready yet, attempt', checkAttempts + 1);
      return false;
    }
  }
  
  // Main loading logic
  async function initializeApp() {
    const messageInterval = showLoadingScreen();
    
    // Check server health
    while (!serverReady && checkAttempts < maxAttempts) {
      checkAttempts++;
      const isReady = await checkServerHealth();
      
      if (isReady) {
        console.log('âœ… Server is ready!');
        hideLoadingScreen(messageInterval);
        break;
      }
      
      // Wait 1 second before next attempt
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    // If server didn't respond after max attempts, still hide loading screen
    // to let user see any error messages
    if (!serverReady) {
      console.warn('âš ï¸ Server may be slow to respond');
      hideLoadingScreen(messageInterval);
    }
  }
  
  // Start initialization when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
})();

    let currentStudent = null;
    let allMyStudents = [];
    let selectedRating = 0;
    let checkedFeedbackSessions = new Set();
    let appConfig = { logoUrl: '/logo.png' };

    // Load app configuration (logo URL from environment)
   async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    appConfig = await res.json();
    
    // Update header logo
    const headerLogo = document.getElementById('headerLogo');
    if (headerLogo && appConfig.logoUrl) {
      headerLogo.src = appConfig.logoUrl;
    }
    
    // Update loading screen logo
    const loadingLogo = document.getElementById('loadingLogo');
    if (loadingLogo && appConfig.logoUrl) {
      loadingLogo.src = appConfig.logoUrl;
    }
  } catch (e) {
    console.log('Using default config');
  }
}

    const adminToken = sessionStorage.getItem('adminParentToken');
    function authHeaders() {
      return adminToken ? { 'x-admin-token': adminToken } : {};
    }

    function toLocalTime(dateStr, timeStr, tz) {
      try {
        if (!dateStr || !timeStr) {
          console.error('Missing date or time:', dateStr, timeStr);
          return { date: 'Invalid Date', time: 'Invalid Time' };
        }

        const cleanDate = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
        let cleanTime = timeStr.trim();
        if (cleanTime.length === 5) cleanTime += ':00';
        if (cleanTime.includes('.')) cleanTime = cleanTime.split('.')[0];

        const isoString = `${cleanDate}T${cleanTime}Z`;
        const utcDate = new Date(isoString);

        if (isNaN(utcDate.getTime())) {
          console.error('Invalid date created:', isoString);
          return { date: cleanDate, time: cleanTime };
        }

        const localDate = utcDate.toLocaleDateString('en-US', {
          timeZone: tz || 'Asia/Kolkata',
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        const localTime = utcDate.toLocaleTimeString('en-US', {
          timeZone: tz || 'Asia/Kolkata',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        return { date: localDate, time: localTime };
      } catch(e) {
        console.error('Error in toLocalTime:', e, 'Date:', dateStr, 'Time:', timeStr);
        return { date: dateStr, time: timeStr };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Load app configuration (logo URL)
      loadConfig();

      if (adminToken) {
        fetch('/api/parent/admin-view', { headers: authHeaders() })
        .then(res => {
          if (!res.ok) throw new Error('Invalid Token');
          return res.json();
        })
        .then(data => {
          currentStudent = data.student;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('dashboardSection').style.display = 'block';
          showDashboard();
        })
        .catch(() => {
          sessionStorage.removeItem('adminParentToken');
          location.reload();
        });
        return;
      }

      // Check for persistent login session in localStorage
      const storedSession = localStorage.getItem('parentSession');
      if (storedSession) {
        try {
          const session = JSON.parse(storedSession);
          // Verify session is still valid (refresh student data from server)
          fetch('/api/parent/check-email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: session.email })
          })
          .then(res => res.json())
          .then(data => {
            if (data.students && data.students.length > 0) {
              // Session is still valid - restore login
              handleMultipleStudents(data.students, true);
            } else {
              // Session invalid - clear storage and show login
              localStorage.removeItem('parentSession');
              setupLoginHandlers();
            }
          })
          .catch(() => {
            // Error checking - clear storage and show login
            localStorage.removeItem('parentSession');
            setupLoginHandlers();
          });
          return;
        } catch (e) {
          localStorage.removeItem('parentSession');
        }
      }

      setupLoginHandlers();
    });

    let hasExistingPassword = false;
    let forgotPasswordOtpVerified = false;

    function setupLoginHandlers() {
      document.getElementById('emailForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        try {
          const res = await fetch('/api/parent/check-email', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || 'Email not found. Please contact your teacher.');
            return;
          }
          hasExistingPassword = data.hasPassword;
          document.getElementById('emailForm').style.display = 'none';

          // Show appropriate section based on whether user has password
          if (hasExistingPassword) {
            document.getElementById('existingUserSection').style.display = 'block';
          } else {
            document.getElementById('firstTimeUserSection').style.display = 'block';
          }
        } catch (err) { alert('Error checking email'); }
      });

      document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const pwd = document.getElementById('loginPassword').value;
        try {
          const res = await fetch('/api/parent/login-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd }) });
          const data = await res.json();
          if (res.ok) handleMultipleStudents(data.students);
          else alert(data.error || 'Invalid password');
        } catch (err) { alert('Login error'); }
      });

      document.getElementById('setupPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const pwd = document.getElementById('newPassword').value;
        const confirmPwd = document.getElementById('confirmPassword').value;

        if (pwd !== confirmPwd) {
          alert('Passwords do not match!');
          return;
        }
        if (pwd.length < 6) {
          alert('Password must be at least 6 characters!');
          return;
        }

        try {
          const res = await fetch('/api/parent/setup-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd }) });
          const data = await res.json();
          if (res.ok) {
            alert('Password created successfully! Welcome to Fluent Feathers Academy!');
            handleMultipleStudents(data.students);
          } else {
            alert(data.error);
          }
        } catch (err) { alert('Error creating password'); }
      });

      document.getElementById('otpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('parentEmail').value.trim();
        const otp = document.getElementById('otpCode').value;
        try {
          const res = await fetch('/api/parent/verify-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, otp }) });
          const data = await res.json();
          if (res.ok) handleMultipleStudents(data.students);
          else alert(data.error || 'Invalid OTP');
        } catch (err) { alert('OTP verification error'); }
      });
    }

    function hideAllLoginForms() {
      document.getElementById('firstTimeUserSection').style.display = 'none';
      document.getElementById('existingUserSection').style.display = 'none';
      document.getElementById('passwordForm').style.display = 'none';
      document.getElementById('forgotPasswordSection').style.display = 'none';
      document.getElementById('otpForm').style.display = 'none';
      document.getElementById('otpSendSection').style.display = 'block';
      document.getElementById('otpVerifySection').style.display = 'none';
      document.getElementById('forgotOtpSendSection').style.display = 'block';
      document.getElementById('forgotOtpVerifySection').style.display = 'none';
      document.getElementById('newPasswordSection').style.display = 'none';
    }

    function backToLoginOptions() {
      hideAllLoginForms();
      if (hasExistingPassword) {
        document.getElementById('existingUserSection').style.display = 'block';
      } else {
        document.getElementById('firstTimeUserSection').style.display = 'block';
      }
    }

    function showPasswordLogin() {
      hideAllLoginForms();
      document.getElementById('passwordForm').style.display = 'block';
    }

    function showOTPLogin() {
      hideAllLoginForms();
      document.getElementById('otpForm').style.display = 'block';
    }

    function showForgotPassword() {
      hideAllLoginForms();
      forgotPasswordOtpVerified = false;
      document.getElementById('forgotPasswordSection').style.display = 'block';
    }

    async function sendForgotPasswordOTP() {
      const email = document.getElementById('parentEmail').value.trim();
      try {
        const res = await fetch('/api/parent/send-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        const data = await res.json();
        if (res.ok) {
          alert('OTP sent to your email!');
          document.getElementById('forgotOtpSendSection').style.display = 'none';
          document.getElementById('forgotOtpVerifySection').style.display = 'block';
        } else {
          alert(data.error || 'Error sending OTP');
        }
      } catch(e) {
        alert('Error sending OTP');
      }
    }

    async function verifyForgotOTP() {
      const email = document.getElementById('parentEmail').value.trim();
      const otp = document.getElementById('forgotOtpCode').value;
      try {
        const res = await fetch('/api/parent/verify-reset-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, otp }) });
        const data = await res.json();
        if (res.ok) {
          forgotPasswordOtpVerified = true;
          document.getElementById('forgotOtpVerifySection').style.display = 'none';
          document.getElementById('newPasswordSection').style.display = 'block';
        } else {
          alert(data.error || 'Invalid OTP');
        }
      } catch(e) {
        alert('Error verifying OTP');
      }
    }

    async function resetPassword() {
      if (!forgotPasswordOtpVerified) {
        alert('Please verify OTP first');
        return;
      }

      const email = document.getElementById('parentEmail').value.trim();
      const pwd = document.getElementById('resetNewPassword').value;
      const confirmPwd = document.getElementById('resetConfirmPassword').value;

      if (pwd !== confirmPwd) {
        alert('Passwords do not match!');
        return;
      }
      if (pwd.length < 6) {
        alert('Password must be at least 6 characters!');
        return;
      }

      try {
        const res = await fetch('/api/parent/reset-password', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd }) });
        const data = await res.json();
        if (res.ok) {
          alert('Password reset successfully! Please login with your new password.');
          hideAllLoginForms();
          document.getElementById('existingUserSection').style.display = 'block';
          hasExistingPassword = true;
        } else {
          alert(data.error || 'Error resetting password');
        }
      } catch(e) {
        alert('Error resetting password');
      }
    }

    function handleMultipleStudents(students, skipSave = false) {
      allMyStudents = students;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';

      // Store session in localStorage for persistent login (unless restoring from storage)
      if (!skipSave) {
        const parentEmail = document.getElementById('parentEmail').value.trim();
        localStorage.setItem('parentSession', JSON.stringify({
          email: parentEmail,
          students: students,
          timestamp: Date.now()
        }));
      }

      if (students.length > 1) {
        // Show Switch Child button in header
        document.getElementById('switchChildBtn').style.display = 'inline-block';

        // Show child selector with nice cards
        showChildSelector();
      } else {
        // Single child - hide switch button
        document.getElementById('switchChildBtn').style.display = 'none';
        currentStudent = students[0];
        showDashboard();
      }
    }

    function showChildSelector() {
      if (allMyStudents.length <= 1) return;

      document.getElementById('studentSelector').style.display = 'block';

      // Create child cards
      const container = document.getElementById('childCards');
      const colors = ['#667eea', '#f093fb', '#4fd1c5', '#f6ad55', '#fc8181'];

      container.innerHTML = allMyStudents.map((s, i) => {
        const color = colors[i % colors.length];
        const initials = s.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const isCurrentChild = currentStudent && currentStudent.id === s.id;
        const borderStyle = isCurrentChild ? '3px solid #38a169' : '2px solid #e2e8f0';
        const currentBadge = isCurrentChild ? '<span style="position: absolute; top: -8px; right: -8px; background: #38a169; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">Current</span>' : '';

        return `
          <div onclick="selectChild(${s.id})" style="position: relative; background: white; border: ${borderStyle}; border-radius: 15px; padding: 25px 30px; cursor: pointer; transition: all 0.3s; min-width: 180px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"
               onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';"
               onmouseleave="this.style.transform='none'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)';">
            ${currentBadge}
            <div style="width: 60px; height: 60px; background: ${color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white; font-size: 1.5rem; font-weight: bold;">${initials}</div>
            <h3 style="margin: 0 0 5px 0; color: #2d3748; font-size: 1.1rem;">${s.name}</h3>
            <p style="margin: 0; color: #718096; font-size: 0.9rem;">Grade ${s.grade}</p>
            <p style="margin: 8px 0 0 0; color: #B05D9E; font-size: 0.85rem; font-weight: 600;">${s.remaining_sessions} sessions left</p>
          </div>
        `;
      }).join('');
    }

    function selectChild(studentId) {
      const student = allMyStudents.find(s => s.id === studentId);
      if (student) {
        currentStudent = student;
        document.getElementById('studentSelector').style.display = 'none';
        showDashboard();
      }
    }

    async function sendOTP() {
      const email = document.getElementById('parentEmail').value.trim();
      try {
        await fetch('/api/parent/send-otp', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        document.getElementById('otpSendSection').style.display = 'none';
        document.getElementById('otpVerifySection').style.display = 'block';
        alert('OTP sent to your email');
      } catch(e) {
        alert('Error sending OTP');
      }
    }

    function showTab(name, e) {
      if(e) e.stopPropagation();
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(name+'Tab').classList.add('active');
      // Highlight the correct tab button
      const tabBtn = document.querySelector(`.tab-btn[onclick*="'${name}'"]`);
      if(tabBtn) tabBtn.classList.add('active');
      // Save current tab to localStorage for persistence on refresh
      localStorage.setItem('parentActiveTab', name);
      if(name === 'homework') loadHomeworkSessions();
      if(name === 'events') loadEvents();
      if(name === 'payments') loadPayments();
      if(name === 'assessments') loadAssessments();
      if(name === 'announcements') loadAnnouncements();
      if(name === 'resources') loadParentResources();
      if(name === 'profile') loadProfile();
    }

    function showDashboard() {
      document.getElementById('displayName').textContent = currentStudent.name;
      document.getElementById('displayGrade').textContent = currentStudent.grade;
      document.getElementById('displayTotal').textContent = currentStudent.total_sessions;
      document.getElementById('displayCompleted').textContent = currentStudent.completed_sessions || 0;
      document.getElementById('displayMissed').textContent = currentStudent.missed_sessions || 0;
      document.getElementById('displayRemaining').textContent = currentStudent.remaining_sessions;

      // Update current child badge in header (for siblings)
      if (allMyStudents && allMyStudents.length > 1) {
        document.getElementById('currentChildBadge').style.display = 'inline-block';
        document.getElementById('currentChildName').textContent = currentStudent.name;
      }

      loadMakeupCredits();
      loadBadges();
      loadStudentChallenges();
      loadMyExpectations();
      loadUpcoming();
      loadPast();
      loadCancelDropdown();
      checkForFeedback();

      // Restore last active tab from localStorage
      const savedTab = localStorage.getItem('parentActiveTab');
      if (savedTab && document.getElementById(savedTab + 'Tab')) {
        showTab(savedTab);
      }
    }

    let allBadges = []; // Store all badges for the modal

    async function loadBadges() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/badges`, { headers: authHeaders() });
        const badges = await res.json();
        allBadges = badges; // Store for modal
        const container = document.getElementById('badgesContainer');

        // Update total count
        document.getElementById('badgeCountNum').textContent = badges.length;

        if (badges.length === 0) {
          container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #718096; padding: 20px;">No badges earned yet. Attend classes and submit homework to unlock badges! ğŸŒŸ</p>';
          document.getElementById('viewAllBadgesBtn').style.display = 'none';
        } else {
          // Show latest 5 badges only
          const displayBadges = badges.slice(0, 5);
          container.innerHTML = displayBadges.map(b => `
            <div class="badge-card" style="padding: 12px; font-size: 0.9rem;">
              <div class="badge-icon" style="font-size: 1.8rem;">${b.badge_name.split(' ')[0]}</div>
              <div class="badge-name" style="font-size: 0.8rem;">${b.badge_name.substring(b.badge_name.indexOf(' ') + 1)}</div>
              <div class="badge-desc" style="font-size: 0.7rem;">${b.badge_description}</div>
              <div class="badge-date" style="font-size: 0.65rem;">Earned: ${new Date(b.earned_date).toLocaleDateString()}</div>
            </div>
          `).join('');

          // Show "View All" button if more than 5 badges
          document.getElementById('viewAllBadgesBtn').style.display = badges.length > 5 ? 'block' : 'none';
        }
      } catch(e) {
        console.error('Error loading badges:', e);
        document.getElementById('badgesContainer').innerHTML = '<p style="color: #e53e3e;">Error loading badges</p>';
      }
    }

    function openAllBadgesModal() {
      // Remove existing modal if any
      const existing = document.getElementById('allBadgesModal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.id = 'allBadgesModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 25px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #B05D9E; margin: 0;">ğŸ† All My Badges (${allBadges.length})</h2>
            <button onclick="document.getElementById('allBadgesModal').remove()" style="background: #e53e3e; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;">âœ•</button>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
            ${allBadges.map(b => `
              <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 12px; border-radius: 12px; text-align: center;">
                <div style="font-size: 2rem;">${b.badge_name.split(' ')[0]}</div>
                <div style="font-weight: 600; font-size: 0.85rem; color: #2d3748;">${b.badge_name.substring(b.badge_name.indexOf(' ') + 1)}</div>
                <div style="font-size: 0.7rem; color: #718096; margin-top: 5px;">${b.badge_description}</div>
                <div style="font-size: 0.65rem; color: #a0aec0; margin-top: 5px;">${new Date(b.earned_date).toLocaleDateString()}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      document.body.appendChild(modal);
    }

    async function openLeaderboardModal() {
      // Remove existing modal if any
      const existing = document.getElementById('leaderboardModal');
      if (existing) existing.remove();

      // Fetch leaderboard data
      let leaderboardData = [];
      try {
        const res = await fetch('/api/leaderboard', { headers: authHeaders() });
        const data = await res.json();
        leaderboardData = data.leaderboard || [];
      } catch (err) {
        console.error('Error fetching leaderboard:', err);
      }

      // Find current student's rank
      const myRank = leaderboardData.findIndex(s => s.id === currentStudent.id) + 1;
      const myBadges = allBadges.length;

      const modal = document.createElement('div');
      modal.id = 'leaderboardModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';

      const top5 = leaderboardData.slice(0, 5);
      const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];

      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; padding: 25px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: white; margin: 0;">ğŸ… Badge Leaderboard</h2>
            <button onclick="document.getElementById('leaderboardModal').remove()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 1rem;">âœ•</button>
          </div>

          <!-- My Rank Card -->
          <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); padding: 20px; border-radius: 16px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <p style="color: #333; margin: 0 0 5px 0; font-size: 0.9rem;">Your Rank</p>
            <div style="font-size: 3rem; font-weight: bold; color: #333;">${myRank > 0 ? '#' + myRank : 'â€”'}</div>
            <p style="color: #333; margin: 10px 0 0 0; font-size: 1.1rem;"><strong>${currentStudent.name}</strong></p>
            <p style="color: #555; margin: 5px 0 0 0;">ğŸ† <strong>${myBadges}</strong> badges collected</p>
          </div>

          <!-- Top 5 Leaderboard -->
          <div style="background: white; border-radius: 12px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #f6d365 0%, #fda085 100%); padding: 12px 15px; text-align: center;">
              <strong style="color: #333;">ğŸŒŸ Top Badge Collectors ğŸŒŸ</strong>
            </div>
            ${top5.length > 0 ? top5.map((student, idx) => `
              <div style="display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; ${student.id === currentStudent.id ? 'background: rgba(102,126,234,0.1);' : ''}">
                <div style="font-size: 1.5rem; margin-right: 12px;">${medals[idx]}</div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #2d3748;">${student.name} ${student.id === currentStudent.id ? '(You!)' : ''}</div>
                  <div style="font-size: 0.75rem; color: #718096;">Total Badges: ${student.total_badges}</div>
                </div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">
                  ${student.total_badges}
                </div>
              </div>
            `).join('') : '<div style="padding: 20px; text-align: center; color: #718096;">No students on leaderboard yet!</div>'}

            ${myRank > 5 ? `
              <div style="padding: 8px 15px; background: #f0f0f0; text-align: center; color: #718096; font-size: 0.8rem;">â€¢ â€¢ â€¢</div>
              <div style="display: flex; align-items: center; padding: 12px 15px; background: linear-gradient(90deg, rgba(102,126,234,0.15) 0%, rgba(118,75,162,0.15) 100%); border-top: 2px solid #667eea;">
                <div style="font-size: 1.2rem; margin-right: 12px; font-weight: bold; color: #667eea;">#${myRank}</div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #2d3748;">${currentStudent.name} <span style="color: #667eea;">(You!)</span></div>
                  <div style="font-size: 0.75rem; color: #718096;">Total Badges: ${myBadges}</div>
                </div>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">
                  ${myBadges}
                </div>
              </div>
            ` : ''}
          </div>

          <p style="color: rgba(255,255,255,0.8); text-align: center; margin-top: 15px; font-size: 0.85rem;">
            ${myRank > 5 ? `You need ${(leaderboardData[4]?.total_badges || 1) - myBadges + 1} more badges to reach Top 5! ğŸ’ª` : 'Keep earning badges to climb the leaderboard! ğŸš€'}
          </p>
        </div>
      `;

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      document.body.appendChild(modal);
    }

    // Load weekly challenges for student
    async function loadStudentChallenges() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/challenges`, { headers: authHeaders() });
        const challenges = await res.json();
        const container = document.getElementById('studentChallenges');

        if (!challenges || challenges.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No active challenges right now. Check back soon! ğŸ¯</p>';
          return;
        }

        container.innerHTML = challenges.map(c => {
          const isCompleted = c.status === 'Completed';
          const isSubmitted = c.status === 'Submitted';
          const dueDate = new Date(c.week_end).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const badgeReward = c.badge_reward || 'ğŸ¯ Challenge Champion';
          const badgeEmoji = badgeReward.split(' ')[0];

          let statusBadge = '';
          let actionButton = '';

          if (isCompleted) {
            statusBadge = `<div style="background: #38b2ac; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">COMPLETED! ğŸ‰</div>`;
          } else if (isSubmitted) {
            statusBadge = `<div style="background: #9f7aea; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">â³ Awaiting Approval</div>`;
          } else {
            statusBadge = `<div style="background: #f5576c; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">IN PROGRESS</div>`;
            actionButton = `<button onclick="submitChallenge(${c.id}, '${c.title.replace(/'/g, "\\'")}')" style="margin-top: 10px; background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">âœ‹ I Did It! Submit for Review</button>`;
          }

          return `
            <div style="background: ${isCompleted ? 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' : isSubmitted ? 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)' : 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'};
                        padding: 15px; border-radius: 12px; border-left: 4px solid ${isCompleted ? '#38b2ac' : isSubmitted ? '#9f7aea' : '#f5576c'};">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                <div style="flex: 1; min-width: 200px;">
                  <h3 style="margin: 0 0 8px 0; color: #2d3748; font-size: 1rem;">
                    ${isCompleted ? 'âœ…' : isSubmitted ? 'â³' : 'ğŸ¯'} ${c.title}
                  </h3>
                  <p style="margin: 0 0 8px 0; color: #4a5568; font-size: 0.9rem;">${c.description || ''}</p>
                  <div style="display: flex; gap: 15px; font-size: 0.8rem; color: #718096; flex-wrap: wrap;">
                    <span>ğŸ“… Due: ${dueDate}</span>
                    <span style="background: rgba(255,255,255,0.7); padding: 2px 8px; border-radius: 10px;">${badgeEmoji} ${badgeReward}</span>
                  </div>
                  ${actionButton}
                </div>
                ${statusBadge}
              </div>
            </div>
          `;
        }).join('');
      } catch(e) {
        console.error('Error loading challenges:', e);
        document.getElementById('studentChallenges').innerHTML = '<p style="color: #e53e3e; text-align: center;">Error loading challenges</p>';
      }
    }

    // Submit challenge as done (parent reports completion)
    async function submitChallenge(challengeId, challengeTitle) {
      if (!confirm(`Submit "${challengeTitle}" as completed?\n\nYour teacher will review and approve it.`)) return;

      try {
        const res = await fetch(`/api/challenges/${challengeId}/student/${currentStudent.id}/submit`, {
          method: 'PUT',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' }
        });
        const result = await res.json();
        if (res.ok) {
          alert('ğŸ‰ Challenge submitted! Your teacher will review and award your badge soon.');
          loadStudentChallenges();
        } else {
          alert('âŒ Error: ' + result.error);
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // Load parent expectations
    async function loadMyExpectations() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/expectations`, { headers: authHeaders() });
        if (!res.ok) return;
        const data = await res.json();
        if (data.expectations) {
          document.getElementById('myExpectations').value = data.expectations;
        }
      } catch(e) {
        console.error('Error loading expectations:', e);
      }
    }

    // Save parent expectations
    async function saveMyExpectations() {
      const expectations = document.getElementById('myExpectations').value.trim();
      const statusEl = document.getElementById('myExpectationsSaveStatus');

      try {
        statusEl.textContent = 'Saving...';
        statusEl.style.color = '#718096';

        const res = await fetch(`/api/students/${currentStudent.id}/expectations`, {
          method: 'PUT',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ expectations })
        });

        if (res.ok) {
          statusEl.textContent = 'âœ“ Saved!';
          statusEl.style.color = '#38b2ac';
          setTimeout(() => { statusEl.textContent = ''; }, 3000);
        } else {
          throw new Error('Failed to save');
        }
      } catch(e) {
        console.error('Error saving expectations:', e);
        statusEl.textContent = 'âœ— Error saving';
        statusEl.style.color = '#e53e3e';
      }
    }

    async function loadMakeupCredits() {
      try {
        // Use the history endpoint to get full makeup credit history
        const res = await fetch('/api/students/' + currentStudent.id + '/makeup-history', { headers: authHeaders() });
        const history = await res.json();

        // Count available credits (not used and not scheduled) - case insensitive check
        const availableCredits = history.filter(c => c.status && c.status.toLowerCase() === 'available').length;
        const hasHistory = history.length > 0;

        // Update top card makeup display
        const topMakeupDisplay = document.getElementById('displayMakeup');
        if (topMakeupDisplay) topMakeupDisplay.textContent = availableCredits;

        if (hasHistory) {
          document.getElementById('makeupCreditCard').style.display = 'block';
          document.getElementById('makeupCount').textContent = availableCredits;

          // Display history
          const historyContainer = document.getElementById('makeupCreditsHistory');
          if (history.length === 0) {
            historyContainer.innerHTML = '<p style="text-align: center; color: #718096;">No makeup credit history</p>';
          } else {
            historyContainer.innerHTML = history.map(c => {
              let statusBadge, statusText;
              const statusLower = (c.status || '').toLowerCase();
              if (statusLower === 'available') {
                statusBadge = 'background: #38a169; color: white;';
                statusText = 'Available';
              } else if (statusLower === 'scheduled') {
                statusBadge = 'background: #805ad5; color: white;';
                const schedDate = c.scheduled_date ? new Date(c.scheduled_date).toLocaleDateString() : '';
                statusText = 'Scheduled' + (schedDate ? ' - ' + schedDate : '');
              } else if (statusLower === 'used') {
                statusBadge = 'background: #718096; color: white;';
                statusText = 'Used';
              } else {
                statusBadge = 'background: #e2e8f0; color: #4a5568;';
                statusText = c.status || 'Unknown';
              }

              const earnedDate = c.created_at ? new Date(c.created_at).toLocaleDateString() : 'N/A';
              const addedBy = c.added_by === 'admin' ? 'Added by Teacher' : c.added_by === 'system' ? 'From Cancellation' : '';
              const bgColor = statusLower === 'scheduled' ? 'linear-gradient(135deg, #e9d8fd 0%, #faf5ff 100%)' : '#f7fafc';
              const borderColor = statusLower === 'available' ? '#38a169' : statusLower === 'scheduled' ? '#805ad5' : '#718096';

              let scheduledDiv = '';
              if (statusLower === 'scheduled' && c.scheduled_date) {
                const schedDateStr = new Date(c.scheduled_date).toLocaleDateString();
                const schedTimeStr = c.scheduled_time ? ' at ' + c.scheduled_time : '';
                scheduledDiv = '<div style="margin-top: 8px; background: #805ad5; color: white; padding: 6px 12px; border-radius: 6px; display: inline-block; font-size: 0.85rem;">Makeup Class: ' + schedDateStr + schedTimeStr + '</div>';
              }

              return '<div style="background: ' + bgColor + '; border-left: 4px solid ' + borderColor + '; padding: 15px; border-radius: 8px; margin-bottom: 12px;">' +
                '<div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">' +
                  '<div>' +
                    '<div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">' + (c.reason || 'Makeup Credit') + '</div>' +
                    '<div style="font-size: 0.85rem; color: #718096;">Earned: ' + earnedDate + (addedBy ? ' - ' + addedBy : '') + '</div>' +
                    scheduledDiv +
                  '</div>' +
                  '<span style="' + statusBadge + ' padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">' + statusText + '</span>' +
                '</div>' +
              '</div>';
            }).join('');
          }
        } else {
          document.getElementById('makeupCreditCard').style.display = 'none';
        }
      } catch(e) {
        console.error('Error loading makeup credits:', e);
      }
    }

    async function loadUpcoming() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date >= today && !['Cancelled', 'Completed', 'Missed'].includes(s.status);
        });

        const tbody = document.getElementById('upcomingBody');

        if (upcoming.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #718096;">No upcoming classes scheduled</td></tr>';
          return;
        }

        tbody.innerHTML = upcoming.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          // Get day name
          const dateStr = s.session_date.includes('T') ? s.session_date.split('T')[0] : s.session_date;
          const d = new Date(dateStr + 'T00:00:00');
          const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
          const meetLink = s.meet_link || 'https://meet.google.com/qne-muzw-wav';

          // Get class duration in minutes from session (default 40 mins if not specified)
          const durationMatch = s.duration ? s.duration.match(/(\d+)\s*mins?/) : null;
          const classDurationMins = durationMatch ? parseInt(durationMatch[1]) : 40;

          // Check if within join window: 5 mins before start until end of class
          const sessionDateTime = new Date(dateStr + 'T' + s.session_time + 'Z');
          const now = new Date();
          const diffMinutes = (sessionDateTime - now) / (1000 * 60);
          
          // Can join from 5 mins before until class duration after start (e.g., 40 mins for 40 min class)
          const canJoin = diffMinutes <= 5 && diffMinutes >= -(classDurationMins);

          const meetButton = canJoin
  ? `<a href="${meetLink}" target="_blank" class="btn-meet">ğŸ¥ Join Meet</a>`
  : `<button onclick="alert('You can join from 5 minutes before class starts until the end of class (${classDurationMins} minutes). Please wait until then.')" class="btn-meet" style="background: #a0aec0; cursor: not-allowed;">ğŸ”’ Join Meet</button>`;

          return `<tr>
            <td>#${s.session_number}</td>
            <td>${dayName}, ${t.date}</td>
            <td><strong style="color:#B05D9E">${t.time}</strong></td>
            <td>${meetButton}</td>
          </tr>`;
        }).join('');
      } catch(e) {
        console.error('Error loading upcoming:', e);
        document.getElementById('upcomingBody').innerHTML = '<tr><td colspan="4">Error loading sessions</td></tr>';
      }
    }

    let allPastSessions = []; // Store all past sessions for filtering
    let showAllPastClasses = false;

    async function loadPast() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        allPastSessions = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date < today || ['Completed', 'Missed'].includes(s.status);
        }).sort((a, b) => {
          // Sort by date descending (most recent first)
          const dateA = new Date(a.session_date + 'T' + (a.session_time || '00:00:00'));
          const dateB = new Date(b.session_date + 'T' + (b.session_time || '00:00:00'));
          return dateB - dateA;
        });

        // Show recent 10 by default
        renderPastClasses(showAllPastClasses ? allPastSessions : allPastSessions.slice(0, 10));
        updatePastClassCount();
      } catch(e) {
        console.error('Error loading past:', e);
      }
    }

    function showRecentClasses(count) {
      showAllPastClasses = false;
      document.getElementById('btnRecent10').style.background = '#B05D9E';
      document.getElementById('btnRecent10').style.color = 'white';
      document.getElementById('btnAllClasses').style.background = 'white';
      document.getElementById('btnAllClasses').style.color = '#B05D9E';
      document.getElementById('pastClassSearch').value = '';
      renderPastClasses(allPastSessions.slice(0, count));
      updatePastClassCount();
    }

    function showAllClasses() {
      showAllPastClasses = true;
      document.getElementById('btnAllClasses').style.background = '#B05D9E';
      document.getElementById('btnAllClasses').style.color = 'white';
      document.getElementById('btnRecent10').style.background = 'white';
      document.getElementById('btnRecent10').style.color = '#B05D9E';
      document.getElementById('pastClassSearch').value = '';
      renderPastClasses(allPastSessions);
      updatePastClassCount();
    }

    function filterPastClasses() {
      const searchTerm = document.getElementById('pastClassSearch').value.toLowerCase().trim();
      if (!searchTerm) {
        renderPastClasses(showAllPastClasses ? allPastSessions : allPastSessions.slice(0, 10));
        updatePastClassCount();
        return;
      }

      const filtered = allPastSessions.filter(s => {
        const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
        const searchStr = `#${s.session_number} ${t.date} ${t.time} ${s.status || ''} ${s.student_attendance || ''}`.toLowerCase();
        return searchStr.includes(searchTerm);
      });
      renderPastClasses(filtered);
      document.getElementById('pastClassCount').textContent = `Found ${filtered.length} class${filtered.length !== 1 ? 'es' : ''} matching "${searchTerm}"`;
    }

    function updatePastClassCount() {
      const total = allPastSessions.length;
      const showing = showAllPastClasses ? total : Math.min(10, total);
      document.getElementById('pastClassCount').textContent = showAllPastClasses
        ? `Showing all ${total} classes`
        : `Showing recent ${showing} of ${total} classes`;
    }

    function renderPastClasses(past) {
        const tbody = document.getElementById('pastBody');

        if (past.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #718096;">No past classes found</td></tr>';
          return;
        }

        tbody.innerHTML = past.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);

          // Helper to format material links/files properly with proper viewer support
          // isProtected = true means view-only with watermark (for class PPTs)
          function getMaterialLink(filePath, icon, label, isProtected = false) {
            if (!filePath) return '';

            let fileUrl = '';
            let isLink = false;

            if (filePath.startsWith('LINK:')) {
              // External link
              fileUrl = filePath.replace('LINK:', '');
              isLink = true;
            } else if (filePath.startsWith('https://') || filePath.startsWith('http://')) {
              // Cloudinary or external URL - use directly
              fileUrl = filePath;
            } else if (filePath.startsWith('/uploads/')) {
              fileUrl = filePath;
            } else if (/^\d+-\d+/.test(filePath)) {
              // Cloudinary public_id - construct full URL
              const ext = filePath.split('.').pop().toLowerCase();
              const isImageFile = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
              const resourceType = isImageFile ? 'image' : 'raw';
              fileUrl = `https://res.cloudinary.com/divz4aavx/${resourceType}/upload/fluentfeathers/materials/${filePath}`;
            } else {
              // File upload - needs /uploads/materials/ prefix
              fileUrl = '/uploads/materials/' + filePath;
            }

            if (isLink) {
              return `<a href="${fileUrl}" target="_blank" class="btn-download">${icon} ${label}</a>`;
            }

            // Determine file type for proper viewing
            const ext = filePath.split('.').pop().toLowerCase();
            let fileType = 'other';
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) fileType = 'image';
            else if (['mp4', 'mov', 'avi', 'webm'].includes(ext)) fileType = 'video';
            else if (['pdf'].includes(ext)) fileType = 'pdf';
            else if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(ext)) fileType = 'doc';

            const fileName = filePath.split('/').pop() || label;

            // Protected files (Class PPT) - view only with watermark, no download
            if (isProtected) {
              return `<button onclick="previewProtectedFile('${fileUrl}', '${fileType}', '${fileName.replace(/'/g, "\\'")}')" class="btn-download" style="cursor:pointer; border:none; background:transparent; color:#B05D9E;">${icon} ğŸ”’${label}</button>`;
            }

            // Non-protected files - show View and Download buttons
            const downloadUrl = getDownloadUrl(fileUrl, fileName);
            return `<span style="display:inline-flex; gap:5px; align-items:center;">
              <button onclick="previewFile('${fileUrl}', '${fileType}', '${fileName.replace(/'/g, "\\'")}')" class="btn-download" style="cursor:pointer; border:none; background:transparent;">${icon} ${label}</button>
              <a href="${downloadUrl}" download="${fileName}" style="color:#38a169; font-size:0.8rem; text-decoration:none;" title="Download ${label}">â¬‡ï¸</a>
            </span>`;
          }

          let materials = '';
          materials += getMaterialLink(s.ppt_file_path, 'ğŸ“Š', 'PPT', true);  // PPT is protected - view only
          materials += getMaterialLink(s.recording_file_path, 'ğŸ¥', 'Recording', false);  // Recording - downloadable
          materials += getMaterialLink(s.homework_file_path, 'ğŸ“', 'HW', false);  // HW - downloadable
          if (!materials) materials = '-';

          let hwStatus = '-';
          if (s.homework_submission_path) {
            hwStatus = `<span style="color: #38a169;">âœ“ Submitted</span>`;
            if (s.homework_grade) {
              hwStatus += `<br><span style="background:#38a169; color:white; padding:2px 8px; border-radius:4px; font-size:0.8rem;">${s.homework_grade}</span>`;
            }
            if (s.homework_feedback) {
              hwStatus += `<br><small style="color:#4a5568; font-style:italic;">ğŸ’¬ ${s.homework_feedback}</small>`;
            }
          }

          // Feedback button - show if completed, attended, and not already given feedback
          let feedbackBtn = '-';
          const wasAbsent = (s.source_type === 'Group' && s.student_attendance && s.student_attendance.toLowerCase() === 'absent') ||
                           s.status === 'Missed' || s.status === 'Absent' || s.status === 'Cancelled';
          if (s.status === 'Completed' && !wasAbsent) {
            if (s.has_feedback) {
              feedbackBtn = `<span style="color:#38a169;">âœ“ Given</span>`;
            } else {
              feedbackBtn = `<button onclick="openFeedbackModal(${s.id}, ${s.session_number})" style="background:#B05D9E; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.85rem;">â­ Rate</button>`;
            }
          } else if (wasAbsent) {
            feedbackBtn = `<span style="color:#718096; font-size:0.85rem;">-</span>`;
          }

          // Convert status to attendance display
          // For group sessions, use student_attendance; for private, use session status
          let attendanceDisplay = '-';
          if (s.source_type === 'Group') {
            // Group session - use individual student attendance
            if (s.student_attendance === 'Present') {
              attendanceDisplay = `<span style="color:#38a169; font-weight:600;">âœ“ Present</span>`;
            } else if (s.student_attendance === 'Absent') {
              attendanceDisplay = `<span style="color:#e53e3e; font-weight:600;">âœ— Absent</span><br><small style="color:#718096;">(Materials available)</small>`;
            } else if (s.status === 'Completed') {
              attendanceDisplay = `<span style="color:#718096;">Pending</span>`;
            } else {
              attendanceDisplay = s.status || '-';
            }
          } else {
            // Private session - use session status
            if (s.status === 'Completed') {
              attendanceDisplay = `<span style="color:#38a169; font-weight:600;">âœ“ Present</span>`;
            } else if (s.status === 'Missed') {
              attendanceDisplay = `<span style="color:#e53e3e; font-weight:600;">âœ— Absent</span>`;
            } else if (s.status === 'Cancelled' || s.status === 'Cancelled by Parent') {
              const cancelledByText = s.cancelled_by ? ` (by ${s.cancelled_by})` : '';
              attendanceDisplay = `<span style="color:#718096;">Cancelled${cancelledByText}</span>`;
            } else {
              attendanceDisplay = s.status || '-';
            }
          }

          return `<tr>
            <td>#${s.session_number}</td>
            <td>${t.date}</td>
            <td>${t.time}</td>
            <td>${attendanceDisplay}</td>
            <td>${materials}</td>
            <td>${hwStatus}</td>
            <td>${feedbackBtn}</td>
          </tr>`;
        }).join('');
    }

    async function loadHomeworkSessions() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        // Include completed sessions AND group sessions where student was absent (so they can still submit HW after watching recording)
        const completed = sessions.filter(s => s.status === 'Completed' || (s.source_type === 'Group' && s.student_attendance === 'Absent'));
        const sel = document.getElementById('homeworkSessionSelect');

        if (completed.length === 0) {
          sel.innerHTML = '<option value="">No completed sessions yet</option>';
          return;
        }

        sel.innerHTML = '<option value="">Select Session...</option>' + completed.map(s => {
          const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
          return `<option value="${s.id}">Session #${s.session_number} - ${t.date}</option>`;
        }).join('');

        // Also load submitted homework
        loadSubmittedHomework();
      } catch(e) {
        console.error('Error loading homework sessions:', e);
      }
    }

    async function loadSubmittedHomework() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/homework`, { headers: authHeaders() });
        const submissions = await res.json();
        const container = document.getElementById('submittedHomeworkList');

        if (!submissions || submissions.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No homework submitted yet. Upload your first homework above!</p>';
          return;
        }

        container.innerHTML = submissions.map(hw => {
          const fileExt = hw.file_name ? hw.file_name.split('.').pop().toLowerCase() : '';
          const fileIcon = ['mp4', 'mov', 'avi'].includes(fileExt) ? 'ğŸ¥' :
                          ['jpg', 'jpeg', 'png', 'gif'].includes(fileExt) ? 'ğŸ–¼ï¸' :
                          ['pdf'].includes(fileExt) ? 'ğŸ“„' :
                          ['doc', 'docx'].includes(fileExt) ? 'ğŸ“' :
                          ['ppt', 'pptx'].includes(fileExt) ? 'ğŸ“Š' : 'ğŸ“';

          const gradeDisplay = hw.feedback_grade
            ? `<span style="background: #38a169; color: white; padding: 3px 10px; border-radius: 4px; font-size: 0.85rem;">${hw.feedback_grade}</span>`
            : '<span style="color: #f6ad55; font-size: 0.85rem;">â³ Pending Review</span>';

          const feedbackDisplay = hw.feedback_comments
            ? `<p style="color: #4a5568; font-size: 0.9rem; margin-top: 8px; padding: 10px; background: #f0fff4; border-radius: 6px;"><strong>Teacher's Feedback:</strong> ${hw.feedback_comments}</p>`
            : '';

          // Build proper file URL for viewing
          let fileUrl = '';
          let viewText = 'View';
          if (hw.file_path) {
            if (hw.file_path.startsWith('LINK:')) {
              fileUrl = hw.file_path.replace('LINK:', '');
              viewText = 'Open Link';
            } else if (hw.file_path.startsWith('https://') || hw.file_path.startsWith('http://')) {
              // Cloudinary or external URL - use directly
              fileUrl = hw.file_path;
            } else if (hw.file_path.startsWith('/uploads/')) {
              fileUrl = hw.file_path;
            } else if (/^\d+-\d+/.test(hw.file_path)) {
              // This is a Cloudinary public_id - construct the full URL
              // Use 'raw' for non-image files (pdf, docx, etc) and 'image' for images
              // Note: homework files go to fluentfeathers/homework folder in Cloudinary
              const isImageFile = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
              const resourceType = isImageFile ? 'image' : 'raw';
              const folder = hw.uploaded_by === 'Parent' ? 'homework' : 'materials';
              fileUrl = `https://res.cloudinary.com/divz4aavx/${resourceType}/upload/fluentfeathers/${folder}/${hw.file_path}`;
            } else {
              fileUrl = '/uploads/homework/' + hw.file_path;
            }
          }

          // Determine file type for preview
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
          const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(fileExt);
          const isPdf = ['pdf'].includes(fileExt);
          const isDoc = ['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(fileExt);

          // Create view button based on file type
          let viewButton = '';
          if (fileUrl && !hw.file_path.startsWith('LINK:')) {
            if (isImage) {
              viewButton = `<button onclick="previewFile('${fileUrl}', 'image', '${hw.file_name || 'Image'}')" style="background: #9f7aea; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">View</button>`;
            } else if (isVideo) {
              viewButton = `<button onclick="previewFile('${fileUrl}', 'video', '${hw.file_name || 'Video'}')" style="background: #9f7aea; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">View</button>`;
            } else if (isPdf) {
              viewButton = `<button onclick="previewFile('${fileUrl}', 'pdf', '${hw.file_name || 'PDF'}')" style="background: #9f7aea; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">View</button>`;
            } else if (isDoc) {
              viewButton = `<button onclick="previewFile('${fileUrl}', 'doc', '${hw.file_name || 'Document'}')" style="background: #9f7aea; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">View</button>`;
            } else {
              viewButton = `<button onclick="previewFile('${fileUrl}', 'other', '${hw.file_name || 'File'}')" style="background: #9f7aea; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">View</button>`;
            }
          } else if (fileUrl && hw.file_path.startsWith('LINK:')) {
            viewButton = `<a href="${fileUrl}" target="_blank" style="background: #9f7aea; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; text-decoration: none;">Open Link</a>`;
          }

          // Create proper download URL with filename
          const downloadUrl = fileUrl && !hw.file_path.startsWith('LINK:') ? getDownloadUrl(fileUrl, hw.file_name || 'homework') : '';

          return `
            <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #B05D9E;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                  <strong style="color: #2d3748;">${fileIcon} Session #${hw.session_number || 'N/A'}</strong>
                  <p style="color: #718096; font-size: 0.85rem; margin: 5px 0;">
                    ${hw.file_name || 'File'} â€¢ Uploaded ${hw.uploaded_at ? new Date(hw.uploaded_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A'}
                  </p>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  ${gradeDisplay}
                  ${viewButton}
                  ${downloadUrl ? `<a href="${downloadUrl}" download="${hw.file_name || 'download'}" style="background: #667eea; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; text-decoration: none;">â¬‡ï¸ Download</a>` : ''}
                  <button onclick="deleteHomework(${hw.id})" style="background: #e53e3e; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Delete</button>
                </div>
              </div>
              ${feedbackDisplay}
            </div>
          `;
        }).join('');
      } catch(e) {
        console.error('Error loading submitted homework:', e);
        document.getElementById('submittedHomeworkList').innerHTML = '<p style="color: #e53e3e;">Error loading submissions</p>';
      }
    }

    async function loadCancelDropdown() {
      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const upcoming = sessions.filter(s => {
          if (!s.session_date) return false;
          return s.session_date >= today && (s.status === 'Pending' || s.status === 'Scheduled');
        });

        const sel = document.getElementById('cancelClassSelect');

        if (upcoming.length === 0) {
           sel.innerHTML = '<option>No cancellable classes</option>';
           return;
        }

        sel.innerHTML = '<option value="">Select Class...</option>' + upcoming.map(s => {
            const t = toLocalTime(s.session_date, s.session_time, currentStudent.timezone);
            return `<option value="${s.id}">Session #${s.session_number} - ${t.date} at ${t.time}</option>`;
        }).join('');
      } catch(e) {
        console.error('Error loading cancel dropdown:', e);
      }
    }

    async function loadPayments() {
      try {
        // Load session progress - use actual data from student object
        const totalSessions = parseInt(currentStudent.total_sessions) || 0;
        const completedSessions = parseInt(currentStudent.completed_sessions) || 0;
        const missedSessions = parseInt(currentStudent.missed_sessions) || 0;
        const remainingSessions = parseInt(currentStudent.remaining_sessions) || 0;

        document.getElementById('paymentTotalSessions').textContent = totalSessions;
        document.getElementById('paymentCompletedSessions').textContent = completedSessions;
        document.getElementById('paymentMissedSessions').textContent = missedSessions;
        document.getElementById('paymentRemainingSessions').textContent = remainingSessions;

        // Load makeup credits count
        try {
          const makeupRes = await fetch('/api/students/' + currentStudent.id + '/makeup-history', { headers: authHeaders() });
          const makeupHistory = await makeupRes.json();
          const availableMakeup = makeupHistory.filter(c => c.status && c.status.toLowerCase() === 'available').length;
          document.getElementById('paymentMakeupCredits').textContent = availableMakeup;
        } catch (e) {
          document.getElementById('paymentMakeupCredits').textContent = '0';
        }

        // Show renewal warning if 2 or fewer sessions remaining
        if (remainingSessions <= 2 && remainingSessions >= 0) {
          document.getElementById('renewalWarning').style.display = 'block';
        } else {
          document.getElementById('renewalWarning').style.display = 'none';
        }

        // Load initial payment info
        document.getElementById('displayInitialPayment').textContent = `${currentStudent.currency} ${currentStudent.fees_paid}`;
        document.getElementById('displayTotalPaid').textContent = `${currentStudent.currency} ${currentStudent.fees_paid}`;
        document.getElementById('displayPaymentMethod').textContent = currentStudent.payment_method || '-';
        document.getElementById('displayCurrency').textContent = currentStudent.currency;

        // Load payment renewals
        const res = await fetch(`/api/students/${currentStudent.id}/renewals`, { headers: authHeaders() });
        const renewals = await res.json();
        const container = document.getElementById('paymentHistoryContainer');

        // Calculate total paid including renewals
        const initialPayment = parseFloat(currentStudent.fees_paid) || 0;
        const renewalTotal = renewals.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
        const totalPaid = initialPayment + renewalTotal;
        document.getElementById('displayTotalPaid').textContent = `${currentStudent.currency} ${totalPaid.toFixed(2)}`;

        if (renewals.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096;">No renewal payments yet</p>';
          return;
        }

        container.innerHTML = renewals.map(r => `
          <div class="payment-history-item">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: #B05D9E; font-size: 18px;">${r.currency} ${r.amount}</strong>
                <p style="color: #4a5568; margin-top: 5px;">+${r.sessions_added} sessions added</p>
                <p style="color: #718096; font-size: 0.9rem; margin-top: 5px;">Payment Method: ${r.payment_method || 'N/A'}</p>
                ${r.notes ? `<p style="color: #718096; font-size: 0.9rem; font-style: italic;">${r.notes}</p>` : ''}
              </div>
              <div style="text-align: right;">
                <span style="background: #38a169; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.85rem;">${r.status}</span>
                <p style="color: #718096; margin-top: 5px; font-size: 0.9rem;">${new Date(r.renewal_date).toLocaleDateString()}</p>
              </div>
            </div>
          </div>
        `).join('');
      } catch(e) {
        console.error('Error loading payments:', e);
        document.getElementById('paymentHistoryContainer').innerHTML = '<p style="color: #e53e3e;">Error loading payment history</p>';
      }
    }

    async function checkForFeedback() {
      // Only show feedback popup ONCE per login session - completely optional
      if (sessionStorage.getItem('feedbackPopupShown_' + currentStudent.id)) return;

      try {
        const res = await fetch(`/api/sessions/${currentStudent.id}`, { headers: authHeaders() });
        const sessions = await res.json();

        // Find ALL completed sessions without feedback (exclude absent/missed students)
        const unratedSessions = sessions.filter(s => {
          // Must be completed
          if (s.status !== 'Completed') return false;
          // Skip if already has feedback
          if (s.has_feedback === true) return false;
          // For group sessions, check student_attendance - skip if absent
          if (s.source_type === 'Group' && s.student_attendance && s.student_attendance.toLowerCase() === 'absent') return false;
          // For private sessions, status would be 'Missed' not 'Completed' if absent, but double check
          if (s.status === 'Missed' || s.status === 'Absent' || s.status === 'Cancelled') return false;
          return true;
        });

        // Get the MOST RECENT unrated session (highest session_number)
        // Sort by session_number descending and take the first one
        if (unratedSessions.length > 0) {
          const mostRecentUnrated = unratedSessions.sort((a, b) => {
            // Sort by session_number descending (highest first)
            return (b.session_number || 0) - (a.session_number || 0);
          })[0];

          // Mark popup as shown for this specific session - so we show next session next time
          const shownKey = `feedbackPopupShown_${currentStudent.id}_session_${mostRecentUnrated.id}`;
          if (sessionStorage.getItem(shownKey)) return;

          sessionStorage.setItem(shownKey, 'true');
          // Also set a general flag to not show multiple popups in one session
          sessionStorage.setItem('feedbackPopupShown_' + currentStudent.id, 'true');

          // Show the optional feedback popup for the most recent unrated session
          openFeedbackModal(mostRecentUnrated.id, mostRecentUnrated.session_number);
        }
      } catch(e) {
        console.error('Error checking feedback:', e);
      }
    }

    // Legacy functions kept for compatibility
    function showFeedbackModal(session) {
      openFeedbackModal(session.id, session.session_number);
    }

    // Star rating interaction (for legacy support)
    document.addEventListener('DOMContentLoaded', () => {
      // No longer needed - using new star system
    });

    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (selectedRating === 0) {
        alert('Please select a star rating');
        return;
      }

      const sessionId = document.getElementById('feedbackSessionId').value;
      const feedbackText = document.getElementById('feedbackTextArea').value;

      try {
        const res = await fetch(`/api/sessions/${sessionId}/feedback`, {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type': 'application/json'},
          body: JSON.stringify({
            student_id: currentStudent.id,
            rating: selectedRating,
            feedback_text: feedbackText
          })
        });

        if (res.ok) {
          alert('Thank you for your feedback! ğŸŒŸ');
          closeFeedbackModal();
          loadBadges(); // Reload badges as feedback might award one
          loadPast(); // Refresh past classes to show feedback given
        } else {
          alert('Error submitting feedback');
        }
      } catch(e) {
        console.error('Feedback submission error:', e);
        alert('Error submitting feedback');
      }
    });

    document.getElementById('cancelClassForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sid = document.getElementById('cancelClassSelect').value;
      if(!sid) return alert('Please select a class to cancel');

      if (!confirm('Are you sure you want to cancel this class? You will receive a makeup credit.')) return;

      try {
        const res = await fetch('/api/parent/cancel-class', {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type':'application/json'},
          body: JSON.stringify({ student_id: currentStudent.id, session_id: sid })
        });

        const data = await res.json();

        if(res.ok) {
          alert(data.message || 'Class cancelled successfully! Makeup credit added.');
          loadUpcoming();
          loadCancelDropdown();
          loadMakeupCredits();
        } else {
          alert(data.error || 'Cannot cancel this class');
        }
      } catch(e) {
        console.error('Cancel error:', e);
        alert('Error cancelling class');
      }
    });

    document.getElementById('uploadHomeworkForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sid = document.getElementById('homeworkSessionSelect').value;
      const files = document.getElementById('homeworkFile').files;
      if(!sid || files.length === 0) return alert('Please select a session and at least one file');

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';

      let successCount = 0;
      let errorCount = 0;

      try {
        // Upload each file separately
        for (let i = 0; i < files.length; i++) {
          const fd = new FormData();
          fd.append('file', files[i]);
          fd.append('sessionId', sid);
          fd.append('uploadType', 'homework');

          try {
            const res = await fetch(`/api/upload/homework/${currentStudent.id}`, {
              method: 'POST',
              headers: authHeaders(),
              body: fd
            });

            if(res.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch(err) {
            errorCount++;
          }
        }

        if (successCount > 0) {
          alert(`âœ… ${successCount} file(s) uploaded successfully!${errorCount > 0 ? ` (${errorCount} failed)` : ''}`);
          e.target.reset();
          loadPast();
          loadBadges();
          loadSubmittedHomework();
        } else {
          alert('Error uploading files');
        }
      } catch(err) {
        console.error('Upload error:', err);
        alert('Error uploading homework');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“¤ Upload Homework';
      }
    });

    // Preview file in modal - supports all file types
    function previewFile(url, fileType, fileName) {
      // Remove any existing modal
      const existingModal = document.getElementById('filePreviewModal');
      if (existingModal) existingModal.remove();

      let content = '';

      if (fileType === 'image') {
        content = `<img src="${url}" style="max-width: 95%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);" onerror="this.parentElement.innerHTML='<p style=color:white;>Error loading image. <a href=${url} target=_blank style=color:#9f7aea;>Click here to download</a></p>'">`;
      } else if (fileType === 'video') {
        content = `
          <video controls autoplay style="max-width: 95%; max-height: 85vh; border-radius: 8px;">
            <source src="${url}">
            Your browser does not support video playback.
          </video>`;
      } else if (fileType === 'pdf') {
        // For Cloudinary raw URLs, use direct embed first, then Google Docs as fallback
        const isCloudinaryRaw = url.includes('cloudinary.com') && url.includes('/raw/');
        const googleViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;

        if (isCloudinaryRaw) {
          // For Cloudinary raw PDFs, try direct object embed first (faster and more reliable)
          content = `
            <object data="${url}" type="application/pdf" style="width: 95vw; max-width: 1200px; height: 85vh; border-radius: 8px; background: white;">
              <iframe src="${googleViewerUrl}" style="width: 95vw; max-width: 1200px; height: 85vh; border: none; border-radius: 8px; background: white;"></iframe>
            </object>
            <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">If the document doesn't load, <a href="${url}" target="_blank" style="color: #9f7aea;">click here to open directly</a></p>`;
        } else {
          content = `
            <iframe src="${googleViewerUrl}" style="width: 95vw; max-width: 1200px; height: 85vh; border: none; border-radius: 8px; background: white;"></iframe>
            <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">If the document doesn't load, <a href="${url}" target="_blank" style="color: #9f7aea;">click here to download</a></p>`;
        }
      } else if (fileType === 'doc') {
        // Use Microsoft Office Online viewer for Word/PPT/Excel
        const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        const googleViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
        content = `
          <iframe src="${officeViewerUrl}" style="width: 95vw; max-width: 1200px; height: 85vh; border: none; border-radius: 8px; background: white;" onerror="this.src='${googleViewerUrl}'"></iframe>
          <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">If the document doesn't load, <a href="${url}" target="_blank" style="color: #9f7aea;">click here to download</a></p>`;
      } else {
        // For other file types, show download prompt
        content = `
          <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 400px;">
            <p style="font-size: 4rem; margin-bottom: 20px;">ğŸ“</p>
            <h3 style="color: #2d3748; margin-bottom: 10px;">${fileName}</h3>
            <p style="color: #718096; margin-bottom: 20px;">This file type cannot be previewed in browser.</p>
            <a href="${url}" download="${fileName}" style="background: #9f7aea; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; display: inline-block;">Download File</a>
          </div>`;
      }

      const modal = document.createElement('div');
      modal.id = 'filePreviewModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';
      modal.innerHTML = `
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
          <a href="${url}" download="${fileName}" style="background: #667eea; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-size: 0.9rem;">â¬‡ï¸ Download</a>
          <button onclick="document.getElementById('filePreviewModal').remove()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">âœ• Close</button>
        </div>
        <p style="color: white; margin-bottom: 15px; font-size: 1.1rem;">${fileName}</p>
        ${content}
      `;

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Close on Escape key
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escHandler);
        }
      });

      document.body.appendChild(modal);
    }

    // Protected file preview - View only with watermark, NO download
    function previewProtectedFile(url, fileType, fileName) {
      // Remove any existing modal
      const existingModal = document.getElementById('protectedFileModal');
      if (existingModal) existingModal.remove();

      // Get parent info for watermark
      const parentName = currentStudent?.parent_name || 'Parent';
      const studentName = currentStudent?.name || 'Student';
      const watermarkText = `${parentName} | ${studentName} | FluentFeathers`;
      const dateStr = new Date().toLocaleDateString();

      let viewerUrl = '';

      const isCloudinaryRaw = url.includes('cloudinary.com') && url.includes('/raw/');

      if (fileType === 'pdf') {
        // For Cloudinary raw PDFs, use direct URL; otherwise use Google Docs viewer
        viewerUrl = isCloudinaryRaw ? url : `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
      } else if (fileType === 'doc') {
        // Use Google Docs viewer for PPT/Word/Excel (more restrictive than Office Online)
        viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
      } else if (fileType === 'image') {
        viewerUrl = url;
      } else {
        // For unsupported types, show message
        viewerUrl = '';
      }

      // Create dense watermark pattern (multiple diagonal watermarks covering entire area)
      let watermarkHtml = '';
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 5; col++) {
          const top = row * 14;
          const left = col * 22 + (row % 2) * 10;
          watermarkHtml += `<div style="position: absolute; top: ${top}%; left: ${left}%; transform: rotate(-25deg); white-space: nowrap; color: rgba(176, 93, 158, 0.25); font-size: 16px; font-weight: bold; pointer-events: none; user-select: none; text-shadow: 1px 1px 2px rgba(255,255,255,0.5);">${watermarkText}</div>`;
        }
      }

      const modal = document.createElement('div');
      modal.id = 'protectedFileModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';

      if (fileType === 'doc') {
        // PPT/Word/Excel - Use Google Docs viewer with protective overlays
        const docViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
        modal.innerHTML = `
          <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; align-items: center; z-index: 1002;">
            <span style="background: linear-gradient(135deg, #B05D9E, #8B4789); color: white; padding: 8px 15px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">ğŸ”’ View Only - No Downloads</span>
            <button onclick="document.getElementById('protectedFileModal').remove()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">âœ• Close</button>
          </div>
          <p style="color: white; margin-bottom: 10px; font-size: 1.1rem;">ğŸ“Š ${fileName}</p>
          <p style="color: #f6ad55; margin-bottom: 15px; font-size: 0.85rem;">ğŸ“‹ Viewing as: ${parentName} | ${dateStr}</p>
          <div style="position: relative; width: 95vw; max-width: 1200px; height: 80vh; background: white; border-radius: 8px; overflow: hidden;" oncontextmenu="return false;" onselectstart="return false;" ondragstart="return false;">
            <iframe src="${docViewerUrl}" style="width: 100%; height: 100%; border: none;" sandbox="allow-scripts allow-same-origin" allow=""></iframe>
            <!-- Dense watermark overlay -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden; z-index: 1000;">
              ${watermarkHtml}
            </div>
            <!-- Top toolbar blocker with Fluent Feathers Academy branding -->
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 55px; background: linear-gradient(135deg, #B05D9E 0%, #8B4789 100%); pointer-events: auto; display: flex; align-items: center; justify-content: center; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
              <span style="color: white; font-weight: 700; font-size: 1.1rem; letter-spacing: 1px;">ğŸ“ FLUENT FEATHERS ACADEMY - Class Material</span>
            </div>
            <!-- Bottom blocker to hide download options -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 50px; background: linear-gradient(to top, #B05D9E, rgba(176,93,158,0.8)); pointer-events: auto; z-index: 1001; display: flex; align-items: center; justify-content: center;">
              <span style="color: white; font-size: 0.85rem; opacity: 0.9;">ğŸ”’ Protected Material - For Learning Purposes Only</span>
            </div>
            <!-- Right side blocker for any side menus -->
            <div style="position: absolute; top: 55px; right: 0; width: 50px; height: calc(100% - 105px); background: linear-gradient(to left, rgba(176,93,158,0.95), transparent); pointer-events: auto; z-index: 1001;"></div>
          </div>
          <p style="color: #a0aec0; margin-top: 10px; font-size: 0.8rem;">âš ï¸ This material is for viewing only. Downloading or sharing is not permitted.</p>
        `;
      } else if (viewerUrl && fileType === 'pdf') {
        // PDF - Use object embed for Cloudinary raw URLs, iframe for Google Docs viewer
        const pdfViewerContent = isCloudinaryRaw
          ? `<object data="${viewerUrl}" type="application/pdf" style="width: 100%; height: 100%; border: none;">
               <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true" style="width: 100%; height: 100%; border: none;"></iframe>
             </object>`
          : `<iframe src="${viewerUrl}" style="width: 100%; height: 100%; border: none;" sandbox="allow-scripts allow-same-origin" allow=""></iframe>`;

        modal.innerHTML = `
          <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; align-items: center;">
            <span style="background: linear-gradient(135deg, #f6ad55, #ed8936); color: #744210; padding: 8px 15px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">ğŸ”’ View Only - No Downloads</span>
            <button onclick="document.getElementById('protectedFileModal').remove()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">âœ• Close</button>
          </div>
          <p style="color: white; margin-bottom: 10px; font-size: 1.1rem;">ğŸ“„ ${fileName}</p>
          <p style="color: #f6ad55; margin-bottom: 15px; font-size: 0.85rem;">ğŸ“‹ Viewing as: ${parentName} | ${dateStr}</p>
          <div style="position: relative; width: 95vw; max-width: 1200px; height: 80vh; background: white; border-radius: 8px; overflow: hidden;" oncontextmenu="return false;" onselectstart="return false;" ondragstart="return false;">
            ${pdfViewerContent}
            <!-- Dense watermark overlay -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden; z-index: 1000;">
              ${watermarkHtml}
            </div>
            <!-- Top toolbar blocker with Fluent Feathers Academy branding -->
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 55px; background: linear-gradient(135deg, #B05D9E 0%, #8B4789 100%); pointer-events: auto; display: flex; align-items: center; justify-content: center; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
              <span style="color: white; font-weight: 700; font-size: 1.1rem; letter-spacing: 1px;">ğŸ“ FLUENT FEATHERS ACADEMY - Class Material</span>
            </div>
            <!-- Bottom blocker -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 45px; background: linear-gradient(to top, rgba(176,93,158,0.95), transparent); pointer-events: auto; z-index: 1001;"></div>
          </div>
          <p style="color: #a0aec0; margin-top: 10px; font-size: 0.8rem;">âš ï¸ This material is for viewing only. Downloading or sharing is not permitted.</p>
        `;
      } else if (fileType === 'image') {
        // Create multiple watermarks for images
        let imgWatermarks = '';
        for (let i = 0; i < 5; i++) {
          const top = 15 + i * 18;
          imgWatermarks += `<div style="position: absolute; top: ${top}%; left: 50%; transform: translate(-50%, -50%) rotate(-25deg); white-space: nowrap; color: rgba(176, 93, 158, 0.35); font-size: 20px; font-weight: bold; pointer-events: none; user-select: none; text-shadow: 2px 2px 4px rgba(255,255,255,0.8);">${watermarkText}</div>`;
        }
        modal.innerHTML = `
          <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; align-items: center;">
            <span style="background: linear-gradient(135deg, #f6ad55, #ed8936); color: #744210; padding: 8px 15px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">ğŸ”’ View Only</span>
            <button onclick="document.getElementById('protectedFileModal').remove()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">âœ• Close</button>
          </div>
          <p style="color: white; margin-bottom: 10px; font-size: 1.1rem;">ğŸ“Š ${fileName}</p>
          <p style="color: #f6ad55; margin-bottom: 15px; font-size: 0.85rem;">ğŸ“‹ Viewing as: ${parentName} | ${dateStr}</p>
          <div style="position: relative; display: inline-block;" oncontextmenu="return false;" onselectstart="return false;" ondragstart="return false;">
            <img src="${url}" style="max-width: 95vw; max-height: 75vh; border-radius: 8px;" draggable="false" onmousedown="return false;" oncopy="return false;">
            <!-- Multiple watermark overlays for images -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;">
              ${imgWatermarks}
            </div>
          </div>
          <p style="color: #a0aec0; margin-top: 10px; font-size: 0.8rem;">âš ï¸ This material is for viewing only. Downloading or sharing is not permitted.</p>
        `;
      } else {
        modal.innerHTML = `
          <div style="position: absolute; top: 20px; right: 20px;">
            <button onclick="document.getElementById('protectedFileModal').remove()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">âœ• Close</button>
          </div>
          <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 400px;">
            <p style="font-size: 4rem; margin-bottom: 20px;">ğŸ”’</p>
            <h3 style="color: #2d3748; margin-bottom: 10px;">${fileName}</h3>
            <p style="color: #718096; margin-bottom: 10px;">This file type cannot be previewed in the browser.</p>
            <p style="color: #e53e3e; font-size: 0.9rem;">Downloads are disabled for class materials.</p>
          </div>
        `;
      }

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Close on Escape key
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escHandler);
        }
      });

      // Disable keyboard shortcuts for saving/printing
      modal.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'p' || e.key === 'S' || e.key === 'P')) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });

      document.body.appendChild(modal);
    }

    // Delete homework submission
    async function deleteHomework(homeworkId) {
      if (!confirm('Are you sure you want to delete this homework submission?')) return;

      try {
        const res = await fetch(`/api/homework/${homeworkId}`, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (res.ok) {
          alert('Homework deleted successfully!');
          loadSubmittedHomework();
          loadPast();
        } else {
          const data = await res.json();
          alert(data.error || 'Error deleting homework');
        }
      } catch (e) {
        console.error('Delete error:', e);
        alert('Error deleting homework');
      }
    }

    // ==================== CLASS FEEDBACK ====================
    function openFeedbackModal(sessionId, sessionNumber) {
      document.getElementById('feedbackSessionId').value = sessionId;
      document.getElementById('feedbackSessionNum').textContent = sessionNumber;
      selectedRating = 0;
      document.getElementById('feedbackTextArea').value = '';
      // Reset stars
      document.querySelectorAll('#starRatingContainer .star').forEach(s => s.textContent = 'â˜†');
      document.getElementById('feedbackModal').classList.add('active');
    }

    function closeFeedbackModal() {
      document.getElementById('feedbackModal').classList.remove('active');
      selectedRating = 0;
    }

    function setRating(rating) {
      selectedRating = rating;
      document.querySelectorAll('#starRatingContainer .star').forEach(s => {
        const starNum = parseInt(s.getAttribute('data-rating'));
        s.textContent = starNum <= rating ? 'â­' : 'â˜†';
      });
    }

    async function loadEvents() {
      try {
        const res = await fetch(`/api/events/student/${currentStudent.id}`, { headers: authHeaders() });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const events = await res.json();
        const container = document.getElementById('eventsContainer');

        if (events.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No upcoming events</p>';
          return;
        }

        container.innerHTML = events.map(e => {
          const t = toLocalTime(e.event_date, e.event_time, currentStudent.timezone);
          return `
          <div style="background:white; border:1px solid #ddd; padding:15px; margin-bottom:10px; border-radius:8px;">
            <h3 style="color: #B05D9E; margin-bottom: 10px;">${e.event_name}</h3>
            <p style="margin-bottom: 10px;">${e.event_description || ''}</p>
            <p><strong>ğŸ“… Date:</strong> ${t.date} | <strong>ğŸ• Time:</strong> ${t.time}</p>
            ${!e.is_registered ? `<button onclick="registerEvent(${e.id})" class="btn btn-primary" style="margin-top:10px; width: auto; padding: 10px 20px;">Register Now</button>` : '<span style="color:green; font-weight: bold;">âœ“ Registered</span>'}
          </div>`;
        }).join('');
      } catch(e) {
        console.error('Error loading events:', e);
        document.getElementById('eventsContainer').innerHTML = '<p style="color: #e53e3e; text-align: center; padding: 20px;">Error loading events. Please try again later.</p>';
      }
    }

    async function registerEvent(eid) {
      try {
        const res = await fetch(`/api/events/${eid}/register`, {
          method: 'POST',
          headers: {...authHeaders(), 'Content-Type':'application/json'},
          body: JSON.stringify({ student_id: currentStudent.id })
        });

        const data = await res.json();

        if(res.ok) {
          alert(data.message || 'Successfully registered for event!');
          loadEvents();
        } else {
          alert(data.error || 'Registration failed');
        }
      } catch(e) {
        console.error('Registration error:', e);
        alert('Error registering for event');
      }
    }

    // ==================== RESOURCE LIBRARY ====================
    async function loadParentResources() {
      try {
        const category = document.getElementById('parentResourceCategory')?.value || 'all';
        const grade = currentStudent?.grade || 'all';
        let url = '/api/resources/library?';
        if (category !== 'all') url += 'category=' + encodeURIComponent(category) + '&';
        if (grade !== 'all') url += 'grade=' + encodeURIComponent(grade);

        const res = await fetch(url, { headers: authHeaders() });
        const resources = await res.json();

        const container = document.getElementById('parentResourcesGrid');

        if (resources.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: #718096;"><div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“š</div><p>No resources available in this category yet.</p><p style="font-size: 0.9rem;">Check back soon for new learning materials!</p></div>';
          return;
        }

        container.innerHTML = resources.map(r => {
          const typeIcon = getParentResourceIcon(r.category);
          const resourceUrl = r.external_link || r.file_path;
          const isFeatured = r.is_featured;
          const cardBg = isFeatured ? 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)' : 'white';
          const textColor = isFeatured ? '#333' : '#2d3748';
          const encodedUrl = encodeURIComponent(resourceUrl);
          const borderStyle = isFeatured ? '3px solid #f6ad55' : '1px solid #e2e8f0';

          // Check if it's a downloadable file (uploaded file, not external link)
          const isDownloadable = r.file_path && !r.external_link;
          // Create proper download URL with filename
          const downloadUrl = isDownloadable ? getDownloadUrl(resourceUrl, r.title) : '';

          let html = '<div class="resource-card" style="background: ' + cardBg + '; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; border: ' + borderStyle + ';">';
          html += '<div style="padding: 20px; text-align: center;">';
          if (isFeatured) {
            html += '<div style="background: #e53e3e; color: white; padding: 3px 12px; border-radius: 15px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-bottom: 10px;">â­ FEATURED</div>';
          }
          html += '<div style="font-size: 3rem; margin-bottom: 10px;">' + typeIcon + '</div>';
          html += '<h3 style="color: ' + textColor + '; margin: 0 0 8px 0; font-size: 1.1rem; line-height: 1.3;">' + escapeHtml(r.title) + '</h3>';
          html += '<span style="background: rgba(176, 93, 158, 0.15); color: #B05D9E; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">' + r.category + '</span>';
          if (r.description) {
            html += '<p style="color: #718096; font-size: 0.85rem; margin-top: 12px; line-height: 1.4;">' + escapeHtml(r.description) + '</p>';
          }
          html += '<div style="margin-top: 12px;">';
          html += '<span style="background: #e2e8f0; padding: 4px 10px; border-radius: 10px; font-size: 0.75rem; color: #4a5568;">' + (r.grade_level || 'All Grades') + '</span>';
          html += '</div>';

          // Action buttons - View and Download (Resources tab allows all downloads)
          html += '<div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">';
          html += '<button data-action="view" data-id="' + r.id + '" data-url="' + encodedUrl + '" style="background: #B05D9E; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: background 0.2s;">ğŸ‘ View</button>';

          if (isDownloadable) {
            // For uploaded files - show download button with proper filename
            html += '<a href="' + downloadUrl + '" download="' + escapeHtml(r.title || 'download') + '" style="background: #38a169; color: white; text-decoration: none; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block;">ğŸ“¥ Download</a>';
          } else {
            // For external links (YouTube, Canva, etc.) - show link indicator
            html += '<span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem;">ğŸ”— Opens in Browser</span>';
          }

          html += '</div>';
          html += '</div></div>';
          return html;
        }).join('');

        // Add click handlers for view buttons
        container.querySelectorAll('[data-action="view"]').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const id = this.dataset.id;
            const url = decodeURIComponent(this.dataset.url);
            openResource(id, url);
          });
          // Hover effect for button
          btn.addEventListener('mouseenter', function() { this.style.background = '#9A4D88'; });
          btn.addEventListener('mouseleave', function() { this.style.background = '#B05D9E'; });
        });

        // Add hover effects to cards
        container.querySelectorAll('.resource-card').forEach(card => {
          card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
          });
          card.addEventListener('mouseleave', function() {
            this.style.transform = 'none';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
          });
        });
      } catch (err) {
        console.error('Error loading resources:', err);
        document.getElementById('parentResourcesGrid').innerHTML = '<p style="color: #e53e3e; text-align: center; grid-column: 1/-1;">Error loading resources</p>';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getParentResourceIcon(category) {
      const icons = {
        'Videos': 'ğŸ¬',
        'Worksheets': 'ğŸ“',
        'PDFs': 'ğŸ“„',
        'Practice': 'âœï¸',
        'Games': 'ğŸ®',
        'Stories': 'ğŸ“–',
        'Other': 'ğŸ“¦'
      };
      return icons[category] || 'ğŸ“š';
    }

    // Helper to create proper download URL for Cloudinary files
    function getDownloadUrl(url, filename) {
      if (!url) return url;

      // For Cloudinary URLs, add fl_attachment transformation
      if (url.includes('cloudinary.com')) {
        try {
          const urlObj = new URL(url);
          const pathParts = urlObj.pathname.split('/');
          const uploadIndex = pathParts.indexOf('upload');

          if (uploadIndex !== -1) {
            // Get file extension from URL
            const lastPart = pathParts[pathParts.length - 1];
            const ext = lastPart.includes('.') ? '.' + lastPart.split('.').pop() : '.pdf';
            const safeFilename = (filename || 'download').replace(/[^a-zA-Z0-9]/g, '_') + ext;

            // Insert fl_attachment after 'upload' for forced download
            pathParts.splice(uploadIndex + 1, 0, 'fl_attachment:' + safeFilename);
            urlObj.pathname = pathParts.join('/');
            return urlObj.toString();
          }
        } catch (e) {
          console.error('Error creating download URL:', e);
        }
      }
      return url;
    }

    function openResource(resourceId, url) {
      // Track view count
      fetch('/api/resources/' + resourceId + '/view', { method: 'POST', headers: authHeaders() }).catch(function() {});
      // Open resource in new tab
      window.open(url, '_blank');
    }

    // Position certificate text elements using JS (more reliable than CSS %)
    function positionCertText(certId) {
      const img = document.getElementById('cert-bg-img-' + certId);
      if (!img) return;
      const imgHeight = img.offsetHeight;

      // Position title at 17% from top
      const titleEl = document.getElementById('cert-title-' + certId);
      if (titleEl) {
        titleEl.style.top = (imgHeight * 0.17) + 'px';
        titleEl.style.opacity = '1';
      }

      // Position name at 36% from top
      const nameEl = document.getElementById('cert-name-' + certId);
      if (nameEl) {
        nameEl.style.top = (imgHeight * 0.36) + 'px';
        nameEl.style.opacity = '1';
      }

      // Position date at 87% from top
      const dateEl = document.getElementById('cert-date-' + certId);
      if (dateEl) {
        dateEl.style.top = (imgHeight * 0.87) + 'px';
        dateEl.style.opacity = '1';
      }
    }

    async function loadAssessments() {
      try {
        const res = await fetch(`/api/students/${currentStudent.id}/assessments`, { headers: authHeaders() });
        const assessments = await res.json();
        const container = document.getElementById('assessmentsContainer');

        if (assessments.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No monthly assessments yet. Your teacher will share progress reports soon! ğŸ“Š</p>';
          return;
        }

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        container.innerHTML = assessments.map(a => {
          const skills = a.skills ? JSON.parse(a.skills) : [];

          return `
          <div style="background: white; border: 1px solid #e2e8f0; padding: 25px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%); padding: 20px; margin: -25px -25px 20px -25px; border-radius: 12px 12px 0 0; text-align: center;">
              <div style="font-size: 40px; margin-bottom: 8px;">ğŸ“Š</div>
              <h3 style="margin: 0; color: white; font-size: 22px;">Monthly Progress Report</h3>
              <p style="margin: 5px 0 0; color: rgba(255,255,255,0.95); font-size: 16px; font-weight: 600;">${monthNames[a.month - 1]} ${a.year}</p>
            </div>

            ${a.certificate_title ? `
            <!-- Award Card Display -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 15px; padding: 25px; text-align: center; margin-bottom: 15px;">
              <div style="font-size: 50px; margin-bottom: 10px;">ğŸ†</div>
              <h3 style="color: #92400e; font-size: 22px; margin: 0 0 15px; font-family: 'Georgia', serif;">${a.certificate_title}</h3>
              <p style="color: #b45309; font-size: 14px; margin: 0 0 8px;">Presented to</p>
              <h2 style="color: #C41E3A; font-size: 26px; margin: 0 0 15px; font-family: 'Georgia', serif; text-transform: uppercase;">${currentStudent.name}</h2>
              <p style="color: #78716c; font-size: 13px; margin: 0;">${monthNames[a.month - 1]} ${a.year}</p>
            </div>

            <!-- Download Button -->
            <div style="text-align: center; margin-bottom: 15px;">
              <button onclick="downloadCertificate(${a.id}, '${currentStudent.name.replace(/'/g, "\\'")}', '${a.certificate_title.replace(/'/g, "\\'")}', '${monthNames[a.month - 1]}', ${a.year})"
                      style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">
                ğŸ“¥ Download Certificate PDF
              </button>
            </div>
            ` : ''}

            ${skills.length > 0 ? `
            <!-- Skills -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 12px; display: flex; align-items: center; gap: 6px;">
                <span>ğŸ“</span> Skills Assessed
              </h4>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${skills.map(skill => `
                <span style="background: #f7fafc; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #B05D9E; font-size: 12px; color: #4a5568; font-weight: 600;">
                  âœ“ ${skill}
                </span>
                `).join('')}
              </div>
            </div>
            ` : ''}

            ${a.performance_summary ? `
            <!-- Performance -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 10px; display: flex; align-items: center; gap: 6px;">
                <span>ğŸ“ˆ</span> Performance Summary
              </h4>
              <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border-left: 3px solid #38b2ac;">
                <p style="margin: 0; color: #2d3748; font-size: 14px; line-height: 1.6;">${a.performance_summary}</p>
              </div>
            </div>
            ` : ''}

            ${a.areas_of_improvement ? `
            <!-- Improvement Areas -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 10px; display: flex; align-items: center; gap: 6px;">
                <span>ğŸ“Œ</span> Areas to Focus On
              </h4>
              <div style="background: #fff5f5; padding: 15px; border-radius: 8px; border-left: 3px solid #fc8181;">
                <p style="margin: 0; color: #2d3748; font-size: 14px; line-height: 1.6;">${a.areas_of_improvement}</p>
              </div>
            </div>
            ` : ''}

            ${a.teacher_comments ? `
            <!-- Teacher Comments -->
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2d3748; font-size: 16px; margin: 0 0 10px; display: flex; align-items: center; gap: 6px;">
                <span>ğŸ’¬</span> Teacher's Comments
              </h4>
              <div style="background: #fef5e7; padding: 15px; border-radius: 8px; border-left: 3px solid #f6ad55;">
                <p style="margin: 0; color: #2d3748; font-size: 14px; line-height: 1.6; font-style: italic;">"${a.teacher_comments}"</p>
              </div>
            </div>
            ` : ''}

            <!-- Footer -->
            <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px; margin-top: 20px;">
              <p style="margin: 0; color: #B05D9E; font-size: 13px; font-weight: 600;">
                ğŸ“… Issued: ${new Date(a.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
              </p>
            </div>
          </div>
          `;
        }).join('');
      } catch(e) {
        console.error('Error loading assessments:', e);
        document.getElementById('assessmentsContainer').innerHTML = '<p style="color: #e53e3e;">Error loading assessments</p>';
      }
    }

    // Download Certificate as PDF
    async function downloadCertificate(assessmentId, studentName, certTitle, month, year) {
      const certElement = document.getElementById(`certificate-${assessmentId}`);
      if (!certElement) {
        alert('Certificate not found');
        return;
      }

      // Show loading
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'â³ Generating PDF...';
      btn.disabled = true;

      try {
        const { jsPDF } = window.jspdf;

        // Capture the certificate as canvas
        const canvas = await html2canvas(certElement, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        });

        // Create PDF in landscape for better certificate look
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4'
        });

        const imgWidth = 297; // A4 landscape width in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // Center vertically if image is shorter than page
        const pageHeight = 210; // A4 landscape height
        const yOffset = imgHeight < pageHeight ? (pageHeight - imgHeight) / 2 : 0;

        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, yOffset, imgWidth, imgHeight);

        // Download the PDF
        const fileName = `Certificate_${studentName.replace(/\s+/g, '_')}_${month}_${year}.pdf`;
        pdf.save(fileName);

        btn.innerHTML = 'âœ… Downloaded!';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      } catch (err) {
        console.error('PDF generation error:', err);
        alert('Error generating PDF. Please try again.');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function loadAnnouncements() {
      try {
        const res = await fetch('/api/announcements');
        const announcements = await res.json();
        const container = document.getElementById('announcementsContainer');

        if (announcements.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No announcements at this time</p>';
          return;
        }

        container.innerHTML = announcements.map(a => {
          const priorityColor = a.priority === 'Urgent' ? '#e53e3e' : a.priority === 'High' ? '#f6ad55' : '#B05D9E';
          const typeIcons = {
            'Holiday': 'ğŸ‰',
            'Reminder': 'â°',
            'Update': 'ğŸ“¢',
            'Challenge Update': 'ğŸ†',
            'Competition Update': 'ğŸ¯',
            'Results': 'ğŸ¥‡',
            'General': 'ğŸ“°'
          };
          const typeIcon = typeIcons[a.announcement_type] || 'ğŸ“°';

          // Image HTML if exists
          const imageHtml = a.image_url ? `
            <div style="margin: 15px 0; text-align: center;">
              <img src="${a.image_url}" style="max-width: 100%; max-height: 400px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer;" onclick="window.open('${a.image_url}', '_blank')" title="Click to view full size">
            </div>
          ` : '';

          return `
          <div style="background: white; border: 1px solid #e2e8f0; border-left: 4px solid ${priorityColor}; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <h3 style="margin: 0; color: ${priorityColor}; font-size: 18px;">${typeIcon} ${a.title}</h3>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span style="background: #e2e8f0; color: #4a5568; padding: 4px 10px; border-radius: 10px; font-size: 11px;">${a.announcement_type}</span>
                <span style="background: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${a.priority}</span>
              </div>
            </div>
            <p style="margin: 0; color: #4a5568; line-height: 1.6; white-space: pre-wrap;">${a.content}</p>
            ${imageHtml}
            <p style="margin: 10px 0 0; color: #718096; font-size: 13px;">ğŸ“… ${new Date(a.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
          </div>
          `;
        }).join('');
      } catch(e) {
        console.error('Error loading announcements:', e);
        document.getElementById('announcementsContainer').innerHTML = '<p style="color: #e53e3e;">Error loading announcements</p>';
      }
    }

    // ==================== PROFILE FUNCTIONS ====================
    function loadProfile() {
      if (!currentStudent) return;

      // Student info (read-only)
      document.getElementById('profileStudentName').textContent = currentStudent.name || '-';
      document.getElementById('profileStudentGrade').textContent = currentStudent.grade || '-';
      document.getElementById('profileProgram').textContent = currentStudent.program_name || '-';
      document.getElementById('profileClassType').textContent = currentStudent.class_type || '-';

      // Parent info (editable)
      document.getElementById('profileParentName').value = currentStudent.parent_name || '';
      document.getElementById('profileEmail').value = currentStudent.parent_email || '';
      document.getElementById('profileContact').value = currentStudent.primary_contact || '';
      document.getElementById('profileAltContact').value = currentStudent.alternate_contact || '';

      // Additional details
      document.getElementById('profileDOB').value = currentStudent.date_of_birth ? currentStudent.date_of_birth.split('T')[0] : '';
      document.getElementById('profileTimezone').value = currentStudent.timezone || 'Asia/Kolkata';
    }

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const updates = {
        parent_name: document.getElementById('profileParentName').value,
        parent_email: document.getElementById('profileEmail').value,
        primary_contact: document.getElementById('profileContact').value,
        alternate_contact: document.getElementById('profileAltContact').value,
        date_of_birth: document.getElementById('profileDOB').value || null
      };

      try {
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const res = await fetch(`/api/students/${currentStudent.id}/profile`, {
          method: 'PUT',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });

        const result = await res.json();

        if (res.ok) {
          alert('âœ… Profile updated successfully!');
          // Update local data
          currentStudent.parent_name = updates.parent_name;
          currentStudent.parent_email = updates.parent_email;
          currentStudent.primary_contact = updates.primary_contact;
          currentStudent.alternate_contact = updates.alternate_contact;
          currentStudent.date_of_birth = updates.date_of_birth;
        } else {
          alert('âŒ Failed: ' + (result.error || 'Unknown error'));
        }

        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Save Changes';
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    function logout() {
      if(confirm('Are you sure you want to logout?')) {
        // Clear persistent login session
        localStorage.removeItem('parentSession');
        localStorage.removeItem('parentActiveTab');
        // Clear admin view session
        sessionStorage.removeItem('adminParentToken');
        sessionStorage.removeItem('parentViewStudent');
        sessionStorage.removeItem('parentViewMode');
        location.reload();
      }
    }
  </script>

  <!-- Footer -->
  <footer style="background: white; padding: 20px; text-align: center; margin-top: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
    <p style="margin: 0; color: #B05D9E; font-size: 14px; font-weight: 600;">Made with â¤ï¸ By Aaliya</p>
  </footer>
</body>
</html>
