<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Fluent Feathers Academy By Aaliya</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; color: #2d3748; }

    /* Sidebar Layout */
    .app-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 240px; background: linear-gradient(180deg, #B05D9E 0%, #8B4789 100%); color: white; position: fixed; height: 100vh; overflow-y: auto; padding: 20px 0; }
    .sidebar-header { padding: 10px 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
    .sidebar-header h2 { font-size: 18px; margin-bottom: 5px; }
    .sidebar-header p { font-size: 11px; opacity: 0.8; }
    .sidebar-nav { padding: 0 10px; }
    .nav-btn { width: 100%; padding: 12px 15px; background: transparent; border: none; color: white; text-align: left; cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 8px; margin-bottom: 4px; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
    .nav-btn:hover { background: rgba(255,255,255,0.15); }
    .nav-btn.active { background: rgba(255,255,255,0.25); font-weight: 600; }

    .main-content { margin-left: 240px; flex: 1; padding: 20px 30px; }
    header { background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    header h1 { color: #B05D9E; font-size: 24px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #B05D9E; }
    .stat-card h3 { color: #718096; font-size: 0.85rem; margin-bottom: 8px; }
    .stat-card .value { font-size: 1.8rem; font-weight: bold; color: #2d3748; }

    /* Hide old tabs - now using sidebar */
    .tabs { display: none; }
    .tab-btn { padding: 12px 24px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: #B05D9E; color: white; border-color: #B05D9E; }

    /* Responsive */
    @media (max-width: 900px) {
      .sidebar { width: 60px; }
      .sidebar-header h2, .sidebar-header p, .nav-btn span { display: none; }
      .nav-btn { justify-content: center; padding: 12px; }
      .main-content { margin-left: 60px; padding: 15px; }
      header { flex-direction: column; align-items: flex-start; }
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
    .section h2 { color: #2d3748; margin-bottom: 20px; font-size: 1.5rem; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #B05D9E; color: white; }
    .btn-primary:hover { background: #9A4D88; }
    .btn-success { background: #38a169; color: white; }
    .btn-success:hover { background: #2f855a; }
    .btn-warning { background: #ed8936; color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-danger:hover { background: #c53030; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; color: #4a5568; font-weight: 600; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
    .modal-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .modal-tab { padding: 10px 20px; background: #f7fafc; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .modal-tab.active { background: #B05D9E; color: white; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .upcoming-classes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .class-card { background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; }
    .schedule-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .schedule-row input { flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; }
    .session-item { background: #f7fafc; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #B05D9E; display: flex; justify-content: space-between; align-items: center; }
    .star-rating { display: flex; gap: 5px; font-size: 24px; }
    .star { cursor: default; color: #fbbf24; }
    .badge-item { display: inline-block; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 8px 16px; border-radius: 20px; margin: 5px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>ğŸ“ Fluent Feathers</h2>
        <p>Admin Dashboard</p>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-btn active" onclick="showTab('upcoming', event)">ğŸ“… <span>Upcoming</span></button>
        <button class="nav-btn" onclick="showTab('students', event)">ğŸ‘¥ <span>Students</span></button>
        <button class="nav-btn" onclick="showTab('groups', event)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ <span>Groups</span></button>
        <button class="nav-btn" onclick="showTab('schedule', event)">ğŸ“† <span>Schedule</span></button>
        <button class="nav-btn" onclick="showTab('scheduleManager', event)">ğŸ“‹ <span>Manage Schedules</span></button>
        <button class="nav-btn" onclick="showTab('past', event)">ğŸ“š <span>Past Classes</span></button>
        <button class="nav-btn" onclick="showTab('homework', event)">ğŸ“ <span>Homework</span></button>
        <button class="nav-btn" onclick="showTab('payments', event)">ğŸ’³ <span>Payments</span></button>
        <button class="nav-btn" onclick="showTab('events', event)">ğŸ‰ <span>Events</span></button>
        <button class="nav-btn" onclick="showTab('announcements', event)">ğŸ“¢ <span>Announcements</span></button>
        <button class="nav-btn" onclick="showTab('monthlyAssessment', event)">ğŸ“Š <span>Assessment</span></button>
        <button class="nav-btn" onclick="showTab('classRatings', event)">â­ <span>Class Ratings</span></button>
        <button class="nav-btn" onclick="showTab('emails', event)">ğŸ“§ <span>Email Logs</span></button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header>
        <div>
          <h1>ğŸ“ Fluent Feathers Academy By Aaliya</h1>
          <p style="color: #718096; font-size: 13px;">Empowering Young Minds Through Language & Communication</p>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="openSwitchToLearnerModal()" class="btn btn-sm" style="background: #B05D9E; color: white; font-size: 12px;">ğŸ‘ï¸ Learner View</button>
          <button onclick="location.href='index.html'" class="btn btn-sm" style="background: #718096; color: white; font-size: 12px;">Logout</button>
        </div>
      </header>

      <div class="stats-grid">
        <div class="stat-card"><h3>Total Students</h3><div class="value" id="totalStudents">0</div></div>
        <div class="stat-card"><h3>Upcoming Sessions</h3><div class="value" id="upcomingSessions">0</div></div>
        <div class="stat-card" onclick="toggleRevenue()" style="cursor: pointer;"><h3>Total Revenue <span style="font-size: 0.7rem; color: #718096;">(click)</span></h3><div class="value" id="totalRevenue">*****</div></div>
        <div class="stat-card"><h3>Total Groups</h3><div class="value" id="totalGroups">0</div></div>
        <div class="stat-card"><h3>Active Events</h3><div class="value" id="activeEvents">0</div></div>
      </div>

      <!-- Old tabs hidden, kept for JS compatibility -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('upcoming', event)">ğŸ“… Upcoming</button>
        <button class="tab-btn" onclick="showTab('students', event)">ğŸ‘¥ Students</button>
        <button class="tab-btn" onclick="showTab('groups', event)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Groups</button>
        <button class="tab-btn" onclick="showTab('schedule', event)">ğŸ“† Schedule</button>
        <button class="tab-btn" onclick="showTab('scheduleManager', event)">ğŸ“‹ Manage Schedules</button>
        <button class="tab-btn" onclick="showTab('past', event)">ğŸ“š Past Classes</button>
        <button class="tab-btn" onclick="showTab('homework', event)">ğŸ“ Homework</button>
        <button class="tab-btn" onclick="showTab('payments', event)">ğŸ’³ Payments</button>
        <button class="tab-btn" onclick="showTab('events', event)">ğŸ‰ Events</button>
        <button class="tab-btn" onclick="showTab('announcements', event)">ğŸ“¢ Announcements</button>
        <button class="tab-btn" onclick="showTab('monthlyAssessment', event)">ğŸ“Š Monthly Assessment</button>
        <button class="tab-btn" onclick="showTab('classRatings', event)">â­ Class Ratings</button>
        <button class="tab-btn" onclick="showTab('emails', event)">ğŸ“§ Email Logs</button>
      </div>

      <div id="upcomingTab" class="tab-content active">
      <div class="section"><h2>ğŸ“… Upcoming Classes</h2><div id="upcomingClassesGrid" class="upcoming-classes-grid"><p>Loading...</p></div></div>
    </div>

    <div id="studentsTab" class="tab-content">
      <div class="section"><h2>â• Add New Student</h2>
        <form id="addStudentForm">
          <div class="form-row"><div class="form-group"><label>Student Name *</label><input type="text" id="studentName" required></div><div class="form-group"><label>Grade *</label><input type="text" id="grade" required></div></div>
          <div class="form-row"><div class="form-group"><label>Parent Name *</label><input type="text" id="parentName" required></div><div class="form-group"><label>Parent Email *</label><input type="email" id="parentEmail" required></div></div>
          <div class="form-row">
            <div class="form-group"><label>Primary Contact *</label><input type="tel" id="primaryContact" required></div>
            <div class="form-group"><label>Date of Birth (Optional)</label><input type="date" id="dateOfBirth"></div>
            <div class="form-group"><label>Timezone *</label>
              <select id="timezone" required>
                <option value="Asia/Kolkata">India (IST)</option>
                <option value="America/New_York">USA East (EST/EDT)</option>
                <option value="America/Chicago">USA Central (CST/CDT)</option>
                <option value="America/Denver">USA Mountain (MST/MDT)</option>
                <option value="America/Los_Angeles">USA West (PST/PDT)</option>
                <option value="America/Toronto">Canada (EST/EDT)</option>
                <option value="Europe/London">UK (GMT/BST)</option>
                <option value="Europe/Paris">France/Germany (CET/CEST)</option>
                <option value="Europe/Moscow">Russia (MSK)</option>
                <option value="Asia/Dubai">UAE (GST)</option>
                <option value="Asia/Singapore">Singapore (SGT)</option>
                <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                <option value="Asia/Tokyo">Japan (JST)</option>
                <option value="Australia/Sydney">Australia East (AEST/AEDT)</option>
                <option value="Pacific/Auckland">New Zealand (NZST/NZDT)</option>
              </select>
            </div>
          </div>
          <div class="form-row"><div class="form-group"><label>Program Name *</label><input type="text" id="programName" required></div><div class="form-group"><label>Class Type *</label><select id="classType" required><option value="Private">Private</option><option value="Group">Group</option></select></div></div>
          <div class="form-row">
            <div class="form-group"><label>Duration *</label>
              <select id="duration" required>
                <option value="25 mins">25 mins</option>
                <option value="30 mins">30 mins</option>
                <option value="40 mins">40 mins</option>
                <option value="45 mins">45 mins</option>
                <option value="60 mins">60 mins</option>
              </select>
            </div>
            <div class="form-group"><label>Currency *</label>
              <select id="currency" required>
                <option value="USD">USD ($)</option>
                <option value="INR">INR (â‚¹)</option>
                <option value="GBP">GBP (Â£)</option>
                <option value="EUR">EUR (â‚¬)</option>
                <option value="AED">AED (Ø¯.Ø¥)</option>
                <option value="AUD">AUD ($)</option>
                <option value="CAD">CAD ($)</option>
                <option value="SGD">SGD ($)</option>
                <option value="HKD">HKD ($)</option>
                <option value="JPY">JPY (Â¥)</option>
                <option value="NZD">NZD ($)</option>
                <option value="RUB">RUB (â‚½)</option>
              </select>
            </div>
            <div class="form-group"><label>Per Session Fee *</label><input type="number" id="perSessionFee" required step="0.01"></div>
            <div class="form-group"><label>Total Sessions *</label><input type="number" id="totalSessions" required min="1"></div>
            <div class="form-group"><label>Payment Method</label>
              <select id="paymentMethod">
                <option value="">Select Method</option>
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Online Payment">Online Payment</option>
                <option value="Cheque">Cheque</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
              <input type="checkbox" id="sendWelcomeEmail" checked style="width: auto; margin: 0;">
              <label style="margin: 0;">Send Welcome Email</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Add Student</button>
        </form>
      </div>
      <div class="section"><h2>ğŸ“‹ All Students</h2><table id="studentsTable"><thead><tr><th>Name</th><th>Grade</th><th>Program</th><th>Type</th><th>Sessions (C/R)</th><th>Makeup</th><th>Actions</th></tr></thead><tbody id="studentsBody"><tr><td colspan="7">Loading...</td></tr></tbody></table></div>
    </div>

    <div id="groupsTab" class="tab-content">
      <div class="section"><h2>â• Create New Group</h2><form id="createGroupForm">
        <div class="form-row"><div class="form-group"><label>Group Name *</label><input type="text" id="groupName" required></div><div class="form-group"><label>Program Name *</label><input type="text" id="groupProgram" required></div></div>
        <div class="form-row">
            <div class="form-group"><label>Duration *</label>
                <select id="groupDuration" required>
                    <option value="25 mins">25 mins</option>
                    <option value="30 mins">30 mins</option>
                    <option value="40 mins">40 mins</option>
                    <option value="45 mins">45 mins</option>
                    <option value="60 mins">60 mins</option>
                </select>
            </div>
            <div class="form-group"><label>Timezone *</label>
                <select id="groupTimezone" required>
                    <option value="Asia/Kolkata">India (IST)</option>
                    <option value="America/New_York">USA (EST)</option>
                    <option value="Europe/London">UK (GMT)</option>
                </select>
            </div>
            <div class="form-group"><label>Max Students *</label><input type="number" id="groupMaxStudents" value="10" required></div>
        </div><button type="submit" class="btn btn-primary">Create Group</button></form></div>
      <div class="section"><h2>ğŸ“‹ All Groups</h2><table id="groupsTable"><thead><tr><th>Group Name</th><th>Program</th><th>Duration</th><th>Students</th><th>Max</th><th>Actions</th></tr></thead><tbody id="groupsBody"><tr><td colspan="6">Loading...</td></tr></tbody></table></div>
    </div>

    <div id="scheduleTab" class="tab-content">
      <div class="section"><h2>ğŸ“… Schedule Classes</h2>
        <div class="form-group" style="margin-bottom: 20px;"><label>Schedule Type *</label><select id="scheduleType" onchange="handleScheduleTypeChange()"><option value="private">Private Session</option><option value="group">Group Session</option></select></div>
        <form id="schedulePrivateForm">
          <div class="form-group"><label>Select Student *</label><select id="scheduleStudent" required><option value="">Select student...</option></select></div>
          <div id="classScheduleList"></div><button type="button" onclick="addScheduleRow()" class="btn btn-primary" style="background:#718096; margin-top:10px;">+ Add Class</button>
          <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-top: 15px;">
            <input type="checkbox" id="sendPrivateScheduleEmail" checked style="width: auto; margin: 0;">
            <label style="margin: 0;">Send Schedule Confirmation Email</label>
          </div>
          <button type="submit" class="btn btn-primary" style="margin-top:10px;">Schedule</button>
        </form>
        <form id="scheduleGroupForm" style="display: none;">
          <div class="form-group"><label>Select Group *</label><select id="scheduleGroup" required><option value="">Select group...</option></select></div>
          <div id="groupClassScheduleList"></div><button type="button" onclick="addGroupScheduleRow()" class="btn btn-primary" style="background:#718096; margin-top:10px;">+ Add Class</button>
          <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-top: 15px;">
            <input type="checkbox" id="sendGroupScheduleEmail" checked style="width: auto; margin: 0;">
            <label style="margin: 0;">Send Schedule Confirmation Email</label>
          </div>
          <button type="submit" class="btn btn-primary" style="margin-top:10px;">Schedule</button>
        </form>
      </div>
    </div>

    <div id="scheduleManagerTab" class="tab-content">
      <div class="section">
        <h2>ğŸ“‹ Manage Student Schedules</h2>
        <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
          <label>Select Student</label>
          <select id="manageScheduleStudent" onchange="loadStudentSchedule()">
            <option value="">Select student...</option>
          </select>
        </div>
        <div id="studentScheduleContainer"></div>
      </div>
    </div>

    <div id="pastTab" class="tab-content">
      <div class="section"><h2>ğŸ“š Past Classes & Materials</h2><table id="pastSessionsTable"><thead><tr><th>Date (IST)</th><th>Student/Group</th><th>Type</th><th>Session #</th><th>Attendance</th><th>Materials</th><th>Feedback</th><th>Actions</th></tr></thead><tbody id="pastSessionsBody"><tr><td colspan="8">Loading...</td></tr></tbody></table></div>
    </div>

    <!-- Homework Submissions Tab -->
    <div id="homeworkTab" class="tab-content">
      <div class="section">
        <h2>ğŸ“ Student Homework Submissions</h2>
        <p style="color: #718096; margin-bottom: 20px;">View and grade homework submitted by students from the Parent Portal</p>
        <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
          <label>Filter by Student</label>
          <select id="homeworkFilterStudent" onchange="loadHomeworkSubmissions()">
            <option value="">All Students</option>
          </select>
        </div>
        <table id="homeworkTable">
          <thead>
            <tr>
              <th>Student</th>
              <th>Session #</th>
              <th>File</th>
              <th>Submitted</th>
              <th>Grade</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="homeworkBody">
            <tr><td colspan="6" style="text-align: center; color: #718096;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="eventsTab" class="tab-content">
      <div class="section"><h2>ğŸ‰ Create New Event</h2><form id="createEventForm">
        <div class="form-row">
          <div class="form-group"><label>Event Name *</label><input type="text" id="eventName" required></div>
          <div class="form-group"><label>Event Duration *</label>
            <select id="eventDuration" required>
              <option value="25 mins">25 mins</option>
              <option value="30 mins">30 mins</option>
              <option value="40 mins">40 mins</option>
              <option value="45 mins">45 mins</option>
              <option value="60 mins">60 mins</option>
              <option value="90 mins">90 mins</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Event Description</label><textarea id="eventDescription" rows="3"></textarea></div>
        <div class="form-row"><div class="form-group"><label>Date *</label><input type="date" id="eventDate" required></div><div class="form-group"><label>Time (IST) *</label><input type="time" id="eventTime" required></div></div>
        <div class="form-row">
          <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
            <input type="checkbox" id="sendEventEmail" checked style="width: auto; margin: 0;">
            <label style="margin: 0;">Send Event Notification Email</label>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Create Event</button>
      </form></div>
      <div class="section"><h2>ğŸ“‹ All Events</h2><table id="eventsTable"><thead><tr><th>Event Name</th><th>Date (IST)</th><th>Time (IST)</th><th>Duration</th><th>Registered</th><th>Status</th><th>Actions</th></tr></thead><tbody id="eventsBody"><tr><td colspan="7">Loading...</td></tr></tbody></table></div>
    </div>

    <!-- Class Ratings Tab -->
    <div id="classRatingsTab" class="tab-content">
      <div class="section">
        <h2>â­ Class Ratings & Feedback</h2>
        <p style="color: #718096; margin-bottom: 20px;">View feedback and ratings submitted by parents after attending classes.</p>

        <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
          <div>
            <label style="font-weight: 600; margin-right: 8px;">Filter by Student:</label>
            <select id="ratingsStudentFilter" onchange="loadClassRatings()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="">All Students</option>
            </select>
          </div>
          <div>
            <label style="font-weight: 600; margin-right: 8px;">Filter by Rating:</label>
            <select id="ratingsRatingFilter" onchange="loadClassRatings()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="">All Ratings</option>
              <option value="5">â­â­â­â­â­ (5 Stars)</option>
              <option value="4">â­â­â­â­ (4 Stars)</option>
              <option value="3">â­â­â­ (3 Stars)</option>
              <option value="2">â­â­ (2 Stars)</option>
              <option value="1">â­ (1 Star)</option>
            </select>
          </div>
          <button onclick="loadClassRatings()" class="btn btn-primary">ğŸ”„ Refresh</button>
        </div>

        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
          <div style="background: linear-gradient(135deg, #B05D9E, #8B4789); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;" id="avgRating">-</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Avg Rating</div>
          </div>
          <div style="background: linear-gradient(135deg, #38a169, #2f855a); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;" id="totalFeedbacks">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Total Feedbacks</div>
          </div>
          <div style="background: linear-gradient(135deg, #ecc94b, #d69e2e); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;" id="fiveStarCount">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">5-Star Ratings</div>
          </div>
        </div>

        <!-- Feedback List -->
        <div id="ratingsContainer" style="display: grid; gap: 15px;">
          <p style="color: #718096; text-align: center; padding: 30px;">Loading feedback...</p>
        </div>
      </div>
    </div>

    <div id="emailsTab" class="tab-content"><div class="section"><h2>ğŸ“§ Email Logs</h2><table id="emailLogsTable"><thead><tr><th>Date/Time</th><th>Recipient</th><th>Type</th><th>Subject</th><th>Status</th></tr></thead><tbody id="emailLogsBody"><tr><td colspan="5">Loading...</td></tr></tbody></table></div></div>

    <div id="announcementsTab" class="tab-content">
      <div class="section">
        <h2>ğŸ“¢ Create Announcement</h2>
        <form id="createAnnouncementForm">
          <div class="form-row">
            <div class="form-group"><label>Title *</label><input type="text" id="announcementTitle" required></div>
            <div class="form-group"><label>Type</label>
              <select id="announcementType">
                <option value="General">General</option>
                <option value="Holiday">Holiday</option>
                <option value="Reminder">Reminder</option>
                <option value="Update">Update</option>
              </select>
            </div>
            <div class="form-group"><label>Priority</label>
              <select id="announcementPriority">
                <option value="Normal">Normal</option>
                <option value="High">High</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>Content *</label><textarea id="announcementContent" rows="4" required placeholder="Write your announcement here..."></textarea></div>
          <button type="submit" class="btn btn-primary">Create Announcement</button>
        </form>
      </div>
      <div class="section">
        <h2>ğŸ“‹ All Announcements</h2>
        <table id="announcementsTable">
          <thead><tr><th>Title</th><th>Type</th><th>Priority</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="announcementsBody"><tr><td colspan="5">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div id="monthlyAssessmentTab" class="tab-content">
      <div class="section">
        <h2>ğŸ“Š Monthly Assessment & Certificate</h2>
        <form id="monthlyAssessmentForm">
          <div class="form-row">
            <div class="form-group"><label>Student *</label>
              <select id="assessmentStudent" required>
                <option value="">Select Student...</option>
              </select>
            </div>
            <div class="form-group"><label>Month *</label>
              <select id="assessmentMonth" required>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>
            <div class="form-group"><label>Year *</label>
              <input type="number" id="assessmentYear" required value="2026" min="2020" max="2030">
            </div>
          </div>

          <h3 style="margin-top: 20px; color: #4a5568;">ğŸ“ Skills Assessment (Tick applicable areas)</h3>

          <!-- Phonics Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">ğŸ”¤ PHONICS</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #fef5e7; border-radius: 8px; border-left: 4px solid #f6ad55;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_letter_sounds" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ”Š Letter Sounds Recognition</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_blending" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ”— Blending Sounds</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_segmenting" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">âœ‚ï¸ Segmenting Words</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_sight_words" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ‘ï¸ Sight Words</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_phonemic_awareness" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ‘‚ Phonemic Awareness</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_decoding" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ”“ Decoding Skills</span>
              </label>
            </div>
          </div>

          <!-- Reading Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">ğŸ“– READING</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38b2ac;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_reading_fluency" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“š Reading Fluency</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_reading_comprehension" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ§  Reading Comprehension</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_reading_expression" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ­ Reading with Expression</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_story_understanding" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“• Story Understanding</span>
              </label>
            </div>
          </div>

          <!-- Spoken English Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">ğŸ—£ï¸ SPOKEN ENGLISH</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #ebf8ff; border-radius: 8px; border-left: 4px solid #B05D9E;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_speaking" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ—£ï¸ Speaking & Communication</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_pronunciation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ¯ Pronunciation</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_confidence" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ’ª Confidence Building</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_listening" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ‘‚ Active Listening</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_conversation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ’¬ Conversation Skills</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_sentence_formation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“ Sentence Formation</span>
              </label>
            </div>
          </div>

          <!-- Grammar Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">ğŸ“– GRAMMAR</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #faf5ff; border-radius: 8px; border-left: 4px solid #9f7aea;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_grammar" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“– Grammar & Structure</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_tenses" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">â° Tenses</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_punctuation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">â— Punctuation</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_parts_of_speech" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ·ï¸ Parts of Speech</span>
              </label>
            </div>
          </div>

          <!-- Vocabulary Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">ğŸ“š VOCABULARY</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #fff5f5; border-radius: 8px; border-left: 4px solid #fc8181;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_vocabulary" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“š Vocabulary Enhancement</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_spelling" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ”¤ Spelling Mastery</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_word_meanings" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“– Word Meanings</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_synonyms_antonyms" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ”„ Synonyms & Antonyms</span>
              </label>
            </div>
          </div>

          <!-- Creative Writing Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">âœï¸ CREATIVE WRITING</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #48bb78;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_writing" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">âœï¸ Creative Writing</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_story_writing" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“ Story Writing</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_essay_writing" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“„ Essay Writing</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_handwriting" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">âœï¸ Handwriting</span>
              </label>
            </div>
          </div>

          <!-- Public Speaking Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">ğŸ¤ PUBLIC SPEAKING</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #fffaf0; border-radius: 8px; border-left: 4px solid #ed8936;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_public_speaking" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ¤ Public Speaking</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_presentation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“Š Presentation Skills</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_storytelling" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ“– Storytelling</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_debate" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸ’­ Debate Skills</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_stage_presence" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">ğŸŒŸ Stage Presence</span>
              </label>
            </div>
          </div>

          <h3 style="margin-top: 20px; color: #4a5568;">ğŸ† Award Certificate (Optional)</h3>
          <div class="form-row">
            <div class="form-group"><label>Certificate Title</label>
              <select id="certificateTitle">
                <option value="">No Certificate</option>
                <optgroup label="ğŸ”¤ Phonics">
                  <option value="Phonics Star">ğŸ”¤ Phonics Star</option>
                  <option value="Sound Master">ğŸ”Š Sound Master</option>
                  <option value="Blending Champion">ğŸ”— Blending Champion</option>
                </optgroup>
                <optgroup label="ğŸ“– Reading">
                  <option value="Avid Reader">ğŸ“š Avid Reader</option>
                  <option value="Reading Rockstar">ğŸ“– Reading Rockstar</option>
                  <option value="Fluent Reader">ğŸŒŸ Fluent Reader</option>
                </optgroup>
                <optgroup label="ğŸ—£ï¸ Spoken English">
                  <option value="Superb Speaker">ğŸ—£ï¸ Superb Speaker</option>
                  <option value="Confident Communicator">ğŸ’¬ Confident Communicator</option>
                  <option value="Excellent Listener">ğŸ‘‚ Excellent Listener</option>
                  <option value="Pronunciation Pro">ğŸ¯ Pronunciation Pro</option>
                </optgroup>
                <optgroup label="ğŸ“– Grammar">
                  <option value="Grammar Guru">ğŸ“– Grammar Guru</option>
                  <option value="Grammar Champion">ğŸ† Grammar Champion</option>
                </optgroup>
                <optgroup label="ğŸ“š Vocabulary">
                  <option value="Vocabulary Virtuoso">ğŸ“• Vocabulary Virtuoso</option>
                  <option value="Spelling Champion">ğŸ”¤ Spelling Champion</option>
                  <option value="Word Wizard">âœ¨ Word Wizard</option>
                </optgroup>
                <optgroup label="âœï¸ Creative Writing">
                  <option value="Creative Writing Star">âœï¸ Creative Writing Star</option>
                  <option value="Story Teller">ğŸ“ Story Teller</option>
                  <option value="Writing Wizard">âœ¨ Writing Wizard</option>
                </optgroup>
                <optgroup label="ğŸ¤ Public Speaking">
                  <option value="Public Speaking Pro">ğŸ¤ Public Speaking Pro</option>
                  <option value="Confident Performer">ğŸ’« Confident Performer</option>
                  <option value="Stage Star">ğŸŒŸ Stage Star</option>
                  <option value="Debate Champion">ğŸ’­ Debate Champion</option>
                </optgroup>
                <optgroup label="â­ General">
                  <option value="Star Student">â­ Star Student</option>
                  <option value="Most Improved">ğŸš€ Most Improved</option>
                  <option value="Outstanding Performer">ğŸ… Outstanding Performer</option>
                  <option value="Best Effort">ğŸ’ª Best Effort</option>
                </optgroup>
                <option value="Custom">âœï¸ Custom Title...</option>
              </select>
            </div>
            <div class="form-group" id="customTitleGroup" style="display: none;">
              <label>Custom Title</label>
              <input type="text" id="customCertificateTitle" placeholder="Enter custom certificate title">
            </div>
          </div>

          <div class="form-group"><label>Overall Performance Summary</label><textarea id="performanceSummary" rows="4" placeholder="Write a brief summary of the student's progress this month..."></textarea></div>

          <div class="form-group"><label>Areas of Improvement</label><textarea id="areasOfImprovement" rows="3" placeholder="Mention areas where the student can focus for better results..."></textarea></div>

          <div class="form-group"><label>Teacher's Comments</label><textarea id="teacherComments" rows="3" placeholder="Any additional comments or encouragement..."></textarea></div>

          <div class="form-row">
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
              <input type="checkbox" id="sendAssessmentEmail" checked style="width: auto; margin: 0;">
              <label style="margin: 0;">Send Report Card & Certificate via Email</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Generate & Send Report Card</button>
        </form>
      </div>
      <div class="section">
        <h2>ğŸ“‹ All Monthly Assessments</h2>
        <table id="assessmentsTable">
          <thead><tr><th>Student</th><th>Month/Year</th><th>Certificate</th><th>Skills</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="assessmentsBody"><tr><td colspan="6">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="paymentsTab" class="tab-content">
      <div class="section">
        <h2>ğŸ’³ Payment Management</h2>
        <div class="form-row">
          <div class="form-group"><label>Select Student</label>
            <select id="paymentStudent" onchange="loadStudentPaymentDetails()">
              <option value="">Select Student...</option>
            </select>
          </div>
        </div>
        <div id="paymentStudentDetails" style="display: none; margin-top: 20px;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #B05D9E; margin-bottom: 15px;">Student Payment Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div><strong>Name:</strong> <span id="payStudentName">-</span></div>
              <div><strong>Total Sessions:</strong> <span id="payTotalSessions">-</span></div>
              <div><strong>Remaining:</strong> <span id="payRemainingSessions" style="color: #e53e3e;">-</span></div>
              <div><strong>Total Paid:</strong> <span id="payTotalPaid" style="color: #38a169;">-</span></div>
            </div>
          </div>

          <!-- Add First Payment Form -->
          <div class="section" style="background: #e6fffa; border: 2px solid #38b2ac;">
            <h3 style="color: #2c7a7b; margin-bottom: 15px;">ğŸ’° Record First Payment</h3>
            <form id="firstPaymentForm">
              <div class="form-row">
                <div class="form-group"><label>Amount *</label><input type="number" id="firstPaymentAmount" step="0.01" required></div>
                <div class="form-group"><label>Currency</label><select id="firstPaymentCurrency"><option value="INR">INR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="EUR">EUR</option><option value="AED">AED</option></select></div>
                <div class="form-group"><label>Sessions Covered</label><input type="number" id="firstPaymentSessions"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Payment Method</label>
                  <select id="firstPaymentMethod">
                    <option value="UPI">UPI</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Card">Card</option>
                    <option value="Cash">Cash</option>
                  </select>
                </div>
                <div class="form-group"><label>Receipt Number</label><input type="text" id="firstPaymentReceipt"></div>
              </div>
              <div class="form-group"><label>Notes</label><textarea id="firstPaymentNotes" rows="2"></textarea></div>
              <div class="form-row" style="align-items: center; gap: 20px;">
                <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                  <input type="checkbox" id="sendFirstPaymentEmail" style="width: auto; margin: 0;">
                  <label style="margin: 0;">Send Payment Confirmation Email</label>
                </div>
                <button type="submit" class="btn btn-primary">Record Payment</button>
              </div>
            </form>
          </div>

          <!-- Add Renewal Payment Form -->
          <div class="section" style="background: #fef5e7; border: 2px solid #f6ad55;">
            <h3 style="color: #c05621; margin-bottom: 15px;">ğŸ”„ Record Renewal Payment</h3>
            <form id="renewalPaymentForm">
              <div class="form-row">
                <div class="form-group"><label>Amount *</label><input type="number" id="renewalPaymentAmount" step="0.01" required></div>
                <div class="form-group"><label>Sessions to Add *</label><input type="number" id="renewalPaymentSessions" required></div>
                <div class="form-group"><label>Currency</label><select id="renewalPaymentCurrency"><option value="INR">INR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="EUR">EUR</option><option value="AED">AED</option></select></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Payment Method</label>
                  <select id="renewalPaymentMethod">
                    <option value="UPI">UPI</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Card">Card</option>
                    <option value="Cash">Cash</option>
                  </select>
                </div>
                <div class="form-group"><label>Notes</label><input type="text" id="renewalPaymentNotes"></div>
              </div>
              <div class="form-row" style="align-items: center; gap: 20px;">
                <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                  <input type="checkbox" id="sendRenewalPaymentEmail" style="width: auto; margin: 0;">
                  <label style="margin: 0;">Send Payment Confirmation Email</label>
                </div>
                <button type="submit" class="btn btn-primary">Record Renewal</button>
              </div>
            </form>
          </div>

          <!-- Payment History Table -->
          <div class="section">
            <h3 style="color: #B05D9E; margin-bottom: 15px;">ğŸ“‹ Payment History</h3>
            <table id="paymentHistoryTable">
              <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Sessions</th><th>Method</th><th>Notes</th></tr></thead>
              <tbody id="paymentHistoryBody"><tr><td colspan="6" style="text-align: center; color: #718096;">Select a student to view payment history</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Switch to Learner View Modal -->
  <div id="switchToLearnerModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 style="color: #38b2ac;">ğŸ‘ï¸ Switch to Learner View</h2>
        <button onclick="closeSwitchToLearnerModal()" class="btn btn-danger btn-sm">âœ•</button>
      </div>
      <p style="color: #4a5568; margin-bottom: 20px;">Select a student to view their parent portal as admin (no password required):</p>
      <div class="form-group">
        <label>Select Student</label>
        <select id="learnerViewStudent">
          <option value="">Select Student...</option>
        </select>
      </div>
      <button onclick="switchToLearnerView()" class="btn btn-primary" style="width: 100%;">ğŸš€ Open Parent Portal</button>
    </div>
  </div>

  <!-- Event View/Edit Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 id="eventModalTitle" style="color: #B05D9E;">Event Details</h2>
        <button onclick="closeEventModal()" class="btn btn-danger btn-sm">âœ•</button>
      </div>
      <div id="eventModalContent">Loading...</div>
    </div>
  </div>

  <!-- Event Attendance Modal -->
  <div id="eventAttendanceModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 id="eventAttendanceTitle" style="color: #38a169;">Mark Event Attendance</h2>
        <button onclick="closeEventAttendanceModal()" class="btn btn-danger btn-sm">âœ•</button>
      </div>
      <div id="eventAttendanceContent">Loading...</div>
    </div>
  </div>

  <!-- Event Registrations Modal -->
  <div id="eventRegistrationsModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 id="eventRegistrationsTitle" style="color: #9f7aea;">Event Registrations</h2>
        <button onclick="closeEventRegistrationsModal()" class="btn btn-danger btn-sm">âœ•</button>
      </div>
      <div id="eventRegistrationsContent">Loading...</div>
    </div>
  </div>

  <!-- Complete Student Modal with ALL tabs -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="modalStudentName">Student Details</h2><button onclick="closeStudentModal()" class="btn btn-danger btn-sm">âœ•</button></div>

      <div class="modal-tabs">
        <button class="modal-tab active" onclick="showModalTab('info', event)">ğŸ“‹ Info</button>
        <button class="modal-tab" onclick="showModalTab('payments', event)">ğŸ’° Payments</button>
        <button class="modal-tab" onclick="showModalTab('homework', event)">ğŸ“š Homework</button>
        <button class="modal-tab" onclick="showModalTab('badges', event)">ğŸ† Badges</button>
      </div>

      <div id="infoTab" class="modal-tab-content active"><div id="studentInfoContent"></div></div>

      <div id="paymentsTab" class="modal-tab-content">
        <button onclick="showRenewalForm()" class="btn btn-primary" style="margin-bottom: 20px;">â• Add Monthly Renewal</button>
        <div id="renewalForm" style="display:none; background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
          <h3>Add Monthly Renewal</h3>
          <div class="form-row">
            <div class="form-group"><label>Amount *</label><input type="number" id="renewalAmount" step="0.01" required></div>
            <div class="form-group"><label>Sessions Added *</label><input type="number" id="renewalSessions" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Payment Method</label><input type="text" id="renewalMethod" placeholder="Cash, Card, UPI, etc."></div>
          </div>
          <div class="form-group"><label>Notes</label><textarea id="renewalNotes" rows="2"></textarea></div>
          <button onclick="submitRenewal()" class="btn btn-success">Add Renewal</button>
          <button onclick="document.getElementById('renewalForm').style.display='none'" class="btn btn-danger">Cancel</button>
        </div>
        <div id="paymentsContent">Loading...</div>
      </div>

      <div id="homeworkTab" class="modal-tab-content"><div id="homeworkContent">Loading...</div></div>
      <div id="badgesTab" class="modal-tab-content"><div id="badgesContent">Loading...</div></div>
    </div>
  </div>

  <!-- Session Modal -->
  <div id="sessionModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="modalSessionTitle">Session Details</h2><button onclick="closeSessionModal()" class="btn btn-danger btn-sm">âœ•</button></div><div id="sessionDetailsContent"></div></div></div>

  <!-- Group Enrollment Modal -->
  <div id="enrollModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="enrollModalTitle">Enroll Students</h2><button onclick="closeEnrollModal()" class="btn btn-danger btn-sm">âœ•</button></div><div id="enrollModalContent"></div></div></div>

  <!-- Edit Session Modal -->
  <div id="editSessionModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Session</h2><button onclick="closeEditSessionModal()" class="btn btn-danger btn-sm">âœ•</button></div><form id="editSessionForm"><input type="hidden" id="editSessionId"><div class="form-row"><div class="form-group"><label>Date *</label><input type="date" id="editSessionDate" required></div><div class="form-group"><label>Time *</label><input type="time" id="editSessionTime" required></div></div><button type="submit" class="btn btn-primary">Save Changes</button></form></div></div>

  <!-- Edit Student Modal -->
  <div id="editStudentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Edit Student</h2><button onclick="closeEditStudentModal()" class="btn btn-danger btn-sm">âœ•</button></div>
      <form id="updateStudentForm">
        <input type="hidden" id="editStudentId">
        <div class="form-row">
          <div class="form-group"><label>Student Name *</label><input type="text" id="editStudentName" required></div>
          <div class="form-group"><label>Grade *</label><input type="text" id="editGrade" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Parent Name *</label><input type="text" id="editParentName" required></div>
          <div class="form-group"><label>Parent Email *</label><input type="email" id="editParentEmail" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Primary Contact *</label><input type="tel" id="editPrimaryContact" required></div>
          <div class="form-group"><label>Timezone *</label><select id="editTimezone" required><option value="Asia/Kolkata">India (IST)</option><option value="America/New_York">USA (EST)</option></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Program Name *</label><input type="text" id="editProgramName" required></div>
          <div class="form-group"><label>Duration *</label><select id="editDuration" required><option value="25 mins">25 mins</option><option value="30 mins">30 mins</option><option value="40 mins">40 mins</option><option value="45 mins">45 mins</option><option value="60 mins">60 mins</option></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Currency *</label><select id="editCurrency" required><option value="USD">USD</option><option value="INR">INR</option><option value="GBP">GBP</option></select></div>
          <div class="form-group"><label>Per Session Fee *</label><input type="number" id="editPerSessionFee" required step="0.01"></div>
        </div>
        <button type="submit" class="btn btn-primary">Update Student</button>
      </form>
    </div>
  </div>

  <!-- Edit Group Modal -->
  <div id="editGroupModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Edit Group</h2><button onclick="closeEditGroupModal()" class="btn btn-danger btn-sm">âœ•</button></div>
      <form id="updateGroupForm">
        <input type="hidden" id="editGroupId">
        <div class="form-row">
          <div class="form-group"><label>Group Name *</label><input type="text" id="editGroupName" required></div>
          <div class="form-group"><label>Program Name *</label><input type="text" id="editGroupProgram" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Duration *</label><select id="editGroupDuration" required><option value="25 mins">25 mins</option><option value="30 mins">30 mins</option><option value="40 mins">40 mins</option><option value="45 mins">45 mins</option><option value="60 mins">60 mins</option></select></div>
          <div class="form-group"><label>Timezone *</label><select id="editGroupTimezone" required><option value="Asia/Kolkata">India (IST)</option><option value="America/New_York">USA (EST)</option></select></div>
          <div class="form-group"><label>Max Students *</label><input type="number" id="editGroupMaxStudents" required></div>
        </div>
        <button type="submit" class="btn btn-primary">Update Group</button>
      </form>
    </div>
  </div>

  <!-- Feedback View Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Class Feedback</h2><button onclick="closeFeedbackModal()" class="btn btn-danger btn-sm">âœ•</button></div>
      <div id="feedbackModalContent">Loading...</div>
    </div>
  </div>

  <script>
    let allStudents = [], allGroups = [];
    let currentStudentId = null;
    let currentGroupId = null;
    let actualRevenue = 0;
    let revenueVisible = false;

    function toggleRevenue() {
      revenueVisible = !revenueVisible;
      const revenueEl = document.getElementById('totalRevenue');
      if (revenueVisible) {
        revenueEl.textContent = actualRevenue.toFixed(2) + ' (Mixed)';
      } else {
        revenueEl.textContent = '*****';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadDashboardStats();
      await loadUpcomingClasses();
      await loadStudents();
      await loadGroups();
      await loadEmailLogs();
    });

    async function showTab(tabName, e) {
      if(e) e.stopPropagation();
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
      // Update old tabs (hidden but kept for compatibility)
      const oldTabBtn = document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`);
      if(oldTabBtn) oldTabBtn.classList.add('active');
      // Update sidebar nav button
      const navBtn = document.querySelector(`.nav-btn[onclick*="'${tabName}'"]`);
      if(navBtn) navBtn.classList.add('active');
      if (tabName === 'emails') loadEmailLogs();
      if (tabName === 'past') loadPastSessions();
      if (tabName === 'events') loadEvents();
      if (tabName === 'scheduleManager') loadScheduleManager();
      if (tabName === 'homework') loadHomeworkSubmissions();
      if (tabName === 'classRatings') loadClassRatings();
    }

    function showModalTab(tabName, e) {
      if(e) e.stopPropagation();
      document.querySelectorAll('.modal-tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
      if(e) e.target.classList.add('active');

      if(tabName === 'payments') loadPayments();
      if(tabName === 'homework') loadHomework();
      if(tabName === 'badges') loadBadges();
    }

    // Admin always sees IST timezone
    function formatSessionTime(session, forceIST = true) {
      try {
        if (!session.session_date || !session.session_time) return 'Invalid Date';
        const dateStr = session.session_date.includes('T') ? session.session_date.split('T')[0] : session.session_date;
        let timeStr = session.session_time.toString().trim();
        if (timeStr.length === 5) timeStr += ':00';
        const isoString = `${dateStr}T${timeStr}Z`;
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return 'Invalid Date';
        // Admin dashboard always shows IST
        return d.toLocaleString('en-US', {
          timeZone: 'Asia/Kolkata',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        });
      } catch(e) {
        return 'Invalid Date';
      }
    }

    async function loadDashboardStats() {
      try {
        const res = await fetch('/api/dashboard/stats');
        const stats = await res.json();
        document.getElementById('totalStudents').textContent = stats.totalStudents;
        document.getElementById('upcomingSessions').textContent = stats.upcomingSessions;
        // Store revenue but keep hidden by default
        actualRevenue = stats.totalRevenue;
        document.getElementById('totalRevenue').textContent = revenueVisible ? (actualRevenue.toFixed(2) + ' (Mixed)') : '*****';
        document.getElementById('totalGroups').textContent = stats.totalGroups;
        document.getElementById('activeEvents').textContent = stats.activeEvents;
      } catch (err) {
        console.error(err);
      }
    }

    async function loadUpcomingClasses() {
      try {
        const res = await fetch('/api/dashboard/upcoming-classes');
        const classes = await res.json();
        const grid = document.getElementById('upcomingClassesGrid');
        if (classes.length === 0) return grid.innerHTML = '<p>No upcoming classes</p>';
        grid.innerHTML = classes.map(cls => `<div class="class-card">
          <h3>${cls.student_name}</h3>
          <p>ğŸ“š ${cls.class_info || 'N/A'}</p>
          <p>ğŸ“… ${formatSessionTime(cls)} (IST)</p>
          <p>ğŸŒ Student TZ: ${cls.timezone}</p>
          <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
            <a href="${cls.zoom_link || '#'}" target="_blank" class="btn btn-sm" style="background:white; color:#B05D9E; text-decoration:none;">ğŸ¥ Join</a>
            <button onclick="openSessionModal(${cls.id}, '${cls.session_type}')" class="btn btn-sm" style="background:rgba(255,255,255,0.3); color:white;">âš™ï¸ Manage</button>
          </div>
        </div>`).join('');
      } catch (err) {
        console.error(err);
      }
    }

    async function loadStudents() {
      try {
        const res = await fetch('/api/students');
        allStudents = await res.json();
        const tbody = document.getElementById('studentsBody');
        tbody.innerHTML = allStudents.map(s => `<tr><td><strong>${s.name}</strong></td><td>${s.grade}</td><td>${s.program_name}</td><td>${s.class_type}</td><td>${s.completed_sessions}/${s.remaining_sessions}</td><td>${s.makeup_credits||0}</td><td><button onclick="openStudentModal(${s.id})" class="btn btn-sm btn-primary">View</button> <button onclick="editStudent(${s.id})" class="btn btn-sm btn-warning">Edit</button> <button onclick="deleteStudent(${s.id})" class="btn btn-sm btn-danger">Delete</button></td></tr>`).join('');
        document.getElementById('scheduleStudent').innerHTML = '<option value="">Select student...</option>' + allStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('manageScheduleStudent').innerHTML = '<option value="">Select student...</option>' + allStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      } catch (err) {
        console.error(err);
      }
    }

    // EDIT STUDENT
    async function editStudent(id) {
      try {
        const res = await fetch(`/api/students/${id}/full`);
        const student = await res.json();
        document.getElementById('editStudentId').value = student.id;
        document.getElementById('editStudentName').value = student.name;
        document.getElementById('editGrade').value = student.grade;
        document.getElementById('editParentName').value = student.parent_name;
        document.getElementById('editParentEmail').value = student.parent_email;
        document.getElementById('editPrimaryContact').value = student.primary_contact;
        document.getElementById('editTimezone').value = student.timezone;
        document.getElementById('editProgramName').value = student.program_name;
        document.getElementById('editDuration').value = student.duration;
        document.getElementById('editCurrency').value = student.currency;
        document.getElementById('editPerSessionFee').value = student.per_session_fee;
        document.getElementById('editStudentModal').classList.add('active');
      } catch(err) {
        alert('Error loading student: ' + err.message);
      }
    }

    document.getElementById('updateStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editStudentId').value;
      const data = {
        name: document.getElementById('editStudentName').value,
        grade: document.getElementById('editGrade').value,
        parent_name: document.getElementById('editParentName').value,
        parent_email: document.getElementById('editParentEmail').value,
        primary_contact: document.getElementById('editPrimaryContact').value,
        timezone: document.getElementById('editTimezone').value,
        program_name: document.getElementById('editProgramName').value,
        duration: document.getElementById('editDuration').value,
        currency: document.getElementById('editCurrency').value,
        per_session_fee: parseFloat(document.getElementById('editPerSessionFee').value)
      };

      try {
        const res = await fetch(`/api/students/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          closeEditStudentModal();
          loadStudents();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    function closeEditStudentModal() {
      document.getElementById('editStudentModal').classList.remove('active');
    }

    async function deleteStudent(id) {
      if(!confirm('Are you sure you want to delete this student? This will also delete all related data.')) return;
      try {
        const res = await fetch(`/api/students/${id}`, {method:'DELETE'});
        if(res.ok) {
          alert('âœ… Student deleted successfully!');
          loadStudents();
          loadDashboardStats();
        } else {
          alert('âŒ Failed to delete student');
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // EDIT GROUP
    async function editGroup(id) {
      try {
        const res = await fetch(`/api/groups/${id}/full`);
        const group = await res.json();
        document.getElementById('editGroupId').value = group.id;
        document.getElementById('editGroupName').value = group.group_name;
        document.getElementById('editGroupProgram').value = group.program_name;
        document.getElementById('editGroupDuration').value = group.duration;
        document.getElementById('editGroupTimezone').value = group.timezone;
        document.getElementById('editGroupMaxStudents').value = group.max_students;
        document.getElementById('editGroupModal').classList.add('active');
      } catch(err) {
        alert('Error loading group: ' + err.message);
      }
    }

    document.getElementById('updateGroupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editGroupId').value;
      const data = {
        group_name: document.getElementById('editGroupName').value,
        program_name: document.getElementById('editGroupProgram').value,
        duration: document.getElementById('editGroupDuration').value,
        timezone: document.getElementById('editGroupTimezone').value,
        max_students: parseInt(document.getElementById('editGroupMaxStudents').value)
      };

      try {
        const res = await fetch(`/api/groups/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          closeEditGroupModal();
          loadGroups();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    function closeEditGroupModal() {
      document.getElementById('editGroupModal').classList.remove('active');
    }

    async function viewGroupDetails(id) {
      try {
        const studentsRes = await fetch(`/api/groups/${id}/students`);
        const students = await studentsRes.json();
        const group = allGroups.find(g => g.id === id);

        const content = `
          <h3>${group.group_name}</h3>
          <p><strong>Program:</strong> ${group.program_name}</p>
          <p><strong>Enrolled Students (${students.length}/${group.max_students}):</strong></p>
          <ul style="list-style: none; padding: 0;">
            ${students.map(s => `<li style="padding: 10px; background: #f7fafc; margin-bottom: 5px; border-radius: 5px;">ğŸ‘¤ ${s.name} (${s.grade})</li>`).join('')}
          </ul>
        `;

        alert(content); // Simple view - you can enhance this with a modal
      } catch(err) {
        alert('Error loading group details');
      }
    }

    document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sendEmail = document.getElementById('sendWelcomeEmail').checked;
      const data = {
        name: document.getElementById('studentName').value,
        grade: document.getElementById('grade').value,
        parent_name: document.getElementById('parentName').value,
        parent_email: document.getElementById('parentEmail').value,
        primary_contact: document.getElementById('primaryContact').value,
        timezone: document.getElementById('timezone').value,
        program_name: document.getElementById('programName').value,
        class_type: document.getElementById('classType').value,
        duration: document.getElementById('duration').value,
        currency: document.getElementById('currency').value,
        per_session_fee: parseFloat(document.getElementById('perSessionFee').value),
        total_sessions: parseInt(document.getElementById('totalSessions').value),
        date_of_birth: document.getElementById('dateOfBirth').value || null,
        payment_method: document.getElementById('paymentMethod').value || null,
        send_email: sendEmail
      };

      try {
        const res = await fetch('/api/students', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert(`âœ… Student added! ${sendEmail && result.emailSent ? 'Welcome email sent.' : ''}`);
          e.target.reset();
          loadStudents();
          loadDashboardStats();
          loadAssessmentStudents();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    function addScheduleRow() {
      const container = document.getElementById('classScheduleList');
      const row = document.createElement('div');
      row.className = 'schedule-row';
      row.innerHTML = `<input type="date" name="date" required><input type="time" name="time" required><button type="button" onclick="this.parentElement.remove()" class="btn btn-sm btn-danger">Ã—</button>`;
      container.appendChild(row);
    }
    addScheduleRow();

    document.getElementById('schedulePrivateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('scheduleStudent').value;
      if (!studentId) return alert('Select a student');
      const rows = document.querySelectorAll('#classScheduleList .schedule-row');
      const classes = [];
      rows.forEach(row => {
        const date = row.querySelector('input[name="date"]').value;
        const time = row.querySelector('input[name="time"]').value;
        if (date && time) classes.push({ date, time });
      });
      if (classes.length === 0) return alert('Add at least one class');
      const sendEmail = document.getElementById('sendPrivateScheduleEmail').checked;

      try {
        const res = await fetch('/api/schedule/private-classes', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ student_id: studentId, classes, send_email: sendEmail })
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          e.target.reset();
          document.getElementById('classScheduleList').innerHTML = '';
          addScheduleRow();
          loadUpcomingClasses();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    async function loadPastSessions() {
      try {
        const res = await fetch('/api/sessions/past/all');
        const sessions = await res.json();
        const tbody = document.getElementById('pastSessionsBody');
        tbody.innerHTML = sessions.map(s => {
          const isPending = s.status === 'Pending' || s.status === 'Scheduled';
          const attendanceBtn = isPending ?
            `<button onclick="markSessionAttendance(${s.id}, '${s.session_type}')" class="btn btn-sm btn-success">Mark Attendance</button>` :
            `<span style="background: ${s.status === 'Present' ? '#38a169' : s.status === 'Absent' ? '#e53e3e' : '#718096'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${s.status}</span>`;
          const materials = `${s.ppt_file_path ? '<span title="PPT">ğŸ“Š</span>' : ''} ${s.recording_file_path ? '<span title="Recording">ğŸ¥</span>' : ''} ${s.homework_file_path ? '<span title="HW">ğŸ“</span>' : ''}`;
          return `<tr>
            <td>${formatSessionTime(s)}</td>
            <td><strong>${s.student_name}</strong></td>
            <td><span style="background: ${s.session_type === 'Private' ? '#B05D9E' : '#9f7aea'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${s.session_type}</span></td>
            <td>#${s.session_number}</td>
            <td>${attendanceBtn}</td>
            <td>${materials || '-'}</td>
            <td><button onclick="viewFeedback(${s.id})" class="btn btn-sm" style="background:#fbbf24; color:white;">â­</button></td>
            <td>
              <button onclick="openSessionModal(${s.id}, '${s.session_type}')" class="btn btn-sm btn-primary">Manage</button>
            </td>
          </tr>`;
        }).join('');
      } catch(err) {
        console.error(err);
      }
    }

    async function viewFeedback(sessionId) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/feedbacks`);
        if (!res.ok) {
          throw new Error('Failed to fetch feedback');
        }
        const feedbacks = await res.json();
        const container = document.getElementById('feedbackModalContent');

        if(!feedbacks || feedbacks.length === 0) {
          container.innerHTML = '<p style="text-align:center; color:#718096; padding: 20px;">No feedback received yet for this session.</p><p style="text-align:center; color:#a0aec0; font-size:0.9rem;">Feedback is submitted by parents/students after completing a class.</p>';
        } else {
          container.innerHTML = feedbacks.map(f => `
            <div style="background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:10px; border-left: 4px solid #fbbf24;">
              <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <strong style="color:#2d3748;">${f.student_name || 'Student'}</strong>
                <div class="star-rating">${'â­'.repeat(f.rating || 0)}</div>
              </div>
              <p style="color:#4a5568;">${f.feedback_text || 'No comment provided'}</p>
              <p style="color:#718096; font-size:0.85rem; margin-top:10px;">ğŸ“… ${f.created_at ? new Date(f.created_at).toLocaleString() : 'N/A'}</p>
            </div>
          `).join('');
        }

        document.getElementById('feedbackModal').classList.add('active');
      } catch(err) {
        console.error('Error loading feedback:', err);
        document.getElementById('feedbackModalContent').innerHTML = '<p style="text-align:center; color:#718096; padding: 20px;">No feedback received yet for this session.</p>';
        document.getElementById('feedbackModal').classList.add('active');
      }
    }

    function closeFeedbackModal() {
      document.getElementById('feedbackModal').classList.remove('active');
    }

    // ==================== HOMEWORK SUBMISSIONS ====================
    async function loadHomeworkSubmissions() {
      try {
        // Populate filter dropdown
        const filterSelect = document.getElementById('homeworkFilterStudent');
        if (filterSelect.options.length <= 1) {
          filterSelect.innerHTML = '<option value="">All Students</option>' +
            allStudents.filter(s => s.is_active).map(s =>
              `<option value="${s.id}">${s.name} (${s.grade})</option>`
            ).join('');
        }

        const studentId = filterSelect.value;
        const url = studentId ? `/api/homework/all?student_id=${studentId}` : '/api/homework/all';
        const res = await fetch(url);
        const submissions = await res.json();
        const tbody = document.getElementById('homeworkBody');

        if (!submissions || submissions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #718096; padding: 30px;">No homework submissions yet. Students can upload homework from the Parent Portal.</td></tr>';
          return;
        }

        tbody.innerHTML = submissions.map(hw => {
          const gradeDisplay = hw.feedback_grade
            ? `<span style="background: #38a169; color: white; padding: 3px 10px; border-radius: 4px;">${hw.feedback_grade}</span>`
            : '<span style="color: #718096;">Not graded</span>';

          const fileExt = hw.file_name ? hw.file_name.split('.').pop().toLowerCase() : '';
          const fileIcon = ['mp4', 'mov', 'avi', 'webm'].includes(fileExt) ? 'ğŸ¥' :
                          ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt) ? 'ğŸ–¼ï¸' :
                          ['pdf'].includes(fileExt) ? 'ğŸ“„' :
                          ['doc', 'docx'].includes(fileExt) ? 'ğŸ“' :
                          ['ppt', 'pptx'].includes(fileExt) ? 'ğŸ“Š' : 'ğŸ“';

          // Build proper file URL
          let fileUrl = '';
          let isLink = false;
          if (hw.file_path) {
            if (hw.file_path.startsWith('LINK:')) {
              fileUrl = hw.file_path.replace('LINK:', '');
              isLink = true;
            } else if (hw.file_path.startsWith('/uploads/')) {
              fileUrl = hw.file_path;
            } else {
              fileUrl = '/uploads/homework/' + hw.file_path;
            }
          }

          // For images, show preview button
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
          const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(fileExt);
          let previewBtn = '';
          if (isImage && fileUrl) {
            previewBtn = `<button onclick="previewImage('${fileUrl}')" class="btn btn-sm" style="background:#9f7aea; color:white;">Preview</button>`;
          } else if (isVideo && fileUrl) {
            previewBtn = `<button onclick="previewVideo('${fileUrl}')" class="btn btn-sm" style="background:#9f7aea; color:white;">Preview</button>`;
          }

          const feedbackDisplay = hw.feedback_comments
            ? `<br><small style="color:#4a5568;">ğŸ’¬ ${hw.feedback_comments}</small>`
            : '';

          return `<tr>
            <td><strong>${hw.student_name || 'Unknown'}</strong></td>
            <td>#${hw.session_number || 'N/A'}</td>
            <td>
              <a href="${fileUrl}" target="_blank" style="color: #B05D9E; text-decoration: none;">
                ${fileIcon} ${hw.file_name || (isLink ? 'External Link' : 'Download')}
              </a>
            </td>
            <td>${hw.uploaded_at ? new Date(hw.uploaded_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'}</td>
            <td>${gradeDisplay}${feedbackDisplay}</td>
            <td>
              <button onclick="openGradeHomeworkModal(${hw.id}, '${(hw.student_name || '').replace(/'/g, "\\'")}', '${(hw.file_name || '').replace(/'/g, "\\'")}')" class="btn btn-sm btn-primary">Grade</button>
              ${previewBtn}
              ${!isLink ? `<a href="${fileUrl}" download class="btn btn-sm" style="background: #B05D9E; color: white; text-decoration: none;">Download</a>` : ''}
            </td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('Error loading homework:', err);
        document.getElementById('homeworkBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e53e3e;">Error loading homework submissions</td></tr>';
      }
    }

    function openGradeHomeworkModal(homeworkId, studentName, fileName) {
      const grade = prompt(`Grade homework for ${studentName}\n\nFile: ${fileName}\n\nEnter grade (e.g., A+, A, B+, B, C, Excellent, Good):`);
      if (grade === null) return;

      const comments = prompt('Enter feedback comments (optional):') || '';

      gradeHomework(homeworkId, grade, comments);
    }

    function previewImage(url) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; align-items:center; justify-content:center; cursor:pointer;';
      modal.innerHTML = `<img src="${url}" style="max-width:90%; max-height:90%; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">`;
      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    }

    function previewVideo(url) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; align-items:center; justify-content:center;';
      modal.innerHTML = `
        <div style="position:relative; max-width:90%; max-height:90%;">
          <button onclick="this.parentElement.parentElement.remove()" style="position:absolute; top:-40px; right:0; background:#e53e3e; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Close</button>
          <video controls autoplay style="max-width:100%; max-height:80vh; border-radius:8px;"><source src="${url}">Your browser does not support video.</video>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function gradeHomework(homeworkId, grade, comments) {
      try {
        const res = await fetch(`/api/materials/${homeworkId}/grade`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ grade, comments })
        });

        if (res.ok) {
          alert('âœ… Homework graded successfully!');
          loadHomeworkSubmissions();
        } else {
          alert('âŒ Failed to grade homework');
        }
      } catch (err) {
        console.error('Error grading homework:', err);
        alert('âŒ Error grading homework');
      }
    }

    async function markSessionAttendance(sessionId, sessionType) {
      if (sessionType === 'Group') {
        openSessionModal(sessionId, 'Group');
      } else {
        const attendance = confirm('Mark as Present? (Cancel for Absent)') ? 'Present' : 'Absent';
        try {
          const res = await fetch(`/api/sessions/${sessionId}/attendance`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ attendance })
          });
          if(res.ok) {
            alert('âœ… Attendance marked');
            loadPastSessions();
            loadDashboardStats();
          } else {
            alert('âŒ Error');
          }
        } catch(err) {
          alert('âŒ Error');
        }
      }
    }

    async function openSessionModal(sessionId, sessionType) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/details`);
        const session = await res.json();
        document.getElementById('modalSessionTitle').textContent = `Session #${session.session_number} - ${session.session_type}`;

        let content = `<p><strong>Date:</strong> ${formatSessionTime(session)}</p>
        <h3>ğŸ“ Upload Materials</h3>
        <div style="display:grid; grid-template-columns:1fr; gap:15px; margin-bottom:20px;">
          <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <strong>ğŸ“Š PPT / Presentation</strong>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="file" id="pptFile" style="flex:1; min-width:200px;">
              <button onclick="uploadMaterial(${sessionId}, 'ppt')" class="btn btn-sm btn-primary">Upload File</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="url" id="pptLink" placeholder="Or paste link (Google Drive, etc.)" style="flex:1; min-width:200px; padding:8px; border:1px solid #ddd; border-radius:4px;">
              <button onclick="saveMaterialLink(${sessionId}, 'ppt')" class="btn btn-sm" style="background:#B05D9E; color:white;">Save Link</button>
            </div>
          </div>
          <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <strong>ğŸ¥ Recording</strong>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="file" id="recFile" style="flex:1; min-width:200px;">
              <button onclick="uploadMaterial(${sessionId}, 'recording')" class="btn btn-sm btn-primary">Upload File</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="url" id="recLink" placeholder="Or paste link (YouTube, Drive, etc.)" style="flex:1; min-width:200px; padding:8px; border:1px solid #ddd; border-radius:4px;">
              <button onclick="saveMaterialLink(${sessionId}, 'recording')" class="btn btn-sm" style="background:#B05D9E; color:white;">Save Link</button>
            </div>
          </div>
          <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <strong>ğŸ“ Homework</strong>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="file" id="hwFile" style="flex:1; min-width:200px;">
              <button onclick="uploadMaterial(${sessionId}, 'homework')" class="btn btn-sm btn-primary">Upload File</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="url" id="hwLink" placeholder="Or paste link (Google Docs, etc.)" style="flex:1; min-width:200px; padding:8px; border:1px solid #ddd; border-radius:4px;">
              <button onclick="saveMaterialLink(${sessionId}, 'homework')" class="btn btn-sm" style="background:#B05D9E; color:white;">Save Link</button>
            </div>
          </div>
        </div>`;

        if (sessionType === 'Group') {
          const attRes = await fetch(`/api/sessions/${sessionId}/group-attendance`);
          const students = await attRes.json();
          content += `<h3 style="margin-top:20px;">Group Attendance</h3><table><thead><tr><th>Student</th><th>Action</th></tr></thead><tbody>` + students.map(s => `
            <tr><td>${s.student_name}</td><td>
              <button onclick="saveGroupAttendance(${sessionId}, ${s.student_id}, 'Present')" class="btn btn-sm btn-success">Present</button>
              <button onclick="saveGroupAttendance(${sessionId}, ${s.student_id}, 'Absent')" class="btn btn-sm btn-danger">Absent</button>
            </td></tr>
          `).join('') + `</tbody></table>`;
        }

        document.getElementById('sessionDetailsContent').innerHTML = content;
        document.getElementById('sessionModal').classList.add('active');
      } catch(err) {
        alert('Error loading session');
      }
    }

    async function saveGroupAttendance(sessionId, studentId, status) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/group-attendance`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ attendanceData: [{ student_id: studentId, attendance: status }] })
        });
        if(res.ok) {
          alert('âœ… Attendance saved');
          openSessionModal(sessionId, 'Group');
        } else {
          alert('âŒ Failed');
        }
      } catch(e) {
        alert('âŒ Error');
      }
    }

    function closeSessionModal() {
      document.getElementById('sessionModal').classList.remove('active');
    }

    async function loadGroups() {
      try {
        const res = await fetch('/api/groups');
        allGroups = await res.json();
        document.getElementById('groupsBody').innerHTML = allGroups.map(g => `<tr><td><strong>${g.group_name}</strong></td><td>${g.program_name}</td><td>${g.duration}</td><td>${g.enrolled_students||0}</td><td>${g.max_students}</td><td><button onclick="viewGroupDetails(${g.id})" class="btn btn-sm btn-primary">View</button> <button onclick="editGroup(${g.id})" class="btn btn-sm btn-warning">Edit</button> <button onclick="openEnrollModal(${g.id})" class="btn btn-sm btn-success">Enroll</button> <button onclick="deleteGroup(${g.id})" class="btn btn-sm btn-danger">Delete</button></td></tr>`).join('');
        document.getElementById('scheduleGroup').innerHTML = '<option value="">Select group...</option>' + allGroups.map(g => `<option value="${g.id}">${g.group_name}</option>`).join('');
      } catch(e) {
        console.error(e);
      }
    }

    async function openEnrollModal(groupId) {
      currentGroupId = groupId;
      const group = allGroups.find(g => g.id === groupId);
      document.getElementById('enrollModalTitle').textContent = `Enroll Students in ${group.group_name}`;

      try {
        const availableStudents = allStudents.filter(s => !s.group_id || s.group_id !== groupId);
        const enrolledRes = await fetch(`/api/groups/${groupId}/students`);
        const enrolledStudents = await enrolledRes.json();

        let content = `<h3>Currently Enrolled (${enrolledStudents.length}/${group.max_students})</h3>`;
        if (enrolledStudents.length > 0) {
          content += `<ul style="list-style: none; padding: 0;">` + enrolledStudents.map(s => `<li style="padding: 10px; background: #f7fafc; margin-bottom: 5px; border-radius: 5px;">ğŸ‘¤ ${s.name} (${s.grade})</li>`).join('') + `</ul>`;
        } else {
          content += `<p style="color: #718096;">No students enrolled yet</p>`;
        }

        content += `<h3 style="margin-top: 20px;">Available Students</h3>`;
        if (availableStudents.length > 0) {
          content += `<div style="max-height: 300px; overflow-y: auto;">` + availableStudents.map(s => `
            <div style="padding: 10px; background: #f7fafc; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
              <span>ğŸ‘¤ ${s.name} (${s.grade}) - ${s.program_name}</span>
              <button onclick="enrollStudent(${groupId}, ${s.id})" class="btn btn-sm btn-success">Enroll</button>
            </div>
          `).join('') + `</div>`;
        } else {
          content += `<p style="color: #718096;">No available students</p>`;
        }

        document.getElementById('enrollModalContent').innerHTML = content;
        document.getElementById('enrollModal').classList.add('active');
      } catch(err) {
        alert('Error loading enrollment data: ' + err.message);
      }
    }

    async function enrollStudent(groupId, studentId) {
      try {
        const res = await fetch(`/api/groups/${groupId}/enroll`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ student_id: studentId })
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          await loadStudents();
          await loadGroups();
          openEnrollModal(groupId);
        } else {
          alert('âŒ ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    function closeEnrollModal() {
      document.getElementById('enrollModal').classList.remove('active');
    }

    function deleteGroup(id) {
      if(confirm('Delete group? This will remove all group sessions.')) {
        fetch(`/api/groups/${id}`, {method:'DELETE'}).then(()=>loadGroups());
      }
    }

    async function openStudentModal(id) {
      currentStudentId = id;
      const student = allStudents.find(s => s.id == id);
      if (!student) return alert('Student not found');

      document.getElementById('modalStudentName').textContent = student.name;

      const infoHTML = `
        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #B05D9E; margin-bottom: 15px;">Basic Information</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><strong>Name:</strong> ${student.name}</div>
            <div><strong>Grade:</strong> ${student.grade}</div>
            <div><strong>Parent:</strong> ${student.parent_name}</div>
            <div><strong>Email:</strong> ${student.parent_email}</div>
            <div><strong>Contact:</strong> ${student.primary_contact || 'N/A'}</div>
            <div><strong>Timezone:</strong> ${student.timezone}</div>
          </div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #B05D9E; margin-bottom: 15px;">Program Details</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><strong>Program:</strong> ${student.program_name}</div>
            <div><strong>Type:</strong> ${student.class_type}</div>
            <div><strong>Duration:</strong> ${student.duration}</div>
            <div><strong>Fee per Session:</strong> ${student.currency} ${student.per_session_fee}</div>
          </div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #B05D9E; margin-bottom: 15px;">Session Statistics</h3>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div><strong>Total:</strong> ${student.total_sessions}</div>
            <div><strong>Completed:</strong> <span style="color: #38a169;">${student.completed_sessions}</span></div>
            <div><strong>Remaining:</strong> <span style="color: #e53e3e;">${student.remaining_sessions}</span></div>
            <div><strong>Makeup Credits:</strong> ${student.makeup_credits || 0}</div>
          </div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px;">
          <h3 style="color: #B05D9E; margin-bottom: 15px;">Financial Summary</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><strong>Total Paid:</strong> ${student.currency} ${student.fees_paid || 0}</div>
            <div><strong>Status:</strong> <span style="color: ${student.is_active ? '#38a169' : '#e53e3e'};">${student.is_active ? 'Active' : 'Inactive'}</span></div>
          </div>
        </div>
      `;

      document.getElementById('studentInfoContent').innerHTML = infoHTML;
      document.getElementById('studentModal').classList.add('active');
    }

    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('active');
    }

    function handleScheduleTypeChange() {
      const type = document.getElementById('scheduleType').value;
      document.getElementById('schedulePrivateForm').style.display = type === 'private' ? 'block' : 'none';
      document.getElementById('scheduleGroupForm').style.display = type === 'group' ? 'block' : 'none';
      if(type==='group' && document.getElementById('groupClassScheduleList').children.length===0) addGroupScheduleRow();
    }

    function addGroupScheduleRow() {
      const container = document.getElementById('groupClassScheduleList');
      const row = document.createElement('div');
      row.className = 'schedule-row';
      row.innerHTML = `<input type="date" name="date" required><input type="time" name="time" required><button type="button" onclick="this.parentElement.remove()" class="btn btn-sm btn-danger">Ã—</button>`;
      container.appendChild(row);
    }

    document.getElementById('scheduleGroupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const groupId = document.getElementById('scheduleGroup').value;
      if (!groupId) return alert('Select a group');
      const rows = document.querySelectorAll('#groupClassScheduleList .schedule-row');
      const classes = [];
      rows.forEach(row => {
        const date = row.querySelector('input[name="date"]').value;
        const time = row.querySelector('input[name="time"]').value;
        if (date && time) classes.push({ date, time });
      });
      if (classes.length === 0) return alert('Add at least one class');
      const sendEmail = document.getElementById('sendGroupScheduleEmail').checked;

      try {
        const res = await fetch('/api/schedule/group-classes', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ group_id: groupId, classes, send_email: sendEmail })
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          e.target.reset();
          document.getElementById('groupClassScheduleList').innerHTML = '';
          loadUpcomingClasses();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    function uploadMaterial(id, type) {
      const inp = document.getElementById(type==='ppt'?'pptFile':type==='recording'?'recFile':'hwFile');
      if(inp.files[0]) {
        const fd=new FormData();
        fd.append('file', inp.files[0]);
        fd.append('materialType', type);
        fetch(`/api/sessions/${id}/upload`, {method:'POST', body:fd})
          .then(r => r.json())
          .then(data => alert('âœ… ' + data.message))
          .catch(err => alert('âŒ Upload failed'));
      } else {
        alert('Please select a file first');
      }
    }

    // ==================== CLASS RATINGS ====================
    async function loadClassRatings() {
      try {
        const studentFilter = document.getElementById('ratingsStudentFilter').value;
        const ratingFilter = document.getElementById('ratingsRatingFilter').value;

        let url = '/api/class-feedback/all';
        const params = [];
        if (studentFilter) params.push(`student_id=${studentFilter}`);
        if (ratingFilter) params.push(`rating=${ratingFilter}`);
        if (params.length > 0) url += '?' + params.join('&');

        const res = await fetch(url);
        const data = await res.json();
        const container = document.getElementById('ratingsContainer');

        // Update stats
        document.getElementById('totalFeedbacks').textContent = data.total || 0;
        document.getElementById('avgRating').textContent = data.avgRating ? data.avgRating.toFixed(1) + ' â­' : '-';
        document.getElementById('fiveStarCount').textContent = data.fiveStarCount || 0;

        // Populate student filter if not already done
        const filterSelect = document.getElementById('ratingsStudentFilter');
        if (filterSelect.options.length <= 1 && data.students) {
          data.students.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.name;
            filterSelect.appendChild(opt);
          });
        }

        if (!data.feedbacks || data.feedbacks.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 30px;">No feedback received yet. Parents can give feedback after their classes.</p>';
          return;
        }

        container.innerHTML = data.feedbacks.map(f => {
          const stars = 'â­'.repeat(f.rating || 0) + 'â˜†'.repeat(5 - (f.rating || 0));
          const date = f.created_at ? new Date(f.created_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';

          return `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid ${f.rating >= 4 ? '#38a169' : f.rating >= 3 ? '#ecc94b' : '#e53e3e'};">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                <div>
                  <strong style="font-size: 1.1rem; color: #2d3748;">${f.student_name || 'Unknown Student'}</strong>
                  <p style="color: #718096; font-size: 0.85rem; margin: 5px 0;">Session #${f.session_number || 'N/A'} â€¢ ${date}</p>
                </div>
                <div style="font-size: 1.3rem;">${stars}</div>
              </div>
              ${f.feedback_text ? `<p style="margin-top: 12px; color: #4a5568; background: white; padding: 12px; border-radius: 8px; font-style: italic;">"${f.feedback_text}"</p>` : ''}
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading class ratings:', err);
        document.getElementById('ratingsContainer').innerHTML = '<p style="color: #e53e3e; text-align: center;">Error loading feedback</p>';
      }
    }

    async function saveMaterialLink(sessionId, type) {
      const inp = document.getElementById(type==='ppt'?'pptLink':type==='recording'?'recLink':'hwLink');
      const link = inp.value.trim();
      if(!link) {
        alert('Please enter a link first');
        return;
      }
      try {
        const res = await fetch(`/api/sessions/${sessionId}/save-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ materialType: type, link: link })
        });
        const data = await res.json();
        if(res.ok) {
          alert('âœ… Link saved successfully!');
          inp.value = '';
        } else {
          alert('âŒ Failed: ' + (data.error || 'Unknown error'));
        }
      } catch(err) {
        alert('âŒ Error saving link');
      }
    }

    function loadEmailLogs() {
      fetch('/api/email-logs')
        .then(r=>r.json())
        .then(logs=>document.getElementById('emailLogsBody').innerHTML=logs.map(l=>`<tr><td>${new Date(l.sent_at).toLocaleString()}</td><td>${l.recipient_name}</td><td>${l.email_type}</td><td>${l.subject}</td><td><span style="color: ${l.status === 'Sent' ? '#38a169' : '#e53e3e'};">${l.status}</span></td></tr>`).join(''))
        .catch(err => console.error(err));
    }

    function loadEvents() {
      fetch('/api/events')
        .then(r=>r.json())
        .then(ev=>document.getElementById('eventsBody').innerHTML=ev.map(e=>{
          // Format date and time to IST
          const eventDateTime = formatSessionTime({ session_date: e.event_date, session_time: e.event_time });
          return `<tr>
            <td><strong>${e.event_name}</strong></td>
            <td>${eventDateTime.split(',')[0] || e.event_date}</td>
            <td>${eventDateTime.split(',')[1] || e.event_time}</td>
            <td>${e.event_duration || '-'}</td>
            <td>${e.registered_count||0}${e.max_participants ? '/' + e.max_participants : ''}</td>
            <td><span style="background: ${e.status === 'Active' ? '#38a169' : '#e53e3e'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${e.status}</span></td>
            <td>
              <button onclick="viewEvent(${e.id})" class="btn btn-sm" style="background:#B05D9E; color:white;">View</button>
              <button onclick="editEvent(${e.id})" class="btn btn-sm btn-warning">Edit</button>
              <button onclick="markEventAttendance(${e.id}, '${e.event_name}')" class="btn btn-sm btn-success">Attendance</button>
              <button onclick="viewEventRegistrations(${e.id}, '${e.event_name}')" class="btn btn-sm" style="background:#9f7aea; color:white;">Registrations</button>
              <button onclick="deleteEvent(${e.id})" class="btn btn-sm btn-danger">Delete</button>
            </td>
          </tr>`;
        }).join(''))
        .catch(err => console.error(err));
    }

    document.getElementById('createGroupForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const data = {
        group_name: document.getElementById('groupName').value,
        program_name: document.getElementById('groupProgram').value,
        duration: document.getElementById('groupDuration').value,
        timezone: document.getElementById('groupTimezone').value,
        max_students: document.getElementById('groupMaxStudents').value
      };

      try {
        const res = await fetch('/api/groups', {method:'POST', headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
        const result = await res.json();
        if(res.ok) {
          alert('âœ… Group created successfully!');
          e.target.reset();
          loadGroups();
          loadDashboardStats();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    function deleteEvent(id) {
      if(confirm('Delete this event? Registrations will also be removed.')) {
        fetch(`/api/events/${id}`, {method:'DELETE'})
          .then(()=>{alert('âœ… Event deleted'); loadEvents();})
          .catch(err => alert('âŒ Error'));
      }
    }

    document.getElementById('createEventForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const sendEmail = document.getElementById('sendEventEmail').checked;
      const data = {
        event_name: document.getElementById('eventName').value,
        event_description: document.getElementById('eventDescription').value,
        event_duration: document.getElementById('eventDuration').value,
        event_date: document.getElementById('eventDate').value,
        event_time: document.getElementById('eventTime').value,
        send_email: sendEmail
      };

      try {
        const res = await fetch('/api/events', {method:'POST', headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          e.target.reset();
          loadEvents();
          loadDashboardStats();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    async function loadScheduleManager() {
      document.getElementById('manageScheduleStudent').innerHTML = '<option value="">Select student...</option>' + allStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    async function loadStudentSchedule() {
      const studentId = document.getElementById('manageScheduleStudent').value;
      const container = document.getElementById('studentScheduleContainer');

      if (!studentId) {
        container.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`/api/sessions/${studentId}`);
        const sessions = await res.json();
        const student = allStudents.find(s => s.id == studentId);

        if (sessions.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">No sessions scheduled for this student</p>';
          return;
        }

        container.innerHTML = `
          <h3 style="margin-bottom: 20px;">Schedule for ${student.name}</h3>
          ${sessions.map(s => `
            <div class="session-item">
              <div>
                <strong>Session #${s.session_number}</strong> - ${s.session_type}
                <br>
                <span style="color: #718096;">ğŸ“… ${formatSessionTime(s)} | Status: ${s.status}</span>
              </div>
              <div style="display: flex; gap: 10px;">
                <button onclick="editSession(${s.id}, '${s.session_date}', '${s.session_time}')" class="btn btn-sm btn-primary">Edit</button>
                <button onclick="deleteSession(${s.id})" class="btn btn-sm btn-danger">Delete</button>
              </div>
            </div>
          `).join('')}
        `;
      } catch(err) {
        container.innerHTML = '<p style="color: #e53e3e;">Error loading schedule</p>';
        console.error(err);
      }
    }

    function editSession(sessionId, date, time) {
      document.getElementById('editSessionId').value = sessionId;
      document.getElementById('editSessionDate').value = date.split('T')[0];
      document.getElementById('editSessionTime').value = time.substring(0, 5);
      document.getElementById('editSessionModal').classList.add('active');
    }

    function closeEditSessionModal() {
      document.getElementById('editSessionModal').classList.remove('active');
    }

    document.getElementById('editSessionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = document.getElementById('editSessionId').value;
      const date = document.getElementById('editSessionDate').value;
      const time = document.getElementById('editSessionTime').value;

      try {
        const res = await fetch(`/api/sessions/${sessionId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ date, time })
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          closeEditSessionModal();
          loadStudentSchedule();
          loadUpcomingClasses();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    async function deleteSession(sessionId) {
      if (!confirm('Are you sure you want to delete this session?')) return;

      try {
        const res = await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          loadStudentSchedule();
          loadUpcomingClasses();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // PAYMENT & RENEWAL FUNCTIONS
    function showRenewalForm() {
      document.getElementById('renewalForm').style.display = 'block';
    }

    async function submitRenewal() {
      const amount = document.getElementById('renewalAmount').value;
      const sessions = document.getElementById('renewalSessions').value;
      const method = document.getElementById('renewalMethod').value;
      const notes = document.getElementById('renewalNotes').value;

      if(!amount || !sessions) return alert('Please fill required fields');

      const student = allStudents.find(s => s.id === currentStudentId);

      try {
        const res = await fetch(`/api/students/${currentStudentId}/renewal`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            amount: parseFloat(amount),
            currency: student.currency,
            sessions_added: parseInt(sessions),
            payment_method: method,
            notes: notes
          })
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          document.getElementById('renewalForm').style.display = 'none';
          document.getElementById('renewalForm').reset();
          loadPayments();
          loadStudents();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    async function loadPayments() {
      try {
        const res = await fetch(`/api/students/${currentStudentId}/payments`);
        const data = await res.json();
        const container = document.getElementById('paymentsContent');

        let html = '<h3>Payment History</h3>';
        if(data.payments.length === 0 && data.renewals.length === 0) {
          html += '<p style="color:#718096;">No payment records yet</p>';
        } else {
          html += '<table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Sessions</th><th>Method</th></tr></thead><tbody>';

          data.renewals.forEach(r => {
            html += `<tr><td>${r.renewal_date}</td><td>Renewal</td><td>${r.currency} ${r.amount}</td><td>+${r.sessions_added}</td><td>${r.payment_method||'-'}</td></tr>`;
          });

          data.payments.forEach(p => {
            html += `<tr><td>${p.payment_date}</td><td>Payment</td><td>${p.currency} ${p.amount}</td><td>${p.sessions_covered||'-'}</td><td>${p.payment_method}</td></tr>`;
          });

          html += '</tbody></table>';
        }

        container.innerHTML = html;
      } catch(err) {
        console.error(err);
        document.getElementById('paymentsContent').innerHTML = '<p style="color:#e53e3e;">Error loading payments</p>';
      }
    }

    async function loadHomework() {
      try {
        const res = await fetch(`/api/students/${currentStudentId}/homework`);
        const homework = await res.json();
        const container = document.getElementById('homeworkContent');

        if(homework.length === 0) {
          container.innerHTML = '<p style="color:#718096; text-align:center;">No homework submitted yet</p>';
        } else {
          container.innerHTML = homework.map(hw => `
            <div style="background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div>
                  <strong>Session #${hw.session_number || 'N/A'}</strong>
                  <p style="color:#718096; font-size:0.9rem;">${hw.file_name}</p>
                  <p style="color:#718096; font-size:0.85rem;">${new Date(hw.uploaded_at).toLocaleDateString()}</p>
                </div>
                <div>
                  ${hw.feedback_given ? `<span style="color:#38a169;">âœ“ Graded: ${hw.feedback_grade}</span>` : '<button onclick="gradeHomework('+hw.id+')" class="btn btn-sm btn-primary">Grade</button>'}
                </div>
              </div>
              ${hw.feedback_comments ? `<p><strong>Feedback:</strong> ${hw.feedback_comments}</p>` : ''}
            </div>
          `).join('');
        }
      } catch(err) {
        console.error(err);
        document.getElementById('homeworkContent').innerHTML = '<p style="color:#e53e3e;">Error loading homework</p>';
      }
    }

    async function gradeHomework(materialId) {
      const grade = prompt('Enter grade (A+, A, B+, B, C, etc):');
      if(!grade) return;
      const comments = prompt('Enter feedback comments:');

      try {
        const res = await fetch(`/api/materials/${materialId}/grade`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ grade, comments })
        });
        const result = await res.json();
        if(res.ok) {
          alert('âœ… ' + result.message);
          loadHomework();
        } else {
          alert('âŒ Failed: ' + result.error);
        }
      } catch(err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    async function loadBadges() {
      try {
        const res = await fetch(`/api/students/${currentStudentId}/badges`);
        const badges = await res.json();
        const container = document.getElementById('badgesContent');

        if(badges.length === 0) {
          container.innerHTML = '<p style="color:#718096; text-align:center; padding:40px;">No badges earned yet. Keep learning!</p>';
        } else {
          container.innerHTML = `
            <h3 style="margin-bottom:20px;">ğŸ† Badges Earned: ${badges.length}</h3>
            <div>
              ${badges.map(b => `
                <span class="badge-item" title="${b.badge_description}">
                  ${b.badge_name}
                </span>
              `).join('')}
            </div>
          `;
        }
      } catch(err) {
        console.error(err);
        document.getElementById('badgesContent').innerHTML = '<p style="color:#e53e3e;">Error loading badges</p>';
      }
    }

    // ==================== ANNOUNCEMENTS ====================
    async function loadAnnouncements() {
      try {
        const res = await fetch('/api/announcements');
        const announcements = await res.json();
        const tbody = document.getElementById('announcementsBody');

        if (announcements.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#718096;">No announcements</td></tr>';
          return;
        }

        tbody.innerHTML = announcements.map(a => `
          <tr>
            <td><strong>${a.title}</strong></td>
            <td><span class="badge">${a.announcement_type}</span></td>
            <td><span class="badge ${a.priority === 'Urgent' ? 'badge-danger' : a.priority === 'High' ? 'badge-warning' : ''}">${a.priority}</span></td>
            <td>${new Date(a.created_at).toLocaleDateString()}</td>
            <td>
              <button onclick="viewAnnouncement(${a.id}, '${a.title.replace(/'/g, "\\'")}', '${a.content.replace(/'/g, "\\'")}', '${a.announcement_type}', '${a.priority}')" class="btn btn-sm" style="background:#B05D9E;color:white;">View</button>
              <button onclick="deleteAnnouncement(${a.id})" class="btn btn-danger btn-sm">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
      }
    }

    document.getElementById('createAnnouncementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        title: document.getElementById('announcementTitle').value,
        content: document.getElementById('announcementContent').value,
        announcement_type: document.getElementById('announcementType').value,
        priority: document.getElementById('announcementPriority').value
      };

      try {
        const res = await fetch('/api/announcements', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('âœ… Announcement created!');
          e.target.reset();
          loadAnnouncements();
        } else {
          alert('âŒ Failed to create announcement');
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    function viewAnnouncement(id, title, content, type, priority) {
      alert(`ğŸ“¢ ${title}\n\nType: ${type}\nPriority: ${priority}\n\n${content}`);
    }

    async function deleteAnnouncement(id) {
      if (!confirm('Delete this announcement?')) return;

      try {
        const res = await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert('âœ… Announcement deleted');
          loadAnnouncements();
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // ==================== MONTHLY ASSESSMENTS ====================
    // Show/hide custom certificate title field
    document.getElementById('certificateTitle').addEventListener('change', function() {
      const customGroup = document.getElementById('customTitleGroup');
      customGroup.style.display = this.value === 'Custom' ? 'block' : 'none';
    });

    async function loadAssessments() {
      try {
        const res = await fetch('/api/assessments');
        const assessments = await res.json();
        const tbody = document.getElementById('assessmentsBody');

        if (assessments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#718096;">No assessments created</td></tr>';
          return;
        }

        tbody.innerHTML = assessments.map(a => {
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const skills = a.skills ? JSON.parse(a.skills) : [];
          const skillsText = skills.length > 0 ? skills.join(', ') : 'N/A';

          return `
          <tr>
            <td><strong>${a.student_name}</strong></td>
            <td>${monthNames[a.month - 1]} ${a.year}</td>
            <td>${a.certificate_title ? 'ğŸ† ' + a.certificate_title : '-'}</td>
            <td>${skillsText}</td>
            <td>${new Date(a.created_at).toLocaleDateString()}</td>
            <td>
              <button onclick="viewAssessment(${a.id})" class="btn btn-sm" style="background:#B05D9E;color:white;">View</button>
              <button onclick="deleteAssessment(${a.id})" class="btn btn-danger btn-sm">Delete</button>
            </td>
          </tr>
        `}).join('');
      } catch (err) {
        console.error(err);
      }
    }

    async function loadAssessmentStudents() {
      try {
        const res = await fetch('/api/students');
        const students = await res.json();
        const select = document.getElementById('assessmentStudent');

        select.innerHTML = '<option value="">Select Student...</option>' +
          students.filter(s => s.is_active).map(s =>
            `<option value="${s.id}">${s.name} (${s.grade})</option>`
          ).join('');
      } catch (err) {
        console.error(err);
      }
    }

    document.getElementById('monthlyAssessmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Collect checked skills
      const skills = [];
      const skillIds = [
        // Phonics
        'letter_sounds', 'blending', 'segmenting', 'sight_words', 'phonemic_awareness', 'decoding',
        // Reading
        'reading_fluency', 'reading_comprehension', 'reading_expression', 'story_understanding',
        // Spoken English
        'speaking', 'pronunciation', 'confidence', 'listening', 'conversation', 'sentence_formation',
        // Grammar
        'grammar', 'tenses', 'punctuation', 'parts_of_speech',
        // Vocabulary
        'vocabulary', 'spelling', 'word_meanings', 'synonyms_antonyms',
        // Creative Writing
        'writing', 'story_writing', 'essay_writing', 'handwriting',
        // Public Speaking
        'public_speaking', 'presentation', 'storytelling', 'debate', 'stage_presence'
      ];
      const skillNames = {
        // Phonics
        'letter_sounds': 'Letter Sounds Recognition',
        'blending': 'Blending Sounds',
        'segmenting': 'Segmenting Words',
        'sight_words': 'Sight Words',
        'phonemic_awareness': 'Phonemic Awareness',
        'decoding': 'Decoding Skills',
        // Reading
        'reading_fluency': 'Reading Fluency',
        'reading_comprehension': 'Reading Comprehension',
        'reading_expression': 'Reading with Expression',
        'story_understanding': 'Story Understanding',
        // Spoken English
        'speaking': 'Speaking & Communication',
        'pronunciation': 'Pronunciation',
        'confidence': 'Confidence Building',
        'listening': 'Active Listening',
        'conversation': 'Conversation Skills',
        'sentence_formation': 'Sentence Formation',
        // Grammar
        'grammar': 'Grammar & Structure',
        'tenses': 'Tenses',
        'punctuation': 'Punctuation',
        'parts_of_speech': 'Parts of Speech',
        // Vocabulary
        'vocabulary': 'Vocabulary Enhancement',
        'spelling': 'Spelling Mastery',
        'word_meanings': 'Word Meanings',
        'synonyms_antonyms': 'Synonyms & Antonyms',
        // Creative Writing
        'writing': 'Creative Writing',
        'story_writing': 'Story Writing',
        'essay_writing': 'Essay Writing',
        'handwriting': 'Handwriting',
        // Public Speaking
        'public_speaking': 'Public Speaking',
        'presentation': 'Presentation Skills',
        'storytelling': 'Storytelling',
        'debate': 'Debate Skills',
        'stage_presence': 'Stage Presence'
      };

      skillIds.forEach(skill => {
        if (document.getElementById(`skill_${skill}`).checked) {
          skills.push(skillNames[skill]);
        }
      });

      // Get certificate title
      let certificateTitle = document.getElementById('certificateTitle').value;
      if (certificateTitle === 'Custom') {
        certificateTitle = document.getElementById('customCertificateTitle').value;
      }
      // Remove emoji from certificate title before saving
      if (certificateTitle && certificateTitle.includes(' ')) {
        certificateTitle = certificateTitle.split(' ').slice(1).join(' ');
      }

      const sendEmail = document.getElementById('sendAssessmentEmail').checked;
      const data = {
        student_id: parseInt(document.getElementById('assessmentStudent').value),
        month: parseInt(document.getElementById('assessmentMonth').value),
        year: parseInt(document.getElementById('assessmentYear').value),
        skills: JSON.stringify(skills),
        certificate_title: certificateTitle || null,
        performance_summary: document.getElementById('performanceSummary').value,
        areas_of_improvement: document.getElementById('areasOfImprovement').value,
        teacher_comments: document.getElementById('teacherComments').value,
        send_email: sendEmail
      };

      try {
        const res = await fetch('/api/assessments', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert(`âœ… Monthly assessment created! ${sendEmail ? 'Report card sent to parent.' : ''}`);
          e.target.reset();
          loadAssessments();
        } else {
          alert('âŒ Failed to create assessment');
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    async function viewAssessment(id) {
      try {
        const res = await fetch(`/api/assessments/${id}`);
        const a = await res.json();
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const skills = a.skills ? JSON.parse(a.skills).join('\nâ€¢ ') : 'None';

        alert(`ğŸ“Š Monthly Assessment Report\n\nStudent: ${a.student_name}\nMonth/Year: ${monthNames[a.month-1]} ${a.year}\n\nğŸ† Certificate: ${a.certificate_title || 'None'}\n\nğŸ“ Skills Assessed:\nâ€¢ ${skills}\n\nğŸ“ˆ Performance Summary:\n${a.performance_summary || 'N/A'}\n\nğŸ“Œ Areas of Improvement:\n${a.areas_of_improvement || 'N/A'}\n\nğŸ’¬ Teacher's Comments:\n${a.teacher_comments || 'N/A'}`);
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    async function deleteAssessment(id) {
      if (!confirm('Delete this assessment?')) return;

      try {
        const res = await fetch(`/api/assessments/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert('âœ… Assessment deleted');
          loadAssessments();
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // Load data when tabs are switched
    const originalShowTab = showTab;
    showTab = function(name, event) {
      originalShowTab(name, event);
      if (name === 'announcements') loadAnnouncements();
      if (name === 'monthlyAssessment') {
        loadAssessments();
        loadAssessmentStudents();
      }
      if (name === 'payments') {
        loadPaymentStudentDropdown();
      }
      if (name === 'events') {
        loadEvents();
      }
    };

    // ==================== SWITCH TO LEARNER VIEW ====================
    function openSwitchToLearnerModal() {
      const select = document.getElementById('learnerViewStudent');
      select.innerHTML = '<option value="">Select Student...</option>' +
        allStudents.map(s => `<option value="${s.id}">${s.name} (${s.grade}) - ${s.parent_email}</option>`).join('');
      document.getElementById('switchToLearnerModal').classList.add('active');
    }

    function closeSwitchToLearnerModal() {
      document.getElementById('switchToLearnerModal').classList.remove('active');
    }

    async function switchToLearnerView() {
      const studentId = document.getElementById('learnerViewStudent').value;
      if (!studentId) {
        alert('Please select a student');
        return;
      }

      try {
        const res = await fetch('/api/admin/parent-view-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ student_id: studentId })
        });
        const data = await res.json();

        if (res.ok && data.token) {
          // Store the admin token and open parent portal
          sessionStorage.setItem('adminParentToken', data.token);
          window.open('parent.html', '_blank');
          closeSwitchToLearnerModal();
        } else {
          alert('Failed to generate access token');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ==================== PAYMENTS MANAGEMENT ====================
    let selectedPaymentStudentId = null;

    function loadPaymentStudentDropdown() {
      const select = document.getElementById('paymentStudent');
      select.innerHTML = '<option value="">Select Student...</option>' +
        allStudents.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
    }

    async function loadStudentPaymentDetails() {
      const studentId = document.getElementById('paymentStudent').value;
      if (!studentId) {
        document.getElementById('paymentStudentDetails').style.display = 'none';
        return;
      }

      selectedPaymentStudentId = studentId;
      const student = allStudents.find(s => s.id == studentId);

      if (student) {
        document.getElementById('payStudentName').textContent = student.name;
        document.getElementById('payTotalSessions').textContent = student.total_sessions;
        document.getElementById('payRemainingSessions').textContent = student.remaining_sessions;
        document.getElementById('payTotalPaid').textContent = `${student.currency} ${student.fees_paid || 0}`;
        document.getElementById('firstPaymentCurrency').value = student.currency || 'INR';
        document.getElementById('renewalPaymentCurrency').value = student.currency || 'INR';
        document.getElementById('paymentStudentDetails').style.display = 'block';

        // Load payment history
        await loadPaymentHistory(studentId);
      }
    }

    async function loadPaymentHistory(studentId) {
      try {
        const res = await fetch(`/api/students/${studentId}/payments`);
        const data = await res.json();
        const tbody = document.getElementById('paymentHistoryBody');

        const allPayments = [];

        // Add initial payments
        if (data.payments) {
          data.payments.forEach(p => {
            allPayments.push({
              date: p.payment_date,
              type: 'Initial',
              amount: `${p.currency} ${p.amount}`,
              sessions: p.sessions_covered || '-',
              method: p.payment_method || '-',
              notes: p.notes || '-'
            });
          });
        }

        // Add renewals
        if (data.renewals) {
          data.renewals.forEach(r => {
            allPayments.push({
              date: r.renewal_date,
              type: 'Renewal',
              amount: `${r.currency} ${r.amount}`,
              sessions: `+${r.sessions_added}`,
              method: r.payment_method || '-',
              notes: r.notes || '-'
            });
          });
        }

        // Sort by date descending
        allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (allPayments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #718096;">No payment records yet</td></tr>';
        } else {
          tbody.innerHTML = allPayments.map(p => `
            <tr>
              <td>${new Date(p.date).toLocaleDateString()}</td>
              <td><span style="background: ${p.type === 'Initial' ? '#38b2ac' : '#f6ad55'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${p.type}</span></td>
              <td><strong>${p.amount}</strong></td>
              <td>${p.sessions}</td>
              <td>${p.method}</td>
              <td>${p.notes}</td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error(err);
        document.getElementById('paymentHistoryBody').innerHTML = '<tr><td colspan="6" style="color: #e53e3e;">Error loading payment history</td></tr>';
      }
    }

    // First Payment Form
    document.getElementById('firstPaymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedPaymentStudentId) return alert('No student selected');

      const data = {
        amount: parseFloat(document.getElementById('firstPaymentAmount').value),
        currency: document.getElementById('firstPaymentCurrency').value,
        sessions_covered: document.getElementById('firstPaymentSessions').value || null,
        payment_method: document.getElementById('firstPaymentMethod').value,
        receipt_number: document.getElementById('firstPaymentReceipt').value,
        notes: document.getElementById('firstPaymentNotes').value,
        send_email: document.getElementById('sendFirstPaymentEmail').checked
      };

      try {
        const res = await fetch(`/api/students/${selectedPaymentStudentId}/payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('âœ… Payment recorded successfully!');
          e.target.reset();
          await loadStudents();
          await loadStudentPaymentDetails();
        } else {
          const err = await res.json();
          alert('âŒ Failed: ' + err.error);
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    // Renewal Payment Form
    document.getElementById('renewalPaymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedPaymentStudentId) return alert('No student selected');

      const data = {
        amount: parseFloat(document.getElementById('renewalPaymentAmount').value),
        sessions_added: parseInt(document.getElementById('renewalPaymentSessions').value),
        currency: document.getElementById('renewalPaymentCurrency').value,
        payment_method: document.getElementById('renewalPaymentMethod').value,
        notes: document.getElementById('renewalPaymentNotes').value,
        send_email: document.getElementById('sendRenewalPaymentEmail').checked
      };

      try {
        const res = await fetch(`/api/students/${selectedPaymentStudentId}/renewal`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('âœ… Renewal recorded successfully!');
          e.target.reset();
          await loadStudents();
          await loadStudentPaymentDetails();
        } else {
          const err = await res.json();
          alert('âŒ Failed: ' + err.error);
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    });

    // ==================== EVENT MANAGEMENT ====================
    let currentEventId = null;

    async function viewEvent(eventId) {
      try {
        const res = await fetch(`/api/events/${eventId}`);
        const event = await res.json();
        currentEventId = eventId;

        const eventDate = formatSessionTime({ session_date: event.event_date, session_time: event.event_time });

        document.getElementById('eventModalTitle').textContent = `ğŸ“‹ ${event.event_name}`;
        document.getElementById('eventModalContent').innerHTML = `
          <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><strong>Event Name:</strong> ${event.event_name}</div>
              <div><strong>Status:</strong> <span style="color: ${event.status === 'Active' ? '#38a169' : '#e53e3e'};">${event.status}</span></div>
              <div><strong>Date & Time (IST):</strong> ${eventDate}</div>
              <div><strong>Duration:</strong> ${event.event_duration || 'N/A'}</div>
              <div><strong>Target Audience:</strong> ${event.target_audience || 'All'}</div>
              <div><strong>Max Participants:</strong> ${event.max_participants || 'Unlimited'}</div>
              <div><strong>Current Registrations:</strong> ${event.current_participants || 0}</div>
              <div><strong>Zoom Link:</strong> <a href="${event.zoom_link}" target="_blank" style="color: #B05D9E;">Open</a></div>
            </div>
            ${event.event_description ? `<div style="margin-top: 15px;"><strong>Description:</strong><p style="margin-top: 5px; color: #4a5568;">${event.event_description}</p></div>` : ''}
          </div>
        `;
        document.getElementById('eventModal').classList.add('active');
      } catch (err) {
        alert('Error loading event: ' + err.message);
      }
    }

    function closeEventModal() {
      document.getElementById('eventModal').classList.remove('active');
    }

    async function editEvent(eventId) {
      try {
        const res = await fetch(`/api/events/${eventId}`);
        const event = await res.json();
        currentEventId = eventId;

        document.getElementById('eventModalTitle').textContent = `âœï¸ Edit Event`;
        document.getElementById('eventModalContent').innerHTML = `
          <form id="editEventForm">
            <div class="form-row">
              <div class="form-group"><label>Event Name *</label><input type="text" id="editEventName" value="${event.event_name}" required></div>
              <div class="form-group"><label>Duration</label>
                <select id="editEventDuration">
                  <option value="25 mins" ${event.event_duration === '25 mins' ? 'selected' : ''}>25 mins</option>
                  <option value="30 mins" ${event.event_duration === '30 mins' ? 'selected' : ''}>30 mins</option>
                  <option value="40 mins" ${event.event_duration === '40 mins' ? 'selected' : ''}>40 mins</option>
                  <option value="45 mins" ${event.event_duration === '45 mins' ? 'selected' : ''}>45 mins</option>
                  <option value="60 mins" ${event.event_duration === '60 mins' ? 'selected' : ''}>60 mins</option>
                  <option value="90 mins" ${event.event_duration === '90 mins' ? 'selected' : ''}>90 mins</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label>Description</label><textarea id="editEventDescription" rows="3">${event.event_description || ''}</textarea></div>
            <div class="form-row">
              <div class="form-group"><label>Status</label>
                <select id="editEventStatus">
                  <option value="Active" ${event.status === 'Active' ? 'selected' : ''}>Active</option>
                  <option value="Cancelled" ${event.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="Completed" ${event.status === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
              </div>
              <div class="form-group"><label>Max Participants</label><input type="number" id="editEventMaxParticipants" value="${event.max_participants || ''}"></div>
            </div>
            <div class="form-group"><label>Zoom Link</label><input type="text" id="editEventZoomLink" value="${event.zoom_link || ''}"></div>
            <button type="submit" class="btn btn-primary">Update Event</button>
          </form>
        `;

        document.getElementById('editEventForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await updateEvent(eventId);
        });

        document.getElementById('eventModal').classList.add('active');
      } catch (err) {
        alert('Error loading event: ' + err.message);
      }
    }

    async function updateEvent(eventId) {
      const data = {
        event_name: document.getElementById('editEventName').value,
        event_description: document.getElementById('editEventDescription').value,
        event_duration: document.getElementById('editEventDuration').value,
        status: document.getElementById('editEventStatus').value,
        max_participants: document.getElementById('editEventMaxParticipants').value || null,
        zoom_link: document.getElementById('editEventZoomLink').value
      };

      try {
        const res = await fetch(`/api/events/${eventId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('âœ… Event updated successfully!');
          closeEventModal();
          loadEvents();
        } else {
          const err = await res.json();
          alert('âŒ Failed: ' + err.error);
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    async function viewEventRegistrations(eventId, eventName) {
      try {
        const res = await fetch(`/api/events/${eventId}/registrations`);
        const registrations = await res.json();

        document.getElementById('eventRegistrationsTitle').textContent = `ğŸ‘¥ ${eventName} - Registrations`;

        if (registrations.length === 0) {
          document.getElementById('eventRegistrationsContent').innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No registrations yet</p>';
        } else {
          document.getElementById('eventRegistrationsContent').innerHTML = `
            <p style="margin-bottom: 15px; color: #4a5568;"><strong>Total Registered:</strong> ${registrations.length}</p>
            <table>
              <thead><tr><th>Student Name</th><th>Grade</th><th>Parent Name</th><th>Parent Email</th><th>Registered At</th><th>Attendance</th></tr></thead>
              <tbody>
                ${registrations.map(r => `
                  <tr>
                    <td><strong>${r.student_name}</strong></td>
                    <td>${r.grade}</td>
                    <td>${r.parent_name}</td>
                    <td>${r.parent_email}</td>
                    <td>${new Date(r.registered_at).toLocaleDateString()}</td>
                    <td><span style="background: ${r.attendance === 'Present' ? '#38a169' : r.attendance === 'Absent' ? '#e53e3e' : '#718096'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${r.attendance || 'Pending'}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        document.getElementById('eventRegistrationsModal').classList.add('active');
      } catch (err) {
        alert('Error loading registrations: ' + err.message);
      }
    }

    function closeEventRegistrationsModal() {
      document.getElementById('eventRegistrationsModal').classList.remove('active');
    }

    async function markEventAttendance(eventId, eventName) {
      try {
        const res = await fetch(`/api/events/${eventId}/registrations`);
        const registrations = await res.json();
        currentEventId = eventId;

        document.getElementById('eventAttendanceTitle').textContent = `âœ… ${eventName} - Mark Attendance`;

        if (registrations.length === 0) {
          document.getElementById('eventAttendanceContent').innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No registrations to mark attendance</p>';
        } else {
          document.getElementById('eventAttendanceContent').innerHTML = `
            <p style="margin-bottom: 15px; color: #4a5568;">Mark attendance for registered students:</p>
            <table>
              <thead><tr><th>Student Name</th><th>Grade</th><th>Current Status</th><th>Mark Attendance</th></tr></thead>
              <tbody>
                ${registrations.map(r => `
                  <tr>
                    <td><strong>${r.student_name}</strong></td>
                    <td>${r.grade}</td>
                    <td><span style="background: ${r.attendance === 'Present' ? '#38a169' : r.attendance === 'Absent' ? '#e53e3e' : '#718096'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${r.attendance || 'Pending'}</span></td>
                    <td>
                      <button onclick="saveEventAttendance(${eventId}, ${r.student_id}, 'Present')" class="btn btn-sm btn-success">Present</button>
                      <button onclick="saveEventAttendance(${eventId}, ${r.student_id}, 'Absent')" class="btn btn-sm btn-danger">Absent</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        document.getElementById('eventAttendanceModal').classList.add('active');
      } catch (err) {
        alert('Error loading attendance: ' + err.message);
      }
    }

    function closeEventAttendanceModal() {
      document.getElementById('eventAttendanceModal').classList.remove('active');
    }

    async function saveEventAttendance(eventId, studentId, status) {
      try {
        const res = await fetch(`/api/events/${eventId}/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ attendanceData: [{ student_id: studentId, attendance: status }] })
        });

        if (res.ok) {
          alert('âœ… Attendance marked!');
          // Refresh the modal
          const event = await (await fetch(`/api/events/${eventId}`)).json();
          markEventAttendance(eventId, event.event_name);
        } else {
          alert('âŒ Failed to mark attendance');
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }
  </script>

      <!-- Footer -->
      <footer style="background: white; padding: 20px; text-align: center; margin: 30px 0 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <p style="margin: 0; color: #B05D9E; font-size: 14px; font-weight: 600;">Made with â¤ï¸ By Aaliya</p>
      </footer>
    </main>
  </div>
</body>
</html>
