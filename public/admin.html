<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Fluent Feathers Academy</title>
  
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; color: #2d3748; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
    header h1 { margin: 0; font-size: 28px; color: #2b6cb0; }
    header p { margin: 5px 0 0 0; color: #718096; font-size: 0.9rem; }
    .logout-btn { background: #e53e3e; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }

    /* Modals */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-content.large-modal { max-width: 900px; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
    .btn-close { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; }

    /* Info Cards */
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .info-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; }
    .info-card h3 { margin-top: 0; color: #2c3e50; margin-bottom: 10px; }

    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
    .tab-btn.active { background: #667eea; color: white; border-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .student-details-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .detail-tab-btn { padding: 12px 20px; background: #f8f9fa; border: none; cursor: pointer; }
    .detail-tab-btn.active { background: white; border-bottom: 3px solid #667eea; color: #667eea; font-weight: bold; }
    .detail-tab-content { display: none; }
    .detail-tab-content.active { display: block; }

    /* Buttons */
    .btn-primary { background: #667eea; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-secondary { background: #95a5a6; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-view { background: #3498db; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
    .btn-edit { background: #f39c12; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
    .btn-mini-delete { background: #e74c3c; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem; }
    .action-btn { display: inline-block; margin: 5px; text-decoration: none; padding: 10px 20px; background: white; border-radius: 8px; color: #2c3e50; border: 1px solid #ddd; font-weight: 600; }
    .action-btn:hover { background: #f8f9fa; }

    /* Forms & Tables */
    .form-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
    .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
    .form-group { flex: 1; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    .schedule-row { display: flex; gap: 10px; margin-bottom: 10px; }
    
    .table-section { margin-top: 20px; background: white; padding: 20px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f8f9fa; color: #2c3e50; }
    .rating-stars { color: #f1c40f; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üéì Admin Dashboard</h1>
        <p>Fluent Feathers Academy - LMS Manager</p>
      </div>
      <button onclick="location.reload()" class="logout-btn">Refresh</button>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('dashboard', this)">üìä Dashboard</button>
      <button class="tab-btn" onclick="showTab('students', this)">üë• Students</button>
      <button class="tab-btn" onclick="showTab('sessions', this)">üìÖ Sessions</button>
      <button class="tab-btn" onclick="showTab('materials', this)">üìö Materials</button>
      <button class="tab-btn" onclick="showTab('events', this)">üéâ Events</button>
      <button class="tab-btn" onclick="showTab('batches', this)">üë• Batches</button>
      <button class="tab-btn" onclick="showTab('ratings', this)">‚≠ê Ratings</button>
      <button class="tab-btn" onclick="showTab('emails', this)">üìß Emails</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardTab" class="tab-content active">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
        <div class="info-card" style="background: white;"><h3 style="color:#667eea;">üë• Students</h3><p style="font-size: 2rem; font-weight: bold; margin: 0;" id="totalStudents">-</p></div>
        <div class="info-card" style="background: white;"><h3 style="color:#48bb78;">üìÖ Upcoming</h3><p style="font-size: 2rem; font-weight: bold; margin: 0;" id="upcomingSessions">-</p></div>
        <div class="info-card" style="background: white;"><h3 style="color:#4299e1;">üìö Today</h3><p style="font-size: 2rem; font-weight: bold; margin: 0;" id="todaySessions">-</p></div>
        <div class="info-card" style="background: white;"><h3 style="color:#f6ad55;">üí∞ Revenue</h3><p style="font-size: 2rem; font-weight: bold; margin: 0;" id="totalRevenue">-</p></div>
      </div>
      <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 30px;">
        <button onclick="window.open('https://us04web.zoom.us/j/7288533155?pwd=Nng5N2l0aU12L0FQK245c0VVVHJBUT09', '_blank')" class="action-btn">üé• Start Zoom</button>
        <button onclick="showTab('sessions', document.querySelectorAll('.tab-btn')[2])" class="action-btn">üìÖ Schedule</button>
      </div>
    </div>

    <!-- STUDENTS TAB -->
    <div id="studentsTab" class="tab-content">
      <section class="form-section">
        <h2>‚ûï Add New Student</h2>
        <form id="addStudentForm">
          <div class="form-row">
            <div class="form-group"><label>Name *</label><input type="text" id="studentName" required></div>
            <div class="form-group"><label>Grade *</label><input type="text" id="grade" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Parent Name *</label><input type="text" id="parentName" required></div>
            <div class="form-group"><label>Email *</label><input type="email" id="parentEmail" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Phone *</label><input type="tel" id="primaryContact" required></div>
            <div class="form-group"><label>Timezone *</label>
              <select id="timezone" required>
                <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                <option value="Asia/Dhaka">Asia/Dhaka (BST)</option>
                <option value="America/New_York">America/New_York (EST)</option>
                <option value="Europe/London">Europe/London (GMT)</option>
                <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
                <option value="Australia/Sydney">Australia/Sydney (AEDT)</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Program *</label><input type="text" id="programName" required></div>
            <div class="form-group"><label>Type *</label><select id="classType"><option>Private</option><option>Group</option></select></div>
            <div class="form-group"><label>Duration *</label><select id="duration"><option>25 mins</option><option>40 mins</option><option>60 mins</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Currency</label><select id="currency"><option>‚Çπ</option><option>$</option><option>¬£</option><option>‚Ç¨</option><option>‡ß≥</option><option>ÿØ.ÿ•</option></select></div>
            <div class="form-group"><label>Fee Per Session</label><input type="number" id="perSessionFee" required></div>
            <div class="form-group"><label>Total Sessions</label><input type="number" id="totalSessions" required></div>
          </div>
          <button type="submit" class="btn-primary">Add Student</button>
        </form>
      </section>

      <section class="table-section">
        <input type="text" id="searchStudents" placeholder="üîç Search..." style="padding:10px; width:300px; margin-bottom:15px;">
        <table id="studentsTable">
          <thead><tr><th>Name</th><th>Program</th><th>Timezone</th><th>Sessions (C/T)</th><th>Paid</th><th>Actions</th></tr></thead>
          <tbody id="studentsTableBody"></tbody>
        </table>
      </section>
    </div>

    <!-- SESSIONS TAB -->
    <div id="sessionsTab" class="tab-content">
      <section class="form-section">
        <h2>üìÖ Schedule Private Classes</h2>
        <form id="scheduleForm">
          <div class="form-group"><label>Select Student</label><select id="scheduleStudentId" required></select></div>
          <div id="classScheduleList"></div>
          <button type="button" onclick="addScheduleRow()" class="btn-secondary" style="margin:10px 0;">+ Add Slot</button>
          <button type="submit" class="btn-primary">Schedule & Notify</button>
        </form>
      </section>

      <section class="table-section">
        <h2>All Private Sessions</h2>
        <div class="form-row">
          <select id="filterSessionStudent" onchange="loadAllSessions()"><option value="">Select Student...</option></select>
          <select id="filterSessionStatus" onchange="loadAllSessions()"><option value="">All Status</option><option>Pending</option><option>Completed</option><option>Missed</option><option>Cancelled by Parent</option></select>
        </div>
        <table id="allSessionsTable">
          <thead><tr><th>#</th><th>Date</th><th>Time</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="allSessionsBody"></tbody>
        </table>
      </section>
    </div>

    <!-- MATERIALS TAB -->
    <div id="materialsTab" class="tab-content">
      <section class="form-section">
        <h2>üì§ Upload Material</h2>
        <form id="uploadMaterialForm">
          <div class="form-row">
            <div class="form-group">
              <label>Target</label>
              <select id="uploadType" onchange="toggleUploadTarget()">
                <option value="private">Private Student</option>
                <option value="batch">Batch/Group</option>
              </select>
            </div>
            <div class="form-group" id="privateTargetGroup"><label>Student</label><select id="privateStudentId"></select></div>
            <div class="form-group" id="batchTargetGroup" style="display:none;"><label>Batch</label><select id="batchSelectUpload"></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Date</label><input type="date" id="matDate" required></div>
            <div class="form-group"><label>Type</label><select id="matType"><option>PPT</option><option>PDF</option><option>Recording</option><option>Homework</option></select></div>
          </div>
          <div class="form-group"><input type="file" id="matFile" required></div>
          <button type="submit" class="btn-primary">Upload</button>
        </form>
      </section>
      <section class="table-section">
        <h2>Recent Uploads</h2>
        <table id="materialsTable"><thead><tr><th>Target</th><th>Date</th><th>Type</th><th>File</th><th>Action</th></tr></thead><tbody id="materialsTableBody"></tbody></table>
      </section>
    </div>

    <!-- BATCHES TAB -->
    <div id="batchesTab" class="tab-content">
      <section class="form-section">
        <h2>‚ûï Create Batch</h2>
        <form id="createBatchForm">
          <div class="form-row">
            <div class="form-group"><input type="text" id="bName" placeholder="Batch Name" required></div>
            <div class="form-group"><input type="text" id="bCode" placeholder="Code (ES-01)" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><input type="text" id="bProg" placeholder="Program" required></div>
            <div class="form-group"><input type="text" id="bGrade" placeholder="Grade" required></div>
            <div class="form-group"><select id="bDur"><option>40 mins</option><option>60 mins</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><select id="bTz"><option value="Asia/Kolkata">Asia/Kolkata</option></select></div>
            <div class="form-group"><input type="number" id="bMax" value="10"></div>
            <div class="form-group"><input type="number" id="bFee" placeholder="Fee"></div>
          </div>
          <div class="form-group"><input type="text" id="bZoom" placeholder="Zoom Link" required></div>
          <button type="submit" class="btn-primary">Create Batch</button>
        </form>
      </section>
      <section class="table-section">
        <table id="batchesTable"><thead><tr><th>Name</th><th>Program</th><th>Students</th><th>Status</th><th>Actions</th></tr></thead><tbody id="batchesTableBody"></tbody></table>
      </section>
    </div>

    <!-- EVENTS TAB -->
    <div id="eventsTab" class="tab-content">
      <section class="form-section">
        <h2>üéâ Create Event</h2>
        <form id="createEventForm">
          <div class="form-row"><div class="form-group"><input type="text" id="eName" placeholder="Event Name" required></div><div class="form-group"><select id="eType"><option>Workshop</option><option>Competition</option></select></div></div>
          <div class="form-row"><div class="form-group"><input type="date" id="eDate" required></div><div class="form-group"><input type="time" id="eTime" required></div></div>
          <div class="form-group"><input type="text" id="eDesc" placeholder="Description"></div>
          <div class="form-group"><input type="text" id="eZoom" placeholder="Zoom Link"></div>
          <button type="submit" class="btn-primary">Create Event</button>
        </form>
      </section>
      <section class="table-section">
        <table id="eventsTable"><thead><tr><th>Event</th><th>Date</th><th>Registered</th><th>Action</th></tr></thead><tbody id="eventsTableBody"></tbody></table>
      </section>
    </div>

    <!-- OTHER TABS -->
    <div id="ratingsTab" class="tab-content">
      <section class="table-section">
        <h2>‚≠ê Feedback</h2>
        <table id="ratingsTable"><thead><tr><th>Date</th><th>Student</th><th>Rating</th><th>Comment</th></tr></thead><tbody id="ratingsTableBody"></tbody></table>
      </section>
    </div>

    <div id="emailsTab" class="tab-content">
      <section class="table-section">
        <h2>üìß Email Log</h2>
        <table id="emailsTable"><thead><tr><th>Time</th><th>To</th><th>Type</th><th>Status</th></tr></thead><tbody id="emailsTableBody"></tbody></table>
      </section>
    </div>
  </div>

  <!-- MODALS -->
  <div id="studentDetailsModal" class="modal"><div class="modal-content large-modal"><div class="modal-header"><h2>Details</h2><button onclick="closeModal('studentDetailsModal')" class="btn-close">x</button></div><div id="studentDetailsContent"></div></div></div>
  <div id="batchDetailsModal" class="modal"><div class="modal-content large-modal"><div class="modal-header"><h2>Batch Details</h2><button onclick="closeModal('batchDetailsModal')" class="btn-close">x</button></div><div id="batchDetailsContent"></div></div></div>

  <script>
    let allStudents = [];
    let allBatches = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadStudents();
      loadBatches();
      loadMaterials();
      loadEvents();
      loadRatings();
      loadEmails();
    });

    // --- TABS ---
    function showTab(t, btn) {
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(t+'Tab').classList.add('active');
      if(btn) btn.classList.add('active');
    }

    // --- DASHBOARD ---
    async function loadStats() {
      const res = await fetch('/api/dashboard/stats');
      const data = await res.json();
      document.getElementById('totalStudents').innerText = data.totalStudents;
      document.getElementById('upcomingSessions').innerText = data.upcomingSessions;
      document.getElementById('todaySessions').innerText = data.todaySessions;
      document.getElementById('totalRevenue').innerText = '‚Çπ'+data.totalRevenue;
    }

    // --- STUDENTS ---
    async function loadStudents() {
      const res = await fetch('/api/students');
      allStudents = await res.json();
      const tbody = document.getElementById('studentsTableBody');
      tbody.innerHTML = allStudents.map(s => `
        <tr>
          <td>${s.name}<br><small>${s.grade}</small></td>
          <td>${s.program_name}</td>
          <td>${s.timezone}</td>
          <td>${s.completed_sessions}/${s.total_sessions}</td>
          <td style="color:green; font-weight:bold;">${s.currency}${s.fees_paid}</td>
          <td>
            <button onclick="viewStudent(${s.id})" class="btn-view">View</button>
            <button onclick="deleteStudent(${s.id})" class="btn-mini-delete">Del</button>
          </td>
        </tr>
      `).join('');
      
      // Populate dropdowns
      const opts = '<option value="">Select...</option>' + allStudents.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      ['scheduleStudentId','filterSessionStudent','privateStudentId'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = opts;
      });
    }

    document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        name: document.getElementById('studentName').value,
        grade: document.getElementById('grade').value,
        parent_name: document.getElementById('parentName').value,
        parent_email: document.getElementById('parentEmail').value,
        primary_contact: document.getElementById('primaryContact').value,
        timezone: document.getElementById('timezone').value,
        program_name: document.getElementById('programName').value,
        class_type: document.getElementById('classType').value,
        duration: document.getElementById('duration').value,
        currency: document.getElementById('currency').value,
        per_session_fee: document.getElementById('perSessionFee').value,
        total_sessions: document.getElementById('totalSessions').value
      };
      await fetch('/api/students', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
      alert('Student Added'); loadStudents(); loadStats(); e.target.reset();
    });

    async function viewStudent(id) {
      const res = await fetch(`/api/students/${id}/details`);
      const d = await res.json();
      const s = d.student;
      
      let html = `
        <div class="info-grid">
          <div class="info-card"><h3>${s.name}</h3><p>Email: ${s.parent_email}</p><p>Pass: ${s.parent_credentials?.password ? 'Set' : 'Not Set'}</p></div>
          <div class="info-card"><h3>Balance</h3><p>Paid: ${s.fees_paid}</p><p>Remaining: ${s.remaining_sessions}</p></div>
        </div>
        <div style="margin-top:20px;">
          <button onclick="loginAsStudent(${s.id}, '${s.parent_email}')" class="btn-primary" style="width:auto;">Login as Parent</button>
          <button onclick="recordPayment(${s.id})" class="btn-secondary" style="width:auto;">Record Payment</button>
        </div>
        <h3>History</h3>
        <table><thead><tr><th>Date</th><th>Status</th><th>Notes</th></tr></thead><tbody>
        ${d.sessions.map(x=>`<tr><td>${x.session_date}</td><td>${x.status}</td><td>${x.teacher_notes||'-'}</td></tr>`).join('')}
        </tbody></table>
      `;
      document.getElementById('studentDetailsContent').innerHTML = html;
      document.getElementById('studentDetailsModal').style.display='flex';
    }

    window.loginAsStudent = (id, email) => {
      const s = allStudents.find(x=>x.id==id);
      sessionStorage.setItem('adminAccessMode', 'true');
      sessionStorage.setItem('adminAccessStudent', JSON.stringify(s));
      sessionStorage.setItem('adminAccessEmail', email);
      window.open('parent.html', '_blank');
    }
    
    window.deleteStudent = async (id) => {
        if(confirm('Delete student?')) {
            await fetch(`/api/students/${id}`, {method:'DELETE'});
            loadStudents();
        }
    }

    // --- SESSIONS ---
    function addScheduleRow() {
      const div = document.createElement('div');
      div.className = 'schedule-row';
      div.innerHTML = `<input type="date" required><input type="time" required><button type="button" onclick="this.parentElement.remove()" class="btn-mini-delete">x</button>`;
      document.getElementById('classScheduleList').appendChild(div);
    }

    document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sid = document.getElementById('scheduleStudentId').value;
      const classes = [];
      document.querySelectorAll('#classScheduleList .schedule-row').forEach(row => {
        const i = row.querySelectorAll('input');
        classes.push({ date: i[0].value, time: i[1].value });
      });
      await fetch('/api/schedule/classes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({student_id:sid, classes})});
      alert('Scheduled'); document.getElementById('classScheduleList').innerHTML='';
    });

    async function loadAllSessions() {
      const sid = document.getElementById('filterSessionStudent').value;
      if(!sid) return;
      const res = await fetch(`/api/sessions/${sid}`);
      const data = await res.json();
      const status = document.getElementById('filterSessionStatus').value;
      
      const filtered = status ? data.filter(x=>x.status===status) : data;
      
      document.getElementById('allSessionsBody').innerHTML = filtered.map(s => `
        <tr>
          <td>${s.session_number}</td>
          <td>${s.session_date}</td>
          <td>${s.session_time}</td>
          <td>${s.status}</td>
          <td>
            <button onclick="deleteSession(${s.id})" class="btn-mini-delete">Del</button>
            ${s.status==='Pending' ? `<button onclick="cancelSession(${s.student_id})" class="btn-secondary" style="padding:5px;">Cancel</button>` : ''}
          </td>
        </tr>
      `).join('');
    }
    
    window.deleteSession = async (id) => { if(confirm('Delete?')) { await fetch(`/api/sessions/${id}`, {method:'DELETE'}); loadAllSessions(); }}
    
    // Admin Cancel (Simulates Teacher Cancellation)
    window.cancelSession = async (sid) => {
        const reason = prompt("Reason for cancellation?");
        if(reason) {
            await fetch(`/api/attendance/cancel/${sid}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({reason})
            });
            alert('Cancelled & Credit Issued'); loadAllSessions();
        }
    }

    // --- MATERIALS ---
    function toggleUploadTarget() {
      const type = document.getElementById('uploadType').value;
      document.getElementById('privateTargetGroup').style.display = type==='private'?'block':'none';
      document.getElementById('batchTargetGroup').style.display = type==='batch'?'block':'none';
    }

    document.getElementById('uploadMaterialForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const type = document.getElementById('uploadType').value;
      const formData = new FormData();
      formData.append('file', document.getElementById('matFile').files[0]);
      formData.append('sessionDate', document.getElementById('matDate').value);
      formData.append('fileType', document.getElementById('matType').value);
      formData.append('uploadType', type);

      let url;
      if(type==='private') {
        url = `/api/upload/material/${document.getElementById('privateStudentId').value}`;
      } else {
        url = `/api/upload/batch-material/${document.getElementById('batchSelectUpload').value}`;
      }
      
      const res = await fetch(url, {method:'POST', body:formData});
      if(res.ok) { alert('Uploaded'); loadMaterials(); } else { alert('Error'); }
    });

    async function loadMaterials() {
      const res = await fetch('/api/materials/all/admin');
      const data = await res.json();
      document.getElementById('materialsTableBody').innerHTML = data.map(m => `
        <tr>
          <td>${m.student_id ? 'Private' : 'Batch: '+m.batch_name}</td>
          <td>${m.session_date}</td>
          <td>${m.file_type}</td>
          <td><a href="/uploads/homework/${m.file_path}" target="_blank">View</a></td>
          <td><button onclick="deleteMat(${m.id})" class="btn-mini-delete">x</button></td>
        </tr>
      `).join('');
    }
    window.deleteMat = async(id)=>{ if(confirm('Del?')) { await fetch(`/api/materials/${id}`, {method:'DELETE'}); loadMaterials(); }}

    // --- BATCHES ---
    async function loadBatches() {
      const res = await fetch('/api/batches');
      allBatches = await res.json();
      document.getElementById('batchesTableBody').innerHTML = allBatches.map(b => `
        <tr>
          <td>${b.batch_name}</td>
          <td>${b.program_name}</td>
          <td>${b.enrolled_students}/${b.max_students}</td>
          <td>${b.status}</td>
          <td><button onclick="viewBatch(${b.id})" class="btn-view">Manage</button></td>
        </tr>
      `).join('');
      
      const opts = '<option value="">Select...</option>' + allBatches.map(b=>`<option value="${b.id}">${b.batch_name}</option>`).join('');
      document.getElementById('batchSelectUpload').innerHTML = opts;
    }

    document.getElementById('createBatchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        batch_name: document.getElementById('bName').value,
        batch_code: document.getElementById('bCode').value,
        program_name: document.getElementById('bProg').value,
        grade_level: document.getElementById('bGrade').value,
        duration: document.getElementById('bDur').value,
        timezone: document.getElementById('bTz').value,
        max_students: document.getElementById('bMax').value,
        per_session_fee: document.getElementById('bFee').value,
        zoom_link: document.getElementById('bZoom').value
      };
      await fetch('/api/batches', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
      alert('Batch Created'); loadBatches(); e.target.reset();
    });

    async function viewBatch(id) {
        // Simple View implementation
        const res = await fetch(`/api/batches/${id}/details`);
        const d = await res.json();
        const html = `
            <h3>${d.batch.batch_name}</h3>
            <div class="info-grid">
                <div>Students: ${d.enrollments.length}</div>
                <div>Sessions: ${d.sessions.length}</div>
            </div>
            <h4>Enroll Student</h4>
            <div style="margin:10px 0;">
                <select id="enrollSid">${document.getElementById('scheduleStudentId').innerHTML}</select>
                <button onclick="enrollInBatch(${id})" class="btn-primary" style="width:auto;">Enroll</button>
            </div>
            <h4>Schedule</h4>
            <div id="batchScheduleRows"></div>
            <button onclick="addBatchScheduleRowUI()" class="btn-secondary">+ Row</button>
            <button onclick="submitBatchSchedule(${id})" class="btn-primary">Save Schedule</button>
            <hr>
            <h4>Enrolled Students</h4>
            <ul>${d.enrollments.map(e=>`<li>${e.name}</li>`).join('')}</ul>
        `;
        document.getElementById('batchDetailsContent').innerHTML = html;
        document.getElementById('batchDetailsModal').style.display = 'flex';
    }
    
    window.enrollInBatch = async(bid) => {
        const sid = document.getElementById('enrollSid').value;
        if(!sid) return;
        await fetch(`/api/batches/${bid}/enroll`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({student_id:sid})});
        alert('Enrolled'); viewBatch(bid);
    }
    
    window.addBatchScheduleRowUI = () => {
        const div = document.createElement('div');
        div.className = 'schedule-row batch-row';
        div.innerHTML = `<input type="date"><input type="time"><button onclick="this.parentElement.remove()">x</button>`;
        document.getElementById('batchScheduleRows').appendChild(div);
    }
    
    window.submitBatchSchedule = async(bid) => {
        const sessions = [];
        document.querySelectorAll('.batch-row').forEach(r => {
            const i = r.querySelectorAll('input');
            sessions.push({date:i[0].value, time:i[1].value});
        });
        await fetch(`/api/batches/${bid}/schedule`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({sessions})});
        alert('Scheduled'); viewBatch(bid);
    }

    // --- EVENTS ---
    document.getElementById('createEventForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            event_name: document.getElementById('eName').value,
            event_type: document.getElementById('eType').value,
            event_date: document.getElementById('eDate').value,
            event_time: document.getElementById('eTime').value,
            event_description: document.getElementById('eDesc').value,
            zoom_link: document.getElementById('eZoom').value,
            duration: '1 hour'
        };
        await fetch('/api/events', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        alert('Event Created'); loadEvents(); e.target.reset();
    });
    
    async function loadEvents() {
        const res = await fetch('/api/events');
        const data = await res.json();
        document.getElementById('eventsTableBody').innerHTML = data.map(e => `<tr><td>${e.event_name}</td><td>${e.event_date}</td><td>${e.registered_count||0}</td><td><button onclick="delEvent(${e.id})" class="btn-mini-delete">x</button></td></tr>`).join('');
    }
    window.delEvent = async(id) => { if(confirm('Del?')) { await fetch(`/api/events/${id}`, {method:'DELETE'}); loadEvents(); } }

    // --- RATINGS & EMAILS ---
    async function loadRatings() {
        const res = await fetch('/api/admin/ratings');
        const data = await res.json();
        document.getElementById('ratingsTableBody').innerHTML = data.map(r => `<tr><td>${new Date(r.student_feedback_date).toLocaleDateString()}</td><td>${r.student_name}</td><td>${r.student_rating}‚≠ê</td><td>${r.student_feedback}</td></tr>`).join('');
    }
    
    async function loadEmails() {
        const res = await fetch('/api/emails/log');
        const data = await res.json();
        document.getElementById('emailsTableBody').innerHTML = data.map(e => `<tr><td>${new Date(e.sent_at).toLocaleString()}</td><td>${e.recipient_email}</td><td>${e.email_type}</td><td>${e.status}</td></tr>`).join('');
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.recordPayment = (id) => { 
        const amount = prompt("Amount?"); 
        if(amount) fetch(`/api/students/${id}/payment`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({amount, currency:'‚Çπ', payment_method:'Cash', sessions_covered:'-'})}).then(()=>alert('Recorded')); 
    }
  </script>
</body>
</html>