<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Fluent Feathers Academy</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; margin: 0; padding: 0; color: #2d3748; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    h1 { margin: 0; color: #2b6cb0; }
    
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
    .tab-btn.active { background: #667eea; color: white; border-color: #667eea; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .info-card { background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    .form-section { background: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
    .form-group { flex: 1; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f8f9fa; font-weight: 600; }
    
    .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-size: 0.9rem; }
    .btn-primary { background: #667eea; }
    .btn-secondary { background: #95a5a6; }
    .btn-danger { background: #e74c3c; }
    .btn-success { background: #27ae60; }
    .btn-sm { padding: 4px 8px; font-size: 0.8rem; margin-right: 5px; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
    .close-modal { float: right; cursor: pointer; font-size: 1.5rem; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div><h1>ðŸŽ“ Admin Dashboard</h1><p>Fluent Feathers Academy</p></div>
    <button onclick="location.reload()" class="btn btn-secondary">Refresh</button>
  </header>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('dashboard', this)">ðŸ“Š Dashboard</button>
    <button class="tab-btn" onclick="showTab('students', this)">ðŸ‘¥ Students</button>
    <button class="tab-btn" onclick="showTab('sessions', this)">ðŸ“… Sessions</button>
    <button class="tab-btn" onclick="showTab('materials', this)">ðŸ“š Materials</button>
    <button class="tab-btn" onclick="showTab('batches', this)">ðŸ‘¥ Batches</button>
    <button class="tab-btn" onclick="showTab('events', this)">ðŸŽ‰ Events</button>
    <button class="tab-btn" onclick="showTab('emails', this)">ðŸ“§ Emails</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardTab" class="tab-content active">
    <div class="info-grid">
      <div class="info-card"><h3>Students</h3><h2 id="statsStudents">-</h2></div>
      <div class="info-card"><h3>Upcoming</h3><h2 id="statsUpcoming">-</h2></div>
      <div class="info-card"><h3>Today</h3><h2 id="statsToday">-</h2></div>
      <div class="info-card"><h3>Revenue</h3><h2 id="statsRevenue">-</h2></div>
    </div>
    <div style="display:flex; gap:10px;">
      <button onclick="showTab('sessions', document.querySelectorAll('.tab-btn')[2])" class="btn btn-primary">Schedule Class</button>
      <a href="https://us04web.zoom.us/j/7288533155?pwd=Nng5N2l0aU12L0FQK245c0VVVHJBUT09" target="_blank" class="btn btn-success" style="text-decoration:none; display:inline-block;">Start Zoom</a>
    </div>
  </div>

  <!-- STUDENTS -->
  <div id="studentsTab" class="tab-content">
    <section class="form-section">
      <h3>Add Student</h3>
      <form id="addStudentForm">
        <div class="form-row"><div class="form-group"><label>Name</label><input id="sName" required></div><div class="form-group"><label>Grade</label><input id="sGrade" required></div></div>
        <div class="form-row"><div class="form-group"><label>Parent Name</label><input id="pName" required></div><div class="form-group"><label>Email</label><input type="email" id="pEmail" required></div></div>
        <div class="form-row">
          <div class="form-group"><label>Program</label><input id="sProg" required></div>
          <div class="form-group"><label>Timezone</label><select id="sTz"><option value="Asia/Kolkata">IST</option><option value="America/New_York">EST</option><option value="Asia/Dubai">GST</option><option value="Europe/London">GMT</option></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Fee</label><input type="number" id="sFee" required></div>
          <div class="form-group"><label>Total Sessions</label><input type="number" id="sTotal" required></div>
        </div>
        <button type="submit" class="btn btn-primary">Add Student</button>
      </form>
    </section>
    <table id="studentsTable"><thead><tr><th>Name</th><th>Program</th><th>Sessions</th><th>Paid</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- SESSIONS -->
  <div id="sessionsTab" class="tab-content">
    <section class="form-section">
      <h3>Schedule Private Class</h3>
      <form id="scheduleForm">
        <div class="form-group"><label>Student</label><select id="schedSid" required></select></div>
        <div class="form-row" style="margin-top:10px;">
          <div class="form-group"><label>Date</label><input type="date" id="schedDate" required></div>
          <div class="form-group"><label>Time</label><input type="time" id="schedTime" required></div>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top:10px;">Schedule</button>
      </form>
    </section>
    <div class="form-group"><select id="filterSid" onchange="loadSessions()"><option value="">Select Student to View Sessions...</option></select></div>
    <table id="sessionsTable"><thead><tr><th>Date</th><th>Time</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- MATERIALS -->
  <div id="materialsTab" class="tab-content">
    <section class="form-section">
      <h3>Upload Material</h3>
      <form id="uploadForm">
        <div class="form-row">
          <div class="form-group"><label>Type</label><select id="upType"><option value="private">Private</option><option value="batch">Batch</option></select></div>
          <div class="form-group"><label>Student/Batch ID</label><input id="upId" placeholder="ID" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Date</label><input type="date" id="upDate" required></div>
          <div class="form-group"><label>File Type</label><select id="upFileType"><option>PPT</option><option>Homework</option><option>Recording</option></select></div>
        </div>
        <div class="form-group"><input type="file" id="upFile" required></div>
        <button type="submit" class="btn btn-primary">Upload</button>
      </form>
    </section>
    <table id="materialsTable"><thead><tr><th>For</th><th>Date</th><th>File</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- BATCHES -->
  <div id="batchesTab" class="tab-content">
    <section class="form-section">
      <h3>Create Batch</h3>
      <form id="batchForm">
        <div class="form-row"><div class="form-group"><input id="bName" placeholder="Name" required></div><div class="form-group"><input id="bCode" placeholder="Code" required></div></div>
        <div class="form-row"><div class="form-group"><input id="bProg" placeholder="Program"></div><div class="form-group"><input type="number" id="bMax" value="10"></div></div>
        <button type="submit" class="btn btn-primary">Create</button>
      </form>
    </section>
    <table id="batchesTable"><thead><tr><th>Name</th><th>Code</th><th>Students</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- EVENTS -->
  <div id="eventsTab" class="tab-content">
    <section class="form-section">
      <h3>Create Event</h3>
      <form id="eventForm">
        <div class="form-row"><div class="form-group"><input id="eName" placeholder="Name" required></div><div class="form-group"><input type="date" id="eDate" required></div></div>
        <button type="submit" class="btn btn-primary">Create Event</button>
      </form>
    </section>
    <table id="eventsTable"><thead><tr><th>Name</th><th>Date</th><th>Registered</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- EMAILS -->
  <div id="emailsTab" class="tab-content">
    <h3>Email Logs</h3>
    <table id="emailsTable"><thead><tr><th>Time</th><th>To</th><th>Subject</th><th>Status</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<!-- STUDENT MODAL -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeModal()">Ã—</span>
    <h2 id="modalTitle">Student Details</h2>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// --- CORE FUNCTIONS ---
const api = async (url, method='GET', body=null) => {
  const opts = { method, headers: {'Content-Type': 'application/json'} };
  if(body) opts.body = JSON.stringify(body);
  const res = await fetch('/api'+url, opts);
  return res.json();
};

const getEl = id => document.getElementById(id);
let allStudents = [];

function showTab(name, btn) {
  document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  getEl(name+'Tab').classList.add('active');
  if(btn) btn.classList.add('active');
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', async () => {
  loadStats();
  loadStudents();
  loadBatches();
  loadMaterials();
  loadEvents();
  loadEmails();
});

// --- DASHBOARD ---
async function loadStats() {
  const data = await api('/dashboard/stats');
  getEl('statsStudents').innerText = data.totalStudents;
  getEl('statsUpcoming').innerText = data.upcomingSessions;
  getEl('statsToday').innerText = data.todaySessions;
  getEl('statsRevenue').innerText = 'â‚¹' + data.totalRevenue;
}

// --- STUDENTS ---
async function loadStudents() {
  allStudents = await api('/students');
  const tbody = getEl('studentsTable').querySelector('tbody');
  tbody.innerHTML = allStudents.map(s => `
    <tr>
      <td>${s.name}</td>
      <td>${s.program_name}</td>
      <td>${s.completed_sessions}/${s.total_sessions}</td>
      <td style="color:green">â‚¹${s.fees_paid}</td>
      <td>
        <button onclick="viewStudent(${s.id})" class="btn btn-sm btn-secondary">View</button>
        <button onclick="deleteStudent(${s.id})" class="btn btn-sm btn-danger">Del</button>
      </td>
    </tr>
  `).join('');
  
  // Populate dropdowns
  const opts = '<option value="">Select Student...</option>' + allStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  getEl('schedSid').innerHTML = opts;
  getEl('filterSid').innerHTML = opts;
}

getEl('addStudentForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const body = {
    name: getEl('sName').value, grade: getEl('sGrade').value, parent_name: getEl('pName').value,
    parent_email: getEl('pEmail').value, program_name: getEl('sProg').value, timezone: getEl('sTz').value,
    per_session_fee: getEl('sFee').value, total_sessions: getEl('sTotal').value,
    primary_contact: '0000000000', class_type: 'Private', duration: '60 mins', currency: 'â‚¹'
  };
  await api('/students', 'POST', body);
  alert('Student Added'); loadStudents(); loadStats(); e.target.reset();
});

async function viewStudent(id) {
  const data = await api(`/students/${id}/details`);
  const s = data.student;
  getEl('modalTitle').innerText = s.name;
  getEl('modalBody').innerHTML = `
    <p><strong>Email:</strong> ${s.parent_email}</p>
    <p><strong>Login:</strong> <button onclick="loginAs(${s.id}, '${s.parent_email}')" class="btn btn-sm btn-primary">Login as Parent</button></p>
    <hr>
    <p><strong>Balance:</strong> Paid â‚¹${s.fees_paid} / Remaining: ${s.remaining_sessions} classes</p>
    <button onclick="addPayment(${s.id})" class="btn btn-sm btn-success">Record Payment</button>
  `;
  getEl('studentModal').style.display = 'flex';
}

function loginAs(id, email) {
  const s = allStudents.find(x => x.id == id);
  sessionStorage.setItem('adminAccessMode', 'true');
  sessionStorage.setItem('adminAccessStudent', JSON.stringify(s));
  sessionStorage.setItem('adminAccessEmail', email);
  window.open('parent.html', '_blank');
}

async function addPayment(id) {
  const amt = prompt('Enter Amount:');
  if(amt) {
    await api(`/students/${id}/payment`, 'POST', {amount: amt, currency: 'â‚¹', payment_method: 'Cash', sessions_covered: 'N/A'});
    alert('Payment Recorded'); viewStudent(id); loadStats();
  }
}

async function deleteStudent(id) {
  if(confirm('Delete student?')) { await api(`/students/${id}`, 'DELETE'); loadStudents(); }
}

// --- SESSIONS (THE FIX FOR ATTENDANCE IS HERE) ---
getEl('scheduleForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const body = {
    student_id: getEl('schedSid').value,
    classes: [{ date: getEl('schedDate').value, time: getEl('schedTime').value }]
  };
  await api('/schedule/classes', 'POST', body);
  alert('Scheduled'); loadStats(); e.target.reset();
});

async function loadSessions() {
  const sid = getEl('filterSid').value;
  if(!sid) return;
  const sessions = await api(`/sessions/${sid}`);
  getEl('sessionsTable').querySelector('tbody').innerHTML = sessions.map(s => {
    // Determine buttons based on status
    let btns = '';
    if(s.status === 'Pending' || s.status === 'Scheduled') {
      btns = `
        <button onclick="markAtt(${s.id}, ${s.student_id})" class="btn btn-sm btn-success">âœ… Mark</button>
        <button onclick="cancelSess(${s.student_id})" class="btn btn-sm btn-secondary">ðŸš« Cancel</button>
        <button onclick="delSess(${s.id})" class="btn btn-sm btn-danger">Del</button>
      `;
    } else {
      btns = `<span style="color:gray">${s.status}</span>`;
    }
    return `<tr><td>${s.session_date}</td><td>${s.session_time}</td><td>${s.status}</td><td>${btns}</td></tr>`;
  }).join('');
}

// âœ… THE ATTENDANCE FUNCTIONS
window.markAtt = async (sid, stid) => {
  const isPresent = confirm("Click OK for PRESENT, Cancel for ABSENT");
  const status = isPresent ? 'Present' : 'Absent';
  
  if (status === 'Absent') {
     // If absent, use the cancellation logic to ensure credit logic is handled if you prefer, 
     // but simplified marking is also supported if you just want to track it.
     // For this system, let's use the standard mark route.
  }
  
  await fetch(`/api/attendance/mark-attendance/${sid}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ status, studentId: stid })
  });
  alert(`Marked as ${status}`);
  loadSessions();
  loadStats();
};

window.cancelSess = async (stid) => {
  const reason = prompt("Reason?");
  if(reason) {
    await api(`/attendance/cancel/${stid}`, 'POST', {reason});
    alert('Cancelled'); loadSessions();
  }
};

window.delSess = async (id) => {
  if(confirm('Delete?')) { await api(`/sessions/${id}`, 'DELETE'); loadSessions(); }
};

// --- MATERIALS ---
getEl('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const type = getEl('upType').value;
  const id = getEl('upId').value;
  const formData = new FormData();
  formData.append('file', getEl('upFile').files[0]);
  formData.append('sessionDate', getEl('upDate').value);
  formData.append('fileType', getEl('upFileType').value);
  formData.append('uploadType', type);
  
  const url = type === 'private' ? `/upload/material/${id}` : `/upload/batch-material/${id}`;
  const res = await fetch('/api'+url, {method:'POST', body:formData});
  if(res.ok) { alert('Uploaded'); loadMaterials(); } else { alert('Error'); }
});

async function loadMaterials() {
  const data = await api('/materials/all/admin');
  getEl('materialsTable').querySelector('tbody').innerHTML = data.map(m => `
    <tr><td>${m.batch_name || 'Private'}</td><td>${m.session_date}</td><td>${m.file_name}</td><td><a href="/uploads/homework/${m.file_path}" target="_blank">View</a></td></tr>
  `).join('');
}

// --- BATCHES & EVENTS (Simplified) ---
getEl('batchForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const body = {
    batch_name: getEl('bName').value, batch_code: getEl('bCode').value, program_name: getEl('bProg').value,
    grade_level: 'Mixed', duration: '60 mins', timezone: 'Asia/Kolkata', max_students: getEl('bMax').value,
    currency: 'â‚¹', per_session_fee: 0, zoom_link: 'link'
  };
  await api('/batches', 'POST', body);
  alert('Batch Created'); loadBatches(); e.target.reset();
});

async function loadBatches() {
  const data = await api('/batches');
  getEl('batchesTable').querySelector('tbody').innerHTML = data.map(b => `
    <tr><td>${b.batch_name}</td><td>${b.batch_code}</td><td>${b.enrolled_students}</td><td><button class="btn btn-sm btn-secondary">Manage</button></td></tr>
  `).join('');
}

getEl('eventForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const body = { event_name: getEl('eName').value, event_date: getEl('eDate').value, event_time: '10:00', event_type: 'Workshop', duration: '1h', zoom_link: 'link' };
  await api('/events', 'POST', body);
  alert('Event Created'); loadEvents(); e.target.reset();
});

async function loadEvents() {
  const data = await api('/events');
  getEl('eventsTable').querySelector('tbody').innerHTML = data.map(e => `
    <tr><td>${e.event_name}</td><td>${e.event_date}</td><td>${e.registered_count||0}</td><td><button onclick="delEvent(${e.id})" class="btn btn-sm btn-danger">x</button></td></tr>
  `).join('');
}
window.delEvent = async (id) => { if(confirm('Del?')) { await api(`/events/${id}`, 'DELETE'); loadEvents(); } };

async function loadEmails() {
  const data = await api('/emails/log');
  getEl('emailsTable').querySelector('tbody').innerHTML = data.map(e => `
    <tr><td>${new Date(e.sent_at).toLocaleTimeString()}</td><td>${e.recipient_email}</td><td>${e.subject}</td><td>${e.status}</td></tr>
  `).join('');
}

function closeModal() { getEl('studentModal').style.display='none'; }
</script>
</body>
</html>