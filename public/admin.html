<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Fluent Feathers Academy By Aaliya</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; color: #2d3748; }

    /* Loading Screen - Shows immediately to prevent black screen */
    #serverLoadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-top: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Hide main content until server is ready */
    .app-layout {
      min-height: 100vh;
      display: none;
    }
    .app-layout.ready {
      display: flex;
    }
    .sidebar { width: 240px; background: linear-gradient(180deg, #B05D9E 0%, #8B4789 100%); color: white; position: fixed; height: 100vh; overflow-y: auto; padding: 20px 0; z-index: 100; }
    .sidebar-header { padding: 10px 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
    .sidebar-header h2 { font-size: 18px; margin-bottom: 5px; }
    .sidebar-header p { font-size: 11px; opacity: 0.8; }
    .sidebar-nav { padding: 0 10px; }
    .nav-btn { width: 100%; padding: 12px 15px; background: transparent; border: none; color: white; text-align: left; cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 8px; margin-bottom: 4px; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
    .nav-btn:hover { background: rgba(255,255,255,0.15); }
    .nav-btn.active { background: rgba(255,255,255,0.25); font-weight: 600; }

    .main-content { margin-left: 240px; flex: 1; padding: 20px 30px; }
    header { background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    header h1 { color: #B05D9E; font-size: 24px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #B05D9E; }
    .stat-card h3 { color: #718096; font-size: 0.85rem; margin-bottom: 8px; }
    .stat-card .value { font-size: 1.8rem; font-weight: bold; color: #2d3748; }

    /* Hide old tabs - now using sidebar */
    .tabs { display: none; }
    .tab-btn { padding: 12px 24px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: #B05D9E; color: white; border-color: #B05D9E; }

    /* Responsive */
    @media (max-width: 900px) {
      .sidebar { width: 60px; }
      .sidebar-header h2, .sidebar-header p, .nav-btn span { display: none; }
      .nav-btn { justify-content: center; padding: 12px; }
      .main-content { margin-left: 60px; padding: 15px; }
      header { flex-direction: column; align-items: flex-start; }
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }

    /* Clean mode for whiteboard and profile - simple approach */
    body.clean-view .main-content {
      padding-top: 15px !important;
    }
    body.clean-view .tabs {
      display: none !important;
    }
    body.clean-view .tab-content.active .section {
      margin-top: 0 !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
    }
    /* Ensure whiteboard toolbar wraps properly */
    #whiteboardTab .section > div:first-of-type {
      flex-wrap: wrap !important;
    }
    .section h2 { color: #2d3748; margin-bottom: 20px; font-size: 1.5rem; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #B05D9E; color: white; }
    .btn-primary:hover { background: #9A4D88; }
    .btn-success { background: #38a169; color: white; }
    .btn-success:hover { background: #2f855a; }
    .btn-warning { background: #ed8936; color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-danger:hover { background: #c53030; }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; color: #4a5568; font-weight: 600; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
    .modal-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .modal-tab { padding: 10px 20px; background: #f7fafc; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .modal-tab.active { background: #B05D9E; color: white; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .upcoming-classes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .class-card { background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; }
    .schedule-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .schedule-row input { flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; }
    .session-item { background: #f7fafc; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #B05D9E; display: flex; justify-content: space-between; align-items: center; }
    .star-rating { display: flex; gap: 5px; font-size: 24px; }
    .star { cursor: default; color: #fbbf24; }
    .badge-item { display: inline-block; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 8px 16px; border-radius: 20px; margin: 5px; font-size: 0.9rem; }
    /* Attendance status badges */
    .att-badge { padding: 4px 12px; border-radius: 12px; font-size: 13px; color: white; }
    .att-badge-present { background: #38a169; }
    .att-badge-excused { background: #dd6b20; }
    .att-badge-absent { background: #e53e3e; }
    .att-badge-pending { background: #718096; }
    .btn-att-active-present { background: #276749 !important; }
    .btn-att-active-excused { background: #c05621 !important; }
    .btn-att-active-absent { background: #c53030 !important; }
    /* Status colors */
    .status-active { color: #38a169; }
    .status-inactive { color: #e53e3e; }
    /* Material type badges */
    .mat-badge { color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
    .mat-badge-ppt { background: #ed8936; }
    .mat-badge-recording { background: #9f7aea; }
    .mat-badge-homework { background: #38b2ac; }
    .mat-badge-other { background: #718096; }
    /* Email log badges */
    .email-badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    .email-badge-group { background: #9f7aea; color: white; }
    .email-badge-default { background: #e2e8f0; color: #4a5568; }
    /* Demo class styling */
    .class-card-demo { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    /* Table row backgrounds */
    .row-even { background: #f7fafc; }
    .row-odd { background: white; }
    .row-pending { background: #fffbeb; }
    .row-completed { background: #f0fff4; }
    /* Leaderboard styling */
    .leaderboard-top3 { background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.05) 100%); }
    .rank-top3 { font-size: 1.5rem; }
    .rank-normal { font-size: 1rem; color: #718096; }
    /* Challenge status styling */
    .challenge-row-pending { background: #fffbeb; }
    .challenge-row-completed { background: #f0fff4; }
    .challenge-row-submitted { background: linear-gradient(90deg, rgba(159,122,234,0.15) 0%, rgba(159,122,234,0.05) 100%); border-bottom: 1px solid #e2e8f0; }
    .challenge-row-default { border-bottom: 1px solid #e2e8f0; }
    /* Challenge status badges */
    .challenge-badge { padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; color: white; }
    .challenge-badge-completed { background: #38a169; }
    .challenge-badge-submitted { background: #9f7aea; animation: pulse 2s infinite; }
    .challenge-badge-pending { background: #cbd5e0; color: #4a5568; }
    .needs-review-badge { background: #9f7aea; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; margin-left: 8px; }
    /* Session type badges */
    .type-badge { color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
    .type-badge-private { background: #B05D9E; }
    .type-badge-group { background: #9f7aea; }
    /* Attendance status */
    .attendance-present { background: #38a169; }
    .attendance-excused { background: #dd6b20; }
    .attendance-absent { background: #e53e3e; }
    .attendance-pending { background: #718096; }
    .attendance-completed { background: #38a169; }
    /* Event/Announcement status */
    .event-active { background: #38a169; }
    .event-inactive { background: #e53e3e; }
    /* Payment type */
    .payment-initial { background: #38b2ac; }
    .payment-renewal { background: #f6ad55; }
    /* Priority badges */
    .priority-urgent { background: #fed7d7; color: #c53030; }
    .priority-high { background: #feebc8; color: #c05621; }
    .priority-normal { background: #e2e8f0; color: #4a5568; }
    /* Day labels */
    .day-label-private { color: #B05D9E; }
    .day-label-group { color: #9f7aea; }
    /* Demo lead status */
    .lead-status { color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; }
    .lead-status-scheduled { background: #3182ce; }
    .lead-status-completed { background: #38a169; }
    .lead-status-converted { background: #d69e2e; }
    .lead-status-lost { background: #e53e3e; }
    .lead-status-default { background: #718096; }
    /* Challenge card states */
    .challenge-card-active { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .challenge-card-inactive { background: #f7fafc; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); opacity: 0.7; }
    /* Challenge buttons */
    .btn-challenge-review { background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%); color: white; }
    .btn-challenge-track { background: #667eea; color: white; }
    /* Leaderboard podium */
    .podium-gold { background: linear-gradient(180deg, #ffd700 0%, #ffb347 100%); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5); }
    .podium-silver { background: linear-gradient(180deg, #c0c0c0 0%, #a8a8a8 100%); box-shadow: 0 4px 15px rgba(192, 192, 192, 0.5); }
    .podium-bronze { background: linear-gradient(180deg, #cd7f32 0%, #b87333 100%); box-shadow: 0 4px 15px rgba(205, 127, 50, 0.5); }
    .podium-height-1 { height: 180px; }
    .podium-height-2 { height: 140px; }
    .podium-height-3 { height: 100px; }
    .podium-shadow-gold { box-shadow: 0 4px 15px rgba(255,215,0,0.4); }
    .podium-shadow-silver { box-shadow: 0 4px 15px rgba(192,192,192,0.4); }
    .podium-shadow-bronze { box-shadow: 0 4px 15px rgba(205,127,50,0.4); }
    /* Feedback rating borders */
    .feedback-card { background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid; }
    .feedback-rating-high { border-left-color: #38a169; }
    .feedback-rating-medium { border-left-color: #ecc94b; }
    .feedback-rating-low { border-left-color: #e53e3e; }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="serverLoadingScreen">
    <div style="text-align:center; color:white;">
      <h1 style="font-size: 2rem; margin-bottom: 10px;">üéì Fluent Feathers Academy</h1>
      <h2 style="font-size: 1.2rem; font-weight: normal; opacity: 0.9;">Admin Dashboard</h2>
      <p id="loadingMessage" style="margin-top: 20px;">Loading your dashboard...</p>
      <div class="spinner"></div>
    </div>
  </div>

  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>üéì Fluent Feathers</h2>
        <p>Admin Dashboard</p>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-btn active" onclick="showTab('upcoming', event)">üìÖ <span>Upcoming</span></button>
        <button class="nav-btn" onclick="showTab('students', event)">üë• <span>Students</span></button>
        <button class="nav-btn" onclick="showTab('demoStudents', event)">üéØ <span>Demo Leads</span></button>
        <button class="nav-btn" onclick="showTab('groups', event)">üë®‚Äçüë©‚Äçüëß <span>Groups</span></button>
        <button class="nav-btn" onclick="showTab('schedule', event)">üìÜ <span>Schedule</span></button>
        <button class="nav-btn" onclick="showTab('scheduleManager', event)">üìã <span>Manage Schedules</span></button>
        <button class="nav-btn" onclick="showTab('calendar', event)">üóìÔ∏è <span>Calendar</span></button>
        <button class="nav-btn" onclick="showTab('past', event)">üìö <span>Past Classes</span></button>
        <button class="nav-btn" onclick="showTab('homework', event)">üìù <span>Homework</span></button>
        <button class="nav-btn" onclick="showTab('payments', event)">üí≥ <span>Payments</span></button>
        <button class="nav-btn" onclick="showTab('events', event)">üéâ <span>Events</span></button>
        <button class="nav-btn" onclick="showTab('announcements', event)">üì¢ <span>Announcements</span></button>
        <button class="nav-btn" onclick="showTab('monthlyAssessment', event)">üìä <span>Assessment</span></button>
        <button class="nav-btn" onclick="showTab('classRatings', event)">‚≠ê <span>Class Ratings</span></button>
        <button class="nav-btn" onclick="showTab('leaderboard', event)">üèÜ <span>Leaderboard</span></button>
        <button class="nav-btn" onclick="showTab('challenges', event)">üéØ <span>Challenges</span></button>
        <button class="nav-btn" onclick="showTab('resources', event)">üìö <span>Resources</span></button>
        <button class="nav-btn" onclick="showTab('emails', event)">üìß <span>Email Logs</span></button>
        <button class="nav-btn" onclick="showTab('financials', event)">üí∞ <span>Financial Reports</span></button>
        <button class="nav-btn" onclick="window.location.href='profile.html'">üë§ <span>My Profile</span></button>
        <button class="nav-btn" onclick="window.location.href='whiteboard.html'">üñäÔ∏è <span>Whiteboard</span></button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header>
        <div style="display: flex; align-items: center; gap: 15px;">
          <img id="headerLogo" src="/logo.png" alt="Fluent Feathers" style="height: 55px;">
          <div>
            <h1 style="margin: 0;">Fluent Feathers Academy By Aaliya</h1>
            <p style="color: #718096; font-size: 13px; margin: 0;">Empowering Young Minds Through Language & Communication</p>
          </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
          <span id="storageStatus" style="padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: help;" title="File storage status">‚è≥ Checking...</span>
          <button onclick="openSwitchToLearnerModal()" class="btn btn-sm" style="background: #B05D9E; color: white; font-size: 12px;">üëÅÔ∏è Learner View</button>
          <button onclick="location.href='index.html'" class="btn btn-sm" style="background: #718096; color: white; font-size: 12px;">Logout</button>
        </div>
      </header>

      <div class="stats-grid">
        <div class="stat-card"><h3>Total Students</h3><div class="value" id="totalStudents">0</div></div>
        <div class="stat-card"><h3>Upcoming Sessions</h3><div class="value" id="upcomingSessions">0</div></div>
        <div class="stat-card" onclick="toggleRevenue()" style="cursor: pointer;"><h3>Total Revenue <span style="font-size: 0.7rem; color: #718096;">(click)</span></h3><div class="value" id="totalRevenue">*****</div></div>
        <div class="stat-card"><h3>Total Groups</h3><div class="value" id="totalGroups">0</div></div>
        <div class="stat-card"><h3>Active Events</h3><div class="value" id="activeEvents">0</div></div>
        <div class="stat-card" onclick="showTab('monthlyAssessment', event)" style="cursor: pointer; border-left-color: #f59e0b;"><h3>üìä Due for Assessment</h3><div class="value" id="dueAssessments" style="color: #f59e0b;">0</div></div>
      </div>

      <!-- Old tabs - HIDDEN (using sidebar navigation instead) -->
      <div class="tabs" style="display: none !important;">
        <button class="tab-btn active" onclick="showTab('upcoming', event)">üìÖ Upcoming</button>
        <button class="tab-btn" onclick="showTab('students', event)">üë• Students</button>
        <button class="tab-btn" onclick="showTab('groups', event)">üë®‚Äçüë©‚Äçüëß Groups</button>
        <button class="tab-btn" onclick="showTab('schedule', event)">üìÜ Schedule</button>
        <button class="tab-btn" onclick="showTab('scheduleManager', event)">üìã Manage Schedules</button>
        <button class="tab-btn" onclick="showTab('past', event)">üìö Past Classes</button>
        <button class="tab-btn" onclick="showTab('homework', event)">üìù Homework</button>
        <button class="tab-btn" onclick="showTab('payments', event)">üí≥ Payments</button>
        <button class="tab-btn" onclick="showTab('events', event)">üéâ Events</button>
        <button class="tab-btn" onclick="showTab('announcements', event)">üì¢ Announcements</button>
        <button class="tab-btn" onclick="showTab('monthlyAssessment', event)">üìä Monthly Assessment</button>
        <button class="tab-btn" onclick="showTab('classRatings', event)">‚≠ê Class Ratings</button>
        <button class="tab-btn" onclick="showTab('resources', event)">üìö Resources</button>
        <button class="tab-btn" onclick="showTab('emails', event)">üìß Email Logs</button>
      </div>

      <div id="upcomingTab" class="tab-content active">
      <div class="section"><h2>üìÖ Upcoming Classes</h2><div id="upcomingClassesGrid" class="upcoming-classes-grid"><p>Loading...</p></div></div>
    </div>

    <div id="studentsTab" class="tab-content">
      <div class="section"><h2>‚ûï Add New Student</h2>
        <form id="addStudentForm">
          <div class="form-row"><div class="form-group"><label>Student Name *</label><input type="text" id="studentName" required></div><div class="form-group"><label>Age (Years) *</label><input type="text" id="grade" required placeholder="e.g. 10 years"></div></div>
          <div class="form-row"><div class="form-group"><label>Parent Name *</label><input type="text" id="parentName" required></div><div class="form-group"><label>Parent Email *</label><input type="email" id="parentEmail" required></div></div>
          <div class="form-row">
            <div class="form-group"><label>Primary Contact *</label><input type="tel" id="primaryContact" required></div>
            <div class="form-group"><label>Date of Birth (Optional)</label><input type="date" id="dateOfBirth" onchange="autoFillAge(this.value, 'grade')"></div>
            <div class="form-group"><label>Timezone *</label>
              <select id="timezone" required>
                <optgroup label="Asia">
                  <option value="Asia/Kolkata">India (IST)</option>
                  <option value="Asia/Dubai">UAE/Dubai (GST)</option>
                  <option value="Asia/Muscat">Oman/Muscat (GST)</option>
                  <option value="Asia/Riyadh">Saudi Arabia (AST)</option>
                  <option value="Asia/Qatar">Qatar (AST)</option>
                  <option value="Asia/Kuwait">Kuwait (AST)</option>
                  <option value="Asia/Bahrain">Bahrain (AST)</option>
                  <option value="Asia/Singapore">Singapore (SGT)</option>
                  <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                  <option value="Asia/Tokyo">Japan (JST)</option>
                  <option value="Asia/Seoul">South Korea (KST)</option>
                  <option value="Asia/Shanghai">China (CST)</option>
                  <option value="Asia/Bangkok">Thailand (ICT)</option>
                  <option value="Asia/Jakarta">Indonesia (WIB)</option>
                  <option value="Asia/Manila">Philippines (PHT)</option>
                  <option value="Asia/Karachi">Pakistan (PKT)</option>
                  <option value="Asia/Dhaka">Bangladesh (BST)</option>
                  <option value="Asia/Colombo">Sri Lanka (IST)</option>
                  <option value="Asia/Kathmandu">Nepal (NPT)</option>
                  <option value="Asia/Tehran">Iran (IRST)</option>
                  <option value="Asia/Jerusalem">Israel (IST)</option>
                </optgroup>
                <optgroup label="Americas">
                  <option value="America/New_York">USA East (EST/EDT)</option>
                  <option value="America/Chicago">USA Central (CST/CDT)</option>
                  <option value="America/Denver">USA Mountain (MST/MDT)</option>
                  <option value="America/Los_Angeles">USA West (PST/PDT)</option>
                  <option value="America/Toronto">Canada East (EST/EDT)</option>
                  <option value="America/Vancouver">Canada West (PST/PDT)</option>
                  <option value="America/Mexico_City">Mexico (CST)</option>
                  <option value="America/Sao_Paulo">Brazil (BRT)</option>
                  <option value="America/Argentina/Buenos_Aires">Argentina (ART)</option>
                  <option value="America/Lima">Peru (PET)</option>
                  <option value="America/Bogota">Colombia (COT)</option>
                </optgroup>
                <optgroup label="Europe">
                  <option value="Europe/London">UK (GMT/BST)</option>
                  <option value="Europe/Paris">France (CET/CEST)</option>
                  <option value="Europe/Berlin">Germany (CET/CEST)</option>
                  <option value="Europe/Rome">Italy (CET/CEST)</option>
                  <option value="Europe/Madrid">Spain (CET/CEST)</option>
                  <option value="Europe/Amsterdam">Netherlands (CET/CEST)</option>
                  <option value="Europe/Brussels">Belgium (CET/CEST)</option>
                  <option value="Europe/Zurich">Switzerland (CET/CEST)</option>
                  <option value="Europe/Vienna">Austria (CET/CEST)</option>
                  <option value="Europe/Stockholm">Sweden (CET/CEST)</option>
                  <option value="Europe/Oslo">Norway (CET/CEST)</option>
                  <option value="Europe/Copenhagen">Denmark (CET/CEST)</option>
                  <option value="Europe/Helsinki">Finland (EET/EEST)</option>
                  <option value="Europe/Athens">Greece (EET/EEST)</option>
                  <option value="Europe/Istanbul">Turkey (TRT)</option>
                  <option value="Europe/Moscow">Russia (MSK)</option>
                  <option value="Europe/Warsaw">Poland (CET/CEST)</option>
                </optgroup>
                <optgroup label="Africa">
                  <option value="Africa/Cairo">Egypt (EET)</option>
                  <option value="Africa/Johannesburg">South Africa (SAST)</option>
                  <option value="Africa/Lagos">Nigeria (WAT)</option>
                  <option value="Africa/Nairobi">Kenya (EAT)</option>
                  <option value="Africa/Casablanca">Morocco (WET)</option>
                </optgroup>
                <optgroup label="Oceania">
                  <option value="Australia/Sydney">Australia East (AEST/AEDT)</option>
                  <option value="Australia/Melbourne">Melbourne (AEST/AEDT)</option>
                  <option value="Australia/Perth">Australia West (AWST)</option>
                  <option value="Pacific/Auckland">New Zealand (NZST/NZDT)</option>
                  <option value="Pacific/Fiji">Fiji (FJT)</option>
                </optgroup>
              </select>
            </div>
          </div>
          <div class="form-row"><div class="form-group"><label>Program Name *</label><input type="text" id="programName" required></div><div class="form-group"><label>Class Type *</label><select id="classType" required><option value="Private">Private</option><option value="Group">Group</option></select></div></div>
          <div class="form-row">
            <div class="form-group"><label>Duration *</label>
              <select id="duration" required>
                <option value="25 mins">25 mins</option>
                <option value="30 mins">30 mins</option>
                <option value="40 mins">40 mins</option>
                <option value="45 mins">45 mins</option>
                <option value="60 mins">60 mins</option>
              </select>
            </div>
            <div class="form-group"><label>Currency *</label>
              <select id="currency" required>
                <optgroup label="Major Currencies">
                  <option value="USD">USD - US Dollar ($)</option>
                  <option value="EUR">EUR - Euro (‚Ç¨)</option>
                  <option value="GBP">GBP - British Pound (¬£)</option>
                  <option value="INR">INR - Indian Rupee (‚Çπ)</option>
                  <option value="AED">AED - UAE Dirham (ÿØ.ÿ•)</option>
                  <option value="SAR">SAR - Saudi Riyal (Ô∑º)</option>
                  <option value="OMR">OMR - Omani Rial (ÿ±.ÿπ.)</option>
                  <option value="QAR">QAR - Qatari Riyal (Ô∑º)</option>
                  <option value="KWD">KWD - Kuwaiti Dinar (ÿØ.ŸÉ)</option>
                  <option value="BHD">BHD - Bahraini Dinar (.ÿØ.ÿ®)</option>
                </optgroup>
                <optgroup label="Asia Pacific">
                  <option value="SGD">SGD - Singapore Dollar ($)</option>
                  <option value="HKD">HKD - Hong Kong Dollar ($)</option>
                  <option value="JPY">JPY - Japanese Yen (¬•)</option>
                  <option value="CNY">CNY - Chinese Yuan (¬•)</option>
                  <option value="KRW">KRW - South Korean Won (‚Ç©)</option>
                  <option value="THB">THB - Thai Baht (‡∏ø)</option>
                  <option value="MYR">MYR - Malaysian Ringgit (RM)</option>
                  <option value="IDR">IDR - Indonesian Rupiah (Rp)</option>
                  <option value="PHP">PHP - Philippine Peso (‚Ç±)</option>
                  <option value="PKR">PKR - Pakistani Rupee (‚Ç®)</option>
                  <option value="BDT">BDT - Bangladeshi Taka (‡ß≥)</option>
                  <option value="LKR">LKR - Sri Lankan Rupee (‚Ç®)</option>
                  <option value="NPR">NPR - Nepalese Rupee (‚Ç®)</option>
                  <option value="AUD">AUD - Australian Dollar ($)</option>
                  <option value="NZD">NZD - New Zealand Dollar ($)</option>
                </optgroup>
                <optgroup label="Americas">
                  <option value="CAD">CAD - Canadian Dollar ($)</option>
                  <option value="MXN">MXN - Mexican Peso ($)</option>
                  <option value="BRL">BRL - Brazilian Real (R$)</option>
                  <option value="ARS">ARS - Argentine Peso ($)</option>
                  <option value="COP">COP - Colombian Peso ($)</option>
                  <option value="PEN">PEN - Peruvian Sol (S/)</option>
                  <option value="CLP">CLP - Chilean Peso ($)</option>
                </optgroup>
                <optgroup label="Europe">
                  <option value="CHF">CHF - Swiss Franc (CHF)</option>
                  <option value="SEK">SEK - Swedish Krona (kr)</option>
                  <option value="NOK">NOK - Norwegian Krone (kr)</option>
                  <option value="DKK">DKK - Danish Krone (kr)</option>
                  <option value="PLN">PLN - Polish Zloty (z≈Ç)</option>
                  <option value="CZK">CZK - Czech Koruna (Kƒç)</option>
                  <option value="HUF">HUF - Hungarian Forint (Ft)</option>
                  <option value="RUB">RUB - Russian Ruble (‚ÇΩ)</option>
                  <option value="TRY">TRY - Turkish Lira (‚Ç∫)</option>
                </optgroup>
                <optgroup label="Africa">
                  <option value="ZAR">ZAR - South African Rand (R)</option>
                  <option value="EGP">EGP - Egyptian Pound (¬£)</option>
                  <option value="NGN">NGN - Nigerian Naira (‚Ç¶)</option>
                  <option value="KES">KES - Kenyan Shilling (KSh)</option>
                  <option value="MAD">MAD - Moroccan Dirham (ÿØ.ŸÖ.)</option>
                </optgroup>
              </select>
            </div>
            <div class="form-group"><label>Per Session Fee *</label><input type="number" id="perSessionFee" required step="0.01"></div>
            <div class="form-group"><label>Total Sessions *</label><input type="number" id="totalSessions" required min="1"></div>
            <div class="form-group"><label>Payment Method</label>
              <select id="paymentMethod">
                <option value="">Select Method</option>
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Online Payment">Online Payment</option>
                <option value="Cheque">Cheque</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
              <input type="checkbox" id="sendWelcomeEmail" checked style="width: auto; margin: 0;">
              <label style="margin: 0;">Send Welcome Email</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Add Student</button>
        </form>
      </div>
      <div class="section"><h2>üìã All Students</h2>
        <div style="margin-bottom: 15px;">
          <input type="text" id="studentSearchInput" placeholder="üîç Search students by name, age, or program..." oninput="filterStudents()" style="width: 100%; max-width: 400px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
          <span id="studentCount" style="margin-left: 15px; color: #718096; font-size: 14px;"></span>
        </div>
        <table id="studentsTable"><thead><tr><th>Name</th><th>Age</th><th>Program</th><th>Type</th><th>Sessions (C/R)</th><th>Makeup</th><th>Actions</th></tr></thead><tbody id="studentsBody"><tr><td colspan="7">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Demo Students Tab -->
    <div id="demoStudentsTab" class="tab-content">
      <div class="section">
        <h2>üéØ Demo Class Leads</h2>
        <p style="color: #718096; margin-bottom: 20px;">Manage students who are scheduled for demo classes. Convert them to permanent students once they pay.</p>

        <!-- Add Demo Lead Form -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
          <h3 style="margin-bottom: 15px;">‚ûï Add New Demo Lead</h3>
          <form id="addDemoLeadForm">
            <div class="form-row">
              <div class="form-group"><label>Child's Name *</label><input type="text" id="demoChildName" required></div>
              <div class="form-group"><label>Child's Age *</label><input type="text" id="demoChildGrade" required placeholder="e.g. 8 years"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Parent Name *</label><input type="text" id="demoParentName" required></div>
              <div class="form-group"><label>Parent Email *</label><input type="email" id="demoParentEmail" required></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Phone Number *</label><input type="tel" id="demoPhone" required></div>
              <div class="form-group"><label>Program Interest</label>
                <select id="demoProgramInterest">
                  <option value="">Select Program...</option>
                  <option value="Fluent Communicators Program">Fluent Communicators Program</option>
                  <option value="Fluent Readers Program">Fluent Readers Program</option>
                  <option value="Fluent Writers Program">Fluent Writers Program</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Demo Date *</label><input type="date" id="demoDate" required></div>
              <div class="form-group"><label>Demo Time *</label><input type="time" id="demoTime" required></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Source/How they found us</label>
                <select id="demoSource">
                  <option value="">Select...</option>
                  <option value="Instagram">Instagram</option>
                  <option value="Facebook">Facebook</option>
                  <option value="WhatsApp">WhatsApp</option>
                  <option value="Referral">Referral</option>
                  <option value="Google">Google</option>
                  <option value="Website">Website</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group"><label>Notes (Optional)</label><input type="text" id="demoNotes" placeholder="Any additional info..."></div>
            </div>
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-top: 10px;">
              <input type="checkbox" id="sendDemoEmail" style="width: auto; margin: 0;" checked>
              <label for="sendDemoEmail" style="margin: 0; cursor: pointer;">üìß Send Demo Confirmation Email (includes your bio)</label>
            </div>
            <button type="submit" class="btn btn-primary">Add Demo Lead</button>
          </form>
        </div>

        <!-- Filter by Status -->
        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
          <strong>Filter:</strong>
          <button onclick="filterDemoLeads('all')" class="btn btn-sm" style="background: #B05D9E; color: white;">All</button>
          <button onclick="filterDemoLeads('Scheduled')" class="btn btn-sm" style="background: #3182ce; color: white;">üìÖ Scheduled</button>
          <button onclick="filterDemoLeads('Completed')" class="btn btn-sm" style="background: #38a169; color: white;">‚úÖ Completed</button>
          <button onclick="filterDemoLeads('Converted')" class="btn btn-sm" style="background: #d69e2e; color: white;">üéâ Converted</button>
          <button onclick="filterDemoLeads('Lost')" class="btn btn-sm" style="background: #e53e3e; color: white;">‚ùå Lost</button>
        </div>

        <!-- Search Demo Leads -->
        <div style="margin-bottom: 15px;">
          <input type="text" id="demoSearchInput" placeholder="üîç Search demo leads by name, parent, email, or phone..." oninput="renderDemoLeads()" style="width: 100%; max-width: 400px; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
          <span id="demoLeadCount" style="margin-left: 15px; color: #718096; font-size: 14px;"></span>
        </div>

        <!-- Demo Leads Table -->
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Child Name</th>
                <th>Parent</th>
                <th>Contact</th>
                <th>Program</th>
                <th>Demo Date/Time</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="demoLeadsBody">
              <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="groupsTab" class="tab-content">
      <div class="section"><h2>‚ûï Create New Group</h2><form id="createGroupForm">
        <div class="form-row"><div class="form-group"><label>Group Name *</label><input type="text" id="groupName" required></div><div class="form-group"><label>Program Name *</label><input type="text" id="groupProgram" required></div></div>
        <div class="form-row">
            <div class="form-group"><label>Duration *</label>
                <select id="groupDuration" required>
                    <option value="25 mins">25 mins</option>
                    <option value="30 mins">30 mins</option>
                    <option value="40 mins">40 mins</option>
                    <option value="45 mins">45 mins</option>
                    <option value="60 mins">60 mins</option>
                </select>
            </div>
            <div class="form-group"><label>Timezone *</label>
                <select id="groupTimezone" required>
                  <optgroup label="Asia">
                    <option value="Asia/Kolkata">India (IST)</option>
                    <option value="Asia/Dubai">UAE/Dubai (GST)</option>
                    <option value="Asia/Muscat">Oman/Muscat (GST)</option>
                    <option value="Asia/Riyadh">Saudi Arabia (AST)</option>
                    <option value="Asia/Qatar">Qatar (AST)</option>
                    <option value="Asia/Kuwait">Kuwait (AST)</option>
                    <option value="Asia/Singapore">Singapore (SGT)</option>
                    <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                    <option value="Asia/Tokyo">Japan (JST)</option>
                    <option value="Asia/Seoul">South Korea (KST)</option>
                    <option value="Asia/Shanghai">China (CST)</option>
                    <option value="Asia/Bangkok">Thailand (ICT)</option>
                    <option value="Asia/Karachi">Pakistan (PKT)</option>
                    <option value="Asia/Dhaka">Bangladesh (BST)</option>
                  </optgroup>
                  <optgroup label="Americas">
                    <option value="America/New_York">USA East (EST/EDT)</option>
                    <option value="America/Chicago">USA Central (CST/CDT)</option>
                    <option value="America/Denver">USA Mountain (MST/MDT)</option>
                    <option value="America/Los_Angeles">USA West (PST/PDT)</option>
                    <option value="America/Toronto">Canada East (EST/EDT)</option>
                    <option value="America/Mexico_City">Mexico (CST)</option>
                    <option value="America/Sao_Paulo">Brazil (BRT)</option>
                  </optgroup>
                  <optgroup label="Europe">
                    <option value="Europe/London">UK (GMT/BST)</option>
                    <option value="Europe/Paris">France (CET/CEST)</option>
                    <option value="Europe/Berlin">Germany (CET/CEST)</option>
                    <option value="Europe/Moscow">Russia (MSK)</option>
                    <option value="Europe/Istanbul">Turkey (TRT)</option>
                  </optgroup>
                  <optgroup label="Africa & Oceania">
                    <option value="Africa/Cairo">Egypt (EET)</option>
                    <option value="Africa/Johannesburg">South Africa (SAST)</option>
                    <option value="Australia/Sydney">Australia East (AEST/AEDT)</option>
                    <option value="Pacific/Auckland">New Zealand (NZST/NZDT)</option>
                  </optgroup>
                </select>
            </div>
            <div class="form-group"><label>Max Students *</label><input type="number" id="groupMaxStudents" value="10" required></div>
        </div><button type="submit" class="btn btn-primary">Create Group</button></form></div>
      <div class="section"><h2>üìã All Groups</h2><table id="groupsTable"><thead><tr><th>Group Name</th><th>Program</th><th>Duration</th><th>Students</th><th>Max</th><th>Actions</th></tr></thead><tbody id="groupsBody"><tr><td colspan="6">Loading...</td></tr></tbody></table></div>
    </div>

    <div id="scheduleTab" class="tab-content">
      <div class="section"><h2>üìÖ Schedule Classes</h2>
        <div class="form-group" style="margin-bottom: 20px;"><label>Schedule Type *</label><select id="scheduleType" onchange="handleScheduleTypeChange()"><option value="private">Private Session</option><option value="group">Group Session</option></select></div>

        <!-- Private Class Scheduling -->
        <form id="schedulePrivateForm">
          <div class="form-group"><label>Select Student *</label><select id="scheduleStudent" required><option value="">Select student...</option></select></div>

          <div id="privateScheduleMakeupInfo" style="display: none; background: #faf5ff; padding: 12px 16px; border-radius: 8px; margin-top: 10px; border: 2px solid #9f7aea;">
            <span style="font-weight: 600; color: #6b46c1;">üé´ Makeup Credits Available: </span>
            <span id="privateScheduleMakeupCount" style="font-weight: bold; color: #9f7aea; font-size: 1.1em;">0</span>
            <span style="color: #718096; font-size: 0.85rem; margin-left: 8px;">(Check "Makeup" on rows below to use credits instead of regular sessions)</span>
          </div>

          <!-- Bulk Scheduling Options -->
          <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #B05D9E;">
            <h3 style="margin-bottom: 15px; color: #B05D9E;">üìÜ Bulk Schedule</h3>
            <div class="form-row">
              <div class="form-group">
                <label>Start Date *</label>
                <input type="date" id="bulkStartDate">
              </div>
              <div class="form-group">
                <label>Number of Sessions *</label>
                <input type="number" id="bulkNumSessions" min="1" max="100" placeholder="e.g. 10">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Time Option 1 *</label>
                <input type="time" id="bulkClassTime1">
              </div>
              <div class="form-group">
                <label>Time Option 2 (Optional)</label>
                <input type="time" id="bulkClassTime2" placeholder="For different days">
              </div>
            </div>
            <div class="form-group">
              <label>Select Days & Assign Time *</label>
              <p style="font-size: 0.85rem; color: #718096; margin-bottom: 10px;">Check days and select which time to use for each day</p>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="bulkDays" value="0" id="bulkDay0">
                  <label for="bulkDay0" style="cursor:pointer; margin-right: 5px;">Sun</label>
                  <select name="bulkDayTime" data-day="0" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="bulkDays" value="1" id="bulkDay1">
                  <label for="bulkDay1" style="cursor:pointer; margin-right: 5px;">Mon</label>
                  <select name="bulkDayTime" data-day="1" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="bulkDays" value="2" id="bulkDay2">
                  <label for="bulkDay2" style="cursor:pointer; margin-right: 5px;">Tue</label>
                  <select name="bulkDayTime" data-day="2" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="bulkDays" value="3" id="bulkDay3">
                  <label for="bulkDay3" style="cursor:pointer; margin-right: 5px;">Wed</label>
                  <select name="bulkDayTime" data-day="3" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="bulkDays" value="4" id="bulkDay4">
                  <label for="bulkDay4" style="cursor:pointer; margin-right: 5px;">Thu</label>
                  <select name="bulkDayTime" data-day="4" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="bulkDays" value="5" id="bulkDay5">
                  <label for="bulkDay5" style="cursor:pointer; margin-right: 5px;">Fri</label>
                  <select name="bulkDayTime" data-day="5" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="bulkDays" value="6" id="bulkDay6">
                  <label for="bulkDay6" style="cursor:pointer; margin-right: 5px;">Sat</label>
                  <select name="bulkDayTime" data-day="6" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
              </div>
            </div>
            <button type="button" onclick="generateBulkSchedule('private')" class="btn" style="background: #B05D9E; color: white; margin-top: 10px;">Generate Schedule Preview</button>
          </div>

          <h4 style="margin: 20px 0 10px; color: #4a5568;">üìã Scheduled Classes (or add manually)</h4>
          <div id="classScheduleList"></div>
          <button type="button" onclick="addScheduleRow()" class="btn btn-primary" style="background:#718096; margin-top:10px;">+ Add Single Class</button>

          <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-top: 15px;">
            <input type="checkbox" id="sendPrivateScheduleEmail" checked style="width: auto; margin: 0;">
            <label style="margin: 0;">Send Schedule Confirmation Email</label>
          </div>
          <button type="submit" class="btn btn-primary" style="margin-top:10px;">Schedule All Classes</button>
        </form>

        <!-- Group Class Scheduling -->
        <form id="scheduleGroupForm" style="display: none;">
          <div class="form-group"><label>Select Group *</label><select id="scheduleGroup" required><option value="">Select group...</option></select></div>

          <!-- Per-Student Session Counts -->
          <div id="groupStudentSessionCounts" style="display: none; background: #f0fff4; padding: 15px; border-radius: 10px; margin: 10px 0; border: 2px solid #48bb78;">
            <h4 style="margin-bottom: 10px; color: #2f855a;">üë• Per-Student Session Counts</h4>
            <p style="font-size: 0.85rem; color: #718096; margin-bottom: 10px;">Set how many sessions each student should be enrolled in. The bulk scheduler will use the highest count.</p>
            <div id="studentSessionInputs"></div>
            <button type="button" id="convertPrivateBtn" onclick="convertPrivateToGroup()" class="btn" style="background: #ed8936; color: white; margin-top: 10px; display: none;">Convert Existing Private Sessions to Group</button>
          </div>

          <!-- Bulk Scheduling Options for Groups -->
          <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #9f7aea;">
            <h3 style="margin-bottom: 15px; color: #9f7aea;">üìÜ Bulk Schedule</h3>
            <div class="form-row">
              <div class="form-group">
                <label>Start Date *</label>
                <input type="date" id="groupBulkStartDate">
              </div>
              <div class="form-group">
                <label>Number of Sessions *</label>
                <input type="number" id="groupBulkNumSessions" min="1" max="100" placeholder="e.g. 10">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Time Option 1 *</label>
                <input type="time" id="groupBulkClassTime1">
              </div>
              <div class="form-group">
                <label>Time Option 2 (Optional)</label>
                <input type="time" id="groupBulkClassTime2" placeholder="For different days">
              </div>
            </div>
            <div class="form-group">
              <label>Select Days & Assign Time *</label>
              <p style="font-size: 0.85rem; color: #718096; margin-bottom: 10px;">Check days and select which time to use for each day</p>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="groupBulkDays" value="0" id="groupBulkDay0">
                  <label for="groupBulkDay0" style="cursor:pointer; margin-right: 5px;">Sun</label>
                  <select name="groupBulkDayTime" data-day="0" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="groupBulkDays" value="1" id="groupBulkDay1">
                  <label for="groupBulkDay1" style="cursor:pointer; margin-right: 5px;">Mon</label>
                  <select name="groupBulkDayTime" data-day="1" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="groupBulkDays" value="2" id="groupBulkDay2">
                  <label for="groupBulkDay2" style="cursor:pointer; margin-right: 5px;">Tue</label>
                  <select name="groupBulkDayTime" data-day="2" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="groupBulkDays" value="3" id="groupBulkDay3">
                  <label for="groupBulkDay3" style="cursor:pointer; margin-right: 5px;">Wed</label>
                  <select name="groupBulkDayTime" data-day="3" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="groupBulkDays" value="4" id="groupBulkDay4">
                  <label for="groupBulkDay4" style="cursor:pointer; margin-right: 5px;">Thu</label>
                  <select name="groupBulkDayTime" data-day="4" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="groupBulkDays" value="5" id="groupBulkDay5">
                  <label for="groupBulkDay5" style="cursor:pointer; margin-right: 5px;">Fri</label>
                  <select name="groupBulkDayTime" data-day="5" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                  <input type="checkbox" name="groupBulkDays" value="6" id="groupBulkDay6">
                  <label for="groupBulkDay6" style="cursor:pointer; margin-right: 5px;">Sat</label>
                  <select name="groupBulkDayTime" data-day="6" style="padding: 2px 5px; font-size: 0.8rem; border-radius: 4px;">
                    <option value="1">Time 1</option>
                    <option value="2">Time 2</option>
                  </select>
                </div>
              </div>
            </div>
            <button type="button" onclick="generateBulkSchedule('group')" class="btn" style="background: #9f7aea; color: white; margin-top: 10px;">Generate Schedule Preview</button>
          </div>

          <h4 style="margin: 20px 0 10px; color: #4a5568;">üìã Scheduled Classes (or add manually)</h4>
          <div id="groupClassScheduleList"></div>
          <button type="button" onclick="addGroupScheduleRow()" class="btn btn-primary" style="background:#718096; margin-top:10px;">+ Add Single Class</button>

          <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-top: 15px;">
            <input type="checkbox" id="sendGroupScheduleEmail" checked style="width: auto; margin: 0;">
            <label style="margin: 0;">Send Schedule Confirmation Email</label>
          </div>
          <button type="submit" class="btn btn-primary" style="margin-top:10px;">Schedule All Classes</button>
        </form>
      </div>
    </div>

    <div id="scheduleManagerTab" class="tab-content">
      <div class="section">
        <h2>üìã Manage Student Schedules</h2>
        <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
          <label>Select Student</label>
          <select id="manageScheduleStudent" onchange="loadStudentSchedule()">
            <option value="">Select student...</option>
          </select>
        </div>
        <div id="studentScheduleContainer"></div>
      </div>
    </div>

    <!-- Calendar Tab -->
    <div id="calendarTab" class="tab-content">
      <div class="section">
        <h2>üóìÔ∏è Class Calendar</h2>
        <p style="color: #718096; margin-bottom: 20px;">View all scheduled sessions at a glance. <span style="background: #38a169; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Paid</span> <span style="background: #f6ad55; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Demo</span> <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Group</span></p>

        <!-- Calendar Navigation -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <button onclick="changeCalendarMonth(-1)" class="btn" style="background: #B05D9E; color: white;">‚Üê Previous</button>
          <h3 id="calendarMonthYear" style="margin: 0; color: #2d3748;"></h3>
          <button onclick="changeCalendarMonth(1)" class="btn" style="background: #B05D9E; color: white;">Next ‚Üí</button>
        </div>

        <!-- Calendar Grid -->
        <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
          <!-- Days header -->
          <div style="background: #B05D9E; color: white; padding: 10px; text-align: center; font-weight: bold;">Sun</div>
          <div style="background: #B05D9E; color: white; padding: 10px; text-align: center; font-weight: bold;">Mon</div>
          <div style="background: #B05D9E; color: white; padding: 10px; text-align: center; font-weight: bold;">Tue</div>
          <div style="background: #B05D9E; color: white; padding: 10px; text-align: center; font-weight: bold;">Wed</div>
          <div style="background: #B05D9E; color: white; padding: 10px; text-align: center; font-weight: bold;">Thu</div>
          <div style="background: #B05D9E; color: white; padding: 10px; text-align: center; font-weight: bold;">Fri</div>
          <div style="background: #B05D9E; color: white; padding: 10px; text-align: center; font-weight: bold;">Sat</div>
        </div>
        <div id="calendarDays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #e2e8f0;"></div>

        <!-- Day Details Modal -->
        <div id="dayDetailsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
          <div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 id="dayDetailsTitle" style="margin: 0; color: #B05D9E;"></h3>
              <button onclick="closeDayDetails()" style="background: #e53e3e; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer;">‚úï</button>
            </div>
            <div id="dayDetailsContent"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="pastTab" class="tab-content">
      <div class="section">
        <h2>üìö Past Classes & Materials</h2>
        <!-- Search and Filter -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end;">
          <div class="form-group" style="flex: 1; min-width: 200px; margin: 0;">
            <label>Search</label>
            <input type="text" id="pastSearchInput" placeholder="Search by student name, group..." oninput="filterPastSessions()" style="width: 100%;">
          </div>
          <div class="form-group" style="min-width: 150px; margin: 0;">
            <label>Filter by Date</label>
            <input type="date" id="pastDateFilter" onchange="filterPastSessions()">
          </div>
          <div class="form-group" style="min-width: 120px; margin: 0;">
            <label>Show</label>
            <select id="pastShowCount" onchange="filterPastSessions()">
              <option value="10">Last 10</option>
              <option value="25">Last 25</option>
              <option value="50">Last 50</option>
              <option value="all">All</option>
            </select>
          </div>
          <button onclick="clearPastFilters()" class="btn" style="background: #718096; color: white; padding: 10px 15px;">Clear</button>
        </div>
        <p id="pastSessionsCount" style="color: #718096; font-size: 13px; margin-bottom: 10px;">Showing 10 recent sessions</p>
        <table id="pastSessionsTable">
          <thead><tr><th>Date (IST)</th><th>Student/Group</th><th>Type</th><th>Session #</th><th>Attendance</th><th>Materials</th><th>Feedback</th><th>Actions</th></tr></thead>
          <tbody id="pastSessionsBody"><tr><td colspan="8">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Homework Submissions Tab -->
    <div id="homeworkTab" class="tab-content">
      <div class="section">
        <h2>üìù Student Homework Submissions</h2>
        <p style="color: #718096; margin-bottom: 20px;">View and grade homework submitted by students from the Parent Portal</p>
        <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
          <label>Filter by Student</label>
          <select id="homeworkFilterStudent" onchange="loadHomeworkSubmissions()">
            <option value="">All Students</option>
          </select>
        </div>
        <table id="homeworkTable">
          <thead>
            <tr>
              <th>Student</th>
              <th>Session #</th>
              <th>File</th>
              <th>Submitted</th>
              <th>Grade</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="homeworkBody">
            <tr><td colspan="6" style="text-align: center; color: #718096;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="eventsTab" class="tab-content">
      <div class="section"><h2>üéâ Create New Event</h2><form id="createEventForm">
        <div class="form-row">
          <div class="form-group"><label>Event Name *</label><input type="text" id="eventName" required></div>
          <div class="form-group"><label>Event Duration *</label>
            <select id="eventDuration" required>
              <option value="25 mins">25 mins</option>
              <option value="30 mins">30 mins</option>
              <option value="40 mins">40 mins</option>
              <option value="45 mins">45 mins</option>
              <option value="60 mins">60 mins</option>
              <option value="90 mins">90 mins</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Event Description</label><textarea id="eventDescription" rows="3"></textarea></div>
        <div class="form-row"><div class="form-group"><label>Date *</label><input type="date" id="eventDate" required></div><div class="form-group"><label>Time (IST) *</label><input type="time" id="eventTime" required></div></div>
        <div class="form-row">
          <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
            <input type="checkbox" id="sendEventEmail" checked style="width: auto; margin: 0;">
            <label style="margin: 0;">Send Event Notification Email</label>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Create Event</button>
      </form></div>
      <div class="section"><h2>üìã All Events</h2><table id="eventsTable"><thead><tr><th>Event Name</th><th>Date (IST)</th><th>Time (IST)</th><th>Duration</th><th>Registered</th><th>Status</th><th>Actions</th></tr></thead><tbody id="eventsBody"><tr><td colspan="7">Loading...</td></tr></tbody></table></div>
    </div>

    <!-- Class Ratings Tab -->
    <div id="classRatingsTab" class="tab-content">
      <div class="section">
        <h2>‚≠ê Class Ratings & Feedback</h2>
        <p style="color: #718096; margin-bottom: 20px;">View feedback and ratings submitted by parents after attending classes.</p>

        <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
          <div>
            <label style="font-weight: 600; margin-right: 8px;">Filter by Student:</label>
            <select id="ratingsStudentFilter" onchange="loadClassRatings()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="">All Students</option>
            </select>
          </div>
          <div>
            <label style="font-weight: 600; margin-right: 8px;">Filter by Rating:</label>
            <select id="ratingsRatingFilter" onchange="loadClassRatings()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="">All Ratings</option>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 Stars)</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 Stars)</option>
              <option value="3">‚≠ê‚≠ê‚≠ê (3 Stars)</option>
              <option value="2">‚≠ê‚≠ê (2 Stars)</option>
              <option value="1">‚≠ê (1 Star)</option>
            </select>
          </div>
          <button onclick="loadClassRatings()" class="btn btn-primary">üîÑ Refresh</button>
        </div>

        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
          <div style="background: linear-gradient(135deg, #B05D9E, #8B4789); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;" id="avgRating">-</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Avg Rating</div>
          </div>
          <div style="background: linear-gradient(135deg, #38a169, #2f855a); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;" id="totalFeedbacks">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Total Feedbacks</div>
          </div>
          <div style="background: linear-gradient(135deg, #ecc94b, #d69e2e); color: white; padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;" id="fiveStarCount">0</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">5-Star Ratings</div>
          </div>
        </div>

        <!-- Feedback List -->
        <div id="ratingsContainer" style="display: grid; gap: 15px;">
          <p style="color: #718096; text-align: center; padding: 30px;">Loading feedback...</p>
        </div>
      </div>
    </div>

    <!-- Leaderboard Tab -->
    <div id="leaderboardTab" class="tab-content">
      <div class="section">
        <h2>üèÜ Badge Leaderboard</h2>
        <p style="color: #718096; margin-bottom: 25px;">See which students are leading in badge collection! This motivates kids to earn more badges.</p>

        <!-- Top 3 Podium -->
        <div id="leaderboardPodium" style="display: flex; justify-content: center; align-items: flex-end; gap: 15px; margin-bottom: 30px; min-height: 200px;">
          <p style="color: #718096; text-align: center;">Loading leaderboard...</p>
        </div>

        <!-- Full Leaderboard Table -->
        <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <table style="width: 100%;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 15px; text-align: center; width: 60px;">Rank</th>
                <th style="padding: 15px; text-align: left;">Student</th>
                <th style="padding: 15px; text-align: center;">Total Badges</th>
                <th style="padding: 15px; text-align: center;">Class Badges</th>
                <th style="padding: 15px; text-align: center;">Milestone Badges</th>
                <th style="padding: 15px; text-align: center;">Latest Badge</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody">
              <tr><td colspan="6" style="text-align: center; padding: 30px; color: #718096;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Weekly Challenges Tab -->
    <div id="challengesTab" class="tab-content">
      <div class="section">
        <h2>üéØ Weekly Challenges</h2>
        <p style="color: #718096; margin-bottom: 20px;">Create fun weekly challenges to keep students engaged and motivated!</p>

        <!-- Create Challenge Form -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px;">
          <h3 style="color: white; margin-bottom: 15px;">‚ûï Create New Challenge</h3>
          <form id="createChallengeForm">
            <div class="form-row">
              <div class="form-group">
                <label style="color: white;">Challenge Title *</label>
                <input type="text" id="challengeTitle" required placeholder="e.g., Read 3 books this week">
              </div>
              <div class="form-group">
                <label style="color: white;">Type</label>
                <select id="challengeType">
                  <option value="Reading">üìñ Reading</option>
                  <option value="Vocabulary">üìö Vocabulary</option>
                  <option value="Speaking">üó£Ô∏è Speaking</option>
                  <option value="Writing">‚úçÔ∏è Writing</option>
                  <option value="Homework">üìù Homework</option>
                  <option value="Practice">üéØ Practice</option>
                  <option value="General">‚≠ê General</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label style="color: white;">Description</label>
              <textarea id="challengeDescription" rows="2" placeholder="Describe what students need to do..."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label style="color: white;">Week Start *</label>
                <input type="date" id="challengeWeekStart" required>
              </div>
              <div class="form-group">
                <label style="color: white;">Week End *</label>
                <input type="date" id="challengeWeekEnd" required>
              </div>
              <div class="form-group">
                <label style="color: white;">Badge Reward</label>
                <select id="challengeBadgeReward">
                  <option value="üéØ Challenge Champion">üéØ Challenge Champion</option>
                  <option value="üìñ Reading Star">üìñ Reading Star</option>
                  <option value="üìö Vocab Master">üìö Vocab Master</option>
                  <option value="üó£Ô∏è Speaking Hero">üó£Ô∏è Speaking Hero</option>
                  <option value="‚úçÔ∏è Writing Wizard">‚úçÔ∏è Writing Wizard</option>
                  <option value="‚≠ê Super Achiever">‚≠ê Super Achiever</option>
                  <option value="üèÜ Weekly Winner">üèÜ Weekly Winner</option>
                  <option value="üåü Shining Star">üåü Shining Star</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
              <input type="checkbox" id="assignToAll" checked style="width: auto; margin: 0;">
              <label for="assignToAll" style="margin: 0; cursor: pointer; color: white;">Assign to all active students</label>
            </div>
            <button type="submit" class="btn" style="background: white; color: #667eea; font-weight: bold;">Create Challenge</button>
          </form>
        </div>

        <!-- Active Challenges List -->
        <h3 style="margin-bottom: 15px;">üìã All Challenges</h3>
        <div id="challengesList" style="display: grid; gap: 15px;">
          <p style="color: #718096; text-align: center; padding: 30px;">Loading challenges...</p>
        </div>
      </div>
    </div>

    <!-- Resource Library Tab -->
    <div id="resourcesTab" class="tab-content">
      <div class="section">
        <h2>üìö Resource Library</h2>
        <p style="color: #718096; margin-bottom: 20px;">Add videos, PDFs, worksheets and other learning materials for parents to access.</p>

        <!-- Add Resource Form -->
        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px;">
          <h3 style="color: #2d3748; margin-bottom: 20px;">‚ûï Add New Resource</h3>
          <form id="addResourceForm">
            <div class="form-row">
              <div class="form-group"><label>Title *</label><input type="text" id="resourceTitle" required placeholder="e.g., Phonics Practice Worksheet"></div>
              <div class="form-group"><label>Category *</label>
                <select id="resourceCategory" required>
                  <option value="">Select Category</option>
                  <option value="Videos">Videos</option>
                  <option value="Worksheets">Worksheets</option>
                  <option value="PDFs">PDFs / Documents</option>
                  <option value="Practice">Practice Materials</option>
                  <option value="Games">Games & Activities</option>
                  <option value="Stories">Stories & Reading</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Resource Type *</label>
                <select id="resourceType" required onchange="toggleResourceInput()">
                  <option value="">Select Type</option>
                  <option value="link">External Link (YouTube, Canva, Google Drive)</option>
                  <option value="file">Upload File</option>
                </select>
              </div>
              <div class="form-group"><label>Grade Level</label>
                <select id="resourceGrade">
                  <option value="All Grades">All Grades</option>
                  <option value="Pre-K">Pre-K</option>
                  <option value="Kindergarten">Kindergarten</option>
                  <option value="Grade 1">Grade 1</option>
                  <option value="Grade 2">Grade 2</option>
                  <option value="Grade 3">Grade 3</option>
                  <option value="Grade 4">Grade 4</option>
                  <option value="Grade 5+">Grade 5+</option>
                </select>
              </div>
            </div>
            <div id="resourceLinkSection" style="display: none;">
              <div class="form-group">
                <label>External Link *</label>
                <input type="url" id="resourceLink" placeholder="https://youtube.com/watch?v=... or https://canva.com/design/...">
                <small style="color: #718096;">Paste YouTube, Canva, Google Drive, or any shareable link</small>
              </div>
            </div>
            <div id="resourceFileSection" style="display: none;">
              <div class="form-group">
                <label>Upload File *</label>
                <input type="file" id="resourceFile" accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.mp4,.mp3">
                <small style="color: #718096;">PDF, Word, PowerPoint, Images, Videos (max 100MB)</small>
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="resourceDescription" rows="2" placeholder="Brief description of this resource..."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Tags (comma separated)</label><input type="text" id="resourceTags" placeholder="e.g., phonics, reading, practice"></div>
              <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 25px;">
                <input type="checkbox" id="resourceFeatured" style="width: 20px; height: 20px;">
                <label for="resourceFeatured" style="margin: 0;">Featured Resource (shows at top)</label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 10px;">üìö Add Resource</button>
          </form>
        </div>

        <!-- Resources List -->
        <h3 style="margin-bottom: 15px;">üìã All Resources</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
          <select id="filterResourceCategory" onchange="loadResources()" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
            <option value="all">All Categories</option>
            <option value="Videos">Videos</option>
            <option value="Worksheets">Worksheets</option>
            <option value="PDFs">PDFs / Documents</option>
            <option value="Practice">Practice Materials</option>
            <option value="Games">Games & Activities</option>
            <option value="Stories">Stories & Reading</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div id="resourcesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
          <p style="color: #718096; text-align: center; padding: 30px; grid-column: 1/-1;">Loading resources...</p>
        </div>
      </div>
    </div>

    <div id="emailsTab" class="tab-content">
      <div class="section"><h2>üìß Email Logs</h2><table id="emailLogsTable"><thead><tr><th>Date/Time</th><th>Recipient</th><th>Type</th><th>Subject</th><th>Status</th></tr></thead><tbody id="emailLogsBody"><tr><td colspan="5">Loading...</td></tr></tbody></table></div>

      <!-- Database Backup Section -->
      <div class="section" style="margin-top: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px;">
        <h2 style="color: white; margin-bottom: 15px;">üíæ Database Backup</h2>
        <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">Download a complete backup of your database. Use this to migrate to a new database provider (like Supabase) or for safekeeping.</p>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <input type="password" id="backupPassword" placeholder="Enter admin password" style="padding: 12px 15px; border-radius: 8px; border: none; width: 250px; font-size: 14px;">
          <button onclick="downloadBackup()" class="btn" style="background: white; color: #667eea; font-weight: bold; padding: 12px 25px;">
            üì• Download Backup (.sql)
          </button>
        </div>
        <p style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 15px;">‚ö†Ô∏è Keep this backup file safe. It contains all your student data, sessions, and records.</p>
      </div>

      <!-- Cleanup Orphaned Data Section -->
      <div class="section" style="margin-top: 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 25px; border-radius: 12px;">
        <h2 style="color: white; margin-bottom: 15px;">üßπ Cleanup Orphaned Data</h2>
        <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">Remove sessions from deleted students that are still showing in calendar and past classes.</p>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <span id="orphanedCount" style="color: white; font-weight: bold;">Checking...</span>
          <button onclick="cleanupOrphanedSessions()" class="btn" style="background: white; color: #d97706; font-weight: bold; padding: 12px 25px;">
            üóëÔ∏è Remove Orphaned Sessions
          </button>
        </div>
      </div>

      <!-- Manual Search & Delete Sessions -->
      <div class="section" style="margin-top: 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 25px; border-radius: 12px;">
        <h2 style="color: white; margin-bottom: 15px;">üîç Manual Search & Delete Sessions</h2>
        <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">Search for sessions by student name and delete them manually.</p>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
          <input type="text" id="sessionSearchName" placeholder="Enter student name to search..." style="padding: 12px 15px; border-radius: 8px; border: none; width: 300px; font-size: 14px;">
          <button onclick="searchSessionsByName()" class="btn" style="background: white; color: #dc2626; font-weight: bold; padding: 12px 25px;">
            üîç Search Sessions
          </button>
        </div>
        <div id="sessionSearchResults" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; display: none;">
          <div id="sessionSearchList"></div>
        </div>
      </div>
    </div>

    <!-- Financial Reports Tab -->
    <div id="financialsTab" class="tab-content">
      <div class="section">
        <h2>üí∞ Financial Reports</h2>
        <p style="color: #718096; margin-bottom: 20px;">Track income, expenses, and generate reports for tax filing</p>

        <!-- Financial Year Filter -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; padding: 20px; background: #f7fafc; border-radius: 10px;">
          <div style="flex: 1; min-width: 200px;">
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Financial Year</label>
            <select id="financialYear" onchange="loadFinancialReports()" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
              <option value="">All Time</option>
            </select>
          </div>
          <div style="flex: 1; min-width: 150px;">
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Start Date</label>
            <input type="date" id="finStartDate" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
          </div>
          <div style="flex: 1; min-width: 150px;">
            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">End Date</label>
            <input type="date" id="finEndDate" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
          </div>
          <div style="display: flex; align-items: flex-end; gap: 10px;">
            <button onclick="loadFinancialReports()" class="btn" style="background: #B05D9E; color: white; padding: 10px 20px;">Apply Filter</button>
            <button onclick="clearFinancialFilters()" class="btn" style="background: #718096; color: white; padding: 10px 20px;">Clear</button>
          </div>
        </div>

        <!-- Income Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 25px; border-radius: 12px; color: white;">
            <h3 style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Income (INR)</h3>
            <div id="totalIncomeINR" style="font-size: 28px; font-weight: bold;">‚Çπ0</div>
          </div>
          <div style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); padding: 25px; border-radius: 12px; color: white;">
            <h3 style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Income (USD)</h3>
            <div id="totalIncomeUSD" style="font-size: 28px; font-weight: bold;">$0</div>
          </div>
          <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); padding: 25px; border-radius: 12px; color: white;">
            <h3 style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Expenses (INR)</h3>
            <div id="totalExpensesINR" style="font-size: 28px; font-weight: bold;">‚Çπ0</div>
          </div>
          <div style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); padding: 25px; border-radius: 12px; color: white;">
            <h3 style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Net Profit (INR)</h3>
            <div id="netProfitINR" style="font-size: 28px; font-weight: bold;">‚Çπ0</div>
          </div>
        </div>

        <!-- Export Buttons -->
        <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
          <button onclick="exportIncomeReport()" class="btn" style="background: #38a169; color: white; padding: 12px 25px;">
            üì• Export Income (CSV)
          </button>
          <button onclick="exportExpensesReport()" class="btn" style="background: #dd6b20; color: white; padding: 12px 25px;">
            üì• Export Expenses (CSV)
          </button>
          <button onclick="exportMergedReport()" class="btn" style="background: #3182ce; color: white; padding: 12px 25px;">
            üì• Export Merged Report (CSV)
          </button>
        </div>

        <!-- Monthly Income Summary -->
        <h3 style="margin-bottom: 15px; color: #2d3748;">üìä Monthly Income Summary</h3>
        <div style="overflow-x: auto; margin-bottom: 30px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f7fafc;">
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Month</th>
                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">INR</th>
                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">USD</th>
                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">Payments</th>
              </tr>
            </thead>
            <tbody id="monthlyIncomeBody">
              <tr><td colspan="4" style="padding: 20px; text-align: center; color: #718096;">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Recent Payments -->
        <h3 style="margin-bottom: 15px; color: #2d3748;">üí≥ Recent Payments <span style="font-size: 12px; color: #718096; font-weight: normal;">(Delete test/trial payments)</span></h3>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f7fafc;">
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Date</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Student</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Parent</th>
                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">Amount</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Method</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Sessions</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Actions</th>
              </tr>
            </thead>
            <tbody id="recentPaymentsBody">
              <tr><td colspan="7" style="padding: 20px; text-align: center; color: #718096;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Expense Tracker Section -->
      <div class="section" style="margin-top: 25px;">
        <h2>üìã Expense Tracker</h2>
        <p style="color: #718096; margin-bottom: 20px;">Track your business expenses to calculate net taxable income</p>

        <!-- Add Expense Form -->
        <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
          <h3 style="margin-bottom: 15px; color: #2d3748;">Add New Expense</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="expenseDate" required style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            <div class="form-group">
              <label>Category *</label>
              <select id="expenseCategory" required style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                <option value="">Select Category</option>
                <option value="Platform Subscription">Platform Subscription (Zoom, etc.)</option>
                <option value="Teaching Materials">Teaching Materials</option>
                <option value="Internet & Phone">Internet & Phone</option>
                <option value="Software & Tools">Software & Tools</option>
                <option value="Marketing & Ads">Marketing & Ads</option>
                <option value="Office Supplies">Office Supplies</option>
                <option value="Professional Development">Professional Development</option>
                <option value="Bank Charges">Bank Charges</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Description *</label>
              <input type="text" id="expenseDescription" required placeholder="e.g., Zoom Annual Plan" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            <div class="form-group">
              <label>Amount *</label>
              <input type="number" id="expenseAmount" required step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            <div class="form-group">
              <label>Currency</label>
              <select id="expenseCurrency" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                <option value="INR">INR (‚Çπ)</option>
                <option value="USD">USD ($)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Payment Method</label>
              <select id="expensePaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="UPI">UPI</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Debit Card">Debit Card</option>
                <option value="Cash">Cash</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-top: 15px;">
            <label>Notes (Optional)</label>
            <input type="text" id="expenseNotes" placeholder="Any additional notes..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
          </div>
          <button onclick="addExpense()" class="btn" style="background: #B05D9E; color: white; padding: 12px 25px; margin-top: 15px;">
            ‚ûï Add Expense
          </button>
        </div>

        <!-- Expense Summary by Category -->
        <h3 style="margin-bottom: 15px; color: #2d3748;">üìä Expense Summary by Category</h3>
        <div id="expenseCategorySummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
          <p style="color: #718096;">Loading...</p>
        </div>

        <!-- Expenses List -->
        <h3 style="margin-bottom: 15px; color: #2d3748;">üìù All Expenses</h3>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f7fafc;">
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Date</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Category</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Description</th>
                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">Amount</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Method</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Actions</th>
              </tr>
            </thead>
            <tbody id="expensesBody">
              <tr><td colspan="6" style="padding: 20px; text-align: center; color: #718096;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit Payment Record Modal (Financial Summary) -->
    <div id="editPaymentRecordModal" class="modal">
      <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
          <h2 style="color: #667eea;">‚úèÔ∏è Edit Payment Record</h2>
          <button onclick="document.getElementById('editPaymentRecordModal').classList.remove('active')" class="btn btn-danger btn-sm">‚úï</button>
        </div>
        <div style="padding: 20px;">
          <input type="hidden" id="editPRId">
          <div class="form-row">
            <div class="form-group"><label>Payment Date *</label><input type="date" id="editPRDate" required></div>
            <div class="form-group"><label>Amount *</label>
              <div style="display: flex; gap: 8px;">
                <select id="editPRCurrency" style="width: 90px;"><option value="INR">INR ‚Çπ</option><option value="USD">USD $</option><option value="GBP">GBP ¬£</option><option value="EUR">EUR ‚Ç¨</option><option value="AED">AED</option><option value="SAR">SAR</option><option value="CAD">CAD</option><option value="AUD">AUD</option></select>
                <input type="number" id="editPRAmount" step="0.01" min="0" required style="flex: 1;">
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Payment Method</label>
              <select id="editPRMethod"><option value="">Select...</option><option value="Bank Transfer">Bank Transfer</option><option value="UPI">UPI</option><option value="Credit Card">Credit Card</option><option value="Debit Card">Debit Card</option><option value="Cash">Cash</option><option value="PayPal">PayPal</option><option value="Other">Other</option></select>
            </div>
            <div class="form-group"><label>Sessions Covered</label><input type="text" id="editPRSessions" placeholder="e.g. 8 or 12"></div>
          </div>
          <div class="form-group"><label>Notes</label><input type="text" id="editPRNotes" placeholder="Optional notes"></div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
            <button onclick="document.getElementById('editPaymentRecordModal').classList.remove('active')" class="btn" style="background: #718096; color: white;">Cancel</button>
            <button onclick="saveEditPaymentRecord()" class="btn btn-primary">üíæ Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" class="modal">
      <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
          <h2 style="color: #dd6b20;">‚úèÔ∏è Edit Expense</h2>
          <button onclick="document.getElementById('editExpenseModal').classList.remove('active')" class="btn btn-danger btn-sm">‚úï</button>
        </div>
        <div style="padding: 20px;">
          <input type="hidden" id="editExpId">
          <div class="form-row">
            <div class="form-group"><label>Date *</label><input type="date" id="editExpDate" required></div>
            <div class="form-group"><label>Category *</label>
              <select id="editExpCategory" required>
                <option value="">Select...</option>
                <option value="Platform Subscription">Platform Subscription</option>
                <option value="Teaching Materials">Teaching Materials</option>
                <option value="Internet & Phone">Internet & Phone</option>
                <option value="Software & Tools">Software & Tools</option>
                <option value="Marketing & Ads">Marketing & Ads</option>
                <option value="Office Supplies">Office Supplies</option>
                <option value="Professional Development">Professional Development</option>
                <option value="Bank Charges">Bank Charges</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>Description *</label><input type="text" id="editExpDescription" required></div>
          <div class="form-row">
            <div class="form-group"><label>Amount *</label>
              <div style="display: flex; gap: 8px;">
                <select id="editExpCurrency" style="width: 90px;"><option value="INR">INR ‚Çπ</option><option value="USD">USD $</option></select>
                <input type="number" id="editExpAmount" step="0.01" min="0" required style="flex: 1;">
              </div>
            </div>
            <div class="form-group"><label>Payment Method</label>
              <select id="editExpMethod"><option value="">Select...</option><option value="Bank Transfer">Bank Transfer</option><option value="UPI">UPI</option><option value="Credit Card">Credit Card</option><option value="Debit Card">Debit Card</option><option value="Cash">Cash</option></select>
            </div>
          </div>
          <div class="form-group"><label>Notes</label><input type="text" id="editExpNotes" placeholder="Optional notes"></div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
            <button onclick="document.getElementById('editExpenseModal').classList.remove('active')" class="btn" style="background: #718096; color: white;">Cancel</button>
            <button onclick="saveEditExpense()" class="btn" style="background: #dd6b20; color: white;">üíæ Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <div id="announcementsTab" class="tab-content">
      <div class="section">
        <h2>üì¢ Create Announcement</h2>
        <form id="createAnnouncementForm">
          <div class="form-row">
            <div class="form-group"><label>Title *</label><input type="text" id="announcementTitle" required></div>
            <div class="form-group"><label>Type</label>
              <select id="announcementType">
                <option value="General">General</option>
                <option value="Holiday">Holiday</option>
                <option value="Reminder">Reminder</option>
                <option value="Update">Update</option>
                <option value="Challenge Update">Challenge Update</option>
                <option value="Competition Update">Competition Update</option>
                <option value="Results">Results</option>
              </select>
            </div>
            <div class="form-group"><label>Priority</label>
              <select id="announcementPriority">
                <option value="Normal">Normal</option>
                <option value="High">High</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>Content *</label><textarea id="announcementContent" rows="4" required placeholder="Write your announcement here..."></textarea></div>
          <div class="form-group">
            <label>Attach Image (Optional)</label>
            <input type="file" id="announcementImage" accept="image/*" style="padding: 8px;">
            <small style="color: #718096;">Add an image for results, winners, or event photos</small>
          </div>
          <div id="announcementImagePreview" style="display: none; margin-bottom: 15px;">
            <img id="announcementPreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #e2e8f0;">
            <button type="button" onclick="clearAnnouncementImage()" style="margin-left: 10px; background: #e53e3e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Remove</button>
          </div>
          <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
            <input type="checkbox" id="sendAnnouncementEmail" style="width: auto; margin: 0;">
            <label for="sendAnnouncementEmail" style="margin: 0; cursor: pointer;">Send Email to All Active Students/Parents</label>
          </div>
          <button type="submit" class="btn btn-primary">Create Announcement</button>
        </form>
      </div>
      <div class="section">
        <h2>üìã All Announcements</h2>
        <table id="announcementsTable">
          <thead><tr><th>Title</th><th>Type</th><th>Priority</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="announcementsBody"><tr><td colspan="5">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Announcement View/Edit Modal -->
    <div id="announcementModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h2 id="announcementModalTitle">View Announcement</h2>
          <button onclick="closeAnnouncementModal()" class="btn btn-danger">Close</button>
        </div>
        <form id="editAnnouncementForm">
          <input type="hidden" id="editAnnouncementId">
          <div class="form-group">
            <label>Title *</label>
            <input type="text" id="editAnnouncementTitle" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Type</label>
              <select id="editAnnouncementType">
                <option value="General">General</option>
                <option value="Holiday">Holiday</option>
                <option value="Reminder">Reminder</option>
                <option value="Update">Update</option>
                <option value="Challenge Update">Challenge Update</option>
                <option value="Competition Update">Competition Update</option>
                <option value="Results">Results</option>
              </select>
            </div>
            <div class="form-group">
              <label>Priority</label>
              <select id="editAnnouncementPriority">
                <option value="Normal">Normal</option>
                <option value="High">High</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Content *</label>
            <textarea id="editAnnouncementContent" rows="6" required></textarea>
          </div>
          <div class="form-group">
            <label>Attached Image</label>
            <div id="editAnnouncementCurrentImage" style="margin-bottom: 10px;"></div>
            <input type="file" id="editAnnouncementImage" accept="image/*" style="padding: 8px;">
            <small style="color: #718096;">Upload new image to replace existing one</small>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" onclick="resendAnnouncementEmail()" class="btn" style="background: #38a169; color: white;">Send Email to All</button>
          </div>
        </form>
      </div>
    </div>

    <div id="monthlyAssessmentTab" class="tab-content">
      <!-- Students Due for Assessment Alert -->
      <div id="dueAssessmentAlert" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
        <h3 style="color: #92400e; margin: 0 0 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">üìä</span> Students Due for Assessment
        </h3>
        <p style="color: #78350f; margin-bottom: 15px; font-size: 14px;">These students have completed 7+ sessions since their last assessment:</p>
        <div id="dueAssessmentList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      </div>

      <div class="section">
        <h2>üìä Assessment & Certificate</h2>
        <form id="monthlyAssessmentForm">
          <!-- Assessment Type Selection -->
          <div class="form-row" style="margin-bottom: 20px;">
            <div class="form-group">
              <label>Assessment Type *</label>
              <div style="display: flex; gap: 15px; margin-top: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: 8px; transition: all 0.2s;" id="typeMonthlyLabel">
                  <input type="radio" name="assessmentType" value="monthly" id="typeMonthly" checked style="width: 18px; height: 18px;">
                  <span style="font-weight: 600;">üìÖ Monthly Assessment</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: 8px; transition: all 0.2s;" id="typeDemoLabel">
                  <input type="radio" name="assessmentType" value="demo" id="typeDemo" style="width: 18px; height: 18px;">
                  <span style="font-weight: 600;">üéØ Demo Class Assessment</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Monthly Assessment Fields -->
          <div id="monthlyFields" class="form-row">
            <div class="form-group"><label>Student *</label>
              <select id="assessmentStudent" required>
                <option value="">Select Student...</option>
              </select>
            </div>
            <div class="form-group"><label>Month *</label>
              <select id="assessmentMonth" required>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>
            <div class="form-group"><label>Year *</label>
              <input type="number" id="assessmentYear" required value="2026" min="2020" max="2030">
            </div>
          </div>

          <!-- Demo Assessment Fields (hidden by default) -->
          <div id="demoFields" class="form-row" style="display: none;">
            <div class="form-group"><label>Demo Lead *</label>
              <select id="assessmentDemoLead">
                <option value="">Select Demo Lead...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Demo Date</label>
              <input type="text" id="demoLeadDate" readonly style="background: #f7fafc; cursor: not-allowed;">
            </div>
          </div>

          <h3 style="margin-top: 20px; color: #4a5568;">üìù Skills Assessment (Tick applicable areas)</h3>

          <!-- Phonics Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">üî§ PHONICS</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #fef5e7; border-radius: 8px; border-left: 4px solid #f6ad55;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_letter_sounds" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üîä Letter Sounds Recognition</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_blending" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üîó Blending Sounds</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_segmenting" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">‚úÇÔ∏è Segmenting Words</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_sight_words" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üëÅÔ∏è Sight Words</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_phonemic_awareness" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üëÇ Phonemic Awareness</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_decoding" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üîì Decoding Skills</span>
              </label>
            </div>
          </div>

          <!-- Reading Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">üìñ READING</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #e6fffa; border-radius: 8px; border-left: 4px solid #38b2ac;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_reading_fluency" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìö Reading Fluency</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_reading_comprehension" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üß† Reading Comprehension</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_reading_expression" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üé≠ Reading with Expression</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_story_understanding" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìï Story Understanding</span>
              </label>
            </div>
          </div>

          <!-- Spoken English Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">üó£Ô∏è SPOKEN ENGLISH</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #ebf8ff; border-radius: 8px; border-left: 4px solid #B05D9E;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_speaking" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üó£Ô∏è Speaking & Communication</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_pronunciation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üéØ Pronunciation</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_confidence" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üí™ Confidence Building</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_listening" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üëÇ Active Listening</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_conversation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üí¨ Conversation Skills</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_sentence_formation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìù Sentence Formation</span>
              </label>
            </div>
          </div>

          <!-- Grammar Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">üìñ GRAMMAR</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #faf5ff; border-radius: 8px; border-left: 4px solid #9f7aea;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_grammar" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìñ Grammar & Structure</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_tenses" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">‚è∞ Tenses</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_punctuation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">‚ùó Punctuation</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_parts_of_speech" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üè∑Ô∏è Parts of Speech</span>
              </label>
            </div>
          </div>

          <!-- Vocabulary Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">üìö VOCABULARY</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #fff5f5; border-radius: 8px; border-left: 4px solid #fc8181;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_vocabulary" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìö Vocabulary Enhancement</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_spelling" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üî§ Spelling Mastery</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_word_meanings" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìñ Word Meanings</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_synonyms_antonyms" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üîÑ Synonyms & Antonyms</span>
              </label>
            </div>
          </div>

          <!-- Creative Writing Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">‚úçÔ∏è CREATIVE WRITING</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #48bb78;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_writing" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">‚úçÔ∏è Creative Writing</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_story_writing" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìù Story Writing</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_essay_writing" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìÑ Essay Writing</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_handwriting" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">‚úèÔ∏è Handwriting</span>
              </label>
            </div>
          </div>

          <!-- Public Speaking Section -->
          <div style="margin: 15px 0;">
            <h4 style="color: #B05D9E; margin-bottom: 10px; font-size: 14px;">üé§ PUBLIC SPEAKING</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 15px; background: #fffaf0; border-radius: 8px; border-left: 4px solid #ed8936;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_public_speaking" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üé§ Public Speaking</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_presentation" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìä Presentation Skills</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_storytelling" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üìñ Storytelling</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_debate" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üí≠ Debate Skills</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="skill_stage_presence" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: 600;">üåü Stage Presence</span>
              </label>
            </div>
          </div>

          <h3 style="margin-top: 20px; color: #4a5568;">üèÜ Award Certificate (Optional)</h3>
          <div class="form-row">
            <div class="form-group"><label>Certificate Title</label>
              <select id="certificateTitle">
                <option value="">No Certificate</option>
                <optgroup label="üéØ Demo Class Certificates" id="demoCertificateOptions" style="display: none;">
                  <option value="Demo Participation Certificate">üéâ Demo Participation Certificate</option>
                  <option value="Demo Star">üåü Demo Star</option>
                  <option value="Brilliant First Impression">‚ú® Brilliant First Impression</option>
                  <option value="Shining Beginner">üí´ Shining Beginner</option>
                  <option value="Eager Learner">üéì Eager Learner</option>
                  <option value="Future Star">‚≠ê Future Star</option>
                  <option value="Promising Talent">üíé Promising Talent</option>
                </optgroup>
                <optgroup label="üî§ Phonics">
                  <option value="Phonics Star">üî§ Phonics Star</option>
                  <option value="Sound Master">üîä Sound Master</option>
                  <option value="Blending Champion">üîó Blending Champion</option>
                </optgroup>
                <optgroup label="üìñ Reading">
                  <option value="Avid Reader">üìö Avid Reader</option>
                  <option value="Reading Rockstar">üìñ Reading Rockstar</option>
                  <option value="Fluent Reader">üåü Fluent Reader</option>
                </optgroup>
                <optgroup label="üó£Ô∏è Spoken English">
                  <option value="Superb Speaker">üó£Ô∏è Superb Speaker</option>
                  <option value="Confident Communicator">üí¨ Confident Communicator</option>
                  <option value="Excellent Listener">üëÇ Excellent Listener</option>
                  <option value="Pronunciation Pro">üéØ Pronunciation Pro</option>
                </optgroup>
                <optgroup label="üìñ Grammar">
                  <option value="Grammar Guru">üìñ Grammar Guru</option>
                  <option value="Grammar Champion">üèÜ Grammar Champion</option>
                </optgroup>
                <optgroup label="üìö Vocabulary">
                  <option value="Vocabulary Virtuoso">üìï Vocabulary Virtuoso</option>
                  <option value="Spelling Champion">üî§ Spelling Champion</option>
                  <option value="Word Wizard">‚ú® Word Wizard</option>
                </optgroup>
                <optgroup label="‚úçÔ∏è Creative Writing">
                  <option value="Creative Writing Star">‚úçÔ∏è Creative Writing Star</option>
                  <option value="Story Teller">üìù Story Teller</option>
                  <option value="Writing Wizard">‚ú® Writing Wizard</option>
                </optgroup>
                <optgroup label="üé§ Public Speaking">
                  <option value="Public Speaking Pro">üé§ Public Speaking Pro</option>
                  <option value="Confident Performer">üí´ Confident Performer</option>
                  <option value="Stage Star">üåü Stage Star</option>
                  <option value="Debate Champion">üí≠ Debate Champion</option>
                </optgroup>
                <optgroup label="‚≠ê General">
                  <option value="Star Student">‚≠ê Star Student</option>
                  <option value="Most Improved">üöÄ Most Improved</option>
                  <option value="Outstanding Performer">üèÖ Outstanding Performer</option>
                  <option value="Best Effort">üí™ Best Effort</option>
                </optgroup>
                <option value="Custom">‚úèÔ∏è Custom Title...</option>
              </select>
            </div>
            <div class="form-group" id="customTitleGroup" style="display: none;">
              <label>Custom Title</label>
              <input type="text" id="customCertificateTitle" placeholder="Enter custom certificate title">
            </div>
          </div>

          <div class="form-group"><label>Overall Performance Summary</label><textarea id="performanceSummary" rows="4" placeholder="Write a brief summary of the student's progress this month..."></textarea></div>

          <div class="form-group"><label>Areas of Improvement</label><textarea id="areasOfImprovement" rows="3" placeholder="Mention areas where the student can focus for better results..."></textarea></div>

          <div class="form-group"><label>Teacher's Comments</label><textarea id="teacherComments" rows="3" placeholder="Any additional comments or encouragement..."></textarea></div>

          <div class="form-row">
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
              <input type="checkbox" id="sendAssessmentEmail" checked style="width: auto; margin: 0;">
              <label style="margin: 0;">Send Report Card & Certificate via Email</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Generate & Send Report Card</button>
        </form>
      </div>
      <div class="section">
        <h2>üìã All Assessments</h2>
        <table id="assessmentsTable">
          <thead><tr><th>Type</th><th>Student/Lead</th><th>Period</th><th>Certificate</th><th>Skills</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="assessmentsBody"><tr><td colspan="7">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="paymentsTab" class="tab-content">
      <div class="section">
        <h2>üí≥ Payment Management</h2>
        <div class="form-row">
          <div class="form-group"><label>Select Student</label>
            <select id="paymentStudent" onchange="loadStudentPaymentDetails()">
              <option value="">Select Student...</option>
            </select>
          </div>
        </div>
        <div id="paymentStudentDetails" style="display: none; margin-top: 20px;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #B05D9E; margin-bottom: 15px;">Student Payment Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div><strong>Name:</strong> <span id="payStudentName">-</span></div>
              <div><strong>Total Sessions:</strong> <span id="payTotalSessions">-</span></div>
              <div><strong>Remaining:</strong> <span id="payRemainingSessions" style="color: #e53e3e;">-</span></div>
              <div><strong>Total Paid:</strong> <span id="payTotalPaid" style="color: #38a169;">-</span></div>
            </div>
          </div>

          <!-- Add First Payment Form -->
          <div class="section" style="background: #e6fffa; border: 2px solid #38b2ac;">
            <h3 style="color: #2c7a7b; margin-bottom: 15px;">üí∞ Record First Payment</h3>
            <form id="firstPaymentForm">
              <div class="form-row">
                <div class="form-group"><label>Amount *</label><input type="number" id="firstPaymentAmount" step="0.01" required></div>
                <div class="form-group"><label>Currency</label><select id="firstPaymentCurrency"><option value="INR">INR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="EUR">EUR</option><option value="AED">AED</option></select></div>
                <div class="form-group"><label>Sessions Covered</label><input type="number" id="firstPaymentSessions"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Payment Method</label>
                  <select id="firstPaymentMethod">
                    <option value="UPI">UPI</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Card">Card</option>
                    <option value="Cash">Cash</option>
                  </select>
                </div>
                <div class="form-group"><label>Receipt Number</label><input type="text" id="firstPaymentReceipt"></div>
              </div>
              <div class="form-group"><label>Notes</label><textarea id="firstPaymentNotes" rows="2"></textarea></div>
              <div class="form-row" style="align-items: center; gap: 20px;">
                <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                  <input type="checkbox" id="sendFirstPaymentEmail" style="width: auto; margin: 0;">
                  <label style="margin: 0;">Send Payment Confirmation Email</label>
                </div>
                <button type="submit" class="btn btn-primary">Record Payment</button>
              </div>
            </form>
          </div>

          <!-- Add Renewal Payment Form -->
          <div class="section" style="background: #fef5e7; border: 2px solid #f6ad55;">
            <h3 style="color: #c05621; margin-bottom: 15px;">üîÑ Record Renewal Payment</h3>
            <form id="renewalPaymentForm">
              <div class="form-row">
                <div class="form-group"><label>Amount *</label><input type="number" id="renewalPaymentAmount" step="0.01" required></div>
                <div class="form-group"><label>Sessions to Add *</label><input type="number" id="renewalPaymentSessions" required></div>
                <div class="form-group"><label>Currency</label><select id="renewalPaymentCurrency"><option value="INR">INR</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="EUR">EUR</option><option value="AED">AED</option></select></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Payment Method</label>
                  <select id="renewalPaymentMethod">
                    <option value="UPI">UPI</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Card">Card</option>
                    <option value="Cash">Cash</option>
                  </select>
                </div>
                <div class="form-group"><label>Notes</label><input type="text" id="renewalPaymentNotes"></div>
              </div>
              <div class="form-row" style="align-items: center; gap: 20px;">
                <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                  <input type="checkbox" id="sendRenewalPaymentEmail" style="width: auto; margin: 0;">
                  <label style="margin: 0;">Send Payment Confirmation Email</label>
                </div>
                <button type="submit" class="btn btn-primary">Record Renewal</button>
              </div>
            </form>
          </div>

          <!-- Payment History Table -->
          <div class="section">
            <h3 style="color: #B05D9E; margin-bottom: 15px;">üìã Payment History</h3>
            <table id="paymentHistoryTable">
              <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Sessions</th><th>Method</th><th>Notes</th></tr></thead>
              <tbody id="paymentHistoryBody"><tr><td colspan="6" style="text-align: center; color: #718096;">Select a student to view payment history</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Admin Profile Tab -->
    <div id="adminProfileTab" class="tab-content">
      <div class="section" style="max-width: 900px; margin: 0 auto;">
        <h2 style="color: #B05D9E; margin-bottom: 10px;">üë§ My Profile & Bio</h2>
        <p style="color: #718096; margin-bottom: 25px;">This bio will be sent to demo parents before their demo class to build trust and showcase your expertise.</p>

        <form id="adminProfileForm">
          <!-- Basic Info Card -->
          <div style="background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white; margin-bottom: 25px;">
            <h3 style="margin: 0 0 20px 0;">‚ú® Basic Information</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label style="color: rgba(255,255,255,0.9);">Your Name</label>
                <input type="text" id="adminName" style="background: rgba(255,255,255,0.95); border: none; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box;" placeholder="Aaliya">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="color: rgba(255,255,255,0.9);">Title / Role</label>
                <input type="text" id="adminTitle" style="background: rgba(255,255,255,0.95); border: none; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box;" placeholder="Founder & Lead Instructor">
              </div>
            </div>
          </div>

          <!-- Bio Section -->
          <div style="background: white; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0; margin-bottom: 25px;">
            <h3 style="margin: 0 0 15px 0; color: #B05D9E;">üìù About You / Bio</h3>
            <p style="color: #718096; font-size: 0.9rem; margin-bottom: 15px;">Write about your experience, qualifications, teaching philosophy, and what makes your classes special. This helps parents feel confident about their child's learning journey.</p>
            <textarea id="adminBio" rows="8" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; line-height: 1.6; resize: vertical; box-sizing: border-box;" placeholder="Hi! I'm Aaliya, the founder of Fluent Feathers Academy...

I have X years of experience in teaching children...

My teaching philosophy focuses on...

What makes my classes unique:
‚Ä¢ Interactive and fun learning
‚Ä¢ Personalized attention
‚Ä¢ Regular progress updates

I'm passionate about helping children develop confidence in communication!"></textarea>
            <p style="color: #718096; font-size: 0.85rem; margin-top: 10px;">üí° Tip: Include your experience, qualifications, teaching style, and what parents can expect.</p>
          </div>

          <!-- Preview Card -->
          <div style="background: #f7fafc; padding: 25px; border-radius: 15px; border: 2px solid #e2e8f0; margin-bottom: 25px;">
            <h3 style="margin: 0 0 15px 0; color: #2d3748;">üìß Email Preview</h3>
            <p style="color: #718096; font-size: 0.9rem; margin-bottom: 15px;">This is how your bio will appear in demo confirmation emails:</p>
            <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #B05D9E;">
              <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #B05D9E 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; flex-shrink: 0;" id="adminInitialPreview">A</div>
                <div>
                  <h4 style="margin: 0; color: #2d3748;" id="adminNamePreview">Aaliya</h4>
                  <p style="margin: 5px 0 0; color: #B05D9E; font-size: 0.9rem;" id="adminTitlePreview">Founder & Lead Instructor</p>
                </div>
              </div>
              <p style="color: #4a5568; font-size: 0.95rem; line-height: 1.7; margin: 0; white-space: pre-wrap;" id="adminBioPreview"><em>Your bio will appear here...</em></p>
            </div>
          </div>

          <div style="text-align: center;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 40px; font-size: 1rem;">üíæ Save Profile</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Whiteboard Tab -->
    <div id="whiteboardTab" class="tab-content">
      <div class="section" style="margin: 0; padding: 15px 20px;">
        <h2 style="color: #B05D9E; margin: 0 0 10px 0;">üé® Teaching Whiteboard</h2>
        <!-- Toolbar -->
        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; padding: 12px; background: #f7fafc; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            <div style="display: flex; gap: 5px; align-items: center;">
              <button onclick="setWhiteboardTool('pen')" id="toolPen" class="wb-tool-btn active">‚úèÔ∏è Pen</button>
              <button onclick="setWhiteboardTool('pencil')" id="toolPencil" class="wb-tool-btn">‚úé Pencil</button>
              <button onclick="setWhiteboardTool('highlighter')" id="toolHighlighter" class="wb-tool-btn">üñçÔ∏è Mark</button>
              <button onclick="setWhiteboardTool('eraser')" id="toolEraser" class="wb-tool-btn">üßπ Erase</button>
              <button onclick="setWhiteboardTool('text')" id="toolText" class="wb-tool-btn">T Text</button>
            </div>
            <div style="display: flex; gap: 5px; align-items: center;">
              <button onclick="setWhiteboardColor('#000000')" class="wb-color-btn active" style="background: #000000;"></button>
              <button onclick="setWhiteboardColor('#e53e3e')" class="wb-color-btn" style="background: #e53e3e;"></button>
              <button onclick="setWhiteboardColor('#dd6b20')" class="wb-color-btn" style="background: #dd6b20;"></button>
              <button onclick="setWhiteboardColor('#38a169')" class="wb-color-btn" style="background: #38a169;"></button>
              <button onclick="setWhiteboardColor('#3182ce')" class="wb-color-btn" style="background: #3182ce;"></button>
              <button onclick="setWhiteboardColor('#805ad5')" class="wb-color-btn" style="background: #805ad5;"></button>
            </div>
            <div style="display: flex; gap: 5px; align-items: center;">
              <span style="font-size: 0.8rem; color: #718096;">Size:</span>
              <input type="range" id="brushSize" min="1" max="50" value="3" style="width: 80px;" onchange="updateBrushSize(this.value)">
              <span id="brushSizeLabel" style="font-size: 0.8rem; color: #2d3748;">3px</span>
            </div>
          </div>
          <div style="display: flex; gap: 5px;">
            <button onclick="undoWhiteboard()" class="btn btn-sm" style="background: #718096; color: white;">‚Ü© Undo</button>
            <button onclick="redoWhiteboard()" class="btn btn-sm" style="background: #718096; color: white;">‚Ü™ Redo</button>
            <button onclick="downloadWhiteboard()" class="btn btn-sm" style="background: #38a169; color: white;">üíæ Save</button>
            <button onclick="clearWhiteboard()" class="btn btn-sm" style="background: #e53e3e; color: white;">üóëÔ∏è Clear</button>
          </div>
        </div>
        <!-- Canvas with fixed height -->
        <div id="whiteboardContainer" style="background: white; border: 2px solid #B05D9E; border-radius: 8px; overflow: hidden; height: 500px;">
          <canvas id="whiteboardCanvas" style="display: block; cursor: crosshair; width: 100%; height: 100%;"></canvas>
        </div>
      </div>

      <style>
        .wb-tool-btn {
          padding: 5px 10px;
          border: 2px solid #e2e8f0;
          border-radius: 5px;
          background: white;
          cursor: pointer;
          font-size: 0.75rem;
          font-weight: 600;
          color: #4a5568;
          transition: all 0.2s;
        }
        .wb-tool-btn:hover {
          border-color: #B05D9E;
          background: #fdf2f8;
        }
        .wb-tool-btn.active {
          border-color: #B05D9E;
          background: #B05D9E;
          color: white;
        }
        .wb-color-btn {
          width: 28px;
          height: 28px;
          border: 2px solid #e2e8f0;
          border-radius: 50%;
          cursor: pointer;
          transition: transform 0.2s;
        }
        .wb-color-btn:hover {
          transform: scale(1.15);
        }
        .wb-color-btn.active {
          border-color: #2d3748;
          box-shadow: 0 0 0 2px white, 0 0 0 4px #B05D9E;
        }
      </style>
    </div>

<!-- Edit Payment Modal -->
<div id="editPaymentModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 style="color: #667eea;">‚úèÔ∏è Edit Payment Details</h2>
      <button onclick="closeEditPaymentModal()" class="btn btn-danger btn-sm">‚úï</button>
    </div>
    <div style="padding: 20px;">
      <input type="hidden" id="editPaymentStudentId">
      <div class="form-group">
        <label>Total Amount Paid *</label>
        <div style="display: flex; gap: 10px;">
          <select id="editPaymentCurrency" style="width: 100px;">
            <option value="INR">INR ‚Çπ</option>
            <option value="USD">USD $</option>
            <option value="GBP">GBP ¬£</option>
            <option value="EUR">EUR ‚Ç¨</option>
            <option value="AED">AED</option>
            <option value="SAR">SAR</option>
            <option value="OMR">OMR</option>
            <option value="QAR">QAR</option>
            <option value="CAD">CAD</option>
            <option value="AUD">AUD</option>
            <option value="SGD">SGD</option>
          </select>
          <input type="number" id="editPaymentAmount" step="0.01" min="0" required style="flex: 1;">
        </div>
      </div>
      <div class="form-group">
        <label>Total Sessions</label>
        <input type="number" id="editPaymentSessions" min="0" required>
      </div>
      <div class="form-group">
        <label>Reason for Edit (Optional)</label>
        <input type="text" id="editPaymentReason" placeholder="e.g., Correction, Refund adjustment">
      </div>
      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
        <p style="color: #856404; font-size: 0.9rem; margin: 0;">‚ö†Ô∏è <strong>Warning:</strong> This will directly update the student's payment record. Use this only for corrections.</p>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="closeEditPaymentModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        <button onclick="saveEditedPayment()" class="btn btn-primary">üíæ Save Changes</button>
      </div>
    </div>
  </div>
</div>
  <!-- Switch to Learner View Modal -->
  <div id="switchToLearnerModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 style="color: #38b2ac;">üëÅÔ∏è Switch to Learner View</h2>
        <button onclick="closeSwitchToLearnerModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <p style="color: #4a5568; margin-bottom: 20px;">Select a student to view their parent portal as admin (no password required):</p>
      <div class="form-group">
        <label>Select Student</label>
        <select id="learnerViewStudent">
          <option value="">Select Student...</option>
        </select>
      </div>
      <button onclick="switchToLearnerView()" class="btn btn-primary" style="width: 100%;">üöÄ Open Parent Portal</button>
    </div>
  </div>

  <!-- Event View/Edit Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 id="eventModalTitle" style="color: #B05D9E;">Event Details</h2>
        <button onclick="closeEventModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <div id="eventModalContent">Loading...</div>
    </div>
  </div>

  <!-- Event Attendance Modal -->
  <div id="eventAttendanceModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 id="eventAttendanceTitle" style="color: #38a169;">Mark Event Attendance</h2>
        <button onclick="closeEventAttendanceModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <div id="eventAttendanceContent">Loading...</div>
    </div>
  </div>

  <!-- Event Registrations Modal -->
  <div id="eventRegistrationsModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 id="eventRegistrationsTitle" style="color: #9f7aea;">Event Registrations</h2>
        <button onclick="closeEventRegistrationsModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <div id="eventRegistrationsContent">Loading...</div>
    </div>
  </div>

  <!-- Event Certificates Modal -->
  <div id="eventCertificatesModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 id="eventCertificatesTitle" style="color: #8b5cf6;">Send Participation Certificates</h2>
        <button onclick="closeEventCertificatesModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <div id="eventCertificatesContent">Loading...</div>
    </div>
  </div>

  <!-- Complete Student Modal with ALL tabs -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="modalStudentName">Student Details</h2><button onclick="closeStudentModal()" class="btn btn-danger btn-sm">‚úï</button></div>

      <div class="modal-tabs">
        <button class="modal-tab active" onclick="showModalTab('modalInfo', event)">üìã Info</button>
        <button class="modal-tab" onclick="showModalTab('modalPayments', event)">üí∞ Payments</button>
        <button class="modal-tab" onclick="showModalTab('modalHomework', event)">üìö Homework</button>
        <button class="modal-tab" onclick="showModalTab('modalBadges', event)">üèÜ Badges</button>
      </div>

      <div id="modalInfoTab" class="modal-tab-content active"><div id="studentInfoContent"></div></div>

      <div id="modalPaymentsTab" class="modal-tab-content">
        <button onclick="showRenewalForm()" class="btn btn-primary" style="margin-bottom: 20px;">‚ûï Add Monthly Renewal</button>
        <div id="renewalForm" style="display:none; background:#f7fafc; padding:20px; border-radius:8px; margin-bottom:20px;">
          <h3>Add Monthly Renewal</h3>
          <div class="form-row">
            <div class="form-group"><label>Amount *</label><input type="number" id="renewalAmount" step="0.01" required></div>
            <div class="form-group"><label>Sessions Added *</label><input type="number" id="renewalSessions" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Payment Method</label><input type="text" id="renewalMethod" placeholder="Cash, Card, UPI, etc."></div>
          </div>
          <div class="form-group"><label>Notes</label><textarea id="renewalNotes" rows="2"></textarea></div>
          <button onclick="submitRenewal()" class="btn btn-success">Add Renewal</button>
          <button onclick="document.getElementById('renewalForm').style.display='none'" class="btn btn-danger">Cancel</button>
        </div>
        <div id="modalPaymentsContent">Loading...</div>
      </div>

      <div id="modalHomeworkTab" class="modal-tab-content"><div id="modalHomeworkContent">Loading...</div></div>
      <div id="modalBadgesTab" class="modal-tab-content"><div id="modalBadgesContent">Loading...</div></div>
    </div>
  </div>

  <!-- Session Modal -->
  <div id="sessionModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="modalSessionTitle">Session Details</h2><button onclick="closeSessionModal()" class="btn btn-danger btn-sm">‚úï</button></div><div id="sessionDetailsContent"></div></div></div>

  <!-- Reschedule Modal -->
  <div id="rescheduleModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin: -30px -30px 20px -30px; padding: 25px 30px; border-radius: 15px 15px 0 0;">
        <h2 style="color: white; margin: 0;">üìÖ Reschedule Class</h2>
        <button onclick="closeRescheduleModal()" class="btn btn-sm" style="background: rgba(255,255,255,0.3); color: white;">‚úï</button>
      </div>
      <div id="rescheduleInfo" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <!-- Session info will be populated here -->
      </div>
      <form id="rescheduleForm">
        <input type="hidden" id="rescheduleSessionId">
        <div class="form-row">
          <div class="form-group">
            <label>New Date *</label>
            <input type="date" id="rescheduleDate" required>
          </div>
          <div class="form-group">
            <label>New Time (IST) *</label>
            <input type="time" id="rescheduleTime" required>
          </div>
        </div>
        <div class="form-group">
          <label>Reason for Reschedule</label>
          <select id="rescheduleReason">
            <option value="Parent Requested">Parent Requested</option>
            <option value="Teacher Schedule Change">Teacher Schedule Change</option>
            <option value="Holiday">Holiday</option>
            <option value="Technical Issues">Technical Issues</option>
            <option value="Emergency">Emergency</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div style="background: #fef5e7; border: 1px solid #f6ad55; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
          <p style="margin: 0; color: #c05621; font-size: 0.9rem;">
            üìß <strong>Note:</strong> Parents will be notified via email about this reschedule.
          </p>
        </div>
        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn btn-primary" style="flex: 1; background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);">‚úÖ Confirm Reschedule</button>
          <button type="button" onclick="closeRescheduleModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Sessions Modal -->
  <div id="editSessionsModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); margin: -30px -30px 20px -30px; padding: 25px 30px; border-radius: 15px 15px 0 0;">
        <h2 style="color: white; margin: 0;">‚úèÔ∏è Fix Session Counts</h2>
        <button onclick="closeEditSessionsModal()" class="btn btn-sm" style="background: rgba(255,255,255,0.3); color: white;">‚úï</button>
      </div>
      <div style="background: #fff5f5; border: 1px solid #fc8181; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
        <p style="margin: 0; color: #c53030; font-size: 0.85rem;">
          ‚ö†Ô∏è <strong>Use with caution!</strong> Only use this to fix incorrect attendance marking. This directly modifies session counts.
        </p>
      </div>
      <p style="margin-bottom: 15px;"><strong>Student:</strong> <span id="editSessionsStudentName"></span></p>
      <form id="editSessionsForm">
        <input type="hidden" id="editSessionsStudentId">
        <div class="form-group">
          <label>Total Sessions</label>
          <input type="number" id="editTotalSessions" min="0" required>
          <small style="color: #718096;">Total sessions purchased/allocated</small>
        </div>
        <div class="form-group">
          <label>Completed Sessions</label>
          <input type="number" id="editCompletedSessions" min="0" required>
          <small style="color: #718096;">Sessions already attended</small>
        </div>
        <div class="form-group">
          <label>Missed Sessions</label>
          <input type="number" id="editMissedSessions" min="0" required>
          <small style="color: #718096;">Excused + Unexcused absences</small>
        </div>
        <div class="form-group">
          <label>Remaining Sessions</label>
          <input type="number" id="editRemainingSessions" min="0" required>
          <small style="color: #718096;">Sessions left to attend</small>
        </div>
        <div class="form-group">
          <label>Reason for Change</label>
          <input type="text" id="editSessionsReason" placeholder="e.g., Fixed double attendance marking" required>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn" style="flex: 1; background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); color: white;">üíæ Save Changes</button>
          <button type="button" onclick="closeEditSessionsModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Group Enrollment Modal -->
  <div id="enrollModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="enrollModalTitle">Enroll Students</h2><button onclick="closeEnrollModal()" class="btn btn-danger btn-sm">‚úï</button></div><div id="enrollModalContent"></div></div></div>

  <!-- Edit Session Modal -->
  <div id="editSessionModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Edit Session</h2><button onclick="closeEditSessionModal()" class="btn btn-danger btn-sm">‚úï</button></div><form id="editSessionForm"><input type="hidden" id="editSessionId"><div class="form-row"><div class="form-group"><label>Date *</label><input type="date" id="editSessionDate" required></div><div class="form-group"><label>Time *</label><input type="time" id="editSessionTime" required></div></div><button type="submit" class="btn btn-primary">Save Changes</button></form></div></div>

  <!-- Cancel Class Modal -->
  <div id="cancelClassModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2>Cancel Class</h2>
        <button onclick="closeCancelClassModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <form id="cancelClassForm">
        <input type="hidden" id="cancelSessionId">
        <input type="hidden" id="cancelSessionType">
        <p style="margin-bottom: 15px;">Cancel class for: <strong id="cancelStudentName"></strong></p>
        <div class="form-group">
          <label>Cancellation Reason *</label>
          <select id="cancelReason" required>
            <option value="">Select reason...</option>
            <option value="Parent Requested">Parent Requested</option>
            <option value="Admin Cancelled">Admin Cancelled</option>
            <option value="Teacher Unavailable">Teacher Unavailable</option>
            <option value="Technical Issues">Technical Issues</option>
            <option value="Holiday">Holiday</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Additional Notes (Optional)</label>
          <textarea id="cancelNotes" rows="2" placeholder="Any additional details..."></textarea>
        </div>
        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
          <input type="checkbox" id="grantMakeupCredit" checked style="width: auto; margin: 0;">
          <label for="grantMakeupCredit" style="margin: 0; cursor: pointer;">Grant makeup credit to student</label>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" class="btn btn-danger">Cancel Class</button>
          <button type="button" onclick="closeCancelClassModal()" class="btn" style="background: #718096; color: white;">Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Update Demo Status Modal -->
  <div id="updateDemoStatusModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2>Update Demo Status</h2>
        <button onclick="closeUpdateDemoStatusModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <form id="updateDemoStatusForm">
        <input type="hidden" id="updateDemoId">
        <p style="margin-bottom: 15px;">Update status for: <strong id="updateDemoName"></strong></p>
        <div class="form-group">
          <label>New Status *</label>
          <select id="newDemoStatus" required>
            <option value="Scheduled">üìÖ Scheduled</option>
            <option value="Completed">‚úÖ Demo Completed</option>
            <option value="Converted">üéâ Converted to Student</option>
            <option value="Lost">‚ùå Lost/Not Interested</option>
          </select>
        </div>
        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="demoStatusNotes" rows="2" placeholder="Any notes about this status change..."></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" class="btn btn-primary">Update Status</button>
          <button type="button" onclick="closeUpdateDemoStatusModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Demo Lead Modal -->
  <div id="editDemoModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h2 style="color: white;">‚úèÔ∏è Edit Demo Details</h2>
        <button onclick="closeEditDemoModal()" class="btn btn-sm" style="background: white; color: #667eea;">‚úï</button>
      </div>
      <form id="editDemoForm">
        <input type="hidden" id="editDemoId">
        <div class="form-row">
          <div class="form-group"><label>Child's Name *</label><input type="text" id="editDemoChildName" required></div>
          <div class="form-group"><label>Child's Age *</label><input type="text" id="editDemoChildGrade" required placeholder="e.g. 8 years"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Parent Name *</label><input type="text" id="editDemoParentName" required></div>
          <div class="form-group"><label>Parent Email *</label><input type="email" id="editDemoParentEmail" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Phone Number</label><input type="tel" id="editDemoPhone"></div>
          <div class="form-group"><label>Program Interest</label>
            <select id="editDemoProgramInterest">
              <option value="">Select Program...</option>
              <option value="Fluent Communicators Program">Fluent Communicators Program</option>
              <option value="Fluent Readers Program">Fluent Readers Program</option>
              <option value="Fluent Writers Program">Fluent Writers Program</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Demo Date *</label><input type="date" id="editDemoDate" required></div>
          <div class="form-group"><label>Demo Time *</label><input type="time" id="editDemoTime" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Source</label>
            <select id="editDemoSource">
              <option value="">Select...</option>
              <option value="Instagram">Instagram</option>
              <option value="Facebook">Facebook</option>
              <option value="WhatsApp">WhatsApp</option>
              <option value="Referral">Referral</option>
              <option value="Google">Google</option>
              <option value="Website">Website</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group"><label>Status</label>
            <select id="editDemoStatus">
              <option value="Scheduled">üìÖ Scheduled</option>
              <option value="Completed">‚úÖ Demo Completed</option>
              <option value="Converted">üéâ Converted</option>
              <option value="Lost">‚ùå Lost</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Notes</label><textarea id="editDemoNotes" rows="2" placeholder="Any additional notes..."></textarea></div>
        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
          <input type="checkbox" id="editDemoSendEmail" style="width: auto; margin: 0;">
          <label for="editDemoSendEmail" style="margin: 0; cursor: pointer;">üìß Send updated confirmation email with new date/time</label>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">Save Changes</button>
          <button type="button" onclick="closeEditDemoModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Makeup Credit Modal -->
  <div id="addMakeupCreditModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h2 style="color: white;">üéÅ Add Makeup Credit</h2>
        <button onclick="closeAddMakeupCreditModal()" class="btn btn-sm" style="background: white; color: #f093fb;">‚úï</button>
      </div>
      <form id="addMakeupCreditForm">
        <input type="hidden" id="makeupStudentId">
        <p style="margin-bottom: 15px;">Adding makeup credit for: <strong id="makeupStudentName"></strong></p>
        <div class="form-group">
          <label>Reason for Makeup Credit *</label>
          <select id="makeupReason" required>
            <option value="Emergency - Student couldn't attend">Emergency - Student couldn't attend</option>
            <option value="Technical issues during class">Technical issues during class</option>
            <option value="Teacher unavailable">Teacher unavailable</option>
            <option value="Power/Internet outage">Power/Internet outage</option>
            <option value="Health reasons">Health reasons</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Additional Notes (Optional)</label>
          <textarea id="makeupNotes" rows="2" placeholder="Any additional details..."></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" class="btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">Add Makeup Credit</button>
          <button type="button" onclick="closeAddMakeupCreditModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Schedule Makeup Class Modal -->
  <div id="scheduleMakeupModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h2 style="color: white;">üìÖ Schedule Makeup Class</h2>
        <button onclick="closeScheduleMakeupModal()" class="btn btn-sm" style="background: white; color: #f093fb;">‚úï</button>
      </div>
      <form id="scheduleMakeupForm">
        <input type="hidden" id="scheduleMakeupCreditId">
        <input type="hidden" id="scheduleMakeupStudentId">
        <p style="margin-bottom: 15px;">Scheduling makeup class for: <strong id="scheduleMakeupStudentName"></strong></p>
        <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <p style="margin: 0; color: #718096; font-size: 0.9rem;">Original Reason: <span id="scheduleMakeupReason" style="color: #2d3748;"></span></p>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date (IST) *</label>
            <input type="date" id="makeupClassDate" required>
          </div>
          <div class="form-group">
            <label>Time (IST) *</label>
            <input type="time" id="makeupClassTime" required>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" class="btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">Schedule Class</button>
          <button type="button" onclick="closeScheduleMakeupModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Convert Demo to Student Modal -->
  <div id="convertDemoModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>üéâ Convert to Permanent Student</h2>
        <button onclick="closeConvertDemoModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <form id="convertDemoForm">
        <input type="hidden" id="convertDemoId">
        <p style="margin-bottom: 15px; color: #38a169;">Converting <strong id="convertDemoName"></strong> to a permanent student!</p>

        <div class="form-row">
          <div class="form-group"><label>Program Name *</label><input type="text" id="convertProgram" required placeholder="e.g., Phonics, Reading"></div>
          <div class="form-group"><label>Duration *</label>
            <select id="convertDuration" required>
              <option value="25 mins">25 mins</option>
              <option value="30 mins">30 mins</option>
              <option value="40 mins" selected>40 mins</option>
              <option value="45 mins">45 mins</option>
              <option value="60 mins">60 mins</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Per Session Fee *</label><input type="number" id="convertFee" required placeholder="e.g., 500"></div>
          <div class="form-group"><label>Currency *</label>
            <select id="convertCurrency" required>
              <option value="‚Çπ">‚Çπ INR</option>
              <option value="$">$ USD</option>
              <option value="AED">AED</option>
              <option value="¬£">¬£ GBP</option>
              <option value="‚Ç¨">‚Ç¨ EUR</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Sessions Purchased *</label><input type="number" id="convertSessions" required placeholder="e.g., 8"></div>
          <div class="form-group"><label>Amount Paid *</label><input type="number" id="convertAmountPaid" required placeholder="e.g., 4000"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Payment Method *</label>
            <select id="convertPaymentMethod" required>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="UPI">UPI</option>
              <option value="Cash">Cash</option>
              <option value="Credit Card">Credit Card</option>
              <option value="PayPal">PayPal</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group"><label>Timezone *</label>
            <select id="convertTimezone" required>
              <option value="Asia/Kolkata">India (IST)</option>
              <option value="Asia/Dubai">UAE/Dubai (GST)</option>
              <option value="America/New_York">USA East (EST)</option>
              <option value="America/Los_Angeles">USA West (PST)</option>
              <option value="Europe/London">UK (GMT)</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
          <input type="checkbox" id="convertSendEmail" checked style="width: auto; margin: 0;">
          <label for="convertSendEmail" style="margin: 0; cursor: pointer;">Send welcome email to parent</label>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" class="btn btn-primary" style="background: #38a169;">üéâ Convert to Student</button>
          <button type="button" onclick="closeConvertDemoModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Assign Badge Modal -->
  <div id="assignBadgeModal" class="modal">
    <div class="modal-content" style="max-width: 650px;">
      <div class="modal-header">
        <h2>üéñÔ∏è Assign Badge</h2>
        <button onclick="closeAssignBadgeModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <p style="color: #718096; margin-bottom: 15px;">Select a badge to reward the student for their achievement in class!</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px;">
        <div onclick="assignBadge('active_listener', 'üëÇ Active Listener', 'Listened attentively throughout the class!')" class="badge-option" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üëÇ</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Active Listener</div>
        </div>
        <div onclick="assignBadge('attentive_star', 'üåü Attentive Star', 'Showed excellent focus and attention!')" class="badge-option" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üåü</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Attentive Star</div>
        </div>
        <div onclick="assignBadge('vocabulary_champ', 'üìö Vocabulary Champ', 'Learned new words brilliantly!')" class="badge-option" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üìö</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Vocabulary Champ</div>
        </div>
        <div onclick="assignBadge('reading_rockstar', 'üìñ Reading Rockstar', 'Read with great fluency and expression!')" class="badge-option" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üìñ</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Reading Rockstar</div>
        </div>
        <div onclick="assignBadge('pronunciation_pro', 'üó£Ô∏è Pronunciation Pro', 'Excellent pronunciation skills!')" class="badge-option" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üó£Ô∏è</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Pronunciation Pro</div>
        </div>
        <div onclick="assignBadge('grammar_guru', '‚úèÔ∏è Grammar Guru', 'Mastered grammar concepts!')" class="badge-option" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">‚úèÔ∏è</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Grammar Guru</div>
        </div>
        <div onclick="assignBadge('creative_writer', '‚úçÔ∏è Creative Writer', 'Showed amazing creativity in writing!')" class="badge-option" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">‚úçÔ∏è</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Creative Writer</div>
        </div>
        <div onclick="assignBadge('quick_learner', '‚ö° Quick Learner', 'Grasped concepts super fast!')" class="badge-option" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">‚ö°</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Quick Learner</div>
        </div>
        <div onclick="assignBadge('confident_speaker', 'üé§ Confident Speaker', 'Spoke with great confidence!')" class="badge-option" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üé§</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Confident Speaker</div>
        </div>
        <div onclick="assignBadge('perfect_participation', 'üôã Perfect Participation', 'Participated actively in every activity!')" class="badge-option" style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üôã</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Perfect Participation</div>
        </div>
        <div onclick="assignBadge('super_effort', 'üí™ Super Effort', 'Put in outstanding effort today!')" class="badge-option" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üí™</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Super Effort</div>
        </div>
        <div onclick="assignBadge('bright_spark', 'üí° Bright Spark', 'Had brilliant ideas in class!')" class="badge-option" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üí°</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Bright Spark</div>
        </div>
        <div onclick="assignBadge('improvement_star', 'üìà Improvement Star', 'Showed great improvement!')" class="badge-option" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üìà</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Improvement Star</div>
        </div>
        <div onclick="assignBadge('curiosity_badge', 'üîç Curious Mind', 'Asked thoughtful questions!')" class="badge-option" style="background: linear-gradient(135deg, #c3cfe2 0%, #c3cfe2 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üîç</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Curious Mind</div>
        </div>
        <div onclick="assignBadge('storyteller', 'üìï Storyteller', 'Told stories wonderfully!')" class="badge-option" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üìï</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Storyteller</div>
        </div>
        <div onclick="assignBadge('spelling_bee', 'üêù Spelling Bee', 'Spelled words perfectly!')" class="badge-option" style="background: linear-gradient(135deg, #f5af19 0%, #f12711 100%); color: white; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üêù</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Spelling Bee</div>
        </div>
        <div onclick="assignBadge('positive_attitude', 'üòä Positive Attitude', 'Maintained a great positive attitude!')" class="badge-option" style="background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">üòä</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Positive Attitude</div>
        </div>
        <div onclick="assignBadge('team_player', 'ü§ù Team Player', 'Worked wonderfully with others!')" class="badge-option" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="font-size: 1.5rem;">ü§ù</div>
          <div style="font-weight: 600; font-size: 0.85rem;">Team Player</div>
        </div>
      </div>
      <button onclick="closeAssignBadgeModal()" class="btn" style="margin-top: 15px; background: #718096; color: white; width: 100%;">Close</button>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div id="editStudentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Edit Student</h2><button onclick="closeEditStudentModal()" class="btn btn-danger btn-sm">‚úï</button></div>
      <form id="updateStudentForm">
        <input type="hidden" id="editStudentId">
        <div class="form-row">
          <div class="form-group"><label>Student Name *</label><input type="text" id="editStudentName" required></div>
          <div class="form-group"><label>Age (Years) *</label><input type="text" id="editGrade" required placeholder="e.g. 10 years"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Parent Name *</label><input type="text" id="editParentName" required></div>
          <div class="form-group"><label>Parent Email *</label><input type="email" id="editParentEmail" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Primary Contact *</label><input type="tel" id="editPrimaryContact" required></div>
          <div class="form-group"><label>Timezone *</label>
            <select id="editTimezone" required>
              <optgroup label="Asia">
                <option value="Asia/Kolkata">India (IST)</option>
                <option value="Asia/Dubai">UAE/Dubai (GST)</option>
                <option value="Asia/Muscat">Oman/Muscat (GST)</option>
                <option value="Asia/Riyadh">Saudi Arabia (AST)</option>
                <option value="Asia/Qatar">Qatar (AST)</option>
                <option value="Asia/Kuwait">Kuwait (AST)</option>
                <option value="Asia/Bahrain">Bahrain (AST)</option>
                <option value="Asia/Singapore">Singapore (SGT)</option>
                <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                <option value="Asia/Tokyo">Japan (JST)</option>
                <option value="Asia/Seoul">South Korea (KST)</option>
                <option value="Asia/Shanghai">China (CST)</option>
                <option value="Asia/Bangkok">Thailand (ICT)</option>
                <option value="Asia/Jakarta">Indonesia (WIB)</option>
                <option value="Asia/Manila">Philippines (PHT)</option>
                <option value="Asia/Karachi">Pakistan (PKT)</option>
                <option value="Asia/Dhaka">Bangladesh (BST)</option>
                <option value="Asia/Colombo">Sri Lanka (IST)</option>
                <option value="Asia/Kathmandu">Nepal (NPT)</option>
                <option value="Asia/Tehran">Iran (IRST)</option>
                <option value="Asia/Jerusalem">Israel (IST)</option>
              </optgroup>
              <optgroup label="Americas">
                <option value="America/New_York">USA East (EST/EDT)</option>
                <option value="America/Chicago">USA Central (CST/CDT)</option>
                <option value="America/Denver">USA Mountain (MST/MDT)</option>
                <option value="America/Los_Angeles">USA West (PST/PDT)</option>
                <option value="America/Toronto">Canada East (EST/EDT)</option>
                <option value="America/Vancouver">Canada West (PST/PDT)</option>
                <option value="America/Mexico_City">Mexico (CST)</option>
                <option value="America/Sao_Paulo">Brazil (BRT)</option>
                <option value="America/Argentina/Buenos_Aires">Argentina (ART)</option>
              </optgroup>
              <optgroup label="Europe">
                <option value="Europe/London">UK (GMT/BST)</option>
                <option value="Europe/Paris">France (CET/CEST)</option>
                <option value="Europe/Berlin">Germany (CET/CEST)</option>
                <option value="Europe/Rome">Italy (CET/CEST)</option>
                <option value="Europe/Madrid">Spain (CET/CEST)</option>
                <option value="Europe/Amsterdam">Netherlands (CET/CEST)</option>
                <option value="Europe/Zurich">Switzerland (CET/CEST)</option>
                <option value="Europe/Istanbul">Turkey (TRT)</option>
                <option value="Europe/Moscow">Russia (MSK)</option>
              </optgroup>
              <optgroup label="Africa & Oceania">
                <option value="Africa/Cairo">Egypt (EET)</option>
                <option value="Africa/Johannesburg">South Africa (SAST)</option>
                <option value="Africa/Lagos">Nigeria (WAT)</option>
                <option value="Australia/Sydney">Australia East (AEST/AEDT)</option>
                <option value="Australia/Perth">Australia West (AWST)</option>
                <option value="Pacific/Auckland">New Zealand (NZST/NZDT)</option>
              </optgroup>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Program Name *</label><input type="text" id="editProgramName" required></div>
          <div class="form-group"><label>Duration *</label><select id="editDuration" required><option value="25 mins">25 mins</option><option value="30 mins">30 mins</option><option value="40 mins">40 mins</option><option value="45 mins">45 mins</option><option value="60 mins">60 mins</option></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Date of Birth</label><input type="date" id="editDateOfBirth" onchange="autoFillAge(this.value, 'editGrade')"></div>
          <div class="form-group"><label>Google Meet Link</label><input type="url" id="editMeetLink" placeholder="https://meet.google.com/..."></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Currency *</label>
            <select id="editCurrency" required>
              <optgroup label="Major Currencies">
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (‚Ç¨)</option>
                <option value="GBP">GBP (¬£)</option>
                <option value="INR">INR (‚Çπ)</option>
                <option value="AED">AED (ÿØ.ÿ•)</option>
                <option value="SAR">SAR (Ô∑º)</option>
                <option value="OMR">OMR (ÿ±.ÿπ.)</option>
                <option value="QAR">QAR (Ô∑º)</option>
                <option value="KWD">KWD (ÿØ.ŸÉ)</option>
                <option value="BHD">BHD (.ÿØ.ÿ®)</option>
              </optgroup>
              <optgroup label="Asia Pacific">
                <option value="SGD">SGD ($)</option>
                <option value="HKD">HKD ($)</option>
                <option value="JPY">JPY (¬•)</option>
                <option value="CNY">CNY (¬•)</option>
                <option value="KRW">KRW (‚Ç©)</option>
                <option value="THB">THB (‡∏ø)</option>
                <option value="MYR">MYR (RM)</option>
                <option value="IDR">IDR (Rp)</option>
                <option value="PHP">PHP (‚Ç±)</option>
                <option value="PKR">PKR (‚Ç®)</option>
                <option value="BDT">BDT (‡ß≥)</option>
                <option value="LKR">LKR (‚Ç®)</option>
                <option value="NPR">NPR (‚Ç®)</option>
                <option value="AUD">AUD ($)</option>
                <option value="NZD">NZD ($)</option>
              </optgroup>
              <optgroup label="Americas & Europe">
                <option value="CAD">CAD ($)</option>
                <option value="MXN">MXN ($)</option>
                <option value="BRL">BRL (R$)</option>
                <option value="CHF">CHF (CHF)</option>
                <option value="SEK">SEK (kr)</option>
                <option value="NOK">NOK (kr)</option>
                <option value="RUB">RUB (‚ÇΩ)</option>
                <option value="TRY">TRY (‚Ç∫)</option>
                <option value="ZAR">ZAR (R)</option>
                <option value="EGP">EGP (¬£)</option>
              </optgroup>
            </select>
          </div>
          <div class="form-group"><label>Per Session Fee *</label><input type="number" id="editPerSessionFee" required step="0.01"></div>
        </div>
        <button type="submit" class="btn btn-primary">Update Student</button>
      </form>
    </div>
  </div>

  <!-- Edit Group Modal -->
  <div id="editGroupModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Edit Group</h2><button onclick="closeEditGroupModal()" class="btn btn-danger btn-sm">‚úï</button></div>
      <form id="updateGroupForm">
        <input type="hidden" id="editGroupId">
        <div class="form-row">
          <div class="form-group"><label>Group Name *</label><input type="text" id="editGroupName" required></div>
          <div class="form-group"><label>Program Name *</label><input type="text" id="editGroupProgram" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Duration *</label><select id="editGroupDuration" required><option value="25 mins">25 mins</option><option value="30 mins">30 mins</option><option value="40 mins">40 mins</option><option value="45 mins">45 mins</option><option value="60 mins">60 mins</option></select></div>
          <div class="form-group"><label>Timezone *</label>
            <select id="editGroupTimezone" required>
              <optgroup label="Asia">
                <option value="Asia/Kolkata">India (IST)</option>
                <option value="Asia/Dubai">UAE/Dubai (GST)</option>
                <option value="Asia/Muscat">Oman/Muscat (GST)</option>
                <option value="Asia/Riyadh">Saudi Arabia (AST)</option>
                <option value="Asia/Qatar">Qatar (AST)</option>
                <option value="Asia/Kuwait">Kuwait (AST)</option>
                <option value="Asia/Singapore">Singapore (SGT)</option>
                <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                <option value="Asia/Tokyo">Japan (JST)</option>
                <option value="Asia/Seoul">South Korea (KST)</option>
                <option value="Asia/Shanghai">China (CST)</option>
                <option value="Asia/Bangkok">Thailand (ICT)</option>
                <option value="Asia/Karachi">Pakistan (PKT)</option>
                <option value="Asia/Dhaka">Bangladesh (BST)</option>
              </optgroup>
              <optgroup label="Americas">
                <option value="America/New_York">USA East (EST/EDT)</option>
                <option value="America/Chicago">USA Central (CST/CDT)</option>
                <option value="America/Denver">USA Mountain (MST/MDT)</option>
                <option value="America/Los_Angeles">USA West (PST/PDT)</option>
                <option value="America/Toronto">Canada East (EST/EDT)</option>
                <option value="America/Mexico_City">Mexico (CST)</option>
                <option value="America/Sao_Paulo">Brazil (BRT)</option>
              </optgroup>
              <optgroup label="Europe">
                <option value="Europe/London">UK (GMT/BST)</option>
                <option value="Europe/Paris">France (CET/CEST)</option>
                <option value="Europe/Berlin">Germany (CET/CEST)</option>
                <option value="Europe/Moscow">Russia (MSK)</option>
                <option value="Europe/Istanbul">Turkey (TRT)</option>
              </optgroup>
              <optgroup label="Africa & Oceania">
                <option value="Africa/Cairo">Egypt (EET)</option>
                <option value="Africa/Johannesburg">South Africa (SAST)</option>
                <option value="Australia/Sydney">Australia East (AEST/AEDT)</option>
                <option value="Pacific/Auckland">New Zealand (NZST/NZDT)</option>
              </optgroup>
            </select>
          </div>
          <div class="form-group"><label>Max Students *</label><input type="number" id="editGroupMaxStudents" required></div>
        </div>
        <button type="submit" class="btn btn-primary">Update Group</button>
      </form>
    </div>
  </div>

  <!-- Feedback View Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Class Feedback</h2><button onclick="closeFeedbackModal()" class="btn btn-danger btn-sm">‚úï</button></div>
      <div id="feedbackModalContent">Loading...</div>
    </div>
  </div>

  <!-- Edit Payment Modal -->
  <div id="editPaymentModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 style="color: #667eea;">‚úèÔ∏è Edit Payment Details</h2>
        <button onclick="closeEditPaymentModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <div style="padding: 20px;">
        <input type="hidden" id="editPaymentStudentId">
        <div class="form-group">
          <label>Total Amount Paid *</label>
          <div style="display: flex; gap: 10px;">
            <select id="editPaymentCurrency" style="width: 100px;">
              <option value="INR">INR ‚Çπ</option>
              <option value="USD">USD $</option>
              <option value="GBP">GBP ¬£</option>
              <option value="EUR">EUR ‚Ç¨</option>
              <option value="AED">AED</option>
              <option value="SAR">SAR</option>
              <option value="OMR">OMR</option>
              <option value="QAR">QAR</option>
              <option value="CAD">CAD</option>
              <option value="AUD">AUD</option>
              <option value="SGD">SGD</option>
            </select>
            <input type="number" id="editPaymentAmount" step="0.01" min="0" required style="flex: 1;">
          </div>
        </div>
        <div class="form-group">
          <label>Total Sessions</label>
          <input type="number" id="editPaymentSessions" min="0" required>
        </div>
        <div class="form-group">
          <label>Reason for Edit (Optional)</label>
          <input type="text" id="editPaymentReason" placeholder="e.g., Correction, Refund adjustment">
        </div>
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
          <p style="color: #856404; font-size: 0.9rem; margin: 0;">‚ö†Ô∏è <strong>Warning:</strong> This will directly update the student's payment record. Use this only for corrections.</p>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeEditPaymentModal()" class="btn" style="background: #718096; color: white;">Cancel</button>
          <button onclick="saveEditedPayment()" class="btn btn-primary">üíæ Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assessment View Modal with Certificate -->
  <div id="assessmentViewModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>üìä Monthly Assessment Report</h2>
        <button onclick="closeAssessmentModal()" class="btn btn-danger btn-sm">‚úï</button>
      </div>
      <div id="assessmentViewContent" style="max-height: 80vh; overflow-y: auto;">Loading...</div>
    </div>
  </div>

  <script>
    // ==================== SERVER WAKE-UP LOADING SCREEN ====================
    (function() {
      let serverReady = false;
      let checkAttempts = 0;
      const maxAttempts = 30;

      const loadingScreen = document.getElementById('serverLoadingScreen');
      const loadingMessage = document.getElementById('loadingMessage');

      const messages = [
        'Loading your dashboard...',
        'Waking up the server...',
        'Connecting to database...',
        'Fetching student data...',
        'Almost ready...',
        'Just a moment more...',
        'Server is starting up, please wait...'
      ];

      let messageIndex = 0;

      // Rotate messages every 3 seconds
      const messageInterval = setInterval(() => {
        messageIndex = (messageIndex + 1) % messages.length;
        if (loadingMessage) loadingMessage.textContent = messages[messageIndex];
      }, 3000);

      // Hide loading screen and show content
      function hideLoadingScreen() {
        clearInterval(messageInterval);
        // Show the main content
        const appLayout = document.querySelector('.app-layout');
        if (appLayout) appLayout.classList.add('ready');
        // Fade out loading screen
        if (loadingScreen) {
          loadingScreen.style.opacity = '0';
          loadingScreen.style.transition = 'opacity 0.5s ease';
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }
      }

      // Check if server is ready
      async function checkServerHealth() {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);

          const response = await fetch('/api/config', {
            signal: controller.signal,
            cache: 'no-store'
          });

          clearTimeout(timeoutId);

          if (response.ok) {
            serverReady = true;
            return true;
          }
          return false;
        } catch (error) {
          console.log('Server not ready yet, attempt', checkAttempts + 1);
          return false;
        }
      }

      // Main loading logic
      async function initializeLoading() {
        while (!serverReady && checkAttempts < maxAttempts) {
          checkAttempts++;
          const isReady = await checkServerHealth();

          if (isReady) {
            console.log('‚úÖ Server is ready!');
            hideLoadingScreen();
            break;
          }

          await new Promise(resolve => setTimeout(resolve, 1000));
        }

        if (!serverReady) {
          console.warn('‚ö†Ô∏è Server may be slow to respond');
          hideLoadingScreen();
        }
      }

      // Start initialization
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLoading);
      } else {
        initializeLoading();
      }
    })();

    // Calculate age from date of birth
    function getAge(dob) {
      if (!dob) return null;
      const birth = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
      return age;
    }
    function getAgeDisplay(student) {
      const age = getAge(student.date_of_birth);
      if (age !== null) return age + ' years';
      return student.grade || '-';
    }
    function autoFillAge(dob, targetId) {
      const age = getAge(dob);
      if (age !== null) document.getElementById(targetId).value = age + ' years';
    }

    let allStudents = [], allGroups = [];
    let currentStudentId = null;
    let currentGroupId = null;
    let actualRevenue = 0;
    let revenueVisible = false;
    let appConfig = { logoUrl: '/logo.png' };

    // Load config (logo URL from environment)
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        appConfig = await res.json();
        // Update header logo
        const headerLogo = document.getElementById('headerLogo');
        if (headerLogo && appConfig.logoUrl) {
          headerLogo.src = appConfig.logoUrl;
        }
        // Update storage status indicator
        const statusEl = document.getElementById('storageStatus');
        if (statusEl) {
          if (appConfig.cloudinaryConfigured) {
            statusEl.innerHTML = '‚òÅÔ∏è Cloud Storage';
            statusEl.style.background = '#c6f6d5';
            statusEl.style.color = '#22543d';
            statusEl.title = 'Files stored on Cloudinary (persistent)';
          } else {
            statusEl.innerHTML = '‚ö†Ô∏è Local Storage';
            statusEl.style.background = '#fed7d7';
            statusEl.style.color = '#c53030';
            statusEl.title = 'WARNING: Files stored locally - will be lost on restart! Configure Cloudinary in environment variables.';
          }
        }
      } catch (e) { console.log('Using default config'); }
    }

    function toggleRevenue() {
      revenueVisible = !revenueVisible;
      const revenueEl = document.getElementById('totalRevenue');
      if (revenueVisible) {
        revenueEl.textContent = '‚Çπ' + actualRevenue.toLocaleString('en-IN');
      } else {
        revenueEl.textContent = '*****';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig();
      await loadDashboardStats();
      await loadUpcomingClasses();
      await loadStudents();
      await loadGroups();
      await loadEmailLogs();
      checkOrphanedCount(); // Check for orphaned sessions
      await loadCalendar(); // Pre-load calendar data

      // Restore last active tab from localStorage
      const savedTab = localStorage.getItem('adminActiveTab');
      if (savedTab && document.getElementById(savedTab + 'Tab')) {
        showTab(savedTab);
      }
    });

    async function showTab(tabName, e) {
      if(e) e.stopPropagation();
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
      // Update old tabs (hidden but kept for compatibility)
      const oldTabBtn = document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`);
      if(oldTabBtn) oldTabBtn.classList.add('active');
      // Update sidebar nav button
      const navBtn = document.querySelector(`.nav-btn[onclick*="'${tabName}'"]`);
      if(navBtn) navBtn.classList.add('active');
      // Save current tab to localStorage for persistence on refresh
      localStorage.setItem('adminActiveTab', tabName);

      // Clean view for Profile and Whiteboard tabs - directly hide elements with JS
      const header = document.querySelector('.main-content > header');
      const statsGrid = document.querySelector('.stats-grid');

      if (tabName === 'adminProfile' || tabName === 'whiteboard') {
        document.body.classList.add('clean-view');
        // Directly hide header and stats with JS
        if (header) header.style.display = 'none';
        if (statsGrid) statsGrid.style.display = 'none';
        // Scroll to top
        document.querySelector('.main-content').scrollTop = 0;
        window.scrollTo(0, 0);
      } else {
        document.body.classList.remove('clean-view');
        // Show header and stats again
        if (header) header.style.display = '';
        if (statsGrid) statsGrid.style.display = '';
      }

      if (tabName === 'emails') { loadEmailLogs(); checkOrphanedCount(); }
      if (tabName === 'past') loadPastSessions();
      if (tabName === 'events') loadEvents();
      if (tabName === 'scheduleManager') loadScheduleManager();
      if (tabName === 'homework') loadHomeworkSubmissions();
      if (tabName === 'classRatings') loadClassRatings();
      if (tabName === 'demoStudents') loadDemoLeads();
      if (tabName === 'leaderboard') loadLeaderboard();
      if (tabName === 'challenges') loadChallenges();
      if (tabName === 'financials') loadFinancialReports();
      if (tabName === 'monthlyAssessment') loadDueAssessments();
      if (tabName === 'whiteboard') {
        setTimeout(initWhiteboard, 100); // Small delay to ensure canvas is visible
      }
    }

    function showModalTab(tabName, e) {
      if(e) e.stopPropagation();
      document.querySelectorAll('.modal-tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
      if(e) e.target.classList.add('active');

      if(tabName === 'modalPayments') loadModalPayments();
      if(tabName === 'modalHomework') loadModalHomework();
      if(tabName === 'modalBadges') loadModalBadges();
    }

    // Admin always sees IST timezone
    function formatSessionTime(session, forceIST = true) {
      try {
        if (!session.session_date || !session.session_time) return 'Invalid Date';
        const dateStr = session.session_date.includes('T') ? session.session_date.split('T')[0] : session.session_date;
        let timeStr = session.session_time.toString().trim();
        if (timeStr.length === 5) timeStr += ':00';
        const isoString = `${dateStr}T${timeStr}Z`;
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return 'Invalid Date';
        // Admin dashboard always shows IST
        return d.toLocaleString('en-US', {
          timeZone: 'Asia/Kolkata',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        });
      } catch(e) {
        return 'Invalid Date';
      }
    }

    async function loadDashboardStats() {
      try {
        const res = await fetch('/api/dashboard/stats');
        const stats = await res.json();
        document.getElementById('totalStudents').textContent = stats.totalStudents;
        document.getElementById('upcomingSessions').textContent = stats.upcomingSessions;
        // Store revenue (already converted to INR by server) but keep hidden by default
        actualRevenue = stats.totalRevenue;
        document.getElementById('totalRevenue').textContent = revenueVisible ? ('‚Çπ' + actualRevenue.toLocaleString('en-IN')) : '*****';
        document.getElementById('totalGroups').textContent = stats.totalGroups;
        document.getElementById('activeEvents').textContent = stats.activeEvents;
      } catch (err) {
        console.error(err);
      }
    }

    async function loadUpcomingClasses() {
      try {
        const res = await fetch('/api/dashboard/upcoming-classes');
const data = await res.json();
const classes = Array.isArray(data.classes) ? data.classes : [];
        const grid = document.getElementById('upcomingClassesGrid');
        if (classes.length === 0) return grid.innerHTML = '<p>No upcoming classes</p>';
        grid.innerHTML = classes.map(cls => {
          // Get day name
          const dateStr = cls.session_date.includes('T') ? cls.session_date.split('T')[0] : cls.session_date;
          const d = new Date(dateStr + 'T00:00:00');
          const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });

          // Different styling for demo classes
          const isDemo = cls.session_type === 'Demo';
          const cardClass = isDemo ? 'class-card class-card-demo' : 'class-card';
          const typeLabel = isDemo ? '<span style="background: #ffd700; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">DEMO</span>' : '';

          // Build student list for group sessions (collapsible dropdown)
          const isGroup = cls.display_type === 'Group';
          let studentsHtml = '';
          if (isGroup && cls.enrolled_students && cls.enrolled_students.length > 0) {
            const joining = cls.enrolled_students.filter(s => !['Cancelled', 'Cancelled by Parent'].includes(s.attendance));
            const cancelled = cls.enrolled_students.filter(s => ['Cancelled', 'Cancelled by Parent'].includes(s.attendance));
            const dropdownId = 'students-' + cls.id;
            studentsHtml = `<div style="margin-top: 8px;">
              <div onclick="var el=document.getElementById('${dropdownId}'); el.style.display = el.style.display==='none'?'block':'none'; this.querySelector('.arrow').textContent = el.style.display==='none'?'‚ñ∏':'‚ñæ';" style="cursor: pointer; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <span class="arrow">‚ñ∏</span> üë• ${joining.length} Student${joining.length !== 1 ? 's' : ''} ${cancelled.length > 0 ? `<span style="background: rgba(229,62,62,0.4); padding: 1px 6px; border-radius: 8px; font-size: 0.7rem; margin-left: auto;">‚ùå ${cancelled.length} cancelled</span>` : ''}
              </div>
              <div id="${dropdownId}" style="display: none; margin-top: 6px; padding: 8px 10px; background: rgba(255,255,255,0.12); border-radius: 8px; font-size: 0.8rem;">
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${joining.map(s => `<span style="background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">‚úÖ ${s.name}</span>`).join('')}
                </div>
                ${cancelled.length > 0 ? `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.15);">
                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                  ${cancelled.map(s => `<span style="background: rgba(229,62,62,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; text-decoration: line-through;">‚ùå ${s.name}</span>`).join('')}
                </div></div>` : ''}
              </div>
            </div>`;
          }

          return `<div class="${cardClass}">
          <h3>${cls.student_name}${typeLabel}</h3>
          <p>üìö ${cls.class_info || 'N/A'}</p>
          <p>üìÖ ${dayName}, ${formatSessionTime(cls)} (IST)</p>
          <p>üåç ${isDemo ? 'Demo Class' : 'Student TZ: ' + cls.timezone}</p>
          ${studentsHtml}
          <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
           <a href="${cls.meet_link || '#'}" target="_blank" class="btn btn-sm" style="background:white; color:#B05D9E; text-decoration:none;">üé• Join Meet</a>
            ${isDemo ? `<button onclick="showTab('demoStudents', event)" class="btn btn-sm" style="background:rgba(255,255,255,0.3); color:white;">üìã View Demo Leads</button>` : `<button onclick="openSessionModal(${cls.id}, '${cls.session_type}')" class="btn btn-sm" style="background:rgba(255,255,255,0.3); color:white;">‚öôÔ∏è Manage</button>
            <button onclick="openCancelClassModal(${cls.id}, decodeURIComponent('${encodeURIComponent(cls.student_name || '')}'), '${cls.session_type}')" class="btn btn-sm" style="background:#e53e3e; color:white;">‚úï Cancel</button>`}
          </div>
        </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
      }
    }

    async function loadStudents() {
      try {
        const res = await fetch('/api/students');
        allStudents = await res.json();
        filterStudents(); // Render with search filter
        document.getElementById('scheduleStudent').innerHTML = '<option value="">Select student...</option>' + allStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('manageScheduleStudent').innerHTML = '<option value="">Select student...</option>' + allStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        // Update due assessments count
        const dueCount = allStudents.filter(s => s.assessment_due).length;
        const dueEl = document.getElementById('dueAssessments');
        if (dueEl) {
          dueEl.textContent = dueCount;
          dueEl.parentElement.style.display = dueCount > 0 ? 'block' : 'block'; // Always show
        }
      } catch (err) {
        console.error(err);
      }
    }

    function filterStudents() {
      const searchInput = document.getElementById('studentSearchInput');
      const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
      const tbody = document.getElementById('studentsBody');

      let filtered = allStudents;
      if (searchTerm) {
        filtered = allStudents.filter(s =>
          s.name.toLowerCase().includes(searchTerm) ||
          (s.grade && s.grade.toLowerCase().includes(searchTerm)) ||
          (s.program_name && s.program_name.toLowerCase().includes(searchTerm)) ||
          (s.parent_name && s.parent_name.toLowerCase().includes(searchTerm)) ||
          (s.parent_email && s.parent_email.toLowerCase().includes(searchTerm))
        );
      }

      // Update count display
      const countSpan = document.getElementById('studentCount');
      if (countSpan) {
        countSpan.textContent = `Showing ${filtered.length} of ${allStudents.length} students`;
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #718096;">No students found matching your search</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(s => {
        const assessmentBadge = s.assessment_due
          ? `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; cursor: pointer;" onclick="showTab('monthlyAssessment', event); setTimeout(() => document.getElementById('assessmentStudent').value = '${s.id}', 100);" title="Due for assessment (${s.sessions_since_assessment} sessions since last)">üìä Due</span>`
          : '';
        return `<tr><td><strong>${s.name}</strong>${assessmentBadge}</td><td>${getAgeDisplay(s)}</td><td>${s.program_name}</td><td>${s.class_type}</td><td>${s.completed_sessions}/${s.remaining_sessions}</td><td>${s.makeup_credits||0}</td><td><button onclick="openStudentModal(${s.id})" class="btn btn-sm btn-primary">View</button> <button onclick="editStudent(${s.id})" class="btn btn-sm btn-warning">Edit</button> <button onclick="deleteStudent(${s.id})" class="btn btn-sm btn-danger">Delete</button></td></tr>`;
      }).join('');
    }

    // EDIT STUDENT
    async function editStudent(id) {
      try {
        const res = await fetch(`/api/students/${id}/full`);
        const student = await res.json();
        document.getElementById('editStudentId').value = student.id;
        document.getElementById('editStudentName').value = student.name;
        document.getElementById('editGrade').value = getAgeDisplay(student);
        document.getElementById('editParentName').value = student.parent_name;
        document.getElementById('editParentEmail').value = student.parent_email;
        document.getElementById('editPrimaryContact').value = student.primary_contact;
        document.getElementById('editTimezone').value = student.timezone;
        document.getElementById('editProgramName').value = student.program_name;
        document.getElementById('editDuration').value = student.duration;
        document.getElementById('editDateOfBirth').value = student.date_of_birth ? student.date_of_birth.split('T')[0] : '';
        document.getElementById('editMeetLink').value = student.meet_link || '';
        document.getElementById('editCurrency').value = student.currency;
        document.getElementById('editPerSessionFee').value = student.per_session_fee;
        document.getElementById('editStudentModal').classList.add('active');
      } catch(err) {
        alert('Error loading student: ' + err.message);
      }
    }

    document.getElementById('updateStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editStudentId').value;
      const data = {
        name: document.getElementById('editStudentName').value,
        grade: document.getElementById('editGrade').value,
        parent_name: document.getElementById('editParentName').value,
        parent_email: document.getElementById('editParentEmail').value,
        primary_contact: document.getElementById('editPrimaryContact').value,
        timezone: document.getElementById('editTimezone').value,
        program_name: document.getElementById('editProgramName').value,
        duration: document.getElementById('editDuration').value,
        date_of_birth: document.getElementById('editDateOfBirth').value || null,
        meet_link: document.getElementById('editMeetLink').value || null,
        currency: document.getElementById('editCurrency').value,
        per_session_fee: parseFloat(document.getElementById('editPerSessionFee').value)
      };

      try {
        const res = await fetch(`/api/students/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          closeEditStudentModal();
          loadStudents();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    function closeEditStudentModal() {
      document.getElementById('editStudentModal').classList.remove('active');
    }

    async function deleteStudent(id) {
      const choice = confirm('Delete this student?\n\nClick OK for PERMANENT DELETE (removes all data including past classes, materials, assessments)\n\nClick Cancel to keep the student');
      if (!choice) return;

      // Double confirm for permanent delete
      const confirmPermanent = confirm('‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\n\nThis will PERMANENTLY delete:\n‚Ä¢ All past class sessions\n‚Ä¢ All materials & recordings\n‚Ä¢ All assessments & certificates\n‚Ä¢ All payment history\n‚Ä¢ All feedback & badges\n\nThis action CANNOT be undone!\n\nType OK to proceed with permanent deletion.');
      if (!confirmPermanent) return;

      try {
        const res = await fetch(`/api/students/${id}?permanent=true`, {method:'DELETE'});
        if(res.ok) {
          alert('‚úÖ Student and all related data permanently deleted!');
          loadStudents();
          loadDashboardStats();
        } else {
          alert('‚ùå Failed to delete student');
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // EDIT GROUP
    async function editGroup(id) {
      try {
        const res = await fetch(`/api/groups/${id}/full`);
        const group = await res.json();
        document.getElementById('editGroupId').value = group.id;
        document.getElementById('editGroupName').value = group.group_name;
        document.getElementById('editGroupProgram').value = group.program_name;
        document.getElementById('editGroupDuration').value = group.duration;
        document.getElementById('editGroupTimezone').value = group.timezone;
        document.getElementById('editGroupMaxStudents').value = group.max_students;
        document.getElementById('editGroupModal').classList.add('active');
      } catch(err) {
        alert('Error loading group: ' + err.message);
      }
    }

    document.getElementById('updateGroupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editGroupId').value;
      const data = {
        group_name: document.getElementById('editGroupName').value,
        program_name: document.getElementById('editGroupProgram').value,
        duration: document.getElementById('editGroupDuration').value,
        timezone: document.getElementById('editGroupTimezone').value,
        max_students: parseInt(document.getElementById('editGroupMaxStudents').value)
      };

      try {
        const res = await fetch(`/api/groups/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          closeEditGroupModal();
          loadGroups();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    function closeEditGroupModal() {
      document.getElementById('editGroupModal').classList.remove('active');
    }

    async function viewGroupDetails(id) {
      try {
        const studentsRes = await fetch(`/api/groups/${id}/students`);
        const students = await studentsRes.json();
        const group = allGroups.find(g => g.id === id);

        const content = `
          <h3>${group.group_name}</h3>
          <p><strong>Program:</strong> ${group.program_name}</p>
          <p><strong>Enrolled Students (${students.length}/${group.max_students}):</strong></p>
          <ul style="list-style: none; padding: 0;">
            ${students.map(s => `<li style="padding: 10px; background: #f7fafc; margin-bottom: 5px; border-radius: 5px;">üë§ ${s.name} (${getAgeDisplay(s)})</li>`).join('')}
          </ul>
        `;

        alert(content); // Simple view - you can enhance this with a modal
      } catch(err) {
        alert('Error loading group details');
      }
    }

    document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sendEmail = document.getElementById('sendWelcomeEmail').checked;
      const data = {
        name: document.getElementById('studentName').value,
        grade: document.getElementById('grade').value,
        parent_name: document.getElementById('parentName').value,
        parent_email: document.getElementById('parentEmail').value,
        primary_contact: document.getElementById('primaryContact').value,
        timezone: document.getElementById('timezone').value,
        program_name: document.getElementById('programName').value,
        class_type: document.getElementById('classType').value,
        duration: document.getElementById('duration').value,
        currency: document.getElementById('currency').value,
        per_session_fee: parseFloat(document.getElementById('perSessionFee').value),
        total_sessions: parseInt(document.getElementById('totalSessions').value),
        date_of_birth: document.getElementById('dateOfBirth').value || null,
        payment_method: document.getElementById('paymentMethod').value || null,
        send_email: sendEmail
      };

      try {
        const res = await fetch('/api/students', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(res.ok) {
          alert(`‚úÖ Student added! ${sendEmail && result.emailSent ? 'Welcome email sent.' : ''}`);
          e.target.reset();
          loadStudents();
          loadDashboardStats();
          loadAssessmentStudents();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    // Makeup credits in schedule classes
    window.currentScheduleStudentMakeupCredits = 0;
    document.getElementById('scheduleStudent').addEventListener('change', function() {
      const studentId = this.value;
      const infoDiv = document.getElementById('privateScheduleMakeupInfo');
      if (!studentId) {
        infoDiv.style.display = 'none';
        window.currentScheduleStudentMakeupCredits = 0;
        document.querySelectorAll('#classScheduleList input[name="use_makeup"]').forEach(cb => cb.checked = false);
        updateMakeupCheckboxStates();
        return;
      }
      const student = allStudents.find(s => s.id == studentId);
      if (student) {
        const count = parseInt(student.makeup_credits) || 0;
        window.currentScheduleStudentMakeupCredits = count;
        document.querySelectorAll('#classScheduleList input[name="use_makeup"]').forEach(cb => cb.checked = false);
        updateMakeupCheckboxStates();
        infoDiv.style.display = count > 0 ? 'block' : 'none';
        if (count > 0) {
          document.getElementById('privateScheduleMakeupCount').textContent = count + ' of ' + count;
        }
      }
    });

    function updateMakeupCheckboxStates() {
      const available = window.currentScheduleStudentMakeupCredits || 0;
      const checkboxes = document.querySelectorAll('#classScheduleList input[name="use_makeup"]');
      let checkedCount = 0;
      checkboxes.forEach(cb => { if (cb.checked) checkedCount++; });
      checkboxes.forEach(cb => {
        if (!cb.checked) cb.disabled = (checkedCount >= available);
        cb.closest('label').style.display = available > 0 ? 'flex' : 'none';
      });
      const countEl = document.getElementById('privateScheduleMakeupCount');
      if (countEl && available > 0) {
        countEl.textContent = (available - checkedCount) + ' of ' + available;
      }
    }

    function addScheduleRow() {
      const container = document.getElementById('classScheduleList');
      const row = document.createElement('div');
      row.className = 'schedule-row';
      row.innerHTML = `<input type="date" name="date" required><input type="time" name="time" required><label style="display: none; align-items: center; gap: 4px; white-space: nowrap; cursor: pointer; font-size: 0.85rem; color: #6b46c1; min-width: fit-content;"><input type="checkbox" name="use_makeup" onchange="updateMakeupCheckboxStates()" style="width: auto; margin: 0;"> Makeup</label><button type="button" onclick="this.parentElement.remove(); updateMakeupCheckboxStates();" class="btn btn-sm btn-danger">√ó</button>`;
      container.appendChild(row);
      updateMakeupCheckboxStates();
    }
    addScheduleRow();

    // Bulk Schedule Generator - supports number of sessions and dual time options
    function generateBulkSchedule(type) {
      const isPrivate = type === 'private';
      const startDateEl = document.getElementById(isPrivate ? 'bulkStartDate' : 'groupBulkStartDate');
      const numSessionsEl = document.getElementById(isPrivate ? 'bulkNumSessions' : 'groupBulkNumSessions');
      const time1El = document.getElementById(isPrivate ? 'bulkClassTime1' : 'groupBulkClassTime1');
      const time2El = document.getElementById(isPrivate ? 'bulkClassTime2' : 'groupBulkClassTime2');
      const daysCheckboxes = document.querySelectorAll(isPrivate ? 'input[name="bulkDays"]:checked' : 'input[name="groupBulkDays"]:checked');
      const dayTimeSelects = document.querySelectorAll(isPrivate ? 'select[name="bulkDayTime"]' : 'select[name="groupBulkDayTime"]');
      const container = document.getElementById(isPrivate ? 'classScheduleList' : 'groupClassScheduleList');

      // Validation
      if (!startDateEl.value) return alert('Please select a start date');
      if (!numSessionsEl.value || numSessionsEl.value < 1) return alert('Please enter number of sessions (at least 1)');
      if (!time1El.value) return alert('Please select Time Option 1');
      if (daysCheckboxes.length === 0) return alert('Please select at least one day of the week');

      const startDate = new Date(startDateEl.value);
      const numSessions = parseInt(numSessionsEl.value);
      const time1 = time1El.value;
      const time2 = time2El.value || time1; // Fallback to time1 if time2 not set

      // Get selected days with their time preference (0=Sun, 1=Mon, etc.)
      const selectedDays = Array.from(daysCheckboxes).map(cb => parseInt(cb.value));

      // Build day to time mapping
      const dayTimeMap = {};
      dayTimeSelects.forEach(select => {
        const day = parseInt(select.getAttribute('data-day'));
        const timeOption = select.value;
        dayTimeMap[day] = timeOption === '2' ? time2 : time1;
      });

      // Clear existing schedule
      container.innerHTML = '';

      // Generate dates until we have the required number of sessions
      let currentDate = new Date(startDate);
      let count = 0;
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const maxIterations = 365; // Safety limit - max 1 year
      let iterations = 0;

      while (count < numSessions && iterations < maxIterations) {
        if (selectedDays.includes(currentDate.getDay())) {
          const dateStr = currentDate.toISOString().split('T')[0];
          const dayName = dayNames[currentDate.getDay()];
          const timeForDay = dayTimeMap[currentDate.getDay()] || time1;

          const row = document.createElement('div');
          row.className = 'schedule-row';
          row.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; background: #f7fafc; border-radius: 6px;';
          const dayClass = isPrivate ? 'day-label-private' : 'day-label-group';
          row.innerHTML = `
            <span style="min-width: 50px; font-weight: bold;" class="${dayClass}">${dayName}</span>
            <input type="date" name="date" value="${dateStr}" required style="flex: 1;">
            <input type="time" name="time" value="${timeForDay}" required style="flex: 1;">
            ${isPrivate ? '<label style="display: none; align-items: center; gap: 4px; white-space: nowrap; cursor: pointer; font-size: 0.85rem; color: #6b46c1; min-width: fit-content;"><input type="checkbox" name="use_makeup" onchange="updateMakeupCheckboxStates()" style="width: auto; margin: 0;"> Makeup</label>' : ''}
            <button type="button" onclick="this.parentElement.remove(); updateMakeupCheckboxStates();" class="btn btn-sm btn-danger">√ó</button>
          `;
          container.appendChild(row);
          count++;
        }
        currentDate.setDate(currentDate.getDate() + 1);
        iterations++;
      }

      if (isPrivate) updateMakeupCheckboxStates();

      if (count === 0) {
        alert('No classes generated. Check your start date and selected days.');
      } else if (count < numSessions) {
        alert(`‚ö†Ô∏è Generated ${count} class${count > 1 ? 'es' : ''} (requested ${numSessions}). Could not find enough matching days within 1 year.`);
      } else {
        alert(`‚úÖ Generated ${count} class${count > 1 ? 'es' : ''} preview. Review below and click "Schedule All Classes" to confirm.`);
      }
    }

    function clearBulkSchedule(type) {
      const isPrivate = type === 'private';
      const container = document.getElementById(isPrivate ? 'classScheduleList' : 'groupClassScheduleList');
      container.innerHTML = '';
      addScheduleRow();
    }

    document.getElementById('schedulePrivateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('scheduleStudent').value;
      if (!studentId) return alert('Select a student');
      const rows = document.querySelectorAll('#classScheduleList .schedule-row');
      const classes = [];
      rows.forEach(row => {
        const date = row.querySelector('input[name="date"]').value;
        const time = row.querySelector('input[name="time"]').value;
        const makeupCb = row.querySelector('input[name="use_makeup"]');
        const use_makeup = makeupCb ? makeupCb.checked : false;
        if (date && time) classes.push({ date, time, use_makeup });
      });
      if (classes.length === 0) return alert('Add at least one class');
      const sendEmail = document.getElementById('sendPrivateScheduleEmail').checked;

      try {
        const res = await fetch('/api/schedule/private-classes', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ student_id: studentId, classes, send_email: sendEmail })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          e.target.reset();
          document.getElementById('classScheduleList').innerHTML = '';
          addScheduleRow();
          window.currentScheduleStudentMakeupCredits = 0;
          document.getElementById('privateScheduleMakeupInfo').style.display = 'none';
          loadStudents(); // Refresh student data (makeup credits may have changed)
          loadUpcomingClasses();
          loadCalendar(); // Refresh calendar with new sessions
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    let allPastSessions = []; // Store all past sessions for filtering

    async function loadPastSessions() {
      try {
        const res = await fetch('/api/sessions/past/all');
        allPastSessions = await res.json();
        filterPastSessions(); // Apply initial filter (show 10)
      } catch(err) {
        console.error(err);
      }
    }

    function filterPastSessions() {
      const searchTerm = (document.getElementById('pastSearchInput')?.value || '').toLowerCase().trim();
      const dateFilter = document.getElementById('pastDateFilter')?.value || '';
      const showCount = document.getElementById('pastShowCount')?.value || '10';

      let filtered = allPastSessions;

      // Apply search filter
      if (searchTerm) {
        filtered = filtered.filter(s =>
          (s.student_name && s.student_name.toLowerCase().includes(searchTerm)) ||
          (s.group_name && s.group_name.toLowerCase().includes(searchTerm)) ||
          (s.session_type && s.session_type.toLowerCase().includes(searchTerm))
        );
      }

      // Apply date filter
      if (dateFilter) {
        filtered = filtered.filter(s => s.session_date && s.session_date.includes(dateFilter));
      }

      // Apply count limit
      const totalFiltered = filtered.length;
      if (showCount !== 'all') {
        filtered = filtered.slice(0, parseInt(showCount));
      }

      // Update count display
      const countEl = document.getElementById('pastSessionsCount');
      if (countEl) {
        if (searchTerm || dateFilter) {
          countEl.textContent = `Found ${totalFiltered} sessions${showCount !== 'all' ? `, showing ${filtered.length}` : ''}`;
        } else {
          countEl.textContent = `Showing ${filtered.length} of ${allPastSessions.length} sessions`;
        }
      }

      // Render filtered sessions
      const tbody = document.getElementById('pastSessionsBody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#718096; padding:20px;">No sessions found matching your search</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(s => {
        const isPending = s.status === 'Pending' || s.status === 'Scheduled';
        const attendanceBtn = isPending ?
          `<button onclick="markAttendance(${s.id}, '${s.session_type}', 'Present')" class="btn btn-sm" style="background:#38a169; color:white; margin-right:5px;">‚úì Present</button>
           <button onclick="markAttendance(${s.id}, '${s.session_type}', 'Excused')" class="btn btn-sm" style="background:#dd6b20; color:white; margin-right:5px;" title="Absent with makeup credit">‚ö†Ô∏è Excused</button>
           <button onclick="markAttendance(${s.id}, '${s.session_type}', 'Unexcused')" class="btn btn-sm" style="background:#e53e3e; color:white;" title="Absent without makeup credit">‚úó Unexcused</button>` :
          `<span class="type-badge ${s.status === 'Present' || s.status === 'Completed' ? 'attendance-present' : s.status === 'Excused' ? 'attendance-excused' : s.status === 'Absent' || s.status === 'Unexcused' || s.status === 'Missed' ? 'attendance-absent' : 'attendance-pending'}">${s.status}</span>`;
        const materials = `${s.ppt_file_path ? '<span title="PPT">üìä</span>' : ''} ${s.recording_file_path ? '<span title="Recording">üé•</span>' : ''} ${s.homework_file_path ? '<span title="HW">üìù</span>' : ''}`;
        const typeClass = s.session_type === 'Private' ? 'type-badge-private' : 'type-badge-group';
        return `<tr>
          <td>${formatSessionTime(s)}</td>
          <td><strong>${s.student_name}</strong></td>
          <td><span class="type-badge ${typeClass}">${s.session_type}</span></td>
          <td>#${s.session_number}</td>
          <td>${attendanceBtn}</td>
          <td>${materials || '-'}</td>
          <td><button onclick="viewFeedback(${s.id})" class="btn btn-sm" style="background:#fbbf24; color:white;">‚≠ê</button></td>
          <td>
            <button onclick="openSessionModal(${s.id}, '${s.session_type}')" class="btn btn-sm btn-primary">Manage</button>
          </td>
        </tr>`;
      }).join('');
    }

    function clearPastFilters() {
      document.getElementById('pastSearchInput').value = '';
      document.getElementById('pastDateFilter').value = '';
      document.getElementById('pastShowCount').value = '10';
      filterPastSessions();
    }

    async function viewFeedback(sessionId) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/feedbacks`);
        if (!res.ok) {
          throw new Error('Failed to fetch feedback');
        }
        const feedbacks = await res.json();
        const container = document.getElementById('feedbackModalContent');

        if(!feedbacks || feedbacks.length === 0) {
          container.innerHTML = '<p style="text-align:center; color:#718096; padding: 20px;">No feedback received yet for this session.</p><p style="text-align:center; color:#a0aec0; font-size:0.9rem;">Feedback is submitted by parents/students after completing a class.</p>';
        } else {
          container.innerHTML = feedbacks.map(f => `
            <div style="background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:10px; border-left: 4px solid #fbbf24;">
              <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <strong style="color:#2d3748;">${f.student_name || 'Student'}</strong>
                <div class="star-rating">${'‚≠ê'.repeat(f.rating || 0)}</div>
              </div>
              <p style="color:#4a5568;">${f.feedback_text || 'No comment provided'}</p>
              <p style="color:#718096; font-size:0.85rem; margin-top:10px;">üìÖ ${f.created_at ? new Date(f.created_at).toLocaleString() : 'N/A'}</p>
            </div>
          `).join('');
        }

        document.getElementById('feedbackModal').classList.add('active');
      } catch(err) {
        console.error('Error loading feedback:', err);
        document.getElementById('feedbackModalContent').innerHTML = '<p style="text-align:center; color:#718096; padding: 20px;">No feedback received yet for this session.</p>';
        document.getElementById('feedbackModal').classList.add('active');
      }
    }

    function closeFeedbackModal() {
      document.getElementById('feedbackModal').classList.remove('active');
    }

    // ==================== HOMEWORK SUBMISSIONS ====================
    async function loadHomeworkSubmissions() {
      try {
        // Populate filter dropdown
        const filterSelect = document.getElementById('homeworkFilterStudent');
        if (filterSelect.options.length <= 1) {
          filterSelect.innerHTML = '<option value="">All Students</option>' +
            allStudents.filter(s => s.is_active).map(s =>
              `<option value="${s.id}">${s.name} (${getAgeDisplay(s)})</option>`
            ).join('');
        }

        const studentId = filterSelect.value;
        const url = studentId ? `/api/homework/all?student_id=${studentId}` : '/api/homework/all';
        const res = await fetch(url);
        const submissions = await res.json();
        const tbody = document.getElementById('homeworkBody');

        if (!submissions || submissions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #718096; padding: 30px;">No homework submissions yet. Students can upload homework from the Parent Portal.</td></tr>';
          return;
        }

        tbody.innerHTML = submissions.map(hw => {
          const gradeDisplay = hw.feedback_grade
            ? `<span style="background: #38a169; color: white; padding: 3px 10px; border-radius: 4px;">${hw.feedback_grade}</span>`
            : '<span style="color: #718096;">Not graded</span>';

          const fileExt = hw.file_name ? hw.file_name.split('.').pop().toLowerCase() : '';
          const fileIcon = ['mp4', 'mov', 'avi', 'webm'].includes(fileExt) ? 'üé•' :
                          ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt) ? 'üñºÔ∏è' :
                          ['pdf'].includes(fileExt) ? 'üìÑ' :
                          ['doc', 'docx'].includes(fileExt) ? 'üìù' :
                          ['ppt', 'pptx'].includes(fileExt) ? 'üìä' : 'üìÅ';

          // Build proper file URL
          let fileUrl = '';
          let isLink = false;
          if (hw.file_path) {
            if (hw.file_path.startsWith('LINK:')) {
              fileUrl = hw.file_path.replace('LINK:', '');
              isLink = true;
            } else if (hw.file_path.startsWith('https://') || hw.file_path.startsWith('http://')) {
              // Cloudinary or external URL - use directly
              fileUrl = hw.file_path;
            } else if (hw.file_path.startsWith('/uploads/')) {
              fileUrl = hw.file_path;
            } else if (/^\d+-\d+/.test(hw.file_path)) {
              // This is a Cloudinary public_id - construct the full URL
              // Note: Parent-uploaded homework goes to homework folder, teacher materials go to materials folder
              const isImageFile = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
              const resourceType = isImageFile ? 'image' : 'raw';
              const folder = hw.uploaded_by === 'Parent' ? 'homework' : 'materials';
              fileUrl = `https://res.cloudinary.com/${appConfig.cloudName || 'dmqipms4f'}/${resourceType}/upload/fluentfeathers/${folder}/${hw.file_path}`;
            } else {
              fileUrl = '/uploads/homework/' + hw.file_path;
            }
          }

          // Determine file type for preview button
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
          const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(fileExt);
          const isPdf = ['pdf'].includes(fileExt);
          const isDoc = ['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(fileExt);

          // Create preview button for all file types
          let previewBtn = '';
          if (fileUrl && !isLink) {
            let fileType = 'other';
            if (isImage) fileType = 'image';
            else if (isVideo) fileType = 'video';
            else if (isPdf) fileType = 'pdf';
            else if (isDoc) fileType = 'doc';

            previewBtn = `<button onclick="previewFile('${fileUrl}', '${fileType}', decodeURIComponent('${encodeURIComponent(hw.file_name || 'File')}'))" class="btn btn-sm" style="background:#9f7aea; color:white;">View</button>`;
          }

          const feedbackDisplay = hw.feedback_comments
            ? `<br><small style="color:#4a5568;">üí¨ ${hw.feedback_comments}</small>`
            : '';

          // Create download URL with proper filename
          const downloadUrl = fileUrl && !isLink ? getDownloadUrl(fileUrl, hw.file_name || 'homework') : '';

          return `<tr>
            <td><strong>${hw.student_name || 'Unknown'}</strong></td>
            <td>#${hw.session_number || 'N/A'}</td>
            <td>
              ${fileUrl ? `<a href="${fileUrl}" target="_blank" style="color: #B05D9E; text-decoration: none;">
                ${fileIcon} ${hw.file_name || (isLink ? 'External Link' : 'Download')}
              </a>` : `${fileIcon} ${hw.file_name || 'File'}`}
            </td>
            <td>${hw.uploaded_at ? new Date(hw.uploaded_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'}</td>
            <td>${gradeDisplay}${feedbackDisplay}</td>
            <td>
              <button onclick="openGradeHomeworkModal(${hw.id}, decodeURIComponent('${encodeURIComponent(hw.student_name || '')}'), decodeURIComponent('${encodeURIComponent(hw.file_name || '')}'))" class="btn btn-sm btn-primary">Grade</button>
              ${previewBtn}
              ${downloadUrl ? `<a href="${downloadUrl}" download="${hw.file_name || 'homework'}" class="btn btn-sm" style="background: #B05D9E; color: white; text-decoration: none;">‚¨áÔ∏è Download</a>` : ''}
              <button onclick="deleteHomework(${hw.id})" class="btn btn-sm btn-danger">Delete</button>
            </td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('Error loading homework:', err);
        document.getElementById('homeworkBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e53e3e;">Error loading homework submissions</td></tr>';
      }
    }

    function openGradeHomeworkModal(homeworkId, studentName, fileName) {
      const grade = prompt(`Grade homework for ${studentName}\n\nFile: ${fileName}\n\nEnter grade (e.g., A+, A, B+, B, C, Excellent, Good):`);
      if (grade === null) return;

      const comments = prompt('Enter feedback comments (optional):') || '';

      gradeHomework(homeworkId, grade, comments);
    }

    // Delete homework submission
    async function deleteHomework(homeworkId) {
      if (!confirm('Are you sure you want to delete this homework submission?')) return;

      try {
        const res = await fetch(`/api/homework/${homeworkId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          alert('Homework deleted successfully!');
          loadHomeworkSubmissions();
        } else {
          const data = await res.json();
          alert(data.error || 'Error deleting homework');
        }
      } catch (e) {
        console.error('Delete error:', e);
        alert('Error deleting homework');
      }
    }

    // Preview file in modal - supports all file types
    function previewFile(url, fileType, fileName) {
      // Remove any existing modal
      const existingModal = document.getElementById('filePreviewModal');
      if (existingModal) existingModal.remove();

      let content = '';

      if (fileType === 'image') {
        content = `<img src="${url}" style="max-width: 95%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);" onerror="this.parentElement.innerHTML='<p style=color:white;>Error loading image. <a href=${url} target=_blank style=color:#9f7aea;>Click here to download</a></p>'">`;
      } else if (fileType === 'video') {
        content = `
          <video controls autoplay style="max-width: 95%; max-height: 85vh; border-radius: 8px;">
            <source src="${url}">
            Your browser does not support video playback.
          </video>`;
      } else if (fileType === 'pdf') {
        // Check if it's a local file, Cloudinary raw URL, or other external URL
        const isLocalFile = url.startsWith('/') || url.startsWith(window.location.origin);
        const isCloudinaryRaw = url.includes('cloudinary.com') && url.includes('/raw/');
        const googleViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;

        if (isLocalFile || isCloudinaryRaw) {
          // For local files and Cloudinary raw PDFs, use direct object embed (faster and more reliable)
          content = `
            <object data="${url}" type="application/pdf" style="width: 95vw; max-width: 1200px; height: 85vh; border: none; border-radius: 8px; background: white;">
              <iframe src="${googleViewerUrl}" style="width: 95vw; max-width: 1200px; height: 85vh; border: none; border-radius: 8px; background: white;"></iframe>
            </object>
            <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">If the document doesn't load, <a href="${url}" target="_blank" style="color: #9f7aea;">click here to open directly</a></p>`;
        } else {
          // For other external URLs, use Google Docs viewer
          content = `
            <iframe src="${googleViewerUrl}" style="width: 95vw; max-width: 1200px; height: 85vh; border: none; border-radius: 8px; background: white;"></iframe>
            <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">If the document doesn't load, <a href="${url}" target="_blank" style="color: #9f7aea;">click here to download</a></p>`;
        }
      } else if (fileType === 'doc') {
        // Use Microsoft Office Online viewer for Word/PPT/Excel
        const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        const googleViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
        content = `
          <iframe src="${officeViewerUrl}" style="width: 95vw; max-width: 1200px; height: 85vh; border: none; border-radius: 8px; background: white;" onerror="this.src='${googleViewerUrl}'"></iframe>
          <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">If the document doesn't load, <a href="${url}" target="_blank" style="color: #9f7aea;">click here to download</a></p>`;
      } else {
        // For other file types, show download prompt
        content = `
          <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 400px;">
            <p style="font-size: 4rem; margin-bottom: 20px;">üìÅ</p>
            <h3 style="color: #2d3748; margin-bottom: 10px;">${fileName}</h3>
            <p style="color: #718096; margin-bottom: 20px;">This file type cannot be previewed in browser.</p>
            <a href="${url}" download="${fileName}" style="background: #9f7aea; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; display: inline-block;">Download File</a>
          </div>`;
      }

      const modal = document.createElement('div');
      modal.id = 'filePreviewModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';
      modal.innerHTML = `
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
          <a href="${url}" download="${fileName}" style="background: #667eea; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-size: 0.9rem;">‚¨áÔ∏è Download</a>
          <button onclick="document.getElementById('filePreviewModal').remove()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">‚úï Close</button>
        </div>
        <p style="color: white; margin-bottom: 15px; font-size: 1.1rem;">${fileName}</p>
        ${content}
      `;

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Close on Escape key
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escHandler);
        }
      });

      document.body.appendChild(modal);
    }

    // Legacy functions for backward compatibility
    function previewImage(url) {
      previewFile(url, 'image', 'Image');
    }

    function previewVideo(url) {
      previewFile(url, 'video', 'Video');
    }

    async function gradeHomework(homeworkId, grade, comments) {
      try {
        const res = await fetch(`/api/materials/${homeworkId}/grade`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ grade, comments })
        });

        if (res.ok) {
          alert('‚úÖ Homework graded successfully!');
          loadHomeworkSubmissions();
        } else {
          alert('‚ùå Failed to grade homework');
        }
      } catch (err) {
        console.error('Error grading homework:', err);
        alert('‚ùå Error grading homework');
      }
    }

    async function markAttendance(sessionId, sessionType, attendance) {
      if (sessionType === 'Group') {
        openSessionModal(sessionId, 'Group');
      } else {
        try {
          const res = await fetch(`/api/sessions/${sessionId}/attendance`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ attendance })
          });
          if(res.ok) {
            const emoji = attendance === 'Present' ? '‚úÖ' : attendance === 'Excused' ? '‚ö†Ô∏è' : '‚ùå';
            const extraMsg = attendance === 'Excused' ? '\n(Makeup credit granted)' :
                            attendance === 'Unexcused' ? '\n(No makeup credit)' : '';
            alert(`${emoji} Marked as ${attendance}${extraMsg}`);
            loadPastSessions();
            loadDashboardStats();
          } else {
            alert('‚ùå Error marking attendance');
          }
        } catch(err) {
          alert('‚ùå Error marking attendance');
        }
      }
    }

    // Helper function to build material URL for viewing
    function buildMaterialUrl(filePath) {
      if (!filePath) return '';
      if (filePath.startsWith('LINK:')) return filePath.replace('LINK:', '');
      if (filePath.startsWith('https://') || filePath.startsWith('http://')) return filePath;
      if (filePath.startsWith('/uploads/')) return filePath;
      if (/^\d+-\d+/.test(filePath)) {
        // Cloudinary public_id - construct URL
        const ext = filePath.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
        const resourceType = isImage ? 'image' : 'raw';
        return `https://res.cloudinary.com/${appConfig.cloudName || 'dmqipms4f'}/${resourceType}/upload/fluentfeathers/materials/${filePath}`;
      }
      return '/uploads/' + filePath;
    }

    async function openSessionModal(sessionId, sessionType) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/details`);
        const session = await res.json();
        document.getElementById('modalSessionTitle').textContent = `Session #${session.session_number} - ${session.session_type}`;

        // Build view links for existing materials with proper file type detection
        const pptUrl = buildMaterialUrl(session.ppt_file_path);
        const recUrl = buildMaterialUrl(session.recording_file_path);
        const hwUrl = buildMaterialUrl(session.homework_file_path);

        // Determine file types for proper viewing
        function getFileType(filePath) {
          if (!filePath) return 'other';
          const ext = filePath.split('.').pop().toLowerCase();
          if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'image';
          if (['mp4', 'mov', 'avi', 'webm'].includes(ext)) return 'video';
          if (['pdf'].includes(ext)) return 'pdf';
          if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(ext)) return 'doc';
          return 'other';
        }

        const pptType = getFileType(session.ppt_file_path);
        const recType = getFileType(session.recording_file_path);
        const hwType = getFileType(session.homework_file_path);

        const pptViewLink = pptUrl ? `<button onclick="previewFile('${pptUrl}', '${pptType}', 'PPT - Session ${session.session_number}')" class="btn btn-sm" style="background:#38a169; color:white; margin-left:10px; cursor:pointer;">üìä View PPT</button>` : '';
        const recViewLink = recUrl ? `<button onclick="previewFile('${recUrl}', '${recType}', 'Recording - Session ${session.session_number}')" class="btn btn-sm" style="background:#38a169; color:white; margin-left:10px; cursor:pointer;">üé• View Recording</button>` : '';
        const hwViewLink = hwUrl ? `<button onclick="previewFile('${hwUrl}', '${hwType}', 'Homework - Session ${session.session_number}')" class="btn btn-sm" style="background:#38a169; color:white; margin-left:10px; cursor:pointer;">üìù View Homework</button>` : '';

        // Store session info for reschedule
        window.currentRescheduleSession = {
          id: sessionId,
          session_number: session.session_number,
          session_type: sessionType,
          student_name: session.student_name || session.group_name || 'Student',
          current_date: session.session_date,
          current_time: session.session_time
        };

        const canReschedule = session.status !== 'Completed' && session.status !== 'Cancelled';

        let content = `
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
          <p style="margin: 0;"><strong>Date:</strong> ${formatSessionTime(session)}</p>
          ${canReschedule ? `<button onclick="openRescheduleModal()" class="btn btn-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; font-weight: 600;">üìÖ Reschedule</button>` : `<span style="background: #718096; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem;">${session.status}</span>`}
        </div>

        ${(pptUrl || recUrl || hwUrl) ? `
        <h3>üìÇ Uploaded Materials</h3>
        <div style="background:#e6fffa; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
          ${pptViewLink}
          ${recViewLink}
          ${hwViewLink}
          ${!pptUrl && !recUrl && !hwUrl ? '<span style="color:#718096;">No materials uploaded yet</span>' : ''}
        </div>` : ''}

        <h3>üìÅ Upload Materials <span style="font-size:0.8rem; color:#718096; font-weight:normal;">(You can upload multiple files)</span></h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:15px; margin-bottom:20px;">
          <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <strong>üìä PPT / Presentation</strong>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="file" id="pptFile" accept=".ppt,.pptx,.pdf,.doc,.docx" style="flex:1; min-width:150px;">
              <button onclick="uploadMaterial(${sessionId}, 'ppt')" class="btn btn-sm btn-primary">Upload</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="url" id="pptLink" placeholder="Paste Canva/Google Drive link..." style="flex:1; min-width:150px; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;">
              <button onclick="saveMaterialLink(${sessionId}, 'ppt')" class="btn btn-sm" style="background:#B05D9E; color:white;">Save Link</button>
            </div>
          </div>
          <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <strong>üé• Recording</strong>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="file" id="recFile" accept=".mp4,.mov,.avi,.mp3,.wav" style="flex:1; min-width:150px;">
              <button onclick="uploadMaterial(${sessionId}, 'recording')" class="btn btn-sm btn-primary">Upload</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="url" id="recLink" placeholder="Paste YouTube/Drive link..." style="flex:1; min-width:150px; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;">
              <button onclick="saveMaterialLink(${sessionId}, 'recording')" class="btn btn-sm" style="background:#B05D9E; color:white;">Save Link</button>
            </div>
          </div>
          <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <strong>üìù Homework</strong>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="file" id="hwFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" style="flex:1; min-width:150px;">
              <button onclick="uploadMaterial(${sessionId}, 'homework')" class="btn btn-sm btn-primary">Upload</button>
            </div>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <input type="url" id="hwLink" placeholder="Paste Canva/Google Drive link..." style="flex:1; min-width:150px; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:0.85rem;">
              <button onclick="saveMaterialLink(${sessionId}, 'homework')" class="btn btn-sm" style="background:#B05D9E; color:white;">Save Link</button>
            </div>
          </div>
        </div>

        <!-- Uploaded Materials List -->
        <div id="uploadedMaterialsList" style="margin-bottom:20px;">
          <h4 style="color:#4a5568; margin-bottom:10px;">üìÇ Uploaded Files</h4>
          <div id="materialFilesContainer" style="background:#f7fafc; padding:15px; border-radius:8px; min-height:60px;">
            <p style="color:#718096; text-align:center;">Loading materials...</p>
          </div>
        </div>
        `;

        if (sessionType === 'Group') {
          const attRes = await fetch(`/api/sessions/${sessionId}/group-attendance`);
          const students = await attRes.json();
          content += `<h3 style="margin-top:20px;">Group Attendance</h3>
          <p style="color:#718096; font-size:0.85rem; margin-bottom:10px;">‚ö†Ô∏è Excused = Absent with makeup credit | ‚úó Unexcused = Absent without makeup credit</p>
          <table><thead><tr><th>Student</th><th>Current Status</th><th>Action</th></tr></thead><tbody>` + students.map(s => {
            const statusClass = s.attendance === 'Present' ? 'att-badge-present' : s.attendance === 'Excused' ? 'att-badge-excused' : (s.attendance === 'Absent' || s.attendance === 'Unexcused') ? 'att-badge-absent' : 'att-badge-pending';
            const statusText = s.attendance === 'Present' ? 'Present' : s.attendance === 'Excused' ? 'Excused' : s.attendance === 'Unexcused' ? 'Unexcused' : s.attendance === 'Absent' ? 'Absent' : 'Pending';
            const presentBtnClass = s.attendance === 'Present' ? 'btn-att-active-present' : '';
            const excusedBtnClass = s.attendance === 'Excused' ? 'btn-att-active-excused' : '';
            const unexcusedBtnClass = (s.attendance === 'Absent' || s.attendance === 'Unexcused') ? 'btn-att-active-absent' : '';
            return `<tr id="att-row-${s.student_id}"><td>${s.student_name}</td><td id="att-status-${s.student_id}"><span class="att-badge ${statusClass}">${statusText}</span></td><td>
              <button onclick="saveGroupAttendance(${sessionId}, ${s.student_id}, 'Present', '${s.student_name}')" class="btn btn-sm btn-success ${presentBtnClass}">‚úì Present</button>
              <button onclick="saveGroupAttendance(${sessionId}, ${s.student_id}, 'Excused', '${s.student_name}')" class="btn btn-sm" style="background:#dd6b20; color:white; ${excusedBtnClass}" title="Absent with makeup credit">‚ö†Ô∏è Excused</button>
              <button onclick="saveGroupAttendance(${sessionId}, ${s.student_id}, 'Unexcused', '${s.student_name}')" class="btn btn-sm btn-danger ${unexcusedBtnClass}" title="Absent without makeup credit">‚úó Unexcused</button>
            </td></tr>`;
          }).join('') + `</tbody></table>`;
        }

        document.getElementById('sessionDetailsContent').innerHTML = content;
        document.getElementById('sessionModal').classList.add('active');
        // Load materials list (must be called after innerHTML since inline scripts don't execute)
        loadSessionMaterials(sessionId);
      } catch(err) {
        alert('Error loading session: ' + err.message);
      }
    }

    async function saveGroupAttendance(sessionId, studentId, status, studentName) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/group-attendance`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ attendanceData: [{ student_id: studentId, attendance: status }] })
        });
        if(res.ok) {
          // Update UI immediately using CSS classes
          const statusCell = document.getElementById(`att-status-${studentId}`);
          if (statusCell) {
            const badgeClass = status === 'Present' ? 'att-badge-present' : status === 'Excused' ? 'att-badge-excused' : 'att-badge-absent';
            statusCell.innerHTML = `<span class="att-badge ${badgeClass}">${status}</span>`;
          }
          const emoji = status === 'Present' ? '‚úÖ' : status === 'Excused' ? '‚ö†Ô∏è' : '‚ùå';
          const extraMsg = status === 'Excused' ? ' (makeup credit granted)' : status === 'Unexcused' ? ' (no makeup credit)' : '';
          alert(`${emoji} ${studentName} marked as ${status}${extraMsg}`);
        } else {
          const err = await res.json();
          alert('‚ùå Failed: ' + (err.error || 'Unknown error'));
        }
      } catch(e) {
        alert('‚ùå Error: ' + e.message);
      }
    }

    function closeSessionModal() {
      document.getElementById('sessionModal').classList.remove('active');
    }

    // ==================== RESCHEDULE FUNCTIONS ====================
    function openRescheduleModal() {
      const session = window.currentRescheduleSession;
      if (!session) {
        alert('No session selected');
        return;
      }

      document.getElementById('rescheduleSessionId').value = session.id;

      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('rescheduleDate').min = today;

      // Format current date/time for display
      let currentDateTime = 'Unknown';
      try {
        const dateStr = session.current_date.includes('T') ? session.current_date.split('T')[0] : session.current_date;
        const d = new Date(dateStr + 'T' + session.current_time + 'Z');
        currentDateTime = d.toLocaleString('en-US', {
          timeZone: 'Asia/Kolkata',
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
      } catch (e) {
        currentDateTime = session.current_date + ' ' + session.current_time;
      }

      document.getElementById('rescheduleInfo').innerHTML =
        '<p style="margin: 0 0 8px 0;"><strong>Session:</strong> #' + session.session_number + ' (' + session.session_type + ')</p>' +
        '<p style="margin: 0 0 8px 0;"><strong>Student/Group:</strong> ' + session.student_name + '</p>' +
        '<p style="margin: 0; color: #e53e3e;"><strong>Current Schedule:</strong> ' + currentDateTime + '</p>';

      document.getElementById('rescheduleModal').classList.add('active');
    }

    function closeRescheduleModal() {
      document.getElementById('rescheduleModal').classList.remove('active');
      document.getElementById('rescheduleForm').reset();
    }

    document.getElementById('rescheduleForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const sessionId = document.getElementById('rescheduleSessionId').value;
      const newDate = document.getElementById('rescheduleDate').value;
      const newTime = document.getElementById('rescheduleTime').value;
      const reason = document.getElementById('rescheduleReason').value;

      if (!newDate || !newTime) {
        alert('Please select new date and time');
        return;
      }

      const confirmMsg = 'Are you sure you want to reschedule this class?\n\n' +
        'New Date: ' + newDate + '\n' +
        'New Time: ' + newTime + ' (IST)\n\n' +
        'Parents will be notified via email.';

      if (!confirm(confirmMsg)) return;

      try {
        const res = await fetch('/api/sessions/' + sessionId + '/reschedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            new_date: newDate,
            new_time: newTime,
            reason: reason
          })
        });

        const data = await res.json();

        if (res.ok) {
          alert('‚úÖ Class rescheduled successfully!\n\n' + data.students_notified + ' parent(s) notified via email.');
          closeRescheduleModal();
          closeSessionModal();
          // Refresh the calendar and upcoming classes
          loadStudents();
          loadUpcomingClasses();
          loadCalendar();
        } else {
          alert('‚ùå Failed to reschedule: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Reschedule error:', err);
        alert('‚ùå Error rescheduling class');
      }
    });

    // ==================== EDIT SESSION COUNTS ====================
    function openEditSessionsModal(studentId, studentName, total, completed, missed, remaining) {
      document.getElementById('editSessionsStudentId').value = studentId;
      document.getElementById('editSessionsStudentName').textContent = studentName;
      document.getElementById('editTotalSessions').value = total;
      document.getElementById('editCompletedSessions').value = completed;
      document.getElementById('editMissedSessions').value = missed || 0;
      document.getElementById('editRemainingSessions').value = remaining;
      document.getElementById('editSessionsReason').value = '';
      document.getElementById('editSessionsModal').classList.add('active');
    }

    function closeEditSessionsModal() {
      document.getElementById('editSessionsModal').classList.remove('active');
      document.getElementById('editSessionsForm').reset();
    }

    document.getElementById('editSessionsForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const studentId = document.getElementById('editSessionsStudentId').value;
      const total = parseInt(document.getElementById('editTotalSessions').value);
      const completed = parseInt(document.getElementById('editCompletedSessions').value);
      const missed = parseInt(document.getElementById('editMissedSessions').value);
      const remaining = parseInt(document.getElementById('editRemainingSessions').value);
      const reason = document.getElementById('editSessionsReason').value;

      // Validate: Total should equal Completed + Missed + Remaining
      if (completed + missed + remaining !== total) {
        if (!confirm('‚ö†Ô∏è Warning: Completed (' + completed + ') + Missed (' + missed + ') + Remaining (' + remaining + ') = ' + (completed + missed + remaining) + ', but Total is ' + total + '.\n\nAre you sure you want to save these values?')) {
          return;
        }
      }

      const confirmMsg = 'Update session counts?\n\n' +
        'Total: ' + total + '\n' +
        'Completed: ' + completed + '\n' +
        'Missed: ' + missed + '\n' +
        'Remaining: ' + remaining + '\n\n' +
        'Reason: ' + reason;

      if (!confirm(confirmMsg)) return;

      try {
        const res = await fetch('/api/students/' + studentId + '/fix-sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            total_sessions: total,
            completed_sessions: completed,
            missed_sessions: missed,
            remaining_sessions: remaining,
            reason: reason
          })
        });

        const data = await res.json();

        if (res.ok) {
          alert('‚úÖ Session counts updated successfully!');
          closeEditSessionsModal();
          // Update the display
          const statTotal = document.getElementById('statTotal-' + studentId);
          const statCompleted = document.getElementById('statCompleted-' + studentId);
          const statMissed = document.getElementById('statMissed-' + studentId);
          const statRemaining = document.getElementById('statRemaining-' + studentId);
          if (statTotal) statTotal.textContent = total;
          if (statCompleted) statCompleted.textContent = completed;
          if (statMissed) statMissed.textContent = missed;
          if (statRemaining) statRemaining.textContent = remaining;
          // Refresh student list
          loadStudents();
        } else {
          alert('‚ùå Failed to update: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Edit sessions error:', err);
        alert('‚ùå Error updating session counts');
      }
    });

    async function loadGroups() {
      try {
        const res = await fetch('/api/groups');
        allGroups = await res.json();
        document.getElementById('groupsBody').innerHTML = allGroups.map(g => `<tr><td><strong>${g.group_name}</strong></td><td>${g.program_name}</td><td>${g.duration}</td><td>${g.enrolled_students||0}</td><td>${g.max_students}</td><td><button onclick="viewGroupDetails(${g.id})" class="btn btn-sm btn-primary">View</button> <button onclick="editGroup(${g.id})" class="btn btn-sm btn-warning">Edit</button> <button onclick="openEnrollModal(${g.id})" class="btn btn-sm btn-success">Enroll</button> <button onclick="deleteGroup(${g.id})" class="btn btn-sm btn-danger">Delete</button></td></tr>`).join('');
        document.getElementById('scheduleGroup').innerHTML = '<option value="">Select group...</option>' + allGroups.map(g => `<option value="${g.id}">${g.group_name}</option>`).join('');
      } catch(e) {
        console.error(e);
      }
    }

    async function openEnrollModal(groupId) {
      currentGroupId = groupId;
      const group = allGroups.find(g => g.id === groupId);
      document.getElementById('enrollModalTitle').textContent = `Enroll Students in ${group.group_name}`;

      try {
        const availableStudents = allStudents.filter(s => !s.group_id || s.group_id !== groupId);
        const enrolledRes = await fetch(`/api/groups/${groupId}/students`);
        const enrolledStudents = await enrolledRes.json();

        let content = `<h3>Currently Enrolled (${enrolledStudents.length}/${group.max_students})</h3>`;
        if (enrolledStudents.length > 0) {
          content += `<ul style="list-style: none; padding: 0;">` + enrolledStudents.map(s => `<li style="padding: 10px; background: #f7fafc; margin-bottom: 5px; border-radius: 5px;">üë§ ${s.name} (${getAgeDisplay(s)})</li>`).join('') + `</ul>`;
        } else {
          content += `<p style="color: #718096;">No students enrolled yet</p>`;
        }

        content += `<h3 style="margin-top: 20px;">Available Students</h3>`;
        if (availableStudents.length > 0) {
          content += `<div style="max-height: 300px; overflow-y: auto;">` + availableStudents.map(s => `
            <div style="padding: 10px; background: #f7fafc; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
              <span>üë§ ${s.name} (${getAgeDisplay(s)}) - ${s.program_name}</span>
              <button onclick="enrollStudent(${groupId}, ${s.id})" class="btn btn-sm btn-success">Enroll</button>
            </div>
          `).join('') + `</div>`;
        } else {
          content += `<p style="color: #718096;">No available students</p>`;
        }

        document.getElementById('enrollModalContent').innerHTML = content;
        document.getElementById('enrollModal').classList.add('active');
      } catch(err) {
        alert('Error loading enrollment data: ' + err.message);
      }
    }

    async function enrollStudent(groupId, studentId) {
      try {
        const res = await fetch(`/api/groups/${groupId}/enroll`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ student_id: studentId })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          await loadStudents();
          await loadGroups();
          openEnrollModal(groupId);
        } else {
          alert('‚ùå ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    function closeEnrollModal() {
      document.getElementById('enrollModal').classList.remove('active');
    }

    function deleteGroup(id) {
      if(confirm('Delete group? This will remove all group sessions.')) {
        fetch(`/api/groups/${id}`, {method:'DELETE'}).then(()=>loadGroups());
      }
    }

    async function openStudentModal(id) {
      currentStudentId = id;
      const student = allStudents.find(s => s.id == id);
      if (!student) return alert('Student not found');

      document.getElementById('modalStudentName').textContent = student.name;

      const infoHTML = `
        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #B05D9E; margin-bottom: 15px;">Basic Information</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><strong>Name:</strong> ${student.name}</div>
            <div><strong>Age:</strong> ${getAgeDisplay(student)}</div>
            <div><strong>Parent:</strong> ${student.parent_name}</div>
            <div><strong>Email:</strong> ${student.parent_email}</div>
            <div><strong>Contact:</strong> ${student.primary_contact || 'N/A'}</div>
            <div><strong>Timezone:</strong> ${student.timezone}</div>
          </div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #B05D9E; margin-bottom: 15px;">Program Details</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><strong>Program:</strong> ${student.program_name}</div>
            <div><strong>Type:</strong> ${student.class_type}</div>
            <div><strong>Duration:</strong> ${student.duration}</div>
            <div><strong>Fee per Session:</strong> ${student.currency} ${student.per_session_fee}</div>
          </div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: #B05D9E; margin: 0;">Session Statistics</h3>
            <button onclick="openEditSessionsModal(${student.id}, '${student.name}', ${student.total_sessions}, ${student.completed_sessions}, ${student.missed_sessions || 0}, ${student.remaining_sessions})" class="btn btn-sm" style="background: #e53e3e; color: white;">‚úèÔ∏è Fix Sessions</button>
          </div>
          <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;">
            <div><strong>Total:</strong> <span id="statTotal-${student.id}">${student.total_sessions}</span></div>
            <div><strong>Completed:</strong> <span id="statCompleted-${student.id}" class="status-active">${student.completed_sessions}</span></div>
            <div><strong>Missed:</strong> <span id="statMissed-${student.id}" style="color: #e53e3e;">${student.missed_sessions || 0}</span></div>
            <div><strong>Remaining:</strong> <span id="statRemaining-${student.id}" style="color: #dd6b20;">${student.remaining_sessions}</span></div>
            <div><strong>Makeup:</strong> <span style="color: #9f7aea; font-weight: bold;">${student.makeup_credits || 0}</span></div>
          </div>
        </div>

        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: white; margin: 0;">üéÅ Makeup Credits</h3>
            <button onclick="openAddMakeupCreditModal(${student.id}, '${student.name}')" class="btn btn-sm" style="background: white; color: #f093fb; font-weight: bold;">+ Add Credit</button>
          </div>
          <div id="makeupCreditsContainer-${student.id}" style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px;">
            <p style="text-align: center; margin: 0;">Loading makeup credits...</p>
          </div>
        </div>

       <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
  <h3 style="color: #B05D9E; margin-bottom: 15px;">Financial Summary</h3>
  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: center;">
    <div><strong>Total Paid:</strong> <span id="studentTotalPaid">${student.currency} ${student.fees_paid || 0}</span></div>
    <div><strong>Status:</strong> <span class="${student.is_active ? 'status-active' : 'status-inactive'}">${student.is_active ? 'Active' : 'Inactive'}</span></div>
    <div><button onclick="openEditPaymentModal(${student.id}, '${student.currency}', ${student.fees_paid || 0}, ${student.total_sessions})" class="btn btn-sm" style="background: #667eea; color: white;">‚úèÔ∏è Edit Payment</button></div>
  </div>
</div>

<div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 8px;">
  <h3 style="color: #2d3748; margin-bottom: 15px;">üí≠ Parent Expectations <span style="font-size: 0.75rem; color: #718096;">(Optional)</span></h3>
  <div id="parentExpectationsDisplay">Loading...</div>
</div>
      `;

      document.getElementById('studentInfoContent').innerHTML = infoHTML;

      // Reset modal tabs to Info tab
      document.querySelectorAll('.modal-tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
      document.getElementById('modalInfoTab').classList.add('active');
      document.querySelector('.modal-tab').classList.add('active');

      // Load parent expectations and makeup credits
      loadParentExpectations(id);
      loadStudentMakeupCredits(id);
      document.getElementById('studentModal').classList.add('active');
    }

    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('active');
    }

    async function loadParentExpectations(studentId) {
      const container = document.getElementById('parentExpectationsDisplay');
      try {
        const res = await fetch(`/api/students/${studentId}/expectations`);
        const data = await res.json();
        const expectations = data.expectations || '';

        container.innerHTML = `
          <textarea id="expectationsText" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; resize: vertical;" placeholder="Parents can share their expectations and goals for their child here...">${expectations}</textarea>
          <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button onclick="saveParentExpectations(${studentId})" class="btn btn-sm" style="background: #38a169; color: white;">üíæ Save</button>
            <span id="expectationsSaveStatus" style="color: #718096; font-size: 0.85rem; align-self: center;"></span>
          </div>
        `;
      } catch (err) {
        container.innerHTML = '<p style="color: #e53e3e;">Error loading expectations</p>';
      }
    }

    async function saveParentExpectations(studentId) {
      const expectations = document.getElementById('expectationsText').value;
      const statusEl = document.getElementById('expectationsSaveStatus');

      try {
        const res = await fetch(`/api/students/${studentId}/expectations`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ expectations })
        });
        if (res.ok) {
          statusEl.textContent = '‚úÖ Saved!';
          statusEl.style.color = '#38a169';
          setTimeout(() => { statusEl.textContent = ''; }, 2000);
        } else {
          statusEl.textContent = '‚ùå Error saving';
          statusEl.style.color = '#e53e3e';
        }
      } catch (err) {
        statusEl.textContent = '‚ùå Error saving';
        statusEl.style.color = '#e53e3e';
      }
    }

    // Edit Payment Functions
function openEditPaymentModal(studentId, currency, amount, totalSessions) {
  document.getElementById('editPaymentStudentId').value = studentId;
  document.getElementById('editPaymentCurrency').value = currency || 'INR';
  document.getElementById('editPaymentAmount').value = amount || 0;
  document.getElementById('editPaymentSessions').value = totalSessions || 0;
  document.getElementById('editPaymentReason').value = '';
  document.getElementById('editPaymentModal').classList.add('active');
}

function closeEditPaymentModal() {
  document.getElementById('editPaymentModal').classList.remove('active');
}

async function saveEditedPayment() {
  const studentId = document.getElementById('editPaymentStudentId').value;
  const currency = document.getElementById('editPaymentCurrency').value;
  const amount = document.getElementById('editPaymentAmount').value;
  const totalSessions = document.getElementById('editPaymentSessions').value;
  const reason = document.getElementById('editPaymentReason').value;

  if (!amount || amount < 0) return alert('Please enter a valid amount');
  if (!totalSessions || totalSessions < 0) return alert('Please enter valid total sessions');

  if (!confirm(`Are you sure you want to update the payment to ${currency} ${amount} and total sessions to ${totalSessions}?`)) {
    return;
  }

  try {
    const res = await fetch(`/api/students/${studentId}/update-payment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        fees_paid: parseFloat(amount),
        currency: currency,
        total_sessions: parseInt(totalSessions),
        reason: reason
      })
    });
    const result = await res.json();
    if (res.ok) {
      alert('‚úÖ Payment updated successfully!');
      closeEditPaymentModal();
      closeStudentModal();
      loadStudents();
      loadDashboardStats();
    } else {
      alert('‚ùå Failed: ' + result.error);
    }
  } catch (err) {
    alert('‚ùå Error: ' + err.message);
  }
}

    

    function handleScheduleTypeChange() {
      const type = document.getElementById('scheduleType').value;
      document.getElementById('schedulePrivateForm').style.display = type === 'private' ? 'block' : 'none';
      document.getElementById('scheduleGroupForm').style.display = type === 'group' ? 'block' : 'none';
      if(type==='group' && document.getElementById('groupClassScheduleList').children.length===0) addGroupScheduleRow();
    }

    function addGroupScheduleRow() {
      const container = document.getElementById('groupClassScheduleList');
      const row = document.createElement('div');
      row.className = 'schedule-row';
      row.innerHTML = `<input type="date" name="date" required><input type="time" name="time" required><button type="button" onclick="this.parentElement.remove()" class="btn btn-sm btn-danger">√ó</button>`;
      container.appendChild(row);
    }

    // When group is selected, load students and show per-student session count inputs
    document.getElementById('scheduleGroup').addEventListener('change', async function() {
      const groupId = this.value;
      const container = document.getElementById('groupStudentSessionCounts');
      const inputsDiv = document.getElementById('studentSessionInputs');
      const numSessionsEl = document.getElementById('groupBulkNumSessions');

      if (!groupId) {
        container.style.display = 'none';
        inputsDiv.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`/api/groups/${groupId}/students`);
        const students = await res.json();

        if (students.length === 0) {
          container.style.display = 'none';
          inputsDiv.innerHTML = '';
          return;
        }

        inputsDiv.innerHTML = students.map(s => {
          const makeupCount = parseInt(s.makeup_credits) || 0;
          return `
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0; flex-wrap: wrap;">
            <span style="flex: 1; font-weight: 500; min-width: 120px;">üë§ ${s.name}</span>
            <span style="color: #718096; font-size: 0.85rem;">Remaining: ${s.remaining_sessions || 0}</span>
            <label style="font-size: 0.8rem; color: #4a5568;">Sessions:</label>
            <input type="number" class="student-session-count" data-student-id="${s.id}"
              value="${s.remaining_sessions || 0}" min="0" max="100"
              style="width: 60px; padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; text-align: center;"
              onchange="updateGroupMaxSessions()">
            ${makeupCount > 0 ? `
            <span style="color: #6b46c1; font-size: 0.8rem; font-weight: 600;">üé´ Makeup: ${makeupCount}</span>
            <label style="font-size: 0.8rem; color: #6b46c1;">Use:</label>
            <input type="number" class="student-makeup-count" data-student-id="${s.id}"
              value="0" min="0" max="${makeupCount}"
              style="width: 50px; padding: 4px 8px; border: 1px solid #9f7aea; border-radius: 4px; text-align: center; color: #6b46c1;"
              onchange="updateGroupMaxSessions()">
            ` : ''}
          </div>`;
        }).join('');
        container.style.display = 'block';

        // Check if any students have pending private sessions - show convert button
        const convertBtn = document.getElementById('convertPrivateBtn');
        let hasPrivate = false;
        for (const s of students) {
          const sessRes = await fetch(`/api/sessions/${s.id}`);
          const sessData = await sessRes.json();
          if (sessData.some && sessData.some(sess => sess.session_type === 'Private' && (sess.status === 'Pending' || sess.status === 'Scheduled'))) {
            hasPrivate = true;
            break;
          }
        }
        convertBtn.style.display = hasPrivate ? 'inline-block' : 'none';

        // Auto-set the number of sessions to the max of all student counts
        updateGroupMaxSessions();
      } catch (err) {
        console.error('Error loading group students:', err);
      }
    });

    // Update the bulk session count to the max of all per-student counts
    function updateGroupMaxSessions() {
      const inputs = document.querySelectorAll('.student-session-count');
      if (inputs.length === 0) return;
      let max = 0;
      inputs.forEach(inp => {
        const studentId = inp.dataset.studentId;
        const sessionCount = parseInt(inp.value) || 0;
        const makeupInp = document.querySelector(`.student-makeup-count[data-student-id="${studentId}"]`);
        const makeupCount = makeupInp ? (parseInt(makeupInp.value) || 0) : 0;
        const total = sessionCount + makeupCount;
        if (total > max) max = total;
      });
      const numSessionsEl = document.getElementById('groupBulkNumSessions');
      if (max > 0) numSessionsEl.value = max;
    }

    // Convert existing private sessions to group sessions
    async function convertPrivateToGroup() {
      const groupId = document.getElementById('scheduleGroup').value;
      if (!groupId) return alert('Select a group first');

      if (!confirm('This will convert all pending private sessions of students in this group into group sessions. Sessions at the same date & time will be merged. Continue?')) return;

      try {
        const res = await fetch(`/api/groups/${groupId}/convert-private-sessions`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        const result = await res.json();
        if (res.ok) {
          alert('‚úÖ ' + result.message);
          document.getElementById('convertPrivateBtn').style.display = 'none';
          loadUpcomingClasses();
          loadCalendar();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    document.getElementById('scheduleGroupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const groupId = document.getElementById('scheduleGroup').value;
      if (!groupId) return alert('Select a group');
      const rows = document.querySelectorAll('#groupClassScheduleList .schedule-row');
      const classes = [];
      rows.forEach(row => {
        const date = row.querySelector('input[name="date"]').value;
        const time = row.querySelector('input[name="time"]').value;
        if (date && time) classes.push({ date, time });
      });
      if (classes.length === 0) return alert('Add at least one class');
      const sendEmail = document.getElementById('sendGroupScheduleEmail').checked;

      // Collect per-student session counts and makeup counts
      const studentInputs = document.querySelectorAll('.student-session-count');
      let student_sessions = [];
      if (studentInputs.length > 0) {
        studentInputs.forEach(inp => {
          const studentId = parseInt(inp.dataset.studentId);
          const count = parseInt(inp.value) || 0;
          const makeupInp = document.querySelector(`.student-makeup-count[data-student-id="${studentId}"]`);
          const makeup_count = makeupInp ? (parseInt(makeupInp.value) || 0) : 0;
          if (count > 0 || makeup_count > 0) {
            student_sessions.push({ student_id: studentId, count: count + makeup_count, makeup_count });
          }
        });
      }

      try {
        const body = { group_id: groupId, classes, send_email: sendEmail };
        if (student_sessions.length > 0) body.student_sessions = student_sessions;

        const res = await fetch('/api/schedule/group-classes', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          e.target.reset();
          document.getElementById('groupClassScheduleList').innerHTML = '';
          document.getElementById('groupStudentSessionCounts').style.display = 'none';
          document.getElementById('studentSessionInputs').innerHTML = '';
          loadUpcomingClasses();
          loadCalendar(); // Refresh calendar with new sessions
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    function uploadMaterial(id, type) {
      const inp = document.getElementById(type==='ppt'?'pptFile':type==='recording'?'recFile':'hwFile');
      if(inp.files[0]) {
        const fd=new FormData();
        fd.append('file', inp.files[0]);
        fd.append('materialType', type);
        fetch(`/api/sessions/${id}/upload`, {method:'POST', body:fd})
          .then(r => r.json().then(data => ({ok: r.ok, data})))
          .then(({ok, data}) => {
            if (ok) {
              alert('‚úÖ ' + (data.message || 'Material uploaded successfully!'));
              inp.value = '';
              loadSessionMaterials(id);
              // Refresh the modal to show updated view links
              openSessionModal(id, window.currentRescheduleSession?.session_type || 'Private');
            } else {
              alert('‚ùå Upload failed: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(err => alert('‚ùå Upload failed: ' + err.message));
      } else {
        alert('Please select a file first');
      }
    }

    // Load all materials for a session
    async function loadSessionMaterials(sessionId) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/materials`);
        const materials = await res.json();
        const container = document.getElementById('materialFilesContainer');

        if (!materials || materials.length === 0) {
          container.innerHTML = '<p style="color:#718096; text-align:center; padding:10px;">No files uploaded yet. Upload using the form above.</p>';
          return;
        }

        const typeIcons = { 'PPT': 'üìä', 'RECORDING': 'üé•', 'HOMEWORK': 'üìù' };
        const typeClasses = { 'PPT': 'mat-badge-ppt', 'RECORDING': 'mat-badge-recording', 'HOMEWORK': 'mat-badge-homework' };

        container.innerHTML = materials.map(m => {
          const icon = typeIcons[m.material_type] || 'üìÑ';
          const badgeClass = typeClasses[m.material_type] || 'mat-badge-other';
          const filePath = m.file_path || '';
          const fileName = m.file_name || filePath.split('/').pop() || 'Unknown file';
          const isLink = filePath.startsWith('http');

          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:10px; border-bottom:1px solid #e2e8f0; gap:10px;">
              <div style="display:flex; align-items:center; gap:10px; flex:1; min-width:0;">
                <span style="font-size:1.2rem;">${icon}</span>
                <div style="min-width:0;">
                  <span class="mat-badge ${badgeClass}">${m.material_type}</span>
                  <div style="font-size:0.9rem; color:#2d3748; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${fileName}">${fileName}</div>
                  <div style="font-size:0.75rem; color:#a0aec0;">${new Date(m.uploaded_at).toLocaleDateString()}</div>
                </div>
              </div>
              <div style="display:flex; gap:5px;">
                <a href="${filePath || '#'}" target="_blank" class="btn btn-sm" style="background:#38b2ac; color:white; text-decoration:none;">View</a>
                <button onclick="deleteSessionMaterial(${m.id}, ${sessionId})" class="btn btn-sm" style="background:#e53e3e; color:white;">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading session materials:', err);
        document.getElementById('materialFilesContainer').innerHTML = '<p style="color:#e53e3e; text-align:center;">Error loading materials</p>';
      }
    }

    // Delete a session material
    async function deleteSessionMaterial(materialId, sessionId) {
      if (!confirm('Delete this file?')) return;
      try {
        const res = await fetch(`/api/session-materials/${materialId}`, { method: 'DELETE' });
        if (res.ok) {
          loadSessionMaterials(sessionId);
        } else {
          alert('‚ùå Failed to delete');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // ==================== CALENDAR ====================
    let calendarDate = new Date();
    let calendarSessions = [];

    async function loadCalendar() {
      try {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();

        // Update header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;

        // Fetch all sessions for this month
        // Use local date formatting to avoid timezone issues with toISOString()
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
        const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

        const res = await fetch(`/api/calendar/sessions?start=${startDate}&end=${endDate}`);
        calendarSessions = await res.json();

        renderCalendar();
      } catch (err) {
        console.error('Error loading calendar:', err);
      }
    }

    // Convert UTC time to IST (UTC+5:30)
    function utcToIST(timeStr) {
      if (!timeStr) return '';
      try {
        const [hours, minutes] = timeStr.split(':').map(Number);
        let istHours = hours + 5;
        let istMinutes = minutes + 30;

        if (istMinutes >= 60) {
          istMinutes -= 60;
          istHours += 1;
        }
        if (istHours >= 24) {
          istHours -= 24;
        }

        return `${String(istHours).padStart(2, '0')}:${String(istMinutes).padStart(2, '0')}`;
      } catch (e) {
        return timeStr.substring(0, 5);
      }
    }

    function renderCalendar() {
      const year = calendarDate.getFullYear();
      const month = calendarDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date().toISOString().split('T')[0];

      const container = document.getElementById('calendarDays');
      container.innerHTML = '';

      // Empty cells for days before first day
      for (let i = 0; i < firstDay; i++) {
        container.innerHTML += '<div style="background: #f7fafc; padding: 10px; min-height: 100px;"></div>';
      }

      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const daySessions = calendarSessions.filter(s => {
          const sessionDate = s.session_date.includes('T') ? s.session_date.split('T')[0] : s.session_date;
          return sessionDate === dateStr;
        });

        // Sort sessions by time
        daySessions.sort((a, b) => {
          const timeToMinutes = (t) => {
            if (!t) return 0;
            const parts = t.toString().split(':');
            return parseInt(parts[0] || 0) * 60 + parseInt(parts[1] || 0);
          };
          return timeToMinutes(a.session_time) - timeToMinutes(b.session_time);
        });

        let sessionsHtml = '';
        daySessions.slice(0, 4).forEach(s => {
          let bgColor = '#38a169'; // Paid - green
          let label = s.student_name || 'Session';

          if (s.session_type === 'Demo') {
            bgColor = '#f6ad55'; // Demo - orange
          } else if (s.session_type === 'Group') {
            bgColor = '#667eea'; // Group - purple
          }

          // Convert to IST time display
          const time = s.session_time ? utcToIST(s.session_time) : '';

          sessionsHtml += `<div style="background: ${bgColor}; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${label} - ${time} IST">${time} ${label.split(' ')[0]}</div>`;
        });

        if (daySessions.length > 4) {
          sessionsHtml += `<div style="color: #718096; font-size: 0.7rem;">+${daySessions.length - 4} more</div>`;
        }

        const todayStyle = isToday ? 'border: 2px solid #B05D9E;' : '';
        const hasSessionsStyle = daySessions.length > 0 ? 'cursor: pointer;' : '';

        container.innerHTML += `
          <div onclick="${daySessions.length > 0 ? `showDayDetails('${dateStr}')` : ''}" style="background: white; padding: 8px; min-height: 100px; ${todayStyle} ${hasSessionsStyle}">
            <div style="font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isToday ? '#B05D9E' : '#2d3748'}; margin-bottom: 5px;">${day}</div>
            ${sessionsHtml}
          </div>
        `;
      }
    }

    function changeCalendarMonth(delta) {
      calendarDate.setMonth(calendarDate.getMonth() + delta);
      loadCalendar();
    }

    function showDayDetails(dateStr) {
      const daySessions = calendarSessions.filter(s => {
        const sessionDate = s.session_date.includes('T') ? s.session_date.split('T')[0] : s.session_date;
        return sessionDate === dateStr;
      });

      const dateObj = new Date(dateStr + 'T00:00:00');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('dayDetailsTitle').textContent = dateObj.toLocaleDateString('en-US', options);

      if (daySessions.length === 0) {
        document.getElementById('dayDetailsContent').innerHTML = '<p style="color: #718096; text-align: center;">No sessions scheduled</p>';
      } else {
        // Sort by time (convert to minutes for proper numeric sorting)
        daySessions.sort((a, b) => {
          const timeToMinutes = (t) => {
            if (!t) return 0;
            const parts = t.toString().split(':');
            return parseInt(parts[0] || 0) * 60 + parseInt(parts[1] || 0);
          };
          return timeToMinutes(a.session_time) - timeToMinutes(b.session_time);
        });

        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
        daySessions.forEach(s => {
          let bgColor = '#38a169';
          let typeLabel = 'Paid';

          if (s.session_type === 'Demo') {
            bgColor = '#f6ad55';
            typeLabel = 'Demo';
          } else if (s.session_type === 'Group') {
            bgColor = '#667eea';
            typeLabel = 'Group';
          }

          const time = s.session_time ? utcToIST(s.session_time) : 'N/A';

          html += `
            <div style="background: #f7fafc; padding: 12px; border-radius: 8px; border-left: 4px solid ${bgColor};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <strong style="color: #2d3748;">${s.student_name || 'Session'}</strong>
                <span style="background: ${bgColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">${typeLabel}</span>
              </div>
              <div style="color: #718096; font-size: 0.9rem;">
                üïê <strong>${time} IST</strong> ‚Ä¢ Session #${s.session_number || 'N/A'}
              </div>
              ${s.status ? `<div style="color: #718096; font-size: 0.85rem; margin-top: 5px;">Status: ${s.status}</div>` : ''}
            </div>
          `;
        });
        html += '</div>';
        document.getElementById('dayDetailsContent').innerHTML = html;
      }

      document.getElementById('dayDetailsModal').style.display = 'flex';
    }

    function closeDayDetails() {
      document.getElementById('dayDetailsModal').style.display = 'none';
    }

    // ==================== WHITEBOARD ====================
    let wbCanvas, wbCtx;
    let wbIsDrawing = false;
    let wbTool = 'pen';
    let wbColor = '#000000';
    let wbBrushSize = 3;
    let wbLastX = 0, wbLastY = 0;
    let wbHistory = [];
    let wbHistoryIndex = -1;
    let wbTextMode = false;

    function initWhiteboard() {
      wbCanvas = document.getElementById('whiteboardCanvas');
      if (!wbCanvas) return;

      wbCtx = wbCanvas.getContext('2d');
      resizeWhiteboard();

      // Mouse events
      wbCanvas.addEventListener('mousedown', wbStartDrawing);
      wbCanvas.addEventListener('mousemove', wbDraw);
      wbCanvas.addEventListener('mouseup', wbStopDrawing);
      wbCanvas.addEventListener('mouseout', wbStopDrawing);

      // Touch events for tablets
      wbCanvas.addEventListener('touchstart', wbTouchStart);
      wbCanvas.addEventListener('touchmove', wbTouchMove);
      wbCanvas.addEventListener('touchend', wbStopDrawing);

      // Click for text tool
      wbCanvas.addEventListener('click', wbHandleClick);

      // Initial state
      clearWhiteboard();

      // Resize on window resize
      window.addEventListener('resize', resizeWhiteboard);
    }

    function resizeWhiteboard() {
      if (!wbCanvas) return;
      const container = document.getElementById('whiteboardContainer');
      if (!container) return;

      const savedImage = wbCanvas.toDataURL();
      const width = container.clientWidth;
      const height = container.clientHeight || Math.max(400, window.innerHeight - 250);

      wbCanvas.width = width;
      wbCanvas.height = height;

      // Restore drawing after resize
      if (savedImage && wbHistoryIndex >= 0) {
        const img = new Image();
        img.onload = () => {
          wbCtx.fillStyle = 'white';
          wbCtx.fillRect(0, 0, wbCanvas.width, wbCanvas.height);
          wbCtx.drawImage(img, 0, 0);
        };
        img.src = savedImage;
      } else {
        wbCtx.fillStyle = 'white';
        wbCtx.fillRect(0, 0, wbCanvas.width, wbCanvas.height);
      }
    }

    function wbStartDrawing(e) {
      if (wbTool === 'text') return;
      wbIsDrawing = true;
      const rect = wbCanvas.getBoundingClientRect();
      wbLastX = e.clientX - rect.left;
      wbLastY = e.clientY - rect.top;
    }

    function wbTouchStart(e) {
      e.preventDefault();
      if (wbTool === 'text') return;
      wbIsDrawing = true;
      const rect = wbCanvas.getBoundingClientRect();
      const touch = e.touches[0];
      wbLastX = touch.clientX - rect.left;
      wbLastY = touch.clientY - rect.top;
    }

    function wbDraw(e) {
      if (!wbIsDrawing) return;

      const rect = wbCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      wbDrawLine(wbLastX, wbLastY, x, y);
      wbLastX = x;
      wbLastY = y;
    }

    function wbTouchMove(e) {
      e.preventDefault();
      if (!wbIsDrawing) return;

      const rect = wbCanvas.getBoundingClientRect();
      const touch = e.touches[0];
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;

      wbDrawLine(wbLastX, wbLastY, x, y);
      wbLastX = x;
      wbLastY = y;
    }

    function wbDrawLine(x1, y1, x2, y2) {
      wbCtx.beginPath();
      wbCtx.moveTo(x1, y1);
      wbCtx.lineTo(x2, y2);

      if (wbTool === 'eraser') {
        wbCtx.strokeStyle = 'white';
        wbCtx.lineWidth = wbBrushSize * 3;
        wbCtx.lineCap = 'round';
        wbCtx.lineJoin = 'round';
      } else if (wbTool === 'highlighter') {
        wbCtx.strokeStyle = wbColor + '40'; // 25% opacity
        wbCtx.lineWidth = wbBrushSize * 4;
        wbCtx.lineCap = 'round';
        wbCtx.lineJoin = 'round';
      } else if (wbTool === 'pencil') {
        wbCtx.strokeStyle = wbColor;
        wbCtx.lineWidth = Math.max(1, wbBrushSize * 0.5);
        wbCtx.lineCap = 'round';
        wbCtx.lineJoin = 'round';
      } else {
        // Pen
        wbCtx.strokeStyle = wbColor;
        wbCtx.lineWidth = wbBrushSize;
        wbCtx.lineCap = 'round';
        wbCtx.lineJoin = 'round';
      }

      wbCtx.stroke();
    }

    function wbStopDrawing() {
      if (wbIsDrawing) {
        wbIsDrawing = false;
        wbSaveState();
      }
    }

    function wbHandleClick(e) {
      if (wbTool !== 'text') return;

      const rect = wbCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const text = prompt('Enter text:');
      if (text) {
        wbCtx.font = `${Math.max(16, wbBrushSize * 5)}px Arial`;
        wbCtx.fillStyle = wbColor;
        wbCtx.fillText(text, x, y);
        wbSaveState();
      }
    }

    function wbSaveState() {
      // Remove any future states if we're not at the end
      wbHistory = wbHistory.slice(0, wbHistoryIndex + 1);

      // Save current state
      wbHistory.push(wbCanvas.toDataURL());
      wbHistoryIndex++;

      // Limit history to 50 states
      if (wbHistory.length > 50) {
        wbHistory.shift();
        wbHistoryIndex--;
      }
    }

    function setWhiteboardTool(tool) {
      wbTool = tool;

      // Update button states
      document.querySelectorAll('.wb-tool-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1))?.classList.add('active');

      // Update cursor
      if (tool === 'text') {
        wbCanvas.style.cursor = 'text';
      } else if (tool === 'eraser') {
        wbCanvas.style.cursor = 'cell';
      } else {
        wbCanvas.style.cursor = 'crosshair';
      }
    }

    function setWhiteboardColor(color) {
      wbColor = color;

      // Update button states
      document.querySelectorAll('.wb-color-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    function updateBrushSize(size) {
      wbBrushSize = parseInt(size);
      document.getElementById('brushSizeLabel').textContent = size + 'px';
    }

    function undoWhiteboard() {
      if (wbHistoryIndex > 0) {
        wbHistoryIndex--;
        const img = new Image();
        img.onload = () => {
          wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
          wbCtx.drawImage(img, 0, 0);
        };
        img.src = wbHistory[wbHistoryIndex];
      }
    }

    function redoWhiteboard() {
      if (wbHistoryIndex < wbHistory.length - 1) {
        wbHistoryIndex++;
        const img = new Image();
        img.onload = () => {
          wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
          wbCtx.drawImage(img, 0, 0);
        };
        img.src = wbHistory[wbHistoryIndex];
      }
    }

    function clearWhiteboard() {
      if (wbCtx) {
        wbCtx.fillStyle = 'white';
        wbCtx.fillRect(0, 0, wbCanvas.width, wbCanvas.height);
        wbSaveState();
      }
    }

    function downloadWhiteboard() {
      const link = document.createElement('a');
      link.download = 'whiteboard-' + new Date().toISOString().slice(0, 10) + '.png';
      link.href = wbCanvas.toDataURL('image/png');
      link.click();
    }

    // ==================== RESOURCE LIBRARY ====================
    function toggleResourceInput() {
      const type = document.getElementById('resourceType').value;
      document.getElementById('resourceLinkSection').style.display = type === 'link' ? 'block' : 'none';
      document.getElementById('resourceFileSection').style.display = type === 'file' ? 'block' : 'none';
    }

    async function loadResources() {
      try {
        const category = document.getElementById('filterResourceCategory')?.value || 'all';
        let url = '/api/resources';

        const res = await fetch(url);
        const resources = await res.json();

        // Filter by category if needed
        const filtered = category === 'all' ? resources : resources.filter(r => r.category === category);

        const container = document.getElementById('resourcesList');
        if (filtered.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 30px; grid-column: 1/-1;">No resources found. Add your first resource above!</p>';
          return;
        }

        container.innerHTML = filtered.map(r => {
          const typeIcon = getResourceIcon(r.category);
          const resourceUrl = r.external_link || r.file_path;
          const downloadUrl = getDownloadUrl(resourceUrl, r.title);
          const isFile = r.file_path && !r.external_link;
          const featuredBadge = r.is_featured ? '<span style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #333; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">‚≠ê FEATURED</span>' : '';
          const statusBadge = r.is_active
            ? '<span style="background: #38a169; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">Active</span>'
            : '<span style="background: #e53e3e; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">Hidden</span>';

          return '<div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;">' +
            '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; color: white;">' +
              '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                '<div style="font-size: 2rem;">' + typeIcon + '</div>' +
                '<div style="display: flex; gap: 5px; flex-wrap: wrap;">' + featuredBadge + ' ' + statusBadge + '</div>' +
              '</div>' +
              '<h4 style="margin: 10px 0 5px 0; font-size: 1.1rem;">' + (r.title || 'Untitled') + '</h4>' +
              '<span style="background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem;">' + r.category + '</span>' +
            '</div>' +
            '<div style="padding: 15px;">' +
              '<p style="color: #718096; font-size: 0.85rem; margin-bottom: 10px; min-height: 40px;">' + (r.description || 'No description') + '</p>' +
              '<div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">' +
                '<span style="background: #e2e8f0; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem;">' + (r.grade_level || 'All Grades') + '</span>' +
                '<span style="color: #718096; font-size: 0.75rem;">üëÅ ' + (r.view_count || 0) + ' views</span>' +
              '</div>' +
              '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
                '<a href="' + resourceUrl + '" target="_blank" class="btn btn-sm" style="background: #38a169; color: white; text-decoration: none;">üëÅ View</a>' +
                (isFile ? '<a href="' + downloadUrl + '" download class="btn btn-sm" style="background: #3182ce; color: white; text-decoration: none;">‚¨áÔ∏è Download</a>' : '') +
                '<button onclick="toggleResourceStatus(' + r.id + ', ' + !r.is_active + ')" class="btn btn-sm" style="background: ' + (r.is_active ? '#e53e3e' : '#38a169') + '; color: white;">' + (r.is_active ? 'üôà Hide' : 'üëÅ Show') + '</button>' +
                '<button onclick="deleteResource(' + r.id + ')" class="btn btn-sm" style="background: #718096; color: white;">üóëÔ∏è</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (err) {
        console.error('Error loading resources:', err);
        document.getElementById('resourcesList').innerHTML = '<p style="color: #e53e3e; text-align: center;">Error loading resources</p>';
      }
    }

    function getResourceIcon(category) {
      const icons = {
        'Videos': 'üé¨',
        'Worksheets': 'üìù',
        'PDFs': 'üìÑ',
        'Practice': '‚úèÔ∏è',
        'Games': 'üéÆ',
        'Stories': 'üìñ',
        'Other': 'üì¶'
      };
      return icons[category] || 'üìö';
    }

    // Helper to create proper download URL for Cloudinary files
    function getDownloadUrl(url, filename) {
      if (!url) return url;

      // For Cloudinary URLs, add fl_attachment transformation
      if (url.includes('cloudinary.com')) {
        try {
          const urlObj = new URL(url);
          const pathParts = urlObj.pathname.split('/');
          const uploadIndex = pathParts.indexOf('upload');

          if (uploadIndex !== -1) {
            // Get file extension from URL
            const lastPart = pathParts[pathParts.length - 1];
            const ext = lastPart.includes('.') ? '.' + lastPart.split('.').pop() : '.pdf';
            const safeFilename = (filename || 'download').replace(/[^a-zA-Z0-9]/g, '_') + ext;

            // Insert fl_attachment after 'upload' for forced download
            pathParts.splice(uploadIndex + 1, 0, 'fl_attachment:' + safeFilename);
            urlObj.pathname = pathParts.join('/');
            return urlObj.toString();
          }
        } catch (e) {
          console.error('Error creating download URL:', e);
        }
      }
      return url;
    }

    document.getElementById('addResourceForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const resourceType = document.getElementById('resourceType').value;
      let filePath = null;
      let externalLink = null;

      if (resourceType === 'link') {
        externalLink = document.getElementById('resourceLink').value;
        if (!externalLink) {
          alert('Please enter an external link');
          return;
        }
      } else if (resourceType === 'file') {
        const fileInput = document.getElementById('resourceFile');
        if (!fileInput.files[0]) {
          alert('Please select a file to upload');
          return;
        }

        // Upload file first
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('uploadType', 'materials');

        try {
          const uploadRes = await fetch('/api/resources/upload', {
            method: 'POST',
            body: formData
          });
          const uploadData = await uploadRes.json();
          if (!uploadRes.ok) throw new Error(uploadData.error);
          filePath = uploadData.filePath;
        } catch (err) {
          alert('Failed to upload file: ' + err.message);
          return;
        }
      }

      const data = {
        title: document.getElementById('resourceTitle').value,
        description: document.getElementById('resourceDescription').value,
        category: document.getElementById('resourceCategory').value,
        resource_type: resourceType,
        file_path: filePath,
        external_link: externalLink,
        grade_level: document.getElementById('resourceGrade').value,
        tags: document.getElementById('resourceTags').value,
        is_featured: document.getElementById('resourceFeatured').checked
      };

      try {
        const res = await fetch('/api/resources', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          alert('‚úÖ Resource added successfully!');
          e.target.reset();
          document.getElementById('resourceLinkSection').style.display = 'none';
          document.getElementById('resourceFileSection').style.display = 'none';
          loadResources();
        } else {
          alert('‚ùå Failed: ' + (result.error || 'Unknown error'));
        }
      } catch (err) {
        alert('‚ùå Error adding resource');
      }
    });

    async function toggleResourceStatus(id, newStatus) {
      try {
        const res = await fetch('/api/resources/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: newStatus })
        });
        if (res.ok) {
          loadResources();
        }
      } catch (err) {
        alert('Error updating resource');
      }
    }

    async function deleteResource(id) {
      if (!confirm('Are you sure you want to delete this resource?')) return;
      try {
        const res = await fetch('/api/resources/' + id, { method: 'DELETE' });
        if (res.ok) {
          alert('‚úÖ Resource deleted');
          loadResources();
        }
      } catch (err) {
        alert('Error deleting resource');
      }
    }

    // ==================== CLASS RATINGS ====================
    async function loadClassRatings() {
      try {
        const studentFilter = document.getElementById('ratingsStudentFilter').value;
        const ratingFilter = document.getElementById('ratingsRatingFilter').value;

        let url = '/api/class-feedback/all';
        const params = [];
        if (studentFilter) params.push(`student_id=${studentFilter}`);
        if (ratingFilter) params.push(`rating=${ratingFilter}`);
        if (params.length > 0) url += '?' + params.join('&');

        const res = await fetch(url);
        const data = await res.json();
        const container = document.getElementById('ratingsContainer');

        // Update stats
        document.getElementById('totalFeedbacks').textContent = data.total || 0;
        document.getElementById('avgRating').textContent = data.avgRating ? data.avgRating.toFixed(1) + ' ‚≠ê' : '-';
        document.getElementById('fiveStarCount').textContent = data.fiveStarCount || 0;

        // Populate student filter if not already done
        const filterSelect = document.getElementById('ratingsStudentFilter');
        if (filterSelect.options.length <= 1 && data.students) {
          data.students.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.name;
            filterSelect.appendChild(opt);
          });
        }

        if (!data.feedbacks || data.feedbacks.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 30px;">No feedback received yet. Parents can give feedback after their classes.</p>';
          return;
        }

        container.innerHTML = data.feedbacks.map(f => {
          const stars = '‚≠ê'.repeat(f.rating || 0) + '‚òÜ'.repeat(5 - (f.rating || 0));
          const date = f.created_at ? new Date(f.created_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';

          return `
            <div class="feedback-card ${f.rating >= 4 ? 'feedback-rating-high' : f.rating >= 3 ? 'feedback-rating-medium' : 'feedback-rating-low'}">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                <div>
                  <strong style="font-size: 1.1rem; color: #2d3748;">${f.student_name || 'Unknown Student'}</strong>
                  <p style="color: #718096; font-size: 0.85rem; margin: 5px 0;">Session #${f.session_number || 'N/A'} ‚Ä¢ ${date}</p>
                </div>
                <div style="font-size: 1.3rem;">${stars}</div>
              </div>
              ${f.feedback_text ? `<p style="margin-top: 12px; color: #4a5568; background: white; padding: 12px; border-radius: 8px; font-style: italic;">"${f.feedback_text}"</p>` : ''}
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading class ratings:', err);
        document.getElementById('ratingsContainer').innerHTML = '<p style="color: #e53e3e; text-align: center;">Error loading feedback</p>';
      }
    }

    async function saveMaterialLink(sessionId, type) {
      const inp = document.getElementById(type==='ppt'?'pptLink':type==='recording'?'recLink':'hwLink');
      const link = inp.value.trim();
      if(!link) {
        alert('Please enter a link first');
        return;
      }
      try {
        const res = await fetch(`/api/sessions/${sessionId}/save-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ materialType: type, link: link })
        });
        const data = await res.json();
        if(res.ok) {
          alert('‚úÖ Link saved successfully!');
          inp.value = '';
          loadSessionMaterials(sessionId);
          // Refresh modal to show updated view links
          openSessionModal(sessionId, window.currentRescheduleSession?.session_type || 'Private');
        } else {
          alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
        }
      } catch(err) {
        alert('‚ùå Error saving link');
      }
    }

    function loadEmailLogs() {
      fetch('/api/email-logs')
        .then(r=>r.json())
        .then(logs=>document.getElementById('emailLogsBody').innerHTML=logs.map((l, idx)=>{
          const isGroup = l.email_type && l.email_type.includes('-Group');
          const displayType = isGroup ? l.email_type.replace('-Group', '') : l.email_type;
          const badgeClass = isGroup ? 'email-badge-group' : 'email-badge-default';
          const typeBadge = isGroup
            ? `<span class="email-badge ${badgeClass}">${displayType} üë•</span>`
            : `<span class="email-badge ${badgeClass}">${displayType}</span>`;
          const statusClass = l.status === 'Sent' ? 'status-active' : 'status-inactive';
          const hasBody = l.email_body && l.email_body.length > 0;
          const expandBtn = hasBody ? `<span onclick="var el=document.getElementById('emailBody${idx}'); el.style.display=el.style.display==='none'?'table-row':'none'; this.textContent=el.style.display==='none'?'‚ñ∏':'‚ñæ';" style="cursor:pointer; margin-right:6px; font-size:14px;">‚ñ∏</span>` : '';
          return `<tr><td>${new Date(l.sent_at).toLocaleString()}</td><td>${l.recipient_name}<br><span style="font-size:11px;color:#718096;">${l.recipient_email}</span></td><td>${typeBadge}</td><td style="max-width:300px;">${expandBtn}${l.subject}</td><td><span class="${statusClass}">${l.status}</span></td></tr>` +
            (hasBody ? `<tr id="emailBody${idx}" style="display:none;"><td colspan="5" style="padding:0;"><div style="max-height:400px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px;margin:5px 10px 15px;background:white;">${l.email_body}</div></td></tr>` : '');
        }).join(''))
        .catch(err => console.error(err));
    }

    // Check for orphaned sessions count
    async function checkOrphanedCount() {
      try {
        const res = await fetch('/api/cleanup/orphaned-count');
        const data = await res.json();
        const countSpan = document.getElementById('orphanedCount');
        if (countSpan) {
          const count = data.orphanedSessions || 0;
          if (count > 0) {
            countSpan.innerHTML = `‚ö†Ô∏è Found <strong>${count}</strong> orphaned session(s) from deleted students`;
            countSpan.style.color = '#fef3c7';
          } else {
            countSpan.innerHTML = '‚úÖ No orphaned sessions found';
            countSpan.style.color = '#d1fae5';
          }
        }
      } catch (err) {
        console.error('Error checking orphaned count:', err);
        const countSpan = document.getElementById('orphanedCount');
        if (countSpan) {
          countSpan.innerHTML = '‚ùå Error checking';
        }
      }
    }

    // Cleanup orphaned sessions
    async function cleanupOrphanedSessions() {
      if (!confirm('Are you sure you want to remove all sessions from deleted students? This cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch('/api/cleanup/orphaned-sessions', {
          method: 'DELETE'
        });
        const data = await res.json();

        if (res.ok) {
          alert(`‚úÖ Successfully removed ${data.deletedCount} orphaned session(s)`);
          // Refresh the data
          checkOrphanedCount();
          loadPastSessions();
          loadCalendar();
        } else {
          alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Cleanup error:', err);
        alert('‚ùå Error cleaning up sessions: ' + err.message);
      }
    }

    // Search sessions by student name
    async function searchSessionsByName() {
      const nameInput = document.getElementById('sessionSearchName');
      const name = nameInput.value.trim();
      if (!name) {
        alert('Please enter a student name to search');
        return;
      }

      try {
        const res = await fetch(`/api/sessions/search-by-name?name=${encodeURIComponent(name)}`);
        const data = await res.json();
        const resultsDiv = document.getElementById('sessionSearchResults');
        const listDiv = document.getElementById('sessionSearchList');

        if (data.sessions && data.sessions.length > 0) {
          resultsDiv.style.display = 'block';
          listDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <span style="color: white; font-weight: bold;">Found ${data.sessions.length} session(s) matching "${name}"</span>
              <button onclick="deleteAllSearchedSessions()" class="btn" style="background: #fef2f2; color: #dc2626; font-weight: bold; padding: 8px 15px; font-size: 12px;">
                üóëÔ∏è Delete All ${data.sessions.length} Sessions
              </button>
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
              ${data.sessions.map(s => `
                <div style="background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong style="color: #1a202c;">${s.student_name || 'Unknown'}</strong>
                    <span style="color: #718096; font-size: 12px; margin-left: 10px;">${s.session_date ? new Date(s.session_date).toLocaleDateString() : 'No date'}</span>
                    <span style="color: #718096; font-size: 12px; margin-left: 10px;">${s.session_time || ''}</span>
                    <span style="background: #e2e8f0; color: #4a5568; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">${s.session_type || 'Private'}</span>
                  </div>
                  <button onclick="deleteSessionById(${s.id})" class="btn" style="background: #dc2626; color: white; padding: 6px 12px; font-size: 12px;">
                    üóëÔ∏è Delete
                  </button>
                </div>
              `).join('')}
            </div>
          `;
          window.searchedSessionIds = data.sessions.map(s => s.id);
        } else {
          resultsDiv.style.display = 'block';
          listDiv.innerHTML = `<p style="color: #fef3c7; text-align: center;">No sessions found for "${name}"</p>`;
          window.searchedSessionIds = [];
        }
      } catch (err) {
        console.error('Search error:', err);
        alert('‚ùå Error searching sessions: ' + err.message);
      }
    }

    // Delete a single session by ID
    async function deleteSessionById(sessionId) {
      if (!confirm('Delete this session? This cannot be undone.')) return;

      try {
        const res = await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
        const data = await res.json();

        if (res.ok) {
          alert('‚úÖ Session deleted');
          searchSessionsByName(); // Refresh search results
          loadPastSessions();
          loadCalendar();
        } else {
          alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // Delete all searched sessions
    async function deleteAllSearchedSessions() {
      if (!window.searchedSessionIds || window.searchedSessionIds.length === 0) {
        alert('No sessions to delete');
        return;
      }

      if (!confirm(`Delete ALL ${window.searchedSessionIds.length} sessions? This cannot be undone!`)) return;

      try {
        let deleted = 0;
        for (const id of window.searchedSessionIds) {
          const res = await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
          if (res.ok) deleted++;
        }

        alert(`‚úÖ Deleted ${deleted} session(s)`);
        document.getElementById('sessionSearchResults').style.display = 'none';
        document.getElementById('sessionSearchName').value = '';
        window.searchedSessionIds = [];
        loadPastSessions();
        loadCalendar();
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // Download database backup for migration
    async function downloadBackup() {
      const password = document.getElementById('backupPassword').value;
      if (!password) {
        alert('Please enter your admin password');
        return;
      }

      try {
        const res = await fetch(`/api/backup/export?pass=${encodeURIComponent(password)}`);

        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to download backup. Check your password.');
          return;
        }

        // Get the SQL content and download as file
        const sql = await res.text();
        const blob = new Blob([sql], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fluentfeathers_backup_${new Date().toISOString().split('T')[0]}.sql`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        alert('‚úÖ Backup downloaded successfully!');
      } catch (e) {
        console.error('Backup error:', e);
        alert('Error downloading backup: ' + e.message);
      }
    }

    function loadEvents() {
      fetch('/api/events')
        .then(r=>r.json())
        .then(ev=>document.getElementById('eventsBody').innerHTML=ev.map(e=>{
          // Format date and time to IST
          const eventDateTime = formatSessionTime({ session_date: e.event_date, session_time: e.event_time });
          return `<tr>
            <td><strong>${e.event_name}</strong></td>
            <td>${eventDateTime.split(',')[0] || e.event_date}</td>
            <td>${eventDateTime.split(',')[1] || e.event_time}</td>
            <td>${e.event_duration || '-'}</td>
            <td>${e.registered_count||0}${e.max_participants ? '/' + e.max_participants : ''}</td>
            <td><span class="type-badge ${e.status === 'Active' ? 'event-active' : 'event-inactive'}">${e.status}</span></td>
            <td>
              <button onclick="viewEvent(${e.id})" class="btn btn-sm" style="background:#B05D9E; color:white;">View</button>
              <button onclick="editEvent(${e.id})" class="btn btn-sm btn-warning">Edit</button>
              <button onclick="markEventAttendance(${e.id}, '${e.event_name}')" class="btn btn-sm btn-success">Attendance</button>
              <button onclick="viewEventRegistrations(${e.id}, '${e.event_name}')" class="btn btn-sm" style="background:#9f7aea; color:white;">Registrations</button>
              <button onclick="openEventCertificates(${e.id}, '${e.event_name}')" class="btn btn-sm" style="background:#8b5cf6; color:white;">Certificates</button>
              <button onclick="copyEventLink(${e.id})" class="btn btn-sm" style="background:#38a169; color:white;">Copy Link</button>
              <button onclick="deleteEvent(${e.id})" class="btn btn-sm btn-danger">Delete</button>
            </td>
          </tr>`;
        }).join(''))
        .catch(err => console.error(err));
    }

    document.getElementById('createGroupForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const data = {
        group_name: document.getElementById('groupName').value,
        program_name: document.getElementById('groupProgram').value,
        duration: document.getElementById('groupDuration').value,
        timezone: document.getElementById('groupTimezone').value,
        max_students: document.getElementById('groupMaxStudents').value
      };

      try {
        const res = await fetch('/api/groups', {method:'POST', headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ Group created successfully!');
          e.target.reset();
          loadGroups();
          loadDashboardStats();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    function copyEventLink(eventId) {
      const link = `${window.location.origin}/event-register.html?id=${eventId}`;
      navigator.clipboard.writeText(link).then(() => {
        alert('‚úÖ Registration link copied! Share it on Instagram.\n\n' + link);
      }).catch(() => {
        prompt('Copy this registration link:', link);
      });
    }

    function deleteEvent(id) {
      if(confirm('Delete this event? Registrations will also be removed.')) {
        fetch(`/api/events/${id}`, {method:'DELETE'})
          .then(()=>{alert('‚úÖ Event deleted'); loadEvents();})
          .catch(err => alert('‚ùå Error'));
      }
    }

    document.getElementById('createEventForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const sendEmail = document.getElementById('sendEventEmail').checked;
      const data = {
        event_name: document.getElementById('eventName').value,
        event_description: document.getElementById('eventDescription').value,
        event_duration: document.getElementById('eventDuration').value,
        event_date: document.getElementById('eventDate').value,
        event_time: document.getElementById('eventTime').value,
        send_email: sendEmail
      };

      try {
        const res = await fetch('/api/events', {method:'POST', headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          e.target.reset();
          loadEvents();
          loadDashboardStats();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    async function loadScheduleManager() {
      document.getElementById('manageScheduleStudent').innerHTML = '<option value="">Select student...</option>' + allStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    async function loadStudentSchedule() {
      const studentId = document.getElementById('manageScheduleStudent').value;
      const container = document.getElementById('studentScheduleContainer');

      if (!studentId) {
        container.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`/api/sessions/${studentId}`);
        const sessions = await res.json();
        const student = allStudents.find(s => s.id == studentId);

        if (sessions.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">No sessions scheduled for this student</p>';
          return;
        }

        container.innerHTML = `
          <h3 style="margin-bottom: 20px;">Schedule for ${student.name}</h3>
          ${sessions.map(s => {
            const isCancelled = s.status === 'Cancelled' || s.status === 'Cancelled by Parent';
            const cancelledByText = isCancelled && s.cancelled_by ? ` (by ${s.cancelled_by})` : '';
            const statusColor = isCancelled ? '#e53e3e' : (s.status === 'Completed' ? '#38a169' : '#718096');
            return `
            <div class="session-item">
              <div>
                <strong>Session #${s.session_number}</strong> - ${s.session_type}
                <br>
                <span style="color: #718096;">üìÖ ${formatSessionTime(s)} | Status: <span style="color: ${statusColor}; font-weight: 600;">${s.status}${cancelledByText}</span></span>
              </div>
              <div style="display: flex; gap: 10px;">
                <button onclick="editSession(${s.id}, '${s.session_date}', '${s.session_time}')" class="btn btn-sm btn-primary">Edit</button>
                <button onclick="deleteSession(${s.id})" class="btn btn-sm btn-danger">Delete</button>
              </div>
            </div>
          `}).join('')}
        `;
      } catch(err) {
        container.innerHTML = '<p style="color: #e53e3e;">Error loading schedule</p>';
        console.error(err);
      }
    }

    function editSession(sessionId, date, time) {
      document.getElementById('editSessionId').value = sessionId;
      document.getElementById('editSessionDate').value = date.split('T')[0];
      document.getElementById('editSessionTime').value = time.substring(0, 5);
      document.getElementById('editSessionModal').classList.add('active');
    }

    function closeEditSessionModal() {
      document.getElementById('editSessionModal').classList.remove('active');
    }

    document.getElementById('editSessionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = document.getElementById('editSessionId').value;
      const date = document.getElementById('editSessionDate').value;
      const time = document.getElementById('editSessionTime').value;

      try {
        const res = await fetch(`/api/sessions/${sessionId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ date, time })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          closeEditSessionModal();
          loadStudentSchedule();
          loadUpcomingClasses();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    async function deleteSession(sessionId) {
      if (!confirm('Are you sure you want to delete this session?')) return;

      try {
        const res = await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          loadStudentSchedule();
          loadUpcomingClasses();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // CANCEL CLASS FUNCTIONS
    function openCancelClassModal(sessionId, studentName, sessionType) {
      document.getElementById('cancelSessionId').value = sessionId;
      document.getElementById('cancelSessionType').value = sessionType;
      document.getElementById('cancelStudentName').textContent = studentName;
      document.getElementById('cancelReason').value = '';
      document.getElementById('cancelNotes').value = '';
      document.getElementById('grantMakeupCredit').checked = true;
      document.getElementById('cancelClassModal').classList.add('active');
    }

    function closeCancelClassModal() {
      document.getElementById('cancelClassModal').classList.remove('active');
    }

    document.getElementById('cancelClassForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = document.getElementById('cancelSessionId').value;
      const sessionType = document.getElementById('cancelSessionType').value;
      const reason = document.getElementById('cancelReason').value;
      const notes = document.getElementById('cancelNotes').value;
      const grantMakeupCredit = document.getElementById('grantMakeupCredit').checked;

      if (!reason) {
        alert('Please select a cancellation reason');
        return;
      }

      try {
        const res = await fetch(`/api/sessions/${sessionId}/cancel`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            reason,
            notes,
            grant_makeup_credit: grantMakeupCredit,
            session_type: sessionType
          })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          closeCancelClassModal();
          loadUpcomingClasses();
          if(currentStudentId) loadStudentSchedule();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    // MAKEUP CREDIT FUNCTIONS
    function openAddMakeupCreditModal(studentId, studentName) {
      document.getElementById('makeupStudentId').value = studentId;
      document.getElementById('makeupStudentName').textContent = studentName;
      document.getElementById('makeupReason').value = 'Emergency - Student couldn\'t attend';
      document.getElementById('makeupNotes').value = '';
      document.getElementById('addMakeupCreditModal').classList.add('active');
    }

    function closeAddMakeupCreditModal() {
      document.getElementById('addMakeupCreditModal').classList.remove('active');
    }

    document.getElementById('addMakeupCreditForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('makeupStudentId').value;
      const reason = document.getElementById('makeupReason').value;
      const notes = document.getElementById('makeupNotes').value;

      try {
        const res = await fetch(`/api/students/${studentId}/makeup-credits`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ reason, notes })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          closeAddMakeupCreditModal();
          loadStudentMakeupCredits(studentId);
          loadStudents(); // Refresh student list to update makeup count
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    async function loadStudentMakeupCredits(studentId) {
      const container = document.getElementById(`makeupCreditsContainer-${studentId}`);
      if (!container) return;

      try {
        const res = await fetch(`/api/students/${studentId}/makeup-history`);
        const credits = await res.json();

        if (credits.length === 0) {
          container.innerHTML = '<p style="text-align: center; margin: 0; opacity: 0.8;">No makeup credits yet</p>';
          return;
        }

        const available = credits.filter(c => c.status === 'Available');
        const scheduled = credits.filter(c => c.status === 'Scheduled');
        const used = credits.filter(c => c.status === 'Used');

        let html = '';

        if (available.length > 0) {
          html += '<div style="margin-bottom: 10px;"><strong>Available Credits (${available.length}):</strong></div>';
          html += available.map(c => `
            <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; color: #2d3748;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <span style="font-size: 0.85rem;">üìã ${c.reason}</span>
                  <br><small style="color: #718096;">Added: ${new Date(c.credit_date).toLocaleDateString()} ${c.added_by === 'admin' ? '(by Admin)' : ''}</small>
                </div>
                <div style="display: flex; gap: 5px;">
                  <button onclick="openScheduleMakeupModal(${c.id}, ${studentId}, '${c.reason.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')" class="btn btn-sm" style="background: #38a169; color: white;">üìÖ Schedule</button>
                  <button onclick="deleteMakeupCredit(${c.id}, ${studentId})" class="btn btn-sm" style="background: #e53e3e; color: white;" title="Delete this makeup credit">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          `).join('');
        }

        if (scheduled.length > 0) {
          html += '<div style="margin: 10px 0;"><strong>Scheduled (${scheduled.length}):</strong></div>';
          html += scheduled.map(c => `
            <div style="background: rgba(255,255,255,0.5); padding: 10px; border-radius: 6px; margin-bottom: 8px; color: #2d3748;">
              <span style="font-size: 0.85rem;">üìÖ Scheduled for: ${c.scheduled_date ? new Date(c.scheduled_date).toLocaleDateString() : 'N/A'} at ${c.scheduled_time || 'N/A'}</span>
              <br><small style="color: #718096;">Original: ${c.reason}</small>
            </div>
          `).join('');
        }

        if (used.length > 0) {
          html += '<div style="margin: 10px 0;"><strong>Used (${used.length}):</strong></div>';
          html += used.map(c => `
            <div style="background: rgba(255,255,255,0.3); padding: 10px; border-radius: 6px; margin-bottom: 8px; color: #2d3748; opacity: 0.7;">
              <span style="font-size: 0.85rem;">‚úÖ Used on: ${c.used_date ? new Date(c.used_date).toLocaleDateString() : 'N/A'}</span>
              <br><small style="color: #718096;">${c.reason}</small>
            </div>
          `).join('');
        }

        container.innerHTML = html.replace(/\$\{available\.length\}/g, available.length)
                                  .replace(/\$\{scheduled\.length\}/g, scheduled.length)
                                  .replace(/\$\{used\.length\}/g, used.length);
      } catch (err) {
        console.error('Error loading makeup credits:', err);
        container.innerHTML = '<p style="text-align: center; color: #fed7d7;">Error loading credits</p>';
      }
    }

    async function deleteMakeupCredit(creditId, studentId) {
      if (!confirm('Are you sure you want to delete this makeup credit? This cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch(`/api/makeup-credits/${creditId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          alert('‚úÖ Makeup credit deleted successfully!');
          loadStudentMakeupCredits(studentId);
          loadStudents(); // Refresh student list to update counts
        } else {
          const err = await res.json();
          alert('‚ùå Error: ' + (err.error || 'Failed to delete makeup credit'));
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    function openScheduleMakeupModal(creditId, studentId, reason) {
      document.getElementById('scheduleMakeupCreditId').value = creditId;
      document.getElementById('scheduleMakeupStudentId').value = studentId;
      document.getElementById('scheduleMakeupReason').textContent = reason;

      // Get student name from the page
      const studentNameEl = document.getElementById('makeupStudentName');
      if (studentNameEl) {
        document.getElementById('scheduleMakeupStudentName').textContent = studentNameEl.textContent;
      }

      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('makeupClassDate').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('makeupClassTime').value = '10:00';

      document.getElementById('scheduleMakeupModal').classList.add('active');
    }

    function closeScheduleMakeupModal() {
      document.getElementById('scheduleMakeupModal').classList.remove('active');
    }

    document.getElementById('scheduleMakeupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const creditId = document.getElementById('scheduleMakeupCreditId').value;
      const studentId = document.getElementById('scheduleMakeupStudentId').value;
      const sessionDate = document.getElementById('makeupClassDate').value;
      const sessionTime = document.getElementById('makeupClassTime').value;

      if (!sessionDate || !sessionTime) {
        alert('Please select date and time');
        return;
      }

      try {
        const res = await fetch(`/api/makeup-credits/${creditId}/schedule`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            session_date: sessionDate,
            session_time: sessionTime,
            student_id: studentId
          })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message + ' (Session #' + result.session_number + ')');
          closeScheduleMakeupModal();
          loadStudentMakeupCredits(studentId);
          loadStudents();
          loadUpcomingClasses();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    // DEMO STUDENTS FUNCTIONS
    let allDemoLeads = [];
    let currentDemoFilter = 'all';

    async function loadDemoLeads() {
      try {
        const res = await fetch('/api/demo-leads');
        allDemoLeads = await res.json();
        renderDemoLeads();
      } catch (err) {
        console.error('Error loading demo leads:', err);
        document.getElementById('demoLeadsBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #e53e3e;">Error loading demo leads</td></tr>';
      }
    }

    function filterDemoLeads(status) {
      currentDemoFilter = status;
      renderDemoLeads();
    }

    function renderDemoLeads() {
      const tbody = document.getElementById('demoLeadsBody');
      let leads = allDemoLeads;

      // Apply status filter
      if (currentDemoFilter !== 'all') {
        leads = leads.filter(l => l.status === currentDemoFilter);
      }

      // Apply search filter
      const searchInput = document.getElementById('demoSearchInput');
      const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
      if (searchTerm) {
        leads = leads.filter(l =>
          (l.child_name && l.child_name.toLowerCase().includes(searchTerm)) ||
          (l.parent_name && l.parent_name.toLowerCase().includes(searchTerm)) ||
          (l.parent_email && l.parent_email.toLowerCase().includes(searchTerm)) ||
          (l.phone && l.phone.toLowerCase().includes(searchTerm)) ||
          (l.program_interest && l.program_interest.toLowerCase().includes(searchTerm))
        );
      }

      // Update count display
      const countSpan = document.getElementById('demoLeadCount');
      if (countSpan) {
        countSpan.textContent = `Showing ${leads.length} of ${allDemoLeads.length} demo leads`;
      }

      if (leads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #718096; padding: 30px;">No demo leads found</td></tr>';
        return;
      }

      tbody.innerHTML = leads.map(lead => {
        const statusClasses = {
          'Scheduled': 'lead-status-scheduled',
          'Completed': 'lead-status-completed',
          'Converted': 'lead-status-converted',
          'Lost': 'lead-status-lost'
        };
        const statusIcons = {
          'Scheduled': 'üìÖ',
          'Completed': '‚úÖ',
          'Converted': 'üéâ',
          'Lost': '‚ùå'
        };

        // Format demo date/time in IST
        let demoDateTime = 'Not set';
        if (lead.demo_date && lead.demo_time) {
          const dateStr = lead.demo_date.includes('T') ? lead.demo_date.split('T')[0] : lead.demo_date;
          const d = new Date(dateStr + 'T' + lead.demo_time + 'Z');
          demoDateTime = d.toLocaleString('en-US', {
            timeZone: 'Asia/Kolkata',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          });
        }

        const editBtn = `<button onclick="openEditDemoModal(${lead.id})" class="btn btn-sm" style="background: #667eea; color: white;">‚úèÔ∏è</button>`;
        const actionButtons = lead.status === 'Completed'
          ? `${editBtn}
             <button onclick="openConvertDemoModal(${lead.id})" class="btn btn-sm" style="background: #38a169; color: white;">üéâ Convert</button>
             <button onclick="openUpdateDemoStatusModal(${lead.id})" class="btn btn-sm" style="background: #718096; color: white;">Status</button>`
          : lead.status === 'Converted'
          ? `${editBtn} <span style="color: #38a169;">Student #${lead.converted_student_id || ''}</span>`
          : `${editBtn} <button onclick="openUpdateDemoStatusModal(${lead.id})" class="btn btn-sm" style="background: #718096; color: white;">Update</button>`;

        return `<tr>
          <td><strong>${lead.child_name}</strong><br><small style="color:#718096;">Age: ${lead.child_grade || 'N/A'}</small></td>
          <td>${lead.parent_name}<br><small style="color:#718096;">${lead.parent_email}</small></td>
          <td>${lead.phone || 'N/A'}<br><small style="color:#a0aec0;">${lead.source || ''}</small></td>
          <td>${lead.program_interest || 'Not specified'}</td>
          <td>${demoDateTime}</td>
          <td><span class="lead-status ${statusClasses[lead.status] || 'lead-status-default'}">${statusIcons[lead.status] || ''} ${lead.status}</span></td>
          <td style="white-space: nowrap;">
            ${actionButtons}
            <button onclick="deleteDemoLead(${lead.id})" class="btn btn-sm" style="background: #e53e3e; color: white;">‚úï</button>
          </td>
        </tr>`;
      }).join('');
    }

    // Add Demo Lead Form Handler
    document.getElementById('addDemoLeadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        child_name: document.getElementById('demoChildName').value,
        child_grade: document.getElementById('demoChildGrade').value,
        parent_name: document.getElementById('demoParentName').value,
        parent_email: document.getElementById('demoParentEmail').value,
        phone: document.getElementById('demoPhone').value,
        program_interest: document.getElementById('demoProgramInterest').value,
        demo_date: document.getElementById('demoDate').value,
        demo_time: document.getElementById('demoTime').value,
        source: document.getElementById('demoSource').value,
        notes: document.getElementById('demoNotes').value,
        send_email: document.getElementById('sendDemoEmail').checked
      };

      try {
        const res = await fetch('/api/demo-leads', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          alert('‚úÖ ' + (result.message || 'Demo lead added successfully!'));
          e.target.reset();
          document.getElementById('sendDemoEmail').checked = true; // Reset checkbox to checked
          loadDemoLeads();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    function openUpdateDemoStatusModal(leadId) {
      const lead = allDemoLeads.find(l => l.id === leadId);
      if (!lead) return;

      document.getElementById('updateDemoId').value = leadId;
      document.getElementById('updateDemoName').textContent = lead.child_name;
      document.getElementById('newDemoStatus').value = lead.status;
      document.getElementById('demoStatusNotes').value = '';
      document.getElementById('updateDemoStatusModal').classList.add('active');
    }

    function closeUpdateDemoStatusModal() {
      document.getElementById('updateDemoStatusModal').classList.remove('active');
    }

    function openEditDemoModal(leadId) {
      const lead = allDemoLeads.find(l => l.id === leadId);
      if (!lead) return;

      document.getElementById('editDemoId').value = leadId;
      document.getElementById('editDemoChildName').value = lead.child_name || '';
      document.getElementById('editDemoChildGrade').value = lead.child_grade || '';
      document.getElementById('editDemoParentName').value = lead.parent_name || '';
      document.getElementById('editDemoParentEmail').value = lead.parent_email || '';
      document.getElementById('editDemoPhone').value = lead.phone || '';
      document.getElementById('editDemoProgramInterest').value = lead.program_interest || '';
      document.getElementById('editDemoSource').value = lead.source || '';
      document.getElementById('editDemoStatus').value = lead.status || 'Scheduled';
      document.getElementById('editDemoNotes').value = lead.notes || '';
      document.getElementById('editDemoSendEmail').checked = false;

      // Handle date - extract date part from ISO string
      if (lead.demo_date) {
        const dateStr = lead.demo_date.includes('T') ? lead.demo_date.split('T')[0] : lead.demo_date;
        document.getElementById('editDemoDate').value = dateStr;
      } else {
        document.getElementById('editDemoDate').value = '';
      }

      // Handle time
      document.getElementById('editDemoTime').value = lead.demo_time || '';

      document.getElementById('editDemoModal').classList.add('active');
    }

    function closeEditDemoModal() {
      document.getElementById('editDemoModal').classList.remove('active');
    }

    document.getElementById('editDemoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const leadId = document.getElementById('editDemoId').value;

      const data = {
        child_name: document.getElementById('editDemoChildName').value,
        child_grade: document.getElementById('editDemoChildGrade').value,
        parent_name: document.getElementById('editDemoParentName').value,
        parent_email: document.getElementById('editDemoParentEmail').value,
        phone: document.getElementById('editDemoPhone').value,
        program_interest: document.getElementById('editDemoProgramInterest').value,
        demo_date: document.getElementById('editDemoDate').value,
        demo_time: document.getElementById('editDemoTime').value,
        source: document.getElementById('editDemoSource').value,
        status: document.getElementById('editDemoStatus').value,
        notes: document.getElementById('editDemoNotes').value,
        send_email: document.getElementById('editDemoSendEmail').checked
      };

      try {
        const res = await fetch(`/api/demo-leads/${leadId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          alert('‚úÖ ' + (result.message || 'Demo details updated!'));
          closeEditDemoModal();
          loadDemoLeads();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    document.getElementById('updateDemoStatusForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const leadId = document.getElementById('updateDemoId').value;
      const status = document.getElementById('newDemoStatus').value;
      const notes = document.getElementById('demoStatusNotes').value;

      try {
        const res = await fetch(`/api/demo-leads/${leadId}/status`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ status, notes })
        });
        const result = await res.json();
        if (res.ok) {
          alert('‚úÖ Status updated!');
          closeUpdateDemoStatusModal();
          loadDemoLeads();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    function openConvertDemoModal(leadId) {
      const lead = allDemoLeads.find(l => l.id === leadId);
      if (!lead) return;

      document.getElementById('convertDemoId').value = leadId;
      document.getElementById('convertDemoName').textContent = lead.child_name + ' (' + lead.parent_name + ')';
      document.getElementById('convertProgram').value = lead.program_interest || '';
      document.getElementById('convertDemoModal').classList.add('active');
    }

    function closeConvertDemoModal() {
      document.getElementById('convertDemoModal').classList.remove('active');
    }

    document.getElementById('convertDemoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const leadId = document.getElementById('convertDemoId').value;
      const data = {
        program_name: document.getElementById('convertProgram').value,
        duration: document.getElementById('convertDuration').value,
        per_session_fee: parseFloat(document.getElementById('convertFee').value),
        currency: document.getElementById('convertCurrency').value,
        total_sessions: parseInt(document.getElementById('convertSessions').value),
        amount_paid: parseFloat(document.getElementById('convertAmountPaid').value),
        payment_method: document.getElementById('convertPaymentMethod').value,
        timezone: document.getElementById('convertTimezone').value,
        send_welcome_email: document.getElementById('convertSendEmail').checked
      };

      try {
        const res = await fetch(`/api/demo-leads/${leadId}/convert`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          alert('üéâ Successfully converted to student!');
          closeConvertDemoModal();
          loadDemoLeads();
          loadStudents(); // Reload students list too
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    async function deleteDemoLead(leadId) {
      if (!confirm('Are you sure you want to delete this demo lead?')) return;

      try {
        const res = await fetch(`/api/demo-leads/${leadId}`, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok) {
          alert('‚úÖ Demo lead deleted');
          loadDemoLeads();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // PAYMENT & RENEWAL FUNCTIONS
    function showRenewalForm() {
      document.getElementById('renewalForm').style.display = 'block';
    }

    async function submitRenewal() {
      const amount = document.getElementById('renewalAmount').value;
      const sessions = document.getElementById('renewalSessions').value;
      const method = document.getElementById('renewalMethod').value;
      const notes = document.getElementById('renewalNotes').value;

      if(!amount || !sessions) return alert('Please fill required fields');

      const student = allStudents.find(s => s.id === currentStudentId);

      try {
        const res = await fetch(`/api/students/${currentStudentId}/renewal`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            amount: parseFloat(amount),
            currency: student.currency,
            sessions_added: parseInt(sessions),
            payment_method: method,
            notes: notes
          })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          document.getElementById('renewalForm').style.display = 'none';
          document.getElementById('renewalForm').reset();
          loadModalPayments();
          loadStudents();
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    async function loadModalPayments() {
      try {
        const res = await fetch(`/api/students/${currentStudentId}/payments`);
        const data = await res.json();
        const container = document.getElementById('modalPaymentsContent');

        let html = '<h3>Payment History</h3>';
        if(data.payments.length === 0 && data.renewals.length === 0) {
          html += '<p style="color:#718096;">No payment records yet</p>';
        } else {
          html += '<table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Sessions</th><th>Method</th></tr></thead><tbody>';

          data.renewals.forEach(r => {
            html += `<tr><td>${r.renewal_date}</td><td>Renewal</td><td>${r.currency} ${r.amount}</td><td>+${r.sessions_added}</td><td>${r.payment_method||'-'}</td></tr>`;
          });

          data.payments.forEach(p => {
            html += `<tr><td>${p.payment_date}</td><td>Payment</td><td>${p.currency} ${p.amount}</td><td>${p.sessions_covered||'-'}</td><td>${p.payment_method}</td></tr>`;
          });

          html += '</tbody></table>';
        }

        container.innerHTML = html;
      } catch(err) {
        console.error(err);
        document.getElementById('modalPaymentsContent').innerHTML = '<p style="color:#e53e3e;">Error loading payments</p>';
      }
    }

    async function loadModalHomework() {
      try {
        const res = await fetch(`/api/students/${currentStudentId}/homework`);
        const homework = await res.json();
        const container = document.getElementById('modalHomeworkContent');

        if(homework.length === 0) {
          container.innerHTML = '<p style="color:#718096; text-align:center;">No homework submitted yet</p>';
        } else {
          container.innerHTML = homework.map(hw => `
            <div style="background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div>
                  <strong>Session #${hw.session_number || 'N/A'}</strong>
                  <p style="color:#718096; font-size:0.9rem;">${hw.file_name}</p>
                  <p style="color:#718096; font-size:0.85rem;">${new Date(hw.uploaded_at).toLocaleDateString()}</p>
                </div>
                <div>
                  ${hw.feedback_given ? `<span style="color:#38a169;">‚úì Graded: ${hw.feedback_grade}</span>` : '<button onclick="gradeHomework('+hw.id+')" class="btn btn-sm btn-primary">Grade</button>'}
                </div>
              </div>
              ${hw.feedback_comments ? `<p><strong>Feedback:</strong> ${hw.feedback_comments}</p>` : ''}
            </div>
          `).join('');
        }
      } catch(err) {
        console.error(err);
        document.getElementById('modalHomeworkContent').innerHTML = '<p style="color:#e53e3e;">Error loading homework</p>';
      }
    }

    async function gradeHomework(materialId, gradeParam, commentsParam) {
      // If grade and comments are passed, use them; otherwise prompt
      let grade = gradeParam;
      let comments = commentsParam;

      if (grade === undefined) {
        grade = prompt('Enter grade (A+, A, B+, B, C, etc):');
        if(!grade) return;
        comments = prompt('Enter feedback comments:') || '';
      }

      try {
        const res = await fetch(`/api/materials/${materialId}/grade`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ grade, comments })
        });
        const result = await res.json();
        if(res.ok) {
          alert('‚úÖ ' + result.message);
          loadModalHomework();
          // Also reload homework submissions if we're on that view
          if (typeof loadHomeworkSubmissions === 'function') {
            loadHomeworkSubmissions();
          }
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch(err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    async function loadModalBadges() {
      try {
        const res = await fetch(`/api/students/${currentStudentId}/badges`);
        const badges = await res.json();
        const container = document.getElementById('modalBadgesContent');

        const assignButton = `<button onclick="openAssignBadgeModal()" class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 15px;">üéñÔ∏è Assign Badge</button>`;

        if(badges.length === 0) {
          container.innerHTML = `
            ${assignButton}
            <p style="color:#718096; text-align:center; padding:40px;">No badges earned yet. Keep learning!</p>
          `;
        } else {
          // Separate auto badges from manual badges
          const autoBadges = badges.filter(b => ['first_class', '5_classes', '10_classes', '25_classes', '50_classes', 'hw_submit', '5_homework', '10_homework', '25_homework'].includes(b.badge_type));
          const manualBadges = badges.filter(b => !['first_class', '5_classes', '10_classes', '25_classes', '50_classes', 'hw_submit', '5_homework', '10_homework', '25_homework'].includes(b.badge_type));

          container.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">üèÜ Total Badges: <span style="color: #667eea;">${badges.length}</span></h3>
              ${assignButton}
            </div>

            ${manualBadges.length > 0 ? `
              <div style="margin-bottom: 20px;">
                <h4 style="color: #764ba2; margin-bottom: 10px;">‚≠ê Class Achievements</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${manualBadges.map(b => `
                    <div class="badge-card" title="${b.badge_description || ''}\n${new Date(b.earned_date).toLocaleDateString()}" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 8px 12px; border-radius: 20px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 2px 8px rgba(252,182,159,0.3);">
                      ${b.badge_name}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${autoBadges.length > 0 ? `
              <div>
                <h4 style="color: #38a169; margin-bottom: 10px;">üéØ Milestone Badges</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${autoBadges.map(b => `
                    <div class="badge-card" title="${b.badge_description || ''}" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); padding: 8px 12px; border-radius: 20px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 2px 8px rgba(150,230,161,0.3);">
                      ${b.badge_name}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          `;
        }
      } catch(err) {
        console.error(err);
        document.getElementById('modalBadgesContent').innerHTML = '<p style="color:#e53e3e;">Error loading badges</p>';
      }
    }

    // Predefined manual badges for teachers to assign
    const manualBadgeOptions = [
      { type: 'active_listener', name: 'üëÇ Active Listener', desc: 'Listened attentively throughout the class!' },
      { type: 'attentive_star', name: 'üåü Attentive Star', desc: 'Showed excellent focus and attention!' },
      { type: 'vocabulary_champ', name: 'üìö Vocabulary Champ', desc: 'Learned new words brilliantly!' },
      { type: 'reading_rockstar', name: 'üìñ Reading Rockstar', desc: 'Read with great fluency and expression!' },
      { type: 'pronunciation_pro', name: 'üó£Ô∏è Pronunciation Pro', desc: 'Excellent pronunciation skills!' },
      { type: 'grammar_guru', name: '‚úèÔ∏è Grammar Guru', desc: 'Mastered grammar concepts!' },
      { type: 'creative_writer', name: '‚úçÔ∏è Creative Writer', desc: 'Showed amazing creativity in writing!' },
      { type: 'quick_learner', name: '‚ö° Quick Learner', desc: 'Grasped concepts super fast!' },
      { type: 'confident_speaker', name: 'üé§ Confident Speaker', desc: 'Spoke with great confidence!' },
      { type: 'perfect_participation', name: 'üôã Perfect Participation', desc: 'Participated actively in every activity!' },
      { type: 'super_effort', name: 'üí™ Super Effort', desc: 'Put in outstanding effort today!' },
      { type: 'bright_spark', name: 'üí° Bright Spark', desc: 'Had brilliant ideas in class!' },
      { type: 'team_player', name: 'ü§ù Team Player', desc: 'Worked wonderfully with others!' },
      { type: 'improvement_star', name: 'üìà Improvement Star', desc: 'Showed great improvement!' },
      { type: 'positive_attitude', name: 'üòä Positive Attitude', desc: 'Maintained a great positive attitude!' },
      { type: 'curiosity_badge', name: 'üîç Curious Mind', desc: 'Asked thoughtful questions!' },
      { type: 'storyteller', name: 'üìï Storyteller', desc: 'Told stories wonderfully!' },
      { type: 'spelling_bee', name: 'üêù Spelling Bee', desc: 'Spelled words perfectly!' }
    ];

    function openAssignBadgeModal() {
      document.getElementById('assignBadgeModal').classList.add('active');
    }

    function closeAssignBadgeModal() {
      document.getElementById('assignBadgeModal').classList.remove('active');
    }

    async function assignBadge(badgeType, badgeName, badgeDesc) {
      try {
        const res = await fetch(`/api/students/${currentStudentId}/badges/assign`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ badge_type: badgeType, badge_name: badgeName, badge_description: badgeDesc })
        });
        const result = await res.json();
        if (res.ok) {
          alert('üéâ Badge assigned successfully!');
          closeAssignBadgeModal();
          loadModalBadges();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // ==================== LEADERBOARD ====================
    async function loadLeaderboard() {
      try {
        const res = await fetch('/api/leaderboard');
        const data = await res.json();
        const students = data.leaderboard || [];

        // Update podium (top 3)
        const podiumContainer = document.getElementById('leaderboardPodium');
        if (students.length >= 1) {
          const top3 = students.slice(0, 3);
          const podiumOrder = top3.length >= 3 ? [top3[1], top3[0], top3[2]] : top3; // 2nd, 1st, 3rd

          let podiumHTML = '';
          podiumOrder.forEach((student, idx) => {
            const actualRank = students.indexOf(student) + 1;
            const medals = { 1: 'ü•á', 2: 'ü•à', 3: 'ü•â' };
            const podiumClasses = { 1: 'podium-gold', 2: 'podium-silver', 3: 'podium-bronze' };
            const heightClasses = { 1: 'podium-height-1', 2: 'podium-height-2', 3: 'podium-height-3' };
            const shadowClasses = { 1: 'podium-shadow-gold', 2: 'podium-shadow-silver', 3: 'podium-shadow-bronze' };

            podiumHTML += `
              <div style="display: flex; flex-direction: column; align-items: center; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">${medals[actualRank]}</div>
                <div class="${shadowClasses[actualRank]}" style="background: white; padding: 15px 20px; border-radius: 12px; text-align: center; margin-bottom: 10px; min-width: 120px;">
                  <div style="font-weight: bold; color: #2d3748; font-size: 1rem;">${student.name}</div>
                  <div style="color: #667eea; font-size: 1.5rem; font-weight: bold;">${student.total_badges}</div>
                  <div style="color: #718096; font-size: 0.75rem;">badges</div>
                </div>
                <div class="${podiumClasses[actualRank]} ${heightClasses[actualRank]}" style="width: 100px; border-radius: 8px 8px 0 0; display: flex; align-items: flex-start; justify-content: center; padding-top: 15px;">
                  <span style="color: white; font-weight: bold; font-size: 1.5rem;">#${actualRank}</span>
                </div>
              </div>
            `;
          });
          podiumContainer.innerHTML = podiumHTML;
        } else {
          podiumContainer.innerHTML = '<p style="color: #718096; text-align: center;">No badges earned yet. Start assigning badges to students!</p>';
        }

        // Update table
        const tbody = document.getElementById('leaderboardBody');
        if (students.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #718096;">No students with badges yet</td></tr>';
          return;
        }

        tbody.innerHTML = students.map((student, index) => {
          const rank = index + 1;
          const rankBadge = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
          const rankClass = rank <= 3 ? 'rank-top3' : 'rank-normal';
          const rowClass = rank <= 3 ? 'leaderboard-top3' : '';

          return `
            <tr class="${rowClass}">
              <td style="padding: 15px; text-align: center;" class="${rankClass}">${rankBadge}</td>
              <td style="padding: 15px;">
                <strong style="color: #2d3748;">${student.name}</strong>
                <br><small style="color: #718096;">${student.program_name || 'N/A'}</small>
              </td>
              <td style="padding: 15px; text-align: center;">
                <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 14px; border-radius: 20px; font-weight: bold; font-size: 1.1rem;">${student.total_badges}</span>
              </td>
              <td style="padding: 15px; text-align: center; color: #f093fb; font-weight: 600;">${student.manual_badges || 0}</td>
              <td style="padding: 15px; text-align: center; color: #38a169; font-weight: 600;">${student.auto_badges || 0}</td>
              <td style="padding: 15px; text-align: center;">
                ${student.latest_badge ? `<span style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 5px 10px; border-radius: 12px; font-size: 0.8rem;">${student.latest_badge}</span>` : '<span style="color: #a0aec0;">-</span>'}
              </td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading leaderboard:', err);
        document.getElementById('leaderboardBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e53e3e;">Error loading leaderboard</td></tr>';
      }
    }

    // ==================== WEEKLY CHALLENGES ====================
    async function loadChallenges() {
      try {
        const res = await fetch('/api/challenges');
        const challenges = await res.json();
        const container = document.getElementById('challengesList');

        if (challenges.length === 0) {
          container.innerHTML = '<p style="color: #718096; text-align: center; padding: 30px;">No challenges created yet. Create your first challenge above!</p>';
          return;
        }

        container.innerHTML = challenges.map(c => {
          const isActive = new Date(c.week_end) >= new Date();
          const typeEmojis = {
            'Reading': 'üìñ', 'Vocabulary': 'üìö', 'Speaking': 'üó£Ô∏è',
            'Writing': '‚úçÔ∏è', 'Homework': 'üìù', 'Practice': 'üéØ', 'General': '‚≠ê'
          };
          const emoji = typeEmojis[c.challenge_type] || 'üéØ';
          const badgeReward = c.badge_reward || 'üéØ Challenge Champion';

          return `
            <div class="${isActive ? 'challenge-card-active' : 'challenge-card-inactive'}">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 8px 0; color: #2d3748;">
                    ${emoji} ${c.title}
                    ${isActive ? '<span style="background: #38a169; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 8px;">Active</span>' : '<span style="background: #718096; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 8px;">Ended</span>'}
                  </h4>
                  <p style="margin: 0 0 10px 0; color: #718096; font-size: 0.9rem;">${c.description || 'No description'}</p>
                  <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.85rem; color: #4a5568;">
                    <span>üìÖ ${new Date(c.week_start).toLocaleDateString()} - ${new Date(c.week_end).toLocaleDateString()}</span>
                    <span style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 3px 10px; border-radius: 12px;">üèÖ ${badgeReward}</span>
                    <span>üë• ${c.assigned_count || 0} assigned</span>
                    ${c.submitted_count > 0 ? `<span style="background: #9f7aea; color: white; padding: 3px 10px; border-radius: 12px; font-weight: 600;">üì© ${c.submitted_count} awaiting review!</span>` : ''}
                    <span style="color: #38a169; font-weight: 600;">‚úÖ ${c.completed_count || 0} completed</span>
                  </div>
                </div>
                <div style="display: flex; gap: 8px; flex-direction: column; align-items: flex-end;">
                  ${c.submitted_count > 0 ? `<span style="background: #e53e3e; color: white; padding: 4px 8px; border-radius: 50%; font-size: 0.75rem; font-weight: bold;">${c.submitted_count}</span>` : ''}
                  <button onclick="viewChallengeStudents(${c.id}, decodeURIComponent('${encodeURIComponent(c.title)}'), decodeURIComponent('${encodeURIComponent(badgeReward)}'))" class="btn btn-sm ${c.submitted_count > 0 ? 'btn-challenge-review' : 'btn-challenge-track'}">${c.submitted_count > 0 ? 'üîî Review Submissions' : 'üë• Track Progress'}</button>
                  <button onclick="deleteChallenge(${c.id})" class="btn btn-sm" style="background: #e53e3e; color: white;">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading challenges:', err);
        document.getElementById('challengesList').innerHTML = '<p style="color: #e53e3e; text-align: center;">Error loading challenges</p>';
      }
    }

    // Create Challenge Form Handler
    document.getElementById('createChallengeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        title: document.getElementById('challengeTitle').value,
        description: document.getElementById('challengeDescription').value,
        challenge_type: document.getElementById('challengeType').value,
        badge_reward: document.getElementById('challengeBadgeReward').value,
        week_start: document.getElementById('challengeWeekStart').value,
        week_end: document.getElementById('challengeWeekEnd').value,
        assign_to_all: document.getElementById('assignToAll').checked
      };

      try {
        const res = await fetch('/api/challenges', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          alert('üéØ Challenge created successfully!');
          e.target.reset();
          document.getElementById('assignToAll').checked = true;
          loadChallenges();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    // View Challenge Students - Track who completed
    async function viewChallengeStudents(challengeId, challengeTitle, badgeReward) {
      currentChallengeTitle = challengeTitle; // Store for refresh
      try {
        const res = await fetch(`/api/challenges/${challengeId}/students`);
        const students = await res.json();

        // Create modal
        const existingModal = document.getElementById('challengeStudentsModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'challengeStudentsModal';
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h2 style="color: #667eea;">üéØ ${challengeTitle}</h2>
              <button onclick="document.getElementById('challengeStudentsModal').remove()" class="btn btn-danger btn-sm">‚úï</button>
            </div>
            <div style="padding: 20px;">
              <p style="color: #718096; margin-bottom: 15px;">Badge Reward: <strong style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 5px 12px; border-radius: 15px;">${badgeReward}</strong></p>

              ${students.length === 0 ? '<p style="color: #718096; text-align: center; padding: 30px;">No students assigned to this challenge yet.</p>' : `
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f7fafc;">
                      <th style="padding: 12px; text-align: left;">Student</th>
                      <th style="padding: 12px; text-align: center;">Status</th>
                      <th style="padding: 12px; text-align: center;">Submission</th>
                      <th style="padding: 12px; text-align: center;">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${students.map(s => {
                      let statusBadge = '';
                      let actionBtn = '';
                      let submissionCol = '<span style="color:#718096;">-</span>';
                      let rowClass = 'challenge-row-default';

                      // Build submission file display
                      if (s.submission_file_path) {
                        const fname = s.submission_file_name || 'Submission';
                        const ext = fname.split('.').pop().toLowerCase();
                        const isImage = ['jpg','jpeg','png','gif','webp'].includes(ext);
                        const isVideo = ['mp4','mov','avi','webm'].includes(ext);
                        const isPdf = ext === 'pdf';
                        const isDoc = ['doc','docx','ppt','pptx'].includes(ext);
                        const fileIcon = isVideo ? 'üé•' : isImage ? 'üñºÔ∏è' : isPdf ? 'üìÑ' : isDoc ? 'üìù' : 'üìÅ';
                        const fileType = isImage ? 'image' : isVideo ? 'video' : isPdf ? 'pdf' : isDoc ? 'doc' : 'other';

                        let fileUrl = s.submission_file_path;
                        if (!fileUrl.startsWith('http') && !fileUrl.startsWith('/uploads/')) {
                          fileUrl = '/uploads/homework/' + fileUrl;
                        }

                        submissionCol = '<div style="display:flex; flex-direction:column; gap:4px; align-items:center;">' +
                          '<span style="font-size:0.8rem; color:#4a5568;">' + fileIcon + ' ' + (fname.length > 20 ? fname.substring(0,20) + '...' : fname) + '</span>' +
                          '<div style="display:flex; gap:4px;">' +
                            '<button onclick="previewFile(\'' + fileUrl + '\', \'' + fileType + '\', decodeURIComponent(\'' + encodeURIComponent(fname) + '\'))" class="btn btn-sm" style="background:#9f7aea; color:white; font-size:0.75rem; padding:3px 8px;">View</button>' +
                            '<a href="' + fileUrl + '" target="_blank" download="' + fname + '" class="btn btn-sm" style="background:#667eea; color:white; font-size:0.75rem; padding:3px 8px; text-decoration:none;">‚¨áÔ∏è</a>' +
                          '</div>' +
                        '</div>';
                      }

                      if (s.status === 'Completed') {
                        statusBadge = '<span class="challenge-badge challenge-badge-completed">‚úÖ Completed</span>' +
                                       '<br><small style="color: #718096;">' + (s.completed_at ? new Date(s.completed_at).toLocaleDateString() : '') + '</small>';
                        actionBtn = '<span class="status-active">üèÖ Badge Awarded</span>';
                      } else if (s.status === 'Submitted') {
                        statusBadge = '<span class="challenge-badge challenge-badge-submitted">üì© Submitted!</span>';
                        actionBtn = '<button onclick="markChallengeComplete(' + challengeId + ', ' + s.student_id + ', decodeURIComponent(\'' + encodeURIComponent(s.student_name) + '\'), decodeURIComponent(\'' + encodeURIComponent(badgeReward) + '\'))" class="btn btn-sm" style="background: linear-gradient(135deg, #38a169 0%, #2f855a 100%); color: white; font-weight: bold;">‚úÖ Approve & Award Badge</button>';
                        rowClass = 'challenge-row-submitted';
                      } else {
                        statusBadge = '<span class="challenge-badge challenge-badge-pending">‚è≥ Not Started</span>';
                        actionBtn = '<button onclick="markChallengeComplete(' + challengeId + ', ' + s.student_id + ', decodeURIComponent(\'' + encodeURIComponent(s.student_name) + '\'), decodeURIComponent(\'' + encodeURIComponent(badgeReward) + '\'))" class="btn btn-sm" style="background: #718096; color: white;">‚úÖ Mark Complete</button>';
                      }

                      return '<tr class="' + rowClass + '">' +
                        '<td style="padding: 12px;">' +
                          '<strong>' + s.student_name + '</strong>' +
                          (s.status === 'Submitted' ? ' <span class="needs-review-badge">NEEDS REVIEW</span>' : '') +
                          '<br><small style="color: #718096;">' + (s.program_name || '') + '</small>' +
                        '</td>' +
                        '<td style="padding: 12px; text-align: center;">' + statusBadge + '</td>' +
                        '<td style="padding: 12px; text-align: center;">' + submissionCol + '</td>' +
                        '<td style="padding: 12px; text-align: center;">' + actionBtn + '</td>' +
                      '</tr>';
                    }).join('')}
                  </tbody>
                </table>
              `}
            </div>
          </div>
        `;

        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });

        document.body.appendChild(modal);
      } catch (err) {
        alert('‚ùå Error loading students: ' + err.message);
      }
    }

    // Mark challenge as complete for a student
    let currentChallengeTitle = '';
    async function markChallengeComplete(challengeId, studentId, studentName, badgeReward) {
      if (!confirm(`Mark challenge as COMPLETED for ${studentName}?\n\nThis will award them the "${badgeReward}" badge!`)) return;

      try {
        const res = await fetch(`/api/challenges/${challengeId}/student/${studentId}/complete`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ badge_reward: badgeReward })
        });
        const result = await res.json();
        if (res.ok) {
          alert(`üéâ ${studentName} completed the challenge and earned the ${badgeReward} badge!`);
          // Refresh the modal and list
          const modalTitle = currentChallengeTitle;
          document.getElementById('challengeStudentsModal')?.remove();
          viewChallengeStudents(challengeId, modalTitle, badgeReward);
          loadChallenges();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    async function deleteChallenge(challengeId) {
      if (!confirm('Are you sure you want to delete this challenge?')) return;

      try {
        const res = await fetch(`/api/challenges/${challengeId}`, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok) {
          alert('‚úÖ Challenge deleted');
          loadChallenges();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // ==================== ANNOUNCEMENTS ====================
    let announcementsData = []; // Store announcements for modal access

    async function loadAnnouncements() {
      try {
        const res = await fetch('/api/announcements');
        const announcements = await res.json();
        announcementsData = announcements; // Store for later use
        const tbody = document.getElementById('announcementsBody');

        if (announcements.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#718096;">No announcements yet</td></tr>';
          return;
        }

        tbody.innerHTML = announcements.map(a => {
          const priorityClass = a.priority === 'Urgent' ? 'priority-urgent' : a.priority === 'High' ? 'priority-high' : 'priority-normal';
          const imageIcon = a.image_url ? 'üñºÔ∏è ' : '';
          return `
            <tr>
              <td><strong>${imageIcon}${a.title}</strong></td>
              <td><span style="background:#e2e8f0; padding:3px 8px; border-radius:4px; font-size:0.8rem;">${a.announcement_type}</span></td>
              <td><span class="type-badge ${priorityClass}">${a.priority}</span></td>
              <td>${new Date(a.created_at).toLocaleDateString()}</td>
              <td>
                <button onclick="openAnnouncementModal(${a.id})" class="btn btn-sm" style="background:#9f7aea;color:white;">View</button>
                <button onclick="openEditAnnouncement(${a.id})" class="btn btn-sm" style="background:#B05D9E;color:white;">Edit</button>
                <button onclick="deleteAnnouncement(${a.id})" class="btn btn-danger btn-sm">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error(err);
      }
    }

    // Image preview for create announcement
    document.getElementById('announcementImage').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('announcementPreviewImg').src = e.target.result;
          document.getElementById('announcementImagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    function clearAnnouncementImage() {
      document.getElementById('announcementImage').value = '';
      document.getElementById('announcementImagePreview').style.display = 'none';
    }

    document.getElementById('createAnnouncementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sendEmail = document.getElementById('sendAnnouncementEmail').checked;

      // Use FormData for file upload
      const formData = new FormData();
      formData.append('title', document.getElementById('announcementTitle').value);
      formData.append('content', document.getElementById('announcementContent').value);
      formData.append('announcement_type', document.getElementById('announcementType').value);
      formData.append('priority', document.getElementById('announcementPriority').value);
      formData.append('send_email', sendEmail);

      const imageFile = document.getElementById('announcementImage').files[0];
      if (imageFile) {
        formData.append('image', imageFile);
      }

      try {
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = sendEmail ? 'Creating & Sending Emails...' : 'Creating...';

        const res = await fetch('/api/announcements', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();

        if (res.ok) {
          alert(result.message || '‚úÖ Announcement created!');
          e.target.reset();
          clearAnnouncementImage();
          loadAnnouncements();
        } else {
          alert('‚ùå Failed: ' + (result.error || 'Unknown error'));
        }

        btn.disabled = false;
        btn.textContent = 'Create Announcement';
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    function openAnnouncementModal(id) {
      // Find announcement from stored data
      const a = announcementsData.find(ann => ann.id === id);
      if (!a) {
        alert('Announcement not found');
        return;
      }

      document.getElementById('editAnnouncementId').value = a.id;
      document.getElementById('editAnnouncementTitle').value = a.title || '';
      document.getElementById('editAnnouncementContent').value = a.content || '';
      document.getElementById('editAnnouncementType').value = a.announcement_type || 'General';
      document.getElementById('editAnnouncementPriority').value = a.priority || 'Normal';
      document.getElementById('announcementModalTitle').textContent = 'View Announcement';

      // Show current image if exists
      const imageContainer = document.getElementById('editAnnouncementCurrentImage');
      if (a.image_url) {
        imageContainer.innerHTML = `
          <div style="margin-bottom: 10px;">
            <img src="${a.image_url}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #e2e8f0;">
            <button type="button" onclick="removeAnnouncementImage(${a.id})" style="margin-left: 10px; background: #e53e3e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Remove Image</button>
          </div>
        `;
      } else {
        imageContainer.innerHTML = '<span style="color: #718096;">No image attached</span>';
      }
      document.getElementById('editAnnouncementImage').value = '';

      document.getElementById('announcementModal').classList.add('active');
    }

    async function removeAnnouncementImage(id) {
      if (!confirm('Remove the attached image?')) return;
      try {
        const formData = new FormData();
        const a = announcementsData.find(ann => ann.id === id);
        formData.append('title', a.title);
        formData.append('content', a.content);
        formData.append('announcement_type', a.announcement_type);
        formData.append('priority', a.priority);
        formData.append('remove_image', 'true');

        const res = await fetch(`/api/announcements/${id}`, { method: 'PUT', body: formData });
        if (res.ok) {
          alert('‚úÖ Image removed!');
          loadAnnouncements();
          closeAnnouncementModal();
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    function openEditAnnouncement(id) {
      openAnnouncementModal(id);
      document.getElementById('announcementModalTitle').textContent = 'Edit Announcement';
      document.getElementById('editAnnouncementTitle').focus();
    }

    function closeAnnouncementModal() {
      document.getElementById('announcementModal').classList.remove('active');
    }

    document.getElementById('editAnnouncementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editAnnouncementId').value;

      // Use FormData for file upload
      const formData = new FormData();
      formData.append('title', document.getElementById('editAnnouncementTitle').value);
      formData.append('content', document.getElementById('editAnnouncementContent').value);
      formData.append('announcement_type', document.getElementById('editAnnouncementType').value);
      formData.append('priority', document.getElementById('editAnnouncementPriority').value);

      const imageFile = document.getElementById('editAnnouncementImage').files[0];
      if (imageFile) {
        formData.append('image', imageFile);
      }

      try {
        const res = await fetch(`/api/announcements/${id}`, {
          method: 'PUT',
          body: formData
        });

        if (res.ok) {
          alert('‚úÖ Announcement updated!');
          closeAnnouncementModal();
          loadAnnouncements();
        } else {
          alert('‚ùå Failed to update announcement');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    async function resendAnnouncementEmail() {
      const id = document.getElementById('editAnnouncementId').value;
      const title = document.getElementById('editAnnouncementTitle').value;

      if (!confirm(`Send email for "${title}" to all active students/parents?`)) return;

      try {
        const res = await fetch(`/api/announcements/${id}/send-email`, {
          method: 'POST'
        });

        const result = await res.json();

        if (res.ok) {
          alert(result.message || '‚úÖ Emails sent!');
        } else {
          alert('‚ùå Failed: ' + (result.error || 'Unknown error'));
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    async function deleteAnnouncement(id) {
      if (!confirm('Delete this announcement?')) return;

      try {
        const res = await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert('‚úÖ Announcement deleted');
          loadAnnouncements();
        } else {
          alert('‚ùå Failed to delete announcement');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // ==================== ASSESSMENTS (Monthly & Demo) ====================
    // Show/hide custom certificate title field
    document.getElementById('certificateTitle').addEventListener('change', function() {
      const customGroup = document.getElementById('customTitleGroup');
      customGroup.style.display = this.value === 'Custom' ? 'block' : 'none';
    });

    // Assessment type toggle
    document.querySelectorAll('input[name="assessmentType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const isDemo = this.value === 'demo';
        document.getElementById('monthlyFields').style.display = isDemo ? 'none' : 'flex';
        document.getElementById('demoFields').style.display = isDemo ? 'flex' : 'none';

        // Update form validation
        document.getElementById('assessmentStudent').required = !isDemo;
        document.getElementById('assessmentMonth').required = !isDemo;
        document.getElementById('assessmentYear').required = !isDemo;
        document.getElementById('assessmentDemoLead').required = isDemo;

        // Update button text
        const submitBtn = document.querySelector('#monthlyAssessmentForm button[type="submit"]');
        submitBtn.textContent = isDemo ? 'Generate & Send Demo Report' : 'Generate & Send Report Card';

        // Update styling
        document.getElementById('typeMonthlyLabel').style.borderColor = isDemo ? '#e2e8f0' : '#B05D9E';
        document.getElementById('typeMonthlyLabel').style.background = isDemo ? 'white' : '#fdf2f8';
        document.getElementById('typeDemoLabel').style.borderColor = isDemo ? '#38b2ac' : '#e2e8f0';
        document.getElementById('typeDemoLabel').style.background = isDemo ? '#e6fffa' : 'white';

        // Show/hide demo certificate options
        const demoCertOptions = document.getElementById('demoCertificateOptions');
        if (demoCertOptions) {
          demoCertOptions.style.display = isDemo ? 'block' : 'none';
        }

        // Load demo leads if not already loaded
        if (isDemo) {
          loadAssessmentDemoLeads();
        }
      });
    });

    // Demo lead selection change
    document.getElementById('assessmentDemoLead').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const demoDate = selectedOption.getAttribute('data-date') || '';
      document.getElementById('demoLeadDate').value = demoDate;
    });

    async function loadAssessments() {
      try {
        const res = await fetch('/api/assessments');
        const assessments = await res.json();
        const tbody = document.getElementById('assessmentsBody');

        if (assessments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#718096;">No assessments created</td></tr>';
          return;
        }

        tbody.innerHTML = assessments.map(a => {
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const skills = a.skills ? JSON.parse(a.skills) : [];
          const skillsText = skills.length > 0 ? (skills.length > 3 ? skills.slice(0, 3).join(', ') + '...' : skills.join(', ')) : 'N/A';
          const isDemo = a.assessment_type === 'demo';
          const typeLabel = isDemo ? '<span style="background:#38b2ac;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">Demo</span>' : '<span style="background:#667eea;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">Monthly</span>';
          const period = isDemo ? (a.demo_date ? new Date(a.demo_date).toLocaleDateString() : 'Demo Class') : `${monthNames[a.month - 1]} ${a.year}`;

          return `
          <tr>
            <td>${typeLabel}</td>
            <td><strong>${a.student_name || a.demo_child_name || 'Unknown'}</strong></td>
            <td>${period}</td>
            <td>${a.certificate_title ? 'üèÜ ' + a.certificate_title : '-'}</td>
            <td title="${skillsText}">${skillsText}</td>
            <td>${new Date(a.created_at).toLocaleDateString()}</td>
            <td>
              <button onclick="viewAssessment(${a.id})" class="btn btn-sm" style="background:#B05D9E;color:white;">View</button>
              ${a.certificate_title ? `<button onclick="window.open('/${isDemo ? 'demo-certificate' : 'monthly-certificate'}.html?id=${a.id}', '_blank')" class="btn btn-sm" style="background:#f59e0b;color:white;">üèÜ Certificate</button>` : ''}
              <button onclick="askGoogleReview(${a.id})" class="btn btn-sm" style="background:#4285f4;color:white;">‚≠ê Ask Review</button>
              <button onclick="deleteAssessment(${a.id})" class="btn btn-danger btn-sm">Delete</button>
            </td>
          </tr>
        `}).join('');
      } catch (err) {
        console.error(err);
      }
    }

    async function loadAssessmentStudents() {
      try {
        const res = await fetch('/api/students');
        const students = await res.json();
        const select = document.getElementById('assessmentStudent');

        select.innerHTML = '<option value="">Select Student...</option>' +
          students.filter(s => s.is_active).map(s =>
            `<option value="${s.id}">${s.name} (${getAgeDisplay(s)})</option>`
          ).join('');
      } catch (err) {
        console.error(err);
      }
    }

    async function loadAssessmentDemoLeads() {
      try {
        const res = await fetch('/api/demo-leads');
        const leads = await res.json();
        const select = document.getElementById('assessmentDemoLead');

        // Filter to show completed demos or scheduled demos
        const eligibleLeads = leads.filter(l => l.status === 'Completed' || l.status === 'Scheduled');

        select.innerHTML = '<option value="">Select Demo Lead...</option>' +
          eligibleLeads.map(l => {
            const demoDate = l.demo_date ? new Date(l.demo_date).toLocaleDateString() : 'No date';
            const statusLabel = l.status === 'Completed' ? '‚úÖ Demo Completed' : 'üìÖ Scheduled';
            return `<option value="${l.id}" data-date="${demoDate}" data-email="${l.parent_email || ''}" data-parent="${l.parent_name || ''}">${l.child_name} (${l.child_grade || 'N/A'}) - ${statusLabel} - ${demoDate}</option>`;
          }).join('');
      } catch (err) {
        console.error(err);
      }
    }

    document.getElementById('monthlyAssessmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Collect checked skills
      const skills = [];
      const skillIds = [
        // Phonics
        'letter_sounds', 'blending', 'segmenting', 'sight_words', 'phonemic_awareness', 'decoding',
        // Reading
        'reading_fluency', 'reading_comprehension', 'reading_expression', 'story_understanding',
        // Spoken English
        'speaking', 'pronunciation', 'confidence', 'listening', 'conversation', 'sentence_formation',
        // Grammar
        'grammar', 'tenses', 'punctuation', 'parts_of_speech',
        // Vocabulary
        'vocabulary', 'spelling', 'word_meanings', 'synonyms_antonyms',
        // Creative Writing
        'writing', 'story_writing', 'essay_writing', 'handwriting',
        // Public Speaking
        'public_speaking', 'presentation', 'storytelling', 'debate', 'stage_presence'
      ];
      const skillNames = {
        // Phonics
        'letter_sounds': 'Letter Sounds Recognition',
        'blending': 'Blending Sounds',
        'segmenting': 'Segmenting Words',
        'sight_words': 'Sight Words',
        'phonemic_awareness': 'Phonemic Awareness',
        'decoding': 'Decoding Skills',
        // Reading
        'reading_fluency': 'Reading Fluency',
        'reading_comprehension': 'Reading Comprehension',
        'reading_expression': 'Reading with Expression',
        'story_understanding': 'Story Understanding',
        // Spoken English
        'speaking': 'Speaking & Communication',
        'pronunciation': 'Pronunciation',
        'confidence': 'Confidence Building',
        'listening': 'Active Listening',
        'conversation': 'Conversation Skills',
        'sentence_formation': 'Sentence Formation',
        // Grammar
        'grammar': 'Grammar & Structure',
        'tenses': 'Tenses',
        'punctuation': 'Punctuation',
        'parts_of_speech': 'Parts of Speech',
        // Vocabulary
        'vocabulary': 'Vocabulary Enhancement',
        'spelling': 'Spelling Mastery',
        'word_meanings': 'Word Meanings',
        'synonyms_antonyms': 'Synonyms & Antonyms',
        // Creative Writing
        'writing': 'Creative Writing',
        'story_writing': 'Story Writing',
        'essay_writing': 'Essay Writing',
        'handwriting': 'Handwriting',
        // Public Speaking
        'public_speaking': 'Public Speaking',
        'presentation': 'Presentation Skills',
        'storytelling': 'Storytelling',
        'debate': 'Debate Skills',
        'stage_presence': 'Stage Presence'
      };

      skillIds.forEach(skill => {
        if (document.getElementById(`skill_${skill}`).checked) {
          skills.push(skillNames[skill]);
        }
      });

      // Get certificate title
      let certificateTitle = document.getElementById('certificateTitle').value;
      if (certificateTitle === 'Custom') {
        certificateTitle = document.getElementById('customCertificateTitle').value;
      }
      // Certificate title is already clean (no emoji in values)

      const sendEmail = document.getElementById('sendAssessmentEmail').checked;
      const assessmentType = document.querySelector('input[name="assessmentType"]:checked').value;
      const isDemo = assessmentType === 'demo';

      const data = {
        assessment_type: assessmentType,
        skills: JSON.stringify(skills),
        certificate_title: certificateTitle || null,
        performance_summary: document.getElementById('performanceSummary').value,
        areas_of_improvement: document.getElementById('areasOfImprovement').value,
        teacher_comments: document.getElementById('teacherComments').value,
        send_email: sendEmail
      };

      if (isDemo) {
        const demoLeadSelect = document.getElementById('assessmentDemoLead');
        const selectedOption = demoLeadSelect.options[demoLeadSelect.selectedIndex];
        data.demo_lead_id = parseInt(demoLeadSelect.value);
        data.demo_parent_email = selectedOption.getAttribute('data-email');
        data.demo_parent_name = selectedOption.getAttribute('data-parent');
      } else {
        data.student_id = parseInt(document.getElementById('assessmentStudent').value);
        data.month = parseInt(document.getElementById('assessmentMonth').value);
        data.year = parseInt(document.getElementById('assessmentYear').value);
      }

      try {
        const res = await fetch('/api/assessments', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });

        if (res.ok) {
          const typeLabel = isDemo ? 'Demo' : 'Monthly';
          alert(`‚úÖ ${typeLabel} assessment created! ${sendEmail ? 'Report sent to parent.' : ''}`);
          e.target.reset();
          // Reset form to monthly view
          document.getElementById('typeMonthly').checked = true;
          document.getElementById('monthlyFields').style.display = 'flex';
          document.getElementById('demoFields').style.display = 'none';
          document.getElementById('typeMonthlyLabel').style.borderColor = '#B05D9E';
          document.getElementById('typeMonthlyLabel').style.background = '#fdf2f8';
          document.getElementById('typeDemoLabel').style.borderColor = '#e2e8f0';
          document.getElementById('typeDemoLabel').style.background = 'white';
          loadAssessments();
        } else {
          const result = await res.json();
          alert('‚ùå Failed to create assessment: ' + (result.error || 'Unknown error'));
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    async function askGoogleReview(id) {
      if (!confirm('Send Google review request email to this parent?')) return;
      try {
        const res = await fetch(`/api/assessments/${id}/ask-review`, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
        const data = await res.json();
        if (res.ok) {
          alert('Google review request email sent successfully!');
        } else {
          alert(data.error || 'Failed to send review email');
        }
      } catch (err) {
        alert('Error sending review email');
      }
    }

    async function viewAssessment(id) {
      try {
        const res = await fetch(`/api/assessments/${id}`);
        const a = await res.json();
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const skillsArray = a.skills ? JSON.parse(a.skills) : [];
        const isDemo = a.assessment_type === 'demo';
        const displayName = a.student_name || a.demo_child_name || 'Unknown';
        const period = isDemo ? (a.demo_date ? new Date(a.demo_date).toLocaleDateString() : 'Demo Class') : `${monthNames[a.month-1]} ${a.year}`;
        const headerGradient = isDemo ? 'linear-gradient(135deg, #38b2ac 0%, #319795 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        const headerLabel = isDemo ? 'üéØ Demo Class Assessment' : 'üìä Monthly Assessment';

        let content = `
          <div style="padding: 20px;">
            <!-- Student Info -->
            <div style="background: ${headerGradient}; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 25px; color: white;">
              <p style="margin: 0 0 8px; font-size: 12px; opacity: 0.9;">${headerLabel}</p>
              <h2 style="margin: 0;">${displayName}</h2>
              <p style="margin: 10px 0 0; opacity: 0.9;">${period}</p>
            </div>

            ${a.certificate_title ? `
            <!-- Award Card Display -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 15px; padding: 25px; text-align: center; margin: 0 auto 20px; max-width: 550px;">
              <div style="font-size: 50px; margin-bottom: 10px;">üèÜ</div>
              <h3 style="color: #92400e; font-size: 20px; margin: 0 0 15px; font-family: 'Georgia', serif;">${a.certificate_title}</h3>
              <p style="color: #b45309; font-size: 14px; margin: 0 0 8px;">Presented to</p>
              <h2 style="color: #C41E3A; font-size: 24px; margin: 0 0 15px; font-family: 'Georgia', serif; text-transform: uppercase;">${displayName}</h2>
              <p style="color: #78716c; font-size: 13px; margin: 0;">${period}</p>
            </div>
            ` : ''}

            ${skillsArray.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #2d3748; margin: 0 0 10px; font-size: 16px;">üìù Skills Assessed</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                ${skillsArray.map(skill => `<div style="background: #f7fafc; padding: 10px; border-radius: 6px; border-left: 3px solid #667eea; font-size: 13px;">‚úì ${skill}</div>`).join('')}
              </div>
            </div>
            ` : ''}

            ${a.performance_summary ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #2d3748; margin: 0 0 10px; font-size: 16px;">üìà Performance Summary</h3>
              <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border-left: 3px solid #38b2ac;">
                <p style="margin: 0; font-size: 14px; line-height: 1.6;">${a.performance_summary}</p>
              </div>
            </div>
            ` : ''}

            ${a.areas_of_improvement ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #2d3748; margin: 0 0 10px; font-size: 16px;">üìå Areas of Improvement</h3>
              <div style="background: #fff5f5; padding: 15px; border-radius: 8px; border-left: 3px solid #fc8181;">
                <p style="margin: 0; font-size: 14px; line-height: 1.6;">${a.areas_of_improvement}</p>
              </div>
            </div>
            ` : ''}

            ${a.teacher_comments ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #2d3748; margin: 0 0 10px; font-size: 16px;">üí¨ Teacher's Comments</h3>
              <div style="background: #fef5e7; padding: 15px; border-radius: 8px; border-left: 3px solid #f6ad55;">
                <p style="margin: 0; font-size: 14px; line-height: 1.6; font-style: italic;">"${a.teacher_comments}"</p>
              </div>
            </div>
            ` : ''}
          </div>
        `;

        document.getElementById('assessmentViewContent').innerHTML = content;
        document.getElementById('assessmentViewModal').classList.add('active');
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    function closeAssessmentModal() {
      document.getElementById('assessmentViewModal').classList.remove('active');
    }

    async function deleteAssessment(id) {
      if (!confirm('Delete this assessment?')) return;

      try {
        const res = await fetch(`/api/assessments/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert('‚úÖ Assessment deleted');
          loadAssessments();
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // Load data when tabs are switched
    const originalShowTab = showTab;
    showTab = function(name, event) {
      originalShowTab(name, event);
      if (name === 'announcements') loadAnnouncements();
      if (name === 'monthlyAssessment') {
        loadAssessments();
        loadAssessmentStudents();
      }
      if (name === 'payments') {
        loadPaymentStudentDropdown();
      }
      if (name === 'events') {
        loadEvents();
      }
      if (name === 'resources') {
        loadResources();
      }
      if (name === 'calendar') {
        loadCalendar();
      }
      if (name === 'adminProfile') {
        loadAdminProfile();
      }
    };

    // ==================== ADMIN PROFILE FUNCTIONS ====================
    async function loadAdminProfile() {
      try {
        const res = await fetch('/api/admin/settings');
        const settings = await res.json();

        document.getElementById('adminName').value = settings.admin_name || 'Aaliya';
        document.getElementById('adminTitle').value = settings.admin_title || 'Founder & Lead Instructor';
        document.getElementById('adminBio').value = settings.admin_bio || '';

        updateAdminProfilePreview();
      } catch (err) {
        console.error('Error loading admin profile:', err);
      }
    }

    function updateAdminProfilePreview() {
      const name = document.getElementById('adminName').value || 'Aaliya';
      const title = document.getElementById('adminTitle').value || 'Founder & Lead Instructor';
      const bio = document.getElementById('adminBio').value || 'Your bio will appear here...';

      document.getElementById('adminNamePreview').textContent = name;
      document.getElementById('adminTitlePreview').textContent = title;
      document.getElementById('adminBioPreview').innerHTML = bio ? bio.replace(/\n/g, '<br>') : '<em>Your bio will appear here...</em>';
      document.getElementById('adminInitialPreview').textContent = name.charAt(0).toUpperCase();
    }

    // Live preview updates
    document.getElementById('adminName').addEventListener('input', updateAdminProfilePreview);
    document.getElementById('adminTitle').addEventListener('input', updateAdminProfilePreview);
    document.getElementById('adminBio').addEventListener('input', updateAdminProfilePreview);

    document.getElementById('adminProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        admin_name: document.getElementById('adminName').value,
        admin_title: document.getElementById('adminTitle').value,
        admin_bio: document.getElementById('adminBio').value
      };

      try {
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('‚úÖ Profile saved successfully! Your bio will be sent to demo parents.');
        } else {
          alert('‚ùå Failed to save profile');
        }

        btn.disabled = false;
        btn.textContent = 'üíæ Save Profile';
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    // ==================== SWITCH TO LEARNER VIEW ====================
    function openSwitchToLearnerModal() {
      const select = document.getElementById('learnerViewStudent');
      select.innerHTML = '<option value="">Select Student...</option>' +
        allStudents.map(s => `<option value="${s.id}">${s.name} (${getAgeDisplay(s)}) - ${s.parent_email}</option>`).join('');
      document.getElementById('switchToLearnerModal').classList.add('active');
    }

    function closeSwitchToLearnerModal() {
      document.getElementById('switchToLearnerModal').classList.remove('active');
    }

    async function switchToLearnerView() {
      const studentId = document.getElementById('learnerViewStudent').value;
      if (!studentId) {
        alert('Please select a student');
        return;
      }

      try {
        const res = await fetch('/api/admin/parent-view-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ student_id: studentId })
        });
        const data = await res.json();

        if (res.ok && data.token) {
          // Store the admin token and open parent portal
          sessionStorage.setItem('adminParentToken', data.token);
          window.open('parent.html', '_blank');
          closeSwitchToLearnerModal();
        } else {
          alert('Failed to generate access token');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ==================== PAYMENTS MANAGEMENT ====================
    let selectedPaymentStudentId = null;

    function loadPaymentStudentDropdown() {
      const select = document.getElementById('paymentStudent');
      select.innerHTML = '<option value="">Select Student...</option>' +
        allStudents.map(s => `<option value="${s.id}">${s.name} (${getAgeDisplay(s)})</option>`).join('');
    }

    async function loadStudentPaymentDetails() {
      const studentId = document.getElementById('paymentStudent').value;
      if (!studentId) {
        document.getElementById('paymentStudentDetails').style.display = 'none';
        return;
      }

      selectedPaymentStudentId = studentId;
      const student = allStudents.find(s => s.id == studentId);

      if (student) {
        document.getElementById('payStudentName').textContent = student.name;
        document.getElementById('payTotalSessions').textContent = student.total_sessions;
        document.getElementById('payRemainingSessions').textContent = student.remaining_sessions;
        document.getElementById('payTotalPaid').textContent = `${student.currency} ${student.fees_paid || 0}`;
        document.getElementById('firstPaymentCurrency').value = student.currency || 'INR';
        document.getElementById('renewalPaymentCurrency').value = student.currency || 'INR';
        document.getElementById('paymentStudentDetails').style.display = 'block';

        // Load payment history
        await loadPaymentHistory(studentId);
      }
    }

    async function loadPaymentHistory(studentId) {
      try {
        const res = await fetch(`/api/students/${studentId}/payments`);
        const data = await res.json();
        const tbody = document.getElementById('paymentHistoryBody');

        const allPayments = [];

        // Add initial payments
        if (data.payments) {
          data.payments.forEach(p => {
            allPayments.push({
              date: p.payment_date,
              type: 'Initial',
              amount: `${p.currency} ${p.amount}`,
              sessions: p.sessions_covered || '-',
              method: p.payment_method || '-',
              notes: p.notes || '-'
            });
          });
        }

        // Add renewals
        if (data.renewals) {
          data.renewals.forEach(r => {
            allPayments.push({
              date: r.renewal_date,
              type: 'Renewal',
              amount: `${r.currency} ${r.amount}`,
              sessions: `+${r.sessions_added}`,
              method: r.payment_method || '-',
              notes: r.notes || '-'
            });
          });
        }

        // Sort by date descending
        allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (allPayments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #718096;">No payment records yet</td></tr>';
        } else {
          tbody.innerHTML = allPayments.map(p => `
            <tr>
              <td>${new Date(p.date).toLocaleDateString()}</td>
              <td><span class="type-badge ${p.type === 'Initial' ? 'payment-initial' : 'payment-renewal'}">${p.type}</span></td>
              <td><strong>${p.amount}</strong></td>
              <td>${p.sessions}</td>
              <td>${p.method}</td>
              <td>${p.notes}</td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error(err);
        document.getElementById('paymentHistoryBody').innerHTML = '<tr><td colspan="6" style="color: #e53e3e;">Error loading payment history</td></tr>';
      }
    }

    // First Payment Form
    document.getElementById('firstPaymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedPaymentStudentId) return alert('No student selected');

      const data = {
        amount: parseFloat(document.getElementById('firstPaymentAmount').value),
        currency: document.getElementById('firstPaymentCurrency').value,
        sessions_covered: document.getElementById('firstPaymentSessions').value || null,
        payment_method: document.getElementById('firstPaymentMethod').value,
        receipt_number: document.getElementById('firstPaymentReceipt').value,
        notes: document.getElementById('firstPaymentNotes').value,
        send_email: document.getElementById('sendFirstPaymentEmail').checked
      };

      try {
        const res = await fetch(`/api/students/${selectedPaymentStudentId}/payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('‚úÖ Payment recorded successfully!');
          e.target.reset();
          await loadStudents();
          await loadStudentPaymentDetails();
        } else {
          const err = await res.json();
          alert('‚ùå Failed: ' + err.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    // Renewal Payment Form
    document.getElementById('renewalPaymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedPaymentStudentId) return alert('No student selected');

      const data = {
        amount: parseFloat(document.getElementById('renewalPaymentAmount').value),
        sessions_added: parseInt(document.getElementById('renewalPaymentSessions').value),
        currency: document.getElementById('renewalPaymentCurrency').value,
        payment_method: document.getElementById('renewalPaymentMethod').value,
        notes: document.getElementById('renewalPaymentNotes').value,
        send_email: document.getElementById('sendRenewalPaymentEmail').checked
      };

      try {
        const res = await fetch(`/api/students/${selectedPaymentStudentId}/renewal`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('‚úÖ Renewal recorded successfully!');
          e.target.reset();
          await loadStudents();
          await loadStudentPaymentDetails();
        } else {
          const err = await res.json();
          alert('‚ùå Failed: ' + err.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    });

    // ==================== EVENT MANAGEMENT ====================
    let currentEventId = null;

    async function viewEvent(eventId) {
      try {
        const res = await fetch(`/api/events/${eventId}`);
        const event = await res.json();
        currentEventId = eventId;

        const eventDate = formatSessionTime({ session_date: event.event_date, session_time: event.event_time });

        document.getElementById('eventModalTitle').textContent = `üìã ${event.event_name}`;
        document.getElementById('eventModalContent').innerHTML = `
          <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><strong>Event Name:</strong> ${event.event_name}</div>
              <div><strong>Status:</strong> <span class="${event.status === 'Active' ? 'status-active' : 'status-inactive'}">${event.status}</span></div>
              <div><strong>Date & Time (IST):</strong> ${eventDate}</div>
              <div><strong>Duration:</strong> ${event.event_duration || 'N/A'}</div>
              <div><strong>Target Audience:</strong> ${event.target_audience || 'All'}</div>
              <div><strong>Max Participants:</strong> ${event.max_participants || 'Unlimited'}</div>
              <div><strong>Current Registrations:</strong> ${event.current_participants || 0}</div>
              <div><strong>Meet Link:</strong> <a href="${event.meet_link}" target="_blank" style="color: #B05D9E;">Open</a></div>
            </div>
            ${event.event_description ? `<div style="margin-top: 15px;"><strong>Description:</strong><p style="margin-top: 5px; color: #4a5568;">${event.event_description}</p></div>` : ''}
          </div>
        `;
        document.getElementById('eventModal').classList.add('active');
      } catch (err) {
        alert('Error loading event: ' + err.message);
      }
    }

    function closeEventModal() {
      document.getElementById('eventModal').classList.remove('active');
    }

    async function editEvent(eventId) {
      try {
        const res = await fetch(`/api/events/${eventId}`);
        const event = await res.json();
        currentEventId = eventId;

        document.getElementById('eventModalTitle').textContent = `‚úèÔ∏è Edit Event`;
        document.getElementById('eventModalContent').innerHTML = `
          <form id="editEventForm">
            <div class="form-row">
              <div class="form-group"><label>Event Name *</label><input type="text" id="editEventName" value="${event.event_name}" required></div>
              <div class="form-group"><label>Duration</label>
                <select id="editEventDuration">
                  <option value="25 mins" ${event.event_duration === '25 mins' ? 'selected' : ''}>25 mins</option>
                  <option value="30 mins" ${event.event_duration === '30 mins' ? 'selected' : ''}>30 mins</option>
                  <option value="40 mins" ${event.event_duration === '40 mins' ? 'selected' : ''}>40 mins</option>
                  <option value="45 mins" ${event.event_duration === '45 mins' ? 'selected' : ''}>45 mins</option>
                  <option value="60 mins" ${event.event_duration === '60 mins' ? 'selected' : ''}>60 mins</option>
                  <option value="90 mins" ${event.event_duration === '90 mins' ? 'selected' : ''}>90 mins</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label>Description</label><textarea id="editEventDescription" rows="3">${event.event_description || ''}</textarea></div>
            <div class="form-row">
              <div class="form-group"><label>Status</label>
                <select id="editEventStatus">
                  <option value="Active" ${event.status === 'Active' ? 'selected' : ''}>Active</option>
                  <option value="Cancelled" ${event.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                  <option value="Completed" ${event.status === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
              </div>
              <div class="form-group"><label>Max Participants</label><input type="number" id="editEventMaxParticipants" value="${event.max_participants || ''}"></div>
            </div>
            <div class="form-group"><label>Meet Link</label><input type="text" id="editEventMeetLink" value="${event.meet_link|| ''}"></div>
            <button type="submit" class="btn btn-primary">Update Event</button>
          </form>
        `;

        document.getElementById('editEventForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await updateEvent(eventId);
        });

        document.getElementById('eventModal').classList.add('active');
      } catch (err) {
        alert('Error loading event: ' + err.message);
      }
    }

    async function updateEvent(eventId) {
      const data = {
        event_name: document.getElementById('editEventName').value,
        event_description: document.getElementById('editEventDescription').value,
        event_duration: document.getElementById('editEventDuration').value,
        status: document.getElementById('editEventStatus').value,
        max_participants: document.getElementById('editEventMaxParticipants').value || null,
        meet_link: document.getElementById('editEventMeetLink').value
      };

      try {
        const res = await fetch(`/api/events/${eventId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('‚úÖ Event updated successfully!');
          closeEventModal();
          loadEvents();
        } else {
          const err = await res.json();
          alert('‚ùå Failed: ' + err.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    async function viewEventRegistrations(eventId, eventName) {
      try {
        const res = await fetch(`/api/events/${eventId}/all-registrations`);
        const registrations = await res.json();

        document.getElementById('eventRegistrationsTitle').textContent = `üë• ${eventName} - Registrations`;

        const regLink = `${window.location.origin}/event-register.html?id=${eventId}`;

        if (registrations.length === 0) {
          document.getElementById('eventRegistrationsContent').innerHTML = `
            <div style="margin-bottom: 15px; padding: 12px; background: #f0f4ff; border-radius: 8px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
              <strong style="color: #4a5568;">Public Registration Link:</strong>
              <input type="text" value="${regLink}" readonly style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px;">
              <button onclick="navigator.clipboard.writeText('${regLink}').then(() => this.textContent = 'Copied!').catch(() => {})" class="btn btn-sm" style="background: #667eea; color: white;">Copy Link</button>
            </div>
            <p style="text-align: center; color: #718096; padding: 40px;">No registrations yet. Share the link above on Instagram!</p>
          `;
        } else {
          document.getElementById('eventRegistrationsContent').innerHTML = `
            <div style="margin-bottom: 15px; padding: 12px; background: #f0f4ff; border-radius: 8px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
              <strong style="color: #4a5568;">Public Registration Link:</strong>
              <input type="text" value="${regLink}" readonly style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px;">
              <button onclick="navigator.clipboard.writeText('${regLink}').then(() => this.textContent = 'Copied!').catch(() => {})" class="btn btn-sm" style="background: #667eea; color: white;">Copy Link</button>
            </div>
            <p style="margin-bottom: 15px; color: #4a5568;"><strong>Total Registered:</strong> ${registrations.length}</p>
            <div style="overflow-x: auto;">
              <table>
                <thead><tr><th>Child Name</th><th>Age</th><th>Parent Name</th><th>Email</th><th>Phone</th><th>Source</th><th>Registered</th><th>Attendance</th></tr></thead>
                <tbody>
                  ${registrations.map(r => `
                    <tr>
                      <td><strong>${r.display_child_name || '-'}</strong></td>
                      <td>${r.display_grade || '-'}</td>
                      <td>${r.display_parent_name || '-'}</td>
                      <td>${r.display_email || '-'}</td>
                      <td>${r.phone || r.student_phone || '-'}</td>
                      <td><span class="type-badge" style="background: ${r.reg_type === 'Public Registration' ? '#f0fff4; color: #38a169' : '#f0f4ff; color: #667eea'}">${r.reg_type}</span></td>
                      <td>${new Date(r.registered_at).toLocaleDateString()}</td>
                      <td><span class="type-badge ${r.attendance === 'Present' ? 'attendance-present' : r.attendance === 'Absent' ? 'attendance-absent' : 'attendance-pending'}">${r.attendance || 'Pending'}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        document.getElementById('eventRegistrationsModal').classList.add('active');
      } catch (err) {
        alert('Error loading registrations: ' + err.message);
      }
    }

    function closeEventRegistrationsModal() {
      document.getElementById('eventRegistrationsModal').classList.remove('active');
    }

    async function markEventAttendance(eventId, eventName) {
      try {
        const res = await fetch(`/api/events/${eventId}/all-registrations`);
        const registrations = await res.json();
        currentEventId = eventId;

        document.getElementById('eventAttendanceTitle').textContent = `‚úÖ ${eventName} - Mark Attendance`;

        if (registrations.length === 0) {
          document.getElementById('eventAttendanceContent').innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No registrations to mark attendance</p>';
        } else {
          document.getElementById('eventAttendanceContent').innerHTML = `
            <p style="margin-bottom: 15px; color: #4a5568;">Mark attendance for all registered participants:</p>
            <table>
              <thead><tr><th>Name</th><th>Age</th><th>Source</th><th>Current Status</th><th>Mark Attendance</th></tr></thead>
              <tbody>
                ${registrations.map(r => `
                  <tr>
                    <td><strong>${r.display_child_name || '-'}</strong></td>
                    <td>${r.display_grade || '-'}</td>
                    <td><span class="type-badge" style="background: ${r.reg_type === 'Public Registration' ? '#f0fff4; color: #38a169' : '#f0f4ff; color: #667eea'}">${r.reg_type}</span></td>
                    <td><span class="type-badge ${r.attendance === 'Present' ? 'attendance-present' : r.attendance === 'Absent' ? 'attendance-absent' : 'attendance-pending'}">${r.attendance || 'Pending'}</span></td>
                    <td>
                      <button onclick="saveEventAttendance(${eventId}, ${r.id}, 'Present')" class="btn btn-sm btn-success">Present</button>
                      <button onclick="saveEventAttendance(${eventId}, ${r.id}, 'Absent')" class="btn btn-sm btn-danger">Absent</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        document.getElementById('eventAttendanceModal').classList.add('active');
      } catch (err) {
        alert('Error loading attendance: ' + err.message);
      }
    }

    function closeEventAttendanceModal() {
      document.getElementById('eventAttendanceModal').classList.remove('active');
    }

    async function saveEventAttendance(eventId, registrationId, status) {
      try {
        const res = await fetch(`/api/events/${eventId}/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ attendanceData: [{ registration_id: registrationId, attendance: status }] })
        });

        if (res.ok) {
          alert('‚úÖ Attendance marked!');
          // Refresh the modal
          const event = await (await fetch(`/api/events/${eventId}`)).json();
          markEventAttendance(eventId, event.event_name);
        } else {
          alert('‚ùå Failed to mark attendance');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // ==================== EVENT CERTIFICATES ====================
    async function openEventCertificates(eventId, eventName) {
      try {
        const res = await fetch(`/api/events/${eventId}/all-registrations`);
        const registrations = await res.json();

        document.getElementById('eventCertificatesTitle').textContent = `üèÜ ${eventName} - Participation Certificates`;

        // Filter to only show present attendees
        const present = registrations.filter(r => r.attendance === 'Present');

        if (present.length === 0) {
          document.getElementById('eventCertificatesContent').innerHTML = `
            <p style="text-align: center; color: #718096; padding: 40px;">No attendees marked as "Present" yet.<br>Please mark attendance first before sending certificates.</p>
          `;
        } else {
          document.getElementById('eventCertificatesContent').innerHTML = `
            <p style="margin-bottom: 15px; color: #4a5568;">Send participation certificates to attendees who were marked <strong>Present</strong>:</p>
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="selectAllEventCerts()" class="btn btn-sm" style="background: #667eea; color: white;">Select All</button>
              <button onclick="deselectAllEventCerts()" class="btn btn-sm" style="background: #718096; color: white;">Deselect All</button>
              <button onclick="sendSelectedEventCerts(${eventId})" class="btn btn-sm" style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); color: white; font-weight: 600;">üìß Send Selected Certificates</button>
            </div>
            <table>
              <thead><tr><th><input type="checkbox" id="selectAllCertCheckbox" onchange="toggleAllEventCerts(this)" checked></th><th>Name</th><th>Email</th><th>Source</th><th>Certificate Status</th></tr></thead>
              <tbody>
                ${present.map(r => {
                  const email = r.display_email || '';
                  const sent = r.certificate_sent;
                  return `
                    <tr>
                      <td><input type="checkbox" class="cert-checkbox" value="${r.id}" ${sent ? '' : 'checked'} data-email="${email}"></td>
                      <td><strong>${r.display_child_name || '-'}</strong></td>
                      <td>${email || '<span style="color:#e53e3e;">No email</span>'}</td>
                      <td><span class="type-badge" style="background: ${r.reg_type === 'Public Registration' ? '#f0fff4; color: #38a169' : '#f0f4ff; color: #667eea'}">${r.reg_type}</span></td>
                      <td>${sent ? '<span style="color:#38a169; font-weight:600;">‚úÖ Sent</span>' : '<span style="color:#718096;">Not sent</span>'}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        }
        document.getElementById('eventCertificatesModal').classList.add('active');
      } catch (err) {
        alert('Error loading certificates: ' + err.message);
      }
    }

    function closeEventCertificatesModal() {
      document.getElementById('eventCertificatesModal').classList.remove('active');
    }

    function selectAllEventCerts() {
      document.querySelectorAll('.cert-checkbox').forEach(cb => cb.checked = true);
      const selectAll = document.getElementById('selectAllCertCheckbox');
      if (selectAll) selectAll.checked = true;
    }

    function deselectAllEventCerts() {
      document.querySelectorAll('.cert-checkbox').forEach(cb => cb.checked = false);
      const selectAll = document.getElementById('selectAllCertCheckbox');
      if (selectAll) selectAll.checked = false;
    }

    function toggleAllEventCerts(masterCheckbox) {
      document.querySelectorAll('.cert-checkbox').forEach(cb => cb.checked = masterCheckbox.checked);
    }

    async function sendSelectedEventCerts(eventId) {
      const selected = [];
      document.querySelectorAll('.cert-checkbox:checked').forEach(cb => {
        if (cb.getAttribute('data-email')) {
          selected.push(parseInt(cb.value));
        }
      });

      if (selected.length === 0) {
        alert('Please select at least one attendee with a valid email.');
        return;
      }

      if (!confirm(`Send participation certificates to ${selected.length} attendee(s)?`)) return;

      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Sending...';
      btn.disabled = true;

      try {
        const res = await fetch(`/api/events/${eventId}/send-certificates`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ registration_ids: selected })
        });

        const result = await res.json();
        if (res.ok) {
          alert(`‚úÖ ${result.message}`);
          // Refresh the modal
          const eventRes = await fetch(`/api/events/${eventId}`);
          const eventData = await eventRes.json();
          openEventCertificates(eventId, eventData.event_name);
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // ==================== FINANCIAL REPORTS ====================
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    function initFinancialYearDropdown() {
      const select = document.getElementById('financialYear');
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth();
      // If before April, current FY started last year
      const currentFY = currentMonth < 3 ? currentYear - 1 : currentYear;

      select.innerHTML = '<option value="">All Time</option>';
      for (let y = currentFY; y >= currentFY - 5; y--) {
        select.innerHTML += `<option value="${y}">FY ${y}-${(y + 1).toString().slice(-2)}</option>`;
      }
    }

    async function loadFinancialReports() {
      const year = document.getElementById('financialYear').value;
      const startDate = document.getElementById('finStartDate').value;
      const endDate = document.getElementById('finEndDate').value;

      let url = '/api/financial-reports?';
      if (year) url += `year=${year}&`;
      if (startDate && endDate) url += `startDate=${startDate}&endDate=${endDate}&`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        // Update income totals
        let inrTotal = 0, usdTotal = 0;
        data.totals.forEach(t => {
          if (t.currency === 'INR') inrTotal = parseFloat(t.total_amount) || 0;
          if (t.currency === 'USD') usdTotal = parseFloat(t.total_amount) || 0;
        });
        document.getElementById('totalIncomeINR').textContent = '‚Çπ' + inrTotal.toLocaleString('en-IN');
        document.getElementById('totalIncomeUSD').textContent = '$' + usdTotal.toLocaleString('en-US');

        // Load expenses for totals
        let expUrl = '/api/expenses?';
        if (year) expUrl += `year=${year}&`;
        if (startDate && endDate) expUrl += `startDate=${startDate}&endDate=${endDate}&`;

        const expRes = await fetch(expUrl);
        const expData = await expRes.json();

        let expInrTotal = 0;
        expData.grandTotal.forEach(t => {
          if (t.currency === 'INR') expInrTotal = parseFloat(t.total_amount) || 0;
        });
        document.getElementById('totalExpensesINR').textContent = '‚Çπ' + expInrTotal.toLocaleString('en-IN');
        document.getElementById('netProfitINR').textContent = '‚Çπ' + (inrTotal - expInrTotal).toLocaleString('en-IN');

        // Monthly summary table
        const monthlyBody = document.getElementById('monthlyIncomeBody');
        if (data.monthlySummary.length === 0) {
          monthlyBody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #718096;">No payments found</td></tr>';
        } else {
          // Group by month/year
          const monthlyData = {};
          data.monthlySummary.forEach(m => {
            const key = `${m.year}-${m.month}`;
            if (!monthlyData[key]) monthlyData[key] = { year: m.year, month: m.month, INR: 0, USD: 0, count: 0 };
            if (m.currency === 'INR') monthlyData[key].INR = parseFloat(m.total_amount);
            if (m.currency === 'USD') monthlyData[key].USD = parseFloat(m.total_amount);
            monthlyData[key].count += parseInt(m.payment_count);
          });

          monthlyBody.innerHTML = Object.values(monthlyData).map(m => `
            <tr>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${monthNames[m.month - 1]} ${m.year}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: right; font-weight: 600; color: #38a169;">‚Çπ${m.INR.toLocaleString('en-IN')}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: right; font-weight: 600; color: #3182ce;">$${m.USD.toLocaleString('en-US')}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: right;">${m.count}</td>
            </tr>
          `).join('');
        }

        // Recent payments table
        const paymentsBody = document.getElementById('recentPaymentsBody');
        if (data.payments.length === 0) {
          paymentsBody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #718096;">No payments found</td></tr>';
        } else {
          paymentsBody.innerHTML = data.payments.slice(0, 100).map(p => `
            <tr>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${new Date(p.payment_date).toLocaleDateString('en-IN')}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${p.student_name || '<span style="color:#e53e3e;">Deleted Student</span>'}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${p.parent_name || '-'}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: right; font-weight: 600;">${p.currency === 'USD' ? '$' : '‚Çπ'}${parseFloat(p.amount).toLocaleString()}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${p.payment_method || '-'}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${p.sessions_covered || '-'}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
                <button onclick="openEditPaymentRecord(${p.id}, '${p.payment_date ? p.payment_date.split('T')[0] : ''}', ${parseFloat(p.amount)}, '${p.currency}', '${(p.payment_method || '').replace(/'/g, "\\'")}', '${(p.sessions_covered || '').replace(/'/g, "\\'")}', '${(p.notes || '').replace(/'/g, "\\'")}')" class="btn btn-sm btn-warning" title="Edit this payment">‚úèÔ∏è</button>
                <button onclick="deletePaymentRecord(${p.id}, '${(p.student_name || 'Unknown').replace(/'/g, "\\'")}', '${p.currency === 'USD' ? '$' : '‚Çπ'}${parseFloat(p.amount).toLocaleString()}')" class="btn btn-sm btn-danger" title="Delete this payment record">üóëÔ∏è</button>
              </td>
            </tr>
          `).join('');
        }

        // Load expenses list
        loadExpenses();
      } catch (err) {
        console.error('Error loading financial reports:', err);
      }
    }

    async function loadExpenses() {
      const year = document.getElementById('financialYear').value;
      const startDate = document.getElementById('finStartDate').value;
      const endDate = document.getElementById('finEndDate').value;

      let url = '/api/expenses?';
      if (year) url += `year=${year}&`;
      if (startDate && endDate) url += `startDate=${startDate}&endDate=${endDate}&`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        // Category summary cards
        const summaryDiv = document.getElementById('expenseCategorySummary');
        if (data.categoryTotals.length === 0) {
          summaryDiv.innerHTML = '<p style="color: #718096;">No expenses recorded</p>';
        } else {
          summaryDiv.innerHTML = data.categoryTotals.map(c => `
            <div style="background: #fff5f5; padding: 15px; border-radius: 10px; border-left: 4px solid #ed8936;">
              <h4 style="margin: 0 0 5px; color: #744210; font-size: 13px;">${c.category}</h4>
              <p style="margin: 0; font-size: 20px; font-weight: bold; color: #c05621;">${c.currency === 'USD' ? '$' : '‚Çπ'}${parseFloat(c.total_amount).toLocaleString()}</p>
              <p style="margin: 5px 0 0; font-size: 12px; color: #975a16;">${c.count} expense(s)</p>
            </div>
          `).join('');
        }

        // Expenses table
        const expBody = document.getElementById('expensesBody');
        if (data.expenses.length === 0) {
          expBody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #718096;">No expenses found. Add your first expense above!</td></tr>';
        } else {
          expBody.innerHTML = data.expenses.map(e => `
            <tr>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${new Date(e.expense_date).toLocaleDateString('en-IN')}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><span style="background: #feebc8; padding: 3px 8px; border-radius: 4px; font-size: 12px;">${e.category}</span></td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${e.description}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: right; font-weight: 600; color: #c05621;">${e.currency === 'USD' ? '$' : '‚Çπ'}${parseFloat(e.amount).toLocaleString()}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${e.payment_method || '-'}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
                <button onclick="openEditExpense(${e.id}, '${e.expense_date ? e.expense_date.split('T')[0] : ''}', '${(e.category || '').replace(/'/g, "\\'")}', '${(e.description || '').replace(/'/g, "\\'")}', ${parseFloat(e.amount)}, '${e.currency}', '${(e.payment_method || '').replace(/'/g, "\\'")}', '${(e.notes || '').replace(/'/g, "\\'")}')" class="btn btn-sm btn-warning">‚úèÔ∏è</button>
                <button onclick="deleteExpense(${e.id})" class="btn btn-sm btn-danger">üóëÔ∏è</button>
              </td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error('Error loading expenses:', err);
      }
    }

    async function addExpense() {
      const expense = {
        expense_date: document.getElementById('expenseDate').value,
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount: document.getElementById('expenseAmount').value,
        currency: document.getElementById('expenseCurrency').value,
        payment_method: document.getElementById('expensePaymentMethod').value,
        notes: document.getElementById('expenseNotes').value
      };

      if (!expense.expense_date || !expense.category || !expense.description || !expense.amount) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const res = await fetch('/api/expenses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(expense)
        });

        if (res.ok) {
          alert('‚úÖ Expense added successfully!');
          // Clear form
          document.getElementById('expenseDate').value = '';
          document.getElementById('expenseCategory').value = '';
          document.getElementById('expenseDescription').value = '';
          document.getElementById('expenseAmount').value = '';
          document.getElementById('expenseNotes').value = '';
          // Reload data
          loadFinancialReports();
        } else {
          alert('‚ùå Failed to add expense');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    async function deleteExpense(id) {
      if (!confirm('Are you sure you want to delete this expense?')) return;

      try {
        const res = await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert('‚úÖ Expense deleted');
          loadFinancialReports();
        } else {
          alert('‚ùå Failed to delete expense');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    async function deletePaymentRecord(id, studentName, amount) {
      if (!confirm(`Delete payment record?\n\nStudent: ${studentName}\nAmount: ${amount}\n\nThis is for removing test/trial payments only. This action cannot be undone.`)) return;

      try {
        const res = await fetch(`/api/payment-history/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert('‚úÖ Payment record deleted');
          loadFinancialReports();
        } else {
          alert('‚ùå Failed to delete payment record');
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    function clearFinancialFilters() {
      document.getElementById('financialYear').value = '';
      document.getElementById('finStartDate').value = '';
      document.getElementById('finEndDate').value = '';
      loadFinancialReports();
    }

    function exportIncomeReport() {
      const year = document.getElementById('financialYear').value;
      const startDate = document.getElementById('finStartDate').value;
      const endDate = document.getElementById('finEndDate').value;

      let url = '/api/financial-reports/export?';
      if (year) url += `year=${year}&`;
      if (startDate && endDate) url += `startDate=${startDate}&endDate=${endDate}&`;

      window.location.href = url;
    }

    function exportExpensesReport() {
      const year = document.getElementById('financialYear').value;
      const startDate = document.getElementById('finStartDate').value;
      const endDate = document.getElementById('finEndDate').value;

      let url = '/api/expenses/export?';
      if (year) url += `year=${year}&`;
      if (startDate && endDate) url += `startDate=${startDate}&endDate=${endDate}&`;

      window.location.href = url;
    }

    function exportMergedReport() {
      const year = document.getElementById('financialYear').value;
      const startDate = document.getElementById('finStartDate').value;
      const endDate = document.getElementById('finEndDate').value;

      let url = '/api/financial-reports/export-merged?';
      if (year) url += `year=${year}&`;
      if (startDate && endDate) url += `startDate=${startDate}&endDate=${endDate}&`;

      window.location.href = url;
    }

    // Edit Payment Record (in financial summary)
    function openEditPaymentRecord(id, date, amount, currency, method, sessions, notes) {
      document.getElementById('editPRId').value = id;
      document.getElementById('editPRDate').value = date;
      document.getElementById('editPRAmount').value = amount;
      document.getElementById('editPRCurrency').value = currency || 'INR';
      document.getElementById('editPRMethod').value = method || '';
      document.getElementById('editPRSessions').value = sessions || '';
      document.getElementById('editPRNotes').value = notes || '';
      document.getElementById('editPaymentRecordModal').classList.add('active');
    }

    async function saveEditPaymentRecord() {
      const id = document.getElementById('editPRId').value;
      const data = {
        payment_date: document.getElementById('editPRDate').value,
        amount: parseFloat(document.getElementById('editPRAmount').value),
        currency: document.getElementById('editPRCurrency').value,
        payment_method: document.getElementById('editPRMethod').value,
        sessions_covered: document.getElementById('editPRSessions').value,
        notes: document.getElementById('editPRNotes').value
      };

      if (!data.payment_date || !data.amount) {
        alert('Please fill in date and amount');
        return;
      }

      try {
        const res = await fetch(`/api/payment-history/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          alert('Payment updated successfully!');
          document.getElementById('editPaymentRecordModal').classList.remove('active');
          loadFinancialReports();
        } else {
          alert('Failed to update payment');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Edit Expense
    function openEditExpense(id, date, category, description, amount, currency, method, notes) {
      document.getElementById('editExpId').value = id;
      document.getElementById('editExpDate').value = date;
      document.getElementById('editExpCategory').value = category || '';
      document.getElementById('editExpDescription').value = description || '';
      document.getElementById('editExpAmount').value = amount;
      document.getElementById('editExpCurrency').value = currency || 'INR';
      document.getElementById('editExpMethod').value = method || '';
      document.getElementById('editExpNotes').value = notes || '';
      document.getElementById('editExpenseModal').classList.add('active');
    }

    async function saveEditExpense() {
      const id = document.getElementById('editExpId').value;
      const data = {
        expense_date: document.getElementById('editExpDate').value,
        category: document.getElementById('editExpCategory').value,
        description: document.getElementById('editExpDescription').value,
        amount: parseFloat(document.getElementById('editExpAmount').value),
        currency: document.getElementById('editExpCurrency').value,
        payment_method: document.getElementById('editExpMethod').value,
        notes: document.getElementById('editExpNotes').value
      };

      if (!data.expense_date || !data.category || !data.description || !data.amount) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const res = await fetch(`/api/expenses/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          alert('Expense updated successfully!');
          document.getElementById('editExpenseModal').classList.remove('active');
          loadFinancialReports();
        } else {
          alert('Failed to update expense');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Initialize financial year dropdown on page load
    initFinancialYearDropdown();

    // Load students due for assessment
    function loadDueAssessments() {
      const dueStudents = allStudents.filter(s => s.assessment_due);
      const alertDiv = document.getElementById('dueAssessmentAlert');
      const listDiv = document.getElementById('dueAssessmentList');

      if (dueStudents.length === 0) {
        alertDiv.style.display = 'none';
        return;
      }

      alertDiv.style.display = 'block';
      listDiv.innerHTML = dueStudents.map(s => `
        <button onclick="document.getElementById('assessmentStudent').value='${s.id}'; document.getElementById('assessmentStudent').scrollIntoView({behavior:'smooth'});"
          style="background: white; border: 2px solid #f59e0b; color: #92400e; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s;"
          onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
          <span>${s.name}</span>
          <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${s.sessions_since_assessment} sessions</span>
        </button>
      `).join('');

      // Also populate the assessment student dropdown
      const select = document.getElementById('assessmentStudent');
      if (select) {
        select.innerHTML = '<option value="">Select Student...</option>' + allStudents.map(s => {
          const dueBadge = s.assessment_due ? ' ‚ö†Ô∏è DUE' : '';
          return `<option value="${s.id}">${s.name}${dueBadge}</option>`;
        }).join('');
      }
    }
  </script>

      <!-- Footer -->
      <footer style="background: white; padding: 20px; text-align: center; margin: 30px 0 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <p style="margin: 0; color: #B05D9E; font-size: 14px; font-weight: 600;">Made with ‚ù§Ô∏è By Aaliya</p>
      </footer>
    </main>
  </div>
</body>
</html>