<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Fluent Feathers Academy By Aaliya</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ğŸ“ Admin Dashboard </h1>
        <p>Fluent Feathers Academy By Aaliya - Professional LMS</p>
      </div>
      <button onclick="location.href='index.html'" class="logout-btn">Logout</button>
    </header>

    <!-- Enhanced Navigation Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('dashboard', this)">ğŸ“Š Dashboard</button>
      <button class="tab-btn" onclick="showTab('students', this)">ğŸ‘¥ Students</button>
      <button class="tab-btn" onclick="showTab('sessions', this)">ğŸ“… Sessions</button>
      <button class="tab-btn" onclick="showTab('materials', this)">ğŸ“š Materials</button>
      <button class="tab-btn" onclick="showTab('events', this)">ğŸ‰ Events</button>
      <button class="tab-btn" onclick="showTab('batches', this)">ğŸ‘¥ Batches</button>
      <button class="tab-btn" onclick="showTab('timetable', this)">ğŸ—“ï¸ Timetable</button>
      <button class="tab-btn" onclick="showTab('emails', this)">ğŸ“§ Emails</button>
    </div>

    <!-- ==================== DASHBOARD TAB ==================== -->
    <div id="dashboardTab" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-value" id="totalStudents">0</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-value" id="upcomingSessions">0</div>
          <div class="stat-label">Upcoming Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“š</div>
          <div class="stat-value" id="todaySessions">0</div>
          <div class="stat-label">Today's Classes</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-value" id="totalRevenue">â‚¹0</div>
          <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ‰</div>
          <div class="stat-value" id="upcomingEvents">0</div>
          <div class="stat-label">Upcoming Events</div>
        </div>
      </div>

      <button onclick="showTab('students', document.querySelector('.tab-btn:nth-child(2)'))" class="action-btn">
  ğŸ‘¥ Manage Students
</button>

<button onclick="showTab('sessions')" class="action-btn">ğŸ“… Schedule Classes</button>
<button onclick="showTab('materials')" class="action-btn">ğŸ“¤ Upload Material</button>
<button onclick="showTab('events')" class="action-btn">ğŸ‰ Create Event</button>
<button onclick="window.open('https://us04web.zoom.us/j/7288533155?pwd=Nng5N2l0aU12L0FQK245c0VVVHJBUT09', '_blank')" class="action-btn">
  ğŸ¥ Join Zoom
</button>


      <!-- Recent Activity -->
      <div class="recent-activity">
        <h2>ğŸ“‹ Recent Activity</h2>
        <div id="recentActivityList">
          <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading recent activity...</p>
        </div>
      </div>
    </div>

<!-- CONTINUE TO PART 2 FOR STUDENTS TAB --><!-- ==================== STUDENTS TAB ==================== -->
    <div id="studentsTab" class="tab-content">
      <!-- Add Student Form -->
      <section class="form-section">
        <h2>â• Add New Student</h2>
        <form id="addStudentForm">
          <div class="form-row">
            <div class="form-group">
              <label>Student Name *</label>
              <input type="text" id="studentName" required>
            </div>
            <div class="form-group">
              <label>Grade *</label>
              <input type="text" id="grade" required placeholder="e.g., Grade 5">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Parent Name *</label>
              <input type="text" id="parentName" required>
            </div>
            <div class="form-group">
              <label>Parent Email *</label>
              <input type="email" id="parentEmail" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Primary Contact Number *</label>
              <input type="tel" id="primaryContact" required placeholder="+91 98765 43210" pattern="[+0-9\s\-()]+">
            </div>
            <div class="form-group">
              <label>Alternate Contact Number</label>
              <input type="tel" id="alternateContact" placeholder="+91 98765 43210 (Optional)" pattern="[+0-9\s\-()]+">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Timezone *</label>
              <select id="timezone" required>
                <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                <option value="Asia/Dhaka">Asia/Dhaka (BST - Bangladesh)</option>
                <option value="America/New_York">America/New_York (EST)</option>
                <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
                <option value="Europe/London">Europe/London (GMT)</option>
                <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
                <option value="Australia/Sydney">Australia/Sydney (AEDT)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Program Name *</label>
              <input type="text" id="programName" required placeholder="e.g., English Speaking">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Class Type *</label>
              <select id="classType" required>
                <option value="">Select...</option>
                <option value="Private">Private</option>
                <option value="Group">Group</option>
              </select>
            </div>
            <div class="form-group">
              <label>Duration *</label>
              <select id="duration" required>
                <option value="">Select...</option>
                <option value="25 mins">25 mins</option>
                <option value="40 mins">40 mins</option>
                <option value="60 mins">60 mins</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Currency *</label>
              <select id="currency" required>
                <option value="â‚¹">â‚¹ (INR - Indian Rupee)</option>
                <option value="à§³">à§³ (BDT - Bangladeshi Taka)</option>
                <option value="$">$ (USD - US Dollar)</option>
                <option value="â‚¬">â‚¬ (EUR - Euro)</option>
                <option value="Â£">Â£ (GBP - British Pound)</option>
                <option value="Ø¯.Ø¥">Ø¯.Ø¥ (AED - UAE Dirham)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Per Session Fee *</label>
              <input type="number" id="perSessionFee" required min="0" step="0.01">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Total Sessions *</label>
              <input type="number" id="totalSessions" required min="1">
            </div>
            <div class="form-group">
              <label>Total Fees (Auto-calculated)</label>
              <input type="text" id="totalFees" readonly style="background: #f0f0f0;">
            </div>
          </div>

          <button type="submit" class="btn-primary">Add Student & Send Welcome Email</button>
        </form>
      </section>

      <!-- All Students Table -->
      <section class="table-section">
        <h2>ğŸ“‹ All Active Students</h2>
        <div class="table-filters">
          <input type="text" id="searchStudents" placeholder="ğŸ” Search students..." style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; width: 300px;">
        </div>
        
        <table id="studentsTable">
          <thead>
            <tr>
              <th>Student & Grade</th>
              <th>Program</th>
              <th>Type</th>
              <th>Timezone</th>
              <th>Currency</th>
              <th>Per Session</th>
              <th>Sessions (C/R)</th>
              <th>Payment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="studentsTableBody">
            <tr><td colspan="9" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <!-- Student Details Modal -->
    <div id="studentDetailsModal" class="modal" style="display: none;">
      <div class="modal-content large-modal">
        <div class="modal-header">
          <h2 id="modalStudentName">Student Details</h2>
          <button onclick="closeStudentModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
        </div>

        <div class="student-details-tabs">
          <button class="detail-tab-btn active" onclick="showDetailTab('info', this)">ğŸ“‹ Info</button>
          <button class="detail-tab-btn" onclick="showDetailTab('payments', this)">ğŸ’° Payments</button>
          <button class="detail-tab-btn" onclick="showDetailTab('makeup', this)">ğŸ Make-up Classes</button>
          <button class="detail-tab-btn" onclick="showDetailTab('sessions', this)">ğŸ“… Sessions</button>
        </div>

        <!-- Info Tab -->
        <div id="infoDetail" class="detail-tab-content active">
  <div id="studentInfoContent"></div>
  
  <!-- âœ… ADD THIS NEW SECTION -->
  <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
    <h3 style="color: white; margin: 0 0 10px 0;">ğŸ‘¤ View as Parent</h3>
    <p style="color: white; margin: 0 0 15px 0; opacity: 0.9;">
      View this student's parent portal to see what parents see
    </p>
    <button onclick="switchToLearnerView()" class="btn-primary" 
            style="background: white; color: #667eea; font-weight: bold;">
      ğŸ”„ Switch to Learner View
    </button>
  </div>
</div>

        <!-- Payments Tab -->
        <div id="paymentsDetail" class="detail-tab-content">
          <button onclick="showPaymentForm()" class="btn-primary" style="margin-bottom: 20px;">+ Record New Payment</button>
          
          <div id="paymentFormSection" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3>Record Payment</h3>
            <form id="recordPaymentForm">
              <div class="form-row">
                <div class="form-group">
                  <label>Amount *</label>
                  <input type="number" id="paymentAmount" required step="0.01">
                </div>
                <div class="form-group">
                  <label>Payment Method *</label>
                  <select id="paymentMethod" required>
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="UPI">UPI</option>
                    <option value="Card">Credit/Debit Card</option>
                    <option value="Check">Check</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Receipt Number</label>
                  <input type="text" id="receiptNumber" placeholder="Optional">
                </div>
                <div class="form-group">
                  <label>Sessions Covered</label>
                  <input type="text" id="sessionsCovered" placeholder="e.g., Sessions 1-10">
                </div>
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea id="paymentNotes" rows="2" placeholder="Additional notes..."></textarea>
              </div>
              <button type="submit" class="btn-primary">Record Payment</button>
              <button type="button" onclick="hidePaymentForm()" class="btn-secondary">Cancel</button>
            </form>
          </div>

          <table id="paymentHistoryTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Receipt #</th>
                <th>Sessions</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="paymentHistoryBody"></tbody>
          </table>
        </div>

        <!-- Make-up Classes Tab -->
        <div id="makeupDetail" class="detail-tab-content">
          <div id="makeupClassesContent"></div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessionsDetail" class="detail-tab-content">
          <div id="studentSessionsContent"></div>
        </div>
      </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="modal" style="display: none;">
      <div class="modal-content large-modal">
        <div class="modal-header">
          <h2>âœï¸ Edit Student Details</h2>
          <button onclick="closeEditModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
        </div>

        <form id="editStudentForm">
          <div class="form-row">
            <div class="form-group">
              <label>Student Name *</label>
              <input type="text" id="editStudentName" required>
            </div>
            <div class="form-group">
              <label>Grade *</label>
              <input type="text" id="editGrade" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Parent Name *</label>
              <input type="text" id="editParentName" required>
            </div>
            <div class="form-group">
              <label>Parent Email *</label>
              <input type="email" id="editParentEmail" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Primary Contact *</label>
              <input type="tel" id="editPrimaryContact" required>
            </div>
            <div class="form-group">
              <label>Alternate Contact</label>
              <input type="tel" id="editAlternateContact">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Timezone *</label>
              <select id="editTimezone" required>
                <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                <option value="Asia/Dhaka">Asia/Dhaka (BST - Bangladesh)</option>
                <option value="America/New_York">America/New_York (EST)</option>
                <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
                <option value="Europe/London">Europe/London (GMT)</option>
                <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
                <option value="Australia/Sydney">Australia/Sydney (AEDT)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Program Name *</label>
              <input type="text" id="editProgramName" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Class Type *</label>
              <select id="editClassType" required>
                <option value="Private">Private</option>
                <option value="Group">Group</option>
              </select>
            </div>
            <div class="form-group">
              <label>Duration *</label>
              <select id="editDuration" required>
                <option value="25 mins">25 mins</option>
                <option value="40 mins">40 mins</option>
                <option value="60 mins">60 mins</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Currency *</label>
              <select id="editCurrency" required>
                <option value="â‚¹">â‚¹ (INR)</option>
                <option value="à§³">à§³ (BDT)</option>
                <option value="$">$ (USD)</option>
                <option value="â‚¬">â‚¬ (EUR)</option>
                <option value="Â£">Â£ (GBP)</option>
                <option value="Ø¯.Ø¥">Ø¯.Ø¥ (AED)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Per Session Fee *</label>
              <input type="number" id="editPerSessionFee" required step="0.01">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Total Sessions *</label>
              <input type="number" id="editTotalSessions" required min="1">
            </div>
            <div class="form-group">
              <label>Total Fees (Auto-calculated)</label>
              <input type="text" id="editTotalFees" readonly style="background: #f0f0f0;">
            </div>
          </div>

          <button type="submit" class="btn-primary">ğŸ’¾ Save Changes</button>
          <button type="button" onclick="closeEditModal()" class="btn-secondary">Cancel</button>
        </form>
      </div>
    </div>

    <!-- ==================== SESSIONS TAB ==================== -->
    <div id="sessionsTab" class="tab-content">
      <section class="form-section">
        <h2>ğŸ“… Schedule Classes</h2>
        <form id="scheduleForm">
          <div class="form-group">
            <label>Select Student *</label>
            <select id="scheduleStudentId" required>
              <option value="">Select student...</option>
            </select>
          </div>
          
          <div id="classScheduleList"></div>
          
          <div style="margin: 20px 0;">
            <button type="button" onclick="addScheduleRow()" class="btn-secondary">+ Add Class</button>
            <button type="button" onclick="addBulkSchedule()" class="btn-secondary">ğŸ“… Bulk Schedule (Weekly Pattern)</button>
          </div>
          
          <button type="submit" class="btn-primary">Schedule All Classes & Send Email</button>
        </form>
      </section>

      <!-- Bulk Schedule Section -->
      <div id="bulkScheduleSection" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3>ğŸ“… Bulk Schedule - Weekly Pattern</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Select Days *</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <label><input type="checkbox" value="Monday"> Monday</label>
              <label><input type="checkbox" value="Tuesday"> Tuesday</label>
              <label><input type="checkbox" value="Wednesday"> Wednesday</label>
              <label><input type="checkbox" value="Thursday"> Thursday</label>
              <label><input type="checkbox" value="Friday"> Friday</label>
              <label><input type="checkbox" value="Saturday"> Saturday</label>
              <label><input type="checkbox" value="Sunday"> Sunday</label>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Time *</label>
            <input type="time" id="bulkScheduleTime" required>
          </div>
          <div class="form-group">
            <label>Number of Weeks *</label>
            <input type="number" id="bulkScheduleWeeks" min="1" max="12" value="4">
          </div>
          <div class="form-group">
            <label>Start Date *</label>
            <input type="date" id="bulkScheduleStartDate" required>
          </div>
        </div>
        <button type="button" onclick="generateBulkSchedule()" class="btn-primary">Generate Schedule</button>
        <button type="button" onclick="closeBulkSchedule()" class="btn-secondary">Cancel</button>
      </div>

      <!-- Today's Attendance -->
      <section class="table-section">
        <h2>ğŸ“‹ Today's Classes - Quick Attendance</h2>
        <table id="todaySessionsTable">
          <thead>
            <tr>
              <th>Student</th>
              <th>Session #</th>
              <th>Time</th>
              <th>Program</th>
              <th>Status</th>
              <th>Quick Actions</th>
            </tr>
          </thead>
          <tbody id="todaySessionsBody">
            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </section>

      <!-- All Sessions -->
      <section class="table-section">
        <h2>ğŸ“… All Sessions</h2>
        <div class="form-row" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>Filter by Student</label>
            <select id="filterSessionStudent" onchange="loadAllSessions()">
              <option value="">All Students</option>
            </select>
          </div>
          <div class="form-group">
            <label>Filter by Status</label>
            <select id="filterSessionStatus" onchange="loadAllSessions()">
              <option value="">All Status</option>
              <option value="Pending">Pending</option>
              <option value="Scheduled">Scheduled</option>
              <option value="Completed">Completed</option>
              <option value="Missed">Missed</option>
              <option value="Cancelled by Teacher">Cancelled by Teacher</option>
              <option value="Cancelled by Parent">Cancelled by Parent</option>
            </select>
          </div>
        </div>
        
        <table id="allSessionsTable">
          <thead>
            <tr>
              <th>Session #</th>
              <th>Student</th>
              <th>Date</th>
              <th>Time</th>
              <th>Status</th>
              <th>Attendance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="allSessionsBody">
            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </section>
    </div>

<!-- CONTINUE TO PART 3 FOR MATERIALS, EVENTS & BATCHES TABS --><!-- ==================== MATERIALS TAB ==================== -->
    <div id="materialsTab" class="tab-content">
      <section class="form-section">
        <h2>ğŸ“¤ Upload Class Material</h2>
        <form id="uploadMaterialForm" enctype="multipart/form-data">
          <div class="form-row">
            <div class="form-group">
              <label>Upload Type *</label>
              <select id="uploadType" required onchange="toggleUploadTarget()">
                <option value="">Select...</option>
                <option value="private">Private Student</option>
                <option value="batch">Batch/Group</option>
              </select>
            </div>
            <div class="form-group" id="privateTargetGroup" style="display: none;">
              <label>Select Private Student *</label>
              <select id="privateStudentId">
                <option value="">Select student...</option>
              </select>
            </div>
            <div class="form-group" id="batchTargetGroup" style="display: none;">
              <label>Select Batch *</label>
              <select id="batchSelect">
                <option value="">Select batch...</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Session Date *</label>
              <input type="date" id="materialSessionDate" required>
            </div>
            <div class="form-group">
              <label>Material Type *</label>
              <select id="materialType" required>
                <option value="">Select...</option>
                <option value="PPT">ğŸ“Š PPT/Presentation</option>
                <option value="PDF">ğŸ“„ PDF/Document</option>
                <option value="Recording">ğŸ¥ Class Recording</option>
                <option value="Homework">ğŸ“ Homework Assignment</option>
                <option value="Notes">ğŸ““ Study Notes</option>
                <option value="Other">ğŸ“ Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Upload File *</label>
            <input type="file" id="materialFile" required>
            <small>Max 50MB - Supported: PDF, PPT, DOCX, MP4, ZIP, etc.</small>
          </div>

          <button type="submit" class="btn-primary">ğŸ“¤ Upload Material & Notify Students</button>
        </form>
      </section>

      <!-- All Materials -->
      <section class="table-section">
        <h2>ğŸ“š All Uploaded Materials</h2>
        <div class="form-row" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>Filter by Student</label>
            <select id="filterMaterialStudent" onchange="loadMaterials()">
              <option value="">All Students</option>
            </select>
          </div>
          <div class="form-group">
            <label>Filter by Type</label>
            <select id="filterMaterialType" onchange="loadMaterials()">
              <option value="">All Types</option>
              <option value="PPT">PPT</option>
              <option value="PDF">PDF</option>
              <option value="Recording">Recording</option>
              <option value="Homework">Homework</option>
              <option value="Notes">Notes</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <table id="materialsTable">
          <thead>
            <tr>
              <th>Target</th>
              <th>Date</th>
              <th>Type</th>
              <th>File Name</th>
              <th>Uploaded By</th>
              <th>Uploaded At</th>
              <th>Feedback</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="materialsTableBody">
            <tr><td colspan="8" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“ Give Homework Feedback</h2>
          <button onclick="closeFeedbackModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
        </div>
        <form id="feedbackForm">
          <div class="form-group">
            <label>Grade *</label>
            <select id="feedbackGrade" required>
              <option value="">Select grade...</option>
              <option value="A+">A+ Excellent</option>
              <option value="A">A Very Good</option>
              <option value="B+">B+ Good</option>
              <option value="B">B Satisfactory</option>
              <option value="C">C Needs Improvement</option>
            </select>
          </div>
          <div class="form-group">
            <label>Feedback Comments *</label>
            <textarea id="feedbackComments" rows="4" required placeholder="Write your feedback here..."></textarea>
          </div>
          <button type="submit" class="btn-primary">âœ… Submit & Send Email</button>
          <button type="button" onclick="closeFeedbackModal()" class="btn-secondary">Cancel</button>
        </form>
      </div>
    </div>

    <!-- ==================== EVENTS TAB ==================== -->
    <div id="eventsTab" class="tab-content">
      <section class="form-section">
        <h2>ğŸ‰ Create New Event</h2>
        <form id="createEventForm">
          <div class="form-row">
            <div class="form-group">
              <label>Event Type *</label>
              <select id="eventType" required>
                <option value="">Select...</option>
                <option value="Workshop">ğŸ“ Workshop</option>
                <option value="Competition">ğŸ† Competition</option>
                <option value="Showcase">ğŸ­ Showcase</option>
                <option value="Webinar">ğŸ’» Webinar</option>
                <option value="Other">ğŸ“Œ Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Event Name *</label>
              <input type="text" id="eventName" required placeholder="e.g., Public Speaking Workshop">
            </div>
          </div>

          <div class="form-group">
            <label>Description *</label>
            <textarea id="eventDescription" rows="3" required placeholder="Describe the event..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Event Date *</label>
              <input type="date" id="eventDate" required>
            </div>
            <div class="form-group">
              <label>Event Time *</label>
              <input type="time" id="eventTime" required>
            </div>
            <div class="form-group">
              <label>Duration *</label>
              <select id="eventDuration" required>
                <option value="30 minutes">30 minutes</option>
                <option value="1 hour">1 hour</option>
                <option value="1.5 hours">1.5 hours</option>
                <option value="2 hours">2 hours</option>
                <option value="3 hours">3 hours</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Zoom Link *</label>
              <input type="url" id="eventZoomLink" required placeholder="https://zoom.us/j/...">
            </div>
            <div class="form-group">
              <label>Max Participants (0 = Unlimited)</label>
              <input type="number" id="eventMaxParticipants" min="0" value="0">
            </div>
          </div>

          <div class="form-group">
            <label>Registration Deadline</label>
            <input type="datetime-local" id="eventRegistrationDeadline">
          </div>

          <button type="submit" class="btn-primary">ğŸ‰ Create Event & Send Announcements</button>
        </form>
      </section>

      <!-- All Events -->
      <section class="table-section">
        <h2>ğŸ“‹ All Events</h2>
        <table id="eventsTable">
          <thead>
            <tr>
              <th>Event Name</th>
              <th>Type</th>
              <th>Date & Time</th>
              <th>Registered</th>
              <th>Capacity</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="eventsTableBody">
            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="modal" style="display: none;">
      <div class="modal-content large-modal">
        <div class="modal-header">
          <h2 id="modalEventName">Event Details</h2>
          <button onclick="closeEventModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
        </div>

        <div id="eventDetailsContent"></div>

        <div id="eventAttendanceSection" style="margin-top: 20px;">
          <h3>Mark Attendance</h3>
          <div id="eventRegistrationsList"></div>
          <button onclick="markEventAttendance()" class="btn-primary">âœ… Save Attendance & Generate Certificates</button>
        </div>
      </div>
    </div>

    <!-- ==================== BATCHES TAB ==================== -->
    <div id="batchesTab" class="tab-content">
      <!-- Create New Batch Form -->
      <section class="form-section">
        <h2>â• Create New Batch/Group</h2>
        <form id="createBatchForm">
          <div class="form-row">
            <div class="form-group">
              <label>Batch Name *</label>
              <input type="text" id="batchName" required placeholder="e.g., English Speaking - Morning Batch">
            </div>
            <div class="form-group">
              <label>Batch Code *</label>
              <input type="text" id="batchCode" required placeholder="e.g., ES-M-001" style="text-transform: uppercase;">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Program Name *</label>
              <input type="text" id="batchProgramName" required placeholder="e.g., English Speaking">
            </div>
            <div class="form-group">
              <label>Grade Level *</label>
              <input type="text" id="batchGradeLevel" required placeholder="e.g., Grades 5-7">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Duration *</label>
              <select id="batchDuration" required>
                <option value="">Select...</option>
                <option value="25 mins">25 mins</option>
                <option value="40 mins">40 mins</option>
                <option value="60 mins">60 mins</option>
              </select>
            </div>
            <div class="form-group">
              <label>Batch Timezone (Your Teaching Timezone) *</label>
              <select id="batchTimezone" required>
                <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                <option value="America/New_York">America/New_York (EST)</option>
                <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
                <option value="Europe/London">Europe/London (GMT)</option>
                <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                <option value="Asia/Dhaka">Asia/Dhaka (BST - Bangladesh)</option>
                <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
                <option value="Australia/Sydney">Australia/Sydney (AEDT)</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Max Students *</label>
              <input type="number" id="batchMaxStudents" required min="2" max="50" value="10">
            </div>
            <div class="form-group">
              <label>Currency *</label>
              <select id="batchCurrency" required>
                <option value="â‚¹">â‚¹ (INR - Indian Rupee)</option>
                <option value="à§³">à§³ (BDT - Bangladeshi Taka)</option>
                <option value="$">$ (USD - US Dollar)</option>
                <option value="â‚¬">â‚¬ (EUR - Euro)</option>
                <option value="Â£">Â£ (GBP - British Pound)</option>
                <option value="Ø¯.Ø¥">Ø¯.Ø¥ (AED - UAE Dirham)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Per Session Fee *</label>
              <input type="number" id="batchPerSessionFee" required min="0" step="0.01">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="batchStartDate">
            </div>
            <div class="form-group">
              <label>End Date</label>
              <input type="date" id="batchEndDate">
            </div>
          </div>

          <div class="form-group">
            <label>Zoom Link *</label>
            <input type="url" id="batchZoomLink" required placeholder="https://zoom.us/j/...">
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="batchDescription" rows="3" placeholder="Brief description of the batch..."></textarea>
          </div>

          <button type="submit" class="btn-primary">Create Batch</button>
        </form>
      </section>

      <!-- All Batches Table -->
      <section class="table-section">
        <h2>ğŸ“‹ All Batches</h2>
        <div class="table-filters">
          <input type="text" id="searchBatches" placeholder="ğŸ” Search batches..." style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; width: 300px;">
          <select id="filterBatchStatus" onchange="loadBatches()" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-left: 10px;">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Completed">Completed</option>
            <option value="On Hold">On Hold</option>
          </select>
        </div>
        
        <table id="batchesTable">
          <thead>
            <tr>
              <th>Batch Name & Code</th>
              <th>Program</th>
              <th>Grade Level</th>
              <th>Duration</th>
              <th>Timezone</th>
              <th>Enrollment</th>
              <th>Fee</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="batchesTableBody">
            <tr><td colspan="9" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <!-- ==================== TIMETABLE TAB ==================== -->
    <div id="timetableTab" class="tab-content">
      <section class="form-section">
        <h2>â• Add Time Slot</h2>
        <form id="addSlotForm">
          <div class="form-row">
            <div class="form-group">
              <label>Day of Week *</label>
              <select id="dayOfWeek" required>
                <option value="">Select...</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
              </select>
            </div>
            <div class="form-group">
              <label>Time Slot *</label>
              <input type="text" id="timeSlot" required placeholder="e.g., 4:00 PM - 4:40 PM">
            </div>
          </div>
          <button type="submit" class="btn-primary">Add Slot</button>
        </form>
      </section>

      <section class="table-section">
        <h2>ğŸ“… Weekly Timetable</h2>
        <div id="timetableView" class="timetable-grid"></div>
      </section>
    </div>

    <!-- Book Slot Modal -->
    <div id="bookSlotModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“ Book Time Slot</h2>
          <button onclick="closeBookModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
        </div>
        <form id="bookSlotForm">
          <div class="form-group">
            <label>Select Student *</label>
            <select id="bookStudentId" required>
              <option value="">Select student...</option>
            </select>
          </div>
          <button type="submit" class="btn-primary">Book Slot</button>
          <button type="button" onclick="closeBookModal()" class="btn-secondary">Cancel</button>
        </form>
      </div>
    </div>

    <!-- ==================== EMAILS TAB ==================== -->
    <div id="emailsTab" class="tab-content">
      <section class="table-section">
        <h2>ğŸ“§ Email Log</h2>
        <p style="color: #7f8c8d; margin-bottom: 20px;">Track all automated emails sent by the system</p>
        
        <div class="form-row" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>Filter by Type</label>
            <select id="filterEmailType" onchange="loadEmailLog()">
              <option value="">All Types</option>
              <option value="Welcome">Welcome</option>
              <option value="Schedule">Schedule</option>
              <option value="24h Reminder">24h Reminder</option>
              <option value="1h Reminder">1h Reminder</option>
              <option value="Cancellation">Cancellation</option>
              <option value="Material Upload">Material Upload</option>
              <option value="Event Announcement">Event Announcement</option>
              <option value="Certificate">Certificate</option>
            </select>
          </div>
          <div class="form-group">
            <label>Filter by Status</label>
            <select id="filterEmailStatus" onchange="loadEmailLog()">
              <option value="">All Status</option>
              <option value="Sent">Sent</option>
              <option value="Failed">Failed</option>
            </select>
          </div>
        </div>

        <table id="emailsTable">
          <thead>
            <tr>
              <th>Sent At</th>
              <th>Recipient</th>
              <th>Email</th>
              <th>Type</th>
              <th>Subject</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="emailsTableBody">
            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </section>
    </div>

<!-- CONTINUE TO PART 4 FOR BATCH MODALS & JAVASCRIPT --><!-- ==================== BATCH MODALS ==================== -->

<!-- Batch Details Modal -->
<div id="batchDetailsModal" class="modal" style="display: none;">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2 id="modalBatchName">Batch Details</h2>
      <button onclick="closeBatchModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
    </div>

    <div class="student-details-tabs">
      <button class="detail-tab-btn active" onclick="showBatchDetailTab('batchInfo', this)">ğŸ“‹ Info</button>
      <button class="detail-tab-btn" onclick="showBatchDetailTab('batchStudents', this)">ğŸ‘¥ Students</button>
      <button class="detail-tab-btn" onclick="showBatchDetailTab('batchSchedule', this)">ğŸ“… Schedule</button>
      <button class="detail-tab-btn" onclick="showBatchDetailTab('batchMaterials', this)">ğŸ“š Materials</button>
    </div>

    <!-- Batch Info Tab -->
    <div id="batchInfoDetail" class="detail-tab-content active">
      <div id="batchInfoContent"></div>
      <div style="margin-top: 20px;">
        <button onclick="openEditBatchModal()" class="btn-primary">âœï¸ Edit Batch</button>
        <button onclick="deleteBatch()" class="btn-danger" style="margin-left: 10px;">ğŸ—‘ï¸ Delete Batch</button>
      </div>
    </div>

    <!-- Students Tab -->
    <div id="batchStudentsDetail" class="detail-tab-content">
      <button onclick="showEnrollStudentForm()" class="btn-primary" style="margin-bottom: 20px;">+ Enroll Student</button>
      
      <div id="enrollStudentForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3>Enroll Student in Batch</h3>
        <form id="enrollStudentInBatchForm">
          <div class="form-group">
            <label>Select Student *</label>
            <select id="enrollStudentSelect" required>
              <option value="">Select student...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="enrollmentNotes" rows="2" placeholder="Optional notes..."></textarea>
          </div>
          <button type="submit" class="btn-primary">Enroll Student</button>
          <button type="button" onclick="hideEnrollStudentForm()" class="btn-secondary">Cancel</button>
        </form>
      </div>

      <table id="batchStudentsTable">
        <thead>
          <tr>
            <th>Student Name</th>
            <th>Grade</th>
            <th>Parent</th>
            <th>Timezone</th>
            <th>Enrolled Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="batchStudentsBody"></tbody>
      </table>
    </div>

    <!-- Schedule Tab -->
    <div id="batchScheduleDetail" class="detail-tab-content">
      <button onclick="showBatchScheduleForm()" class="btn-primary" style="margin-bottom: 20px;">ğŸ“… Schedule Classes</button>
      
      <div id="batchScheduleFormSection" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3>Schedule Batch Sessions</h3>
        <form id="scheduleBatchSessionsForm">
          <div id="batchClassScheduleList"></div>
          
          <div style="margin: 20px 0;">
            <button type="button" onclick="addBatchScheduleRow()" class="btn-secondary">+ Add Session</button>
            <button type="button" onclick="addBatchBulkSchedule()" class="btn-secondary">ğŸ“… Bulk Schedule</button>
          </div>
          
          <button type="submit" class="btn-primary">Schedule All & Send Emails</button>
          <button type="button" onclick="hideBatchScheduleForm()" class="btn-secondary">Cancel</button>
        </form>
      </div>

      <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #17a2b8;">
        <p style="margin: 0; color: #0c5460;">
          <strong>â„¹ï¸ Timezone Info:</strong> Schedule times in YOUR timezone. Students will see times converted to THEIR timezone automatically.
        </p>
      </div>

      <table id="batchSessionsTable">
        <thead>
          <tr>
            <th>Session #</th>
            <th>Date</th>
            <th>Time (Your Timezone)</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="batchSessionsBody"></tbody>
      </table>
    </div>

    <!-- Materials Tab -->
    <div id="batchMaterialsDetail" class="detail-tab-content">
      <button onclick="showBatchMaterialUpload()" class="btn-primary" style="margin-bottom: 20px;">ğŸ“¤ Upload Material</button>
      
      <div id="batchMaterialUploadForm"
     style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3>Upload Material for Batch</h3>
        <form id="uploadBatchMaterialForm" enctype="multipart/form-data">
          <div class="form-row">
            <div class="form-group">
              <label>Session Date *</label>
              <input type="date" id="batchMaterialSessionDate" required>
            </div>
            <div class="form-group">
              <label>Material Type *</label>
              <select id="batchMaterialType" required>
                <option value="">Select...</option>
                <option value="PPT">ğŸ“Š PPT/Presentation</option>
                <option value="PDF">ğŸ“„ PDF/Document</option>
                <option value="Recording">ğŸ¥ Class Recording</option>
                <option value="Homework">ğŸ“ Homework Assignment</option>
                <option value="Notes">ğŸ““ Study Notes</option>
                <option value="Other">ğŸ“ Other</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Upload File *</label>
            <input type="file" id="batchMaterialFile" required>
          </div>
          <button type="submit" class="btn-primary">Upload & Notify Students</button>
          <button type="button" onclick="hideBatchMaterialUpload()" class="btn-secondary">Cancel</button>
        </form>
      </div>

      <div id="batchMaterialsList"></div>
    </div>
  </div>
</div>

<!-- Edit Batch Modal -->
<div id="editBatchModal" class="modal" style="display: none;">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>âœï¸ Edit Batch Details</h2>
      <button onclick="closeEditBatchModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
    </div>

    <form id="editBatchForm">
      <div class="form-row">
        <div class="form-group">
          <label>Batch Name *</label>
          <input type="text" id="editBatchName" required>
        </div>
        <div class="form-group">
          <label>Program Name *</label>
          <input type="text" id="editBatchProgramName" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Grade Level *</label>
          <input type="text" id="editBatchGradeLevel" required>
        </div>
        <div class="form-group">
          <label>Duration *</label>
          <select id="editBatchDuration" required>
            <option value="25 mins">25 mins</option>
            <option value="40 mins">40 mins</option>
            <option value="60 mins">60 mins</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Timezone *</label>
          <select id="editBatchTimezone" required>
            <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
            <option value="America/New_York">America/New_York (EST)</option>
            <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
            <option value="Europe/London">Europe/London (GMT)</option>
            <option value="Asia/Dubai">Asia/Dubai (GST)</option>
            <option value="Asia/Dhaka">Asia/Dhaka (BST - Bangladesh)</option>
            <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
            <option value="Australia/Sydney">Australia/Sydney (AEDT)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Max Students *</label>
          <input type="number" id="editBatchMaxStudents" required min="2" max="50">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Currency *</label>
          <select id="editBatchCurrency" required>
            <option value="â‚¹">â‚¹ (INR)</option>
            <option value="à§³">à§³ (BDT)</option>
            <option value="$">$ (USD)</option>
            <option value="â‚¬">â‚¬ (EUR)</option>
            <option value="Â£">Â£ (GBP)</option>
            <option value="Ø¯.Ø¥">Ø¯.Ø¥ (AED)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Per Session Fee *</label>
          <input type="number" id="editBatchPerSessionFee" required step="0.01">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" id="editBatchStartDate">
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input type="date" id="editBatchEndDate">
        </div>
      </div>

      <div class="form-group">
        <label>Zoom Link *</label>
        <input type="url" id="editBatchZoomLink" required>
      </div>

      <div class="form-group">
        <label>Status *</label>
        <select id="editBatchStatus" required>
          <option value="Active">Active</option>
          <option value="Completed">Completed</option>
          <option value="On Hold">On Hold</option>
        </select>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea id="editBatchDescription" rows="3"></textarea>
      </div>

      <button type="submit" class="btn-primary">ğŸ’¾ Save Changes</button>
      <button type="button" onclick="closeEditBatchModal()" class="btn-secondary">Cancel</button>
    </form>
  </div>
</div>

<!-- Batch Session Attendance Modal -->
<div id="batchAttendanceModal" class="modal" style="display: none;">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>âœ… Mark Batch Session Attendance</h2>
      <button onclick="closeBatchAttendanceModal()" class="btn-close" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">âœ•</button>
    </div>

    <div id="batchAttendanceContent">
      <form id="batchAttendanceForm">
        <div id="batchAttendanceList"></div>
        <button type="submit" class="btn-primary" style="margin-top: 20px;">ğŸ’¾ Save Attendance</button>
      </form>
    </div>
  </div>
</div>

  </div> <!-- Close main container -->
  <script>
// Admin Panel JavaScript - Single Clean Copy
let allStudents = [];
let allEvents = [];
let allBatches = [];
let currentStudentId = null;
let currentEditStudentId = null;
let currentEventId = null;
let scheduleCounter = 0;

document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸ“ Admin Panel Loading...');
  loadDashboardStats();
  loadStudents();
  loadEvents();
  loadBatches();
  
  const perSessionFee = document.getElementById('perSessionFee');
  const totalSessions = document.getElementById('totalSessions');
  if (perSessionFee) perSessionFee.addEventListener('input', calculateTotalFees);
  if (totalSessions) totalSessions.addEventListener('input', calculateTotalFees);
  
  console.log('âœ… Admin Panel Loaded!');
});

window.showTab = function(tabName, btn) {
  console.log('Switching to tab:', tabName);
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const targetTab = document.getElementById(tabName + 'Tab');
  if (targetTab) targetTab.classList.add('active');
  if (btn) btn.classList.add('active');
  if (tabName === 'events') loadEventsTab();
  if (tabName === 'sessions') loadSessionsTab();
  if (tabName === 'materials') loadMaterialsTab();
  if (tabName === 'timetable') loadTimetableTab();
  if (tabName === 'emails') loadEmailsTab();
  if (tabName === 'batches') loadBatches();
}

async function loadDashboardStats() {
  try {
    const response = await fetch('/api/dashboard/stats');
    const stats = await response.json();
    document.getElementById('totalStudents').textContent = stats.totalStudents || 0;
    document.getElementById('upcomingSessions').textContent = stats.upcomingSessions || 0;
    document.getElementById('todaySessions').textContent = stats.todaySessions || 0;
    document.getElementById('totalRevenue').textContent = 'â‚¹' + (stats.totalRevenue || 0).toLocaleString();
    document.getElementById('upcomingEvents').textContent = stats.upcomingEvents || 0;
  } catch (error) {
    console.error('Error:', error);
  }
}

async function loadStudents() {
  try {
    const response = await fetch('/api/students');
    allStudents = await response.json();
    console.log('Loaded students:', allStudents.length);
    renderStudentsTable();
    populateStudentDropdowns();
  } catch (error) {
    console.error('Error:', error);
  }
}

function renderStudentsTable() {
  const tbody = document.getElementById('studentsTableBody');
  if (!tbody) return;
  if (allStudents.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No students yet</td></tr>';
    return;
  }
  tbody.innerHTML = allStudents.map(s => `
    <tr>
      <td><strong>${s.name}</strong><br><small>Grade ${s.grade}</small></td>
      <td>${s.program_name}</td>
      <td>${s.class_type}</td>
      <td>${s.timezone}</td>
      <td>${s.currency}${s.per_session_fee}</td>
      <td>${s.completed_sessions} / ${s.remaining_sessions}</td>
      <td>${s.currency}${s.fees_paid}</td>
      <td>
        <button onclick="viewStudentDetails(${s.id})" class="btn-view">Details</button>
        <button onclick="openEditModal(${s.id})" class="btn-edit">Edit</button>
        <button onclick="deleteStudent(${s.id})" class="btn-mini-delete">Delete</button>
      </td>
    </tr>
  `).join('');
}

function calculateTotalFees() {
  const perSession = parseFloat(document.getElementById('perSessionFee')?.value) || 0;
  const totalSessions = parseInt(document.getElementById('totalSessions')?.value) || 0;
  const currency = document.getElementById('currency')?.value || 'â‚¹';
  const totalFeesElem = document.getElementById('totalFees');
  if (totalFeesElem) totalFeesElem.value = currency + (perSession * totalSessions).toFixed(2);
}

function calculateEditTotalFees() {
  const perSession = parseFloat(document.getElementById('editPerSessionFee')?.value) || 0;
  const totalSessions = parseInt(document.getElementById('editTotalSessions')?.value) || 0;
  const currency = document.getElementById('editCurrency')?.value || 'â‚¹';
  const totalFeesElem = document.getElementById('editTotalFees');
  if (totalFeesElem) totalFeesElem.value = currency + (perSession * totalSessions).toFixed(2);
}

function populateStudentDropdowns() {
  const dropdowns = ['scheduleStudentId', 'filterSessionStudent', 'privateStudentId', 'filterMaterialStudent', 'bookStudentId'];
  dropdowns.forEach(id => {
    const dropdown = document.getElementById(id);
    if (dropdown) {
      const isFilter = id.startsWith('filter');
      dropdown.innerHTML = (isFilter ? '<option value="">All Students</option>' : '<option value="">Select student...</option>');
      allStudents.forEach(s => {
        dropdown.innerHTML += `<option value="${s.id}">${s.name} - ${s.program_name}</option>`;
      });
    }
  });
}

window.deleteStudent = async function(id) {
  if (!confirm('Delete this student?')) return;
  try {
    const response = await fetch(`/api/students/${id}`, { method: 'DELETE' });
    if (response.ok) {
      alert('âœ… Student deleted!');
      loadStudents();
      loadDashboardStats();
    }
  } catch (error) {
    alert('âŒ Failed');
  }
}

window.viewStudentDetails = async function(studentId) {
  currentStudentId = studentId;
  try {
    const response = await fetch(`/api/students/${studentId}/details`);
    const data = await response.json();
    const student = data.student;
    
    document.getElementById('modalStudentName').textContent = student.name;
    document.getElementById('studentInfoContent').innerHTML = `
      <div class="info-grid">
        <div class="info-card">
          <h3>ğŸ‘¤ Personal</h3>
          <p><strong>Name:</strong> ${student.name}</p>
          <p><strong>Grade:</strong> ${student.grade}</p>
          <p><strong>Parent:</strong> ${student.parent_name}</p>
          <p><strong>Email:</strong> ${student.parent_email}</p>
        </div>
        <div class="info-card">
          <h3>ğŸ“š Program</h3>
          <p><strong>Program:</strong> ${student.program_name}</p>
          <p><strong>Type:</strong> ${student.class_type}</p>
          <p><strong>Duration:</strong> ${student.duration}</p>
        </div>
        <div class="info-card">
          <h3>ğŸ“Š Progress</h3>
          <p><strong>Total:</strong> ${student.total_sessions}</p>
          <p><strong>Completed:</strong> ${student.completed_sessions}</p>
          <p><strong>Remaining:</strong> ${student.remaining_sessions}</p>
        </div>
      </div>
    `;
    
    document.getElementById('studentDetailsModal').style.display = 'flex';
  } catch (error) {
    alert('Failed to load');
  }
}

window.closeStudentModal = function() {
  document.getElementById('studentDetailsModal').style.display = 'none';
}

window.showDetailTab = function(tabName, btn) {
  document.querySelectorAll('.detail-tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.detail-tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabName + 'Detail').classList.add('active');
  if (btn) btn.classList.add('active');
}

window.showPaymentForm = function() {
  const form = document.getElementById('paymentFormSection');
  if (form) form.style.display = 'block';
}

window.hidePaymentForm = function() {
  const form = document.getElementById('paymentFormSection');
  if (form) form.style.display = 'none';
}

window.openEditModal = async function(studentId) {
  currentEditStudentId = studentId;
  try {
    const response = await fetch(`/api/students/${studentId}/details`);
    const data = await response.json();
    const s = data.student;
    
    document.getElementById('editStudentName').value = s.name;
    document.getElementById('editGrade').value = s.grade;
    document.getElementById('editParentName').value = s.parent_name;
    document.getElementById('editParentEmail').value = s.parent_email;
    document.getElementById('editPrimaryContact').value = s.primary_contact || '';
    document.getElementById('editAlternateContact').value = s.alternate_contact || '';
    document.getElementById('editTimezone').value = s.timezone;
    document.getElementById('editProgramName').value = s.program_name;
    document.getElementById('editClassType').value = s.class_type;
    document.getElementById('editDuration').value = s.duration;
    document.getElementById('editCurrency').value = s.currency;
    document.getElementById('editPerSessionFee').value = s.per_session_fee;
    document.getElementById('editTotalSessions').value = s.total_sessions;
    
    calculateEditTotalFees();
    document.getElementById('editStudentModal').style.display = 'flex';
  } catch (error) {
    alert('Failed to load');
  }
}

window.closeEditModal = function() {
  document.getElementById('editStudentModal').style.display = 'none';
}

window.addScheduleRow = function() {
  scheduleCounter++;
  const row = document.createElement('div');
  row.className = 'schedule-row';
  row.innerHTML = `
    <input type="date" id="scheduleDate${scheduleCounter}" required>
    <input type="time" id="scheduleTime${scheduleCounter}" required>
    <button type="button" onclick="removeScheduleRow(${scheduleCounter})" class="btn-delete">âœ—</button>
  `;
  document.getElementById('classScheduleList')?.appendChild(row);
}

window.removeScheduleRow = function(id) {
  document.getElementById(`scheduleRow${id}`)?.remove();
}

async function loadEvents() {
  try {
    const response = await fetch('/api/events');
    allEvents = await response.json();
  } catch (error) {
    console.error('Error:', error);
  }
}

async function loadBatches() {
  try {
    const response = await fetch('/api/batches');
    allBatches = await response.json();
  } catch (error) {
    console.error('Error:', error);
  }
}

async function loadEventsTab() { console.log('Events tab'); }
async function loadSessionsTab() { console.log('Sessions tab'); }
async function loadMaterialsTab() { console.log('Materials tab'); }
async function loadTimetableTab() { console.log('Timetable tab'); }
async function loadEmailsTab() { console.log('Emails tab'); }
// ==================== SWITCH TO LEARNER VIEW ====================
window.switchToLearnerView = async function() {
  if (!currentStudentId) {
    alert('âŒ No student selected');
    return;
  }
  
  try {
    // Get fresh student data
    const response = await fetch(`/api/students/${currentStudentId}/details`);
    const data = await response.json();
    const student = data.student;
    
    // Store in session storage for parent portal
    sessionStorage.setItem('adminAccessStudent', JSON.stringify(student));
    sessionStorage.setItem('adminAccessMode', 'true');
    sessionStorage.setItem('adminAccessEmail', student.parent_email);
    
    // Open parent portal in new tab
    window.open('parent.html', '_blank');
    
    // Show confirmation
    alert(`âœ… Opening parent portal for ${student.name}\n\nYou'll see exactly what ${student.parent_name} sees.`);
    
  } catch (error) {
    console.error('Error switching to learner view:', error);
    alert('âŒ Failed to switch to learner view');
  }
}
console.log('%câœ… Admin Panel Ready', 'color: green; font-size: 16px;');
  </script>

  <style>
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-content.large-modal { max-width: 900px; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .info-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; }
    .info-card h3 { margin-top: 0; color: #2c3e50; }
    .detail-tab-btn { padding: 12px 20px; background: #f8f9fa; border: none; cursor: pointer; }
    .detail-tab-btn.active { background: white; border-bottom: 3px solid #667eea; color: #667eea; }
    .detail-tab-content { display: none; }
    .detail-tab-content.active { display: block; }
    .schedule-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .schedule-row input { flex: 1; padding: 8px; border: 2px solid #ddd; border-radius: 5px; }
  </style>

</body>
</html>